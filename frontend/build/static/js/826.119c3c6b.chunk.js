(self.webpackChunkcanvas_app=self.webpackChunkcanvas_app||[]).push([[826],{42522:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>Kt});var a=r(65043),n=r(7353),s=r(81637),o=r(39412),i=r(17392),l=r(61596),c=r(35721),d=r(30681),u=r(38968),h=r(48734),p=r(81045),m=r(90035),g=r(26600),y=r(35316),f=r(94496),x=r(29347),w=r(11906),b=r(52134),v=r(75267),j=r(90422),A=r(98533),S=r(15795),k=r(56258),C=r(64165),D=r(30279),T=r(67254),I=r(40490),P=r(34642),R=r(70579);function E(e){let{isHealthy:t,queueSize:r=0}=e;return(0,R.jsx)(D.A,{in:!t,children:(0,R.jsxs)(T.A,{severity:"warning",icon:(0,R.jsx)(P.A,{}),sx:{mb:2,borderRadius:1,"& .MuiAlert-message":{width:"100%"}},children:[(0,R.jsx)(I.A,{children:"Blockchain Service Temporarily Unavailable"}),"Your drawings are being saved normally, but blockchain persistence is currently offline.",r>0&&(0,R.jsxs)(R.Fragment,{children:[" ",(0,R.jsxs)("strong",{children:[r," stroke",1!==r?"s":""]})," will be automatically synced once the service is restored."]}),0===r&&(0,R.jsx)(R.Fragment,{children:" Your work will be automatically synced to the blockchain once the service is restored."})]})})}var M=r(93533);let U=null,B=!0,W=null,$=0,z=[];async function N(){try{const e=await fetch(`${M.t}/health/resilientdb`,{method:"GET",headers:{"Content-Type":"application/json"}}),t=await e.json(),r=B,a=$;return B=e.ok,$=t.retry_queue_size||0,W=Date.now(),(r!==B||Math.abs(a-$)>5)&&(console.log(`[ResilientDB Monitor] Status: ${B?"healthy":"unhealthy"}, Queue: ${$}`),z.forEach((e=>e({isHealthy:B,queueSize:$,timestamp:W})))),B}catch(e){const t=B;return B=!1,W=Date.now(),t!==B&&(console.error("[ResilientDB Monitor] Health check failed:",e),z.forEach((e=>e({isHealthy:B,queueSize:$,timestamp:W})))),!1}}var F=r(51787),O=r(39336),L=r(43845),_=r(79484),H=r(17673);const q=function(e){let{open:t,onClose:r,commands:s=[],onExecute:o}=e;const[i,l]=(0,a.useState)(""),[u,p]=(0,a.useState)([]),[g,y]=(0,a.useState)(0),[x,w]=(0,a.useState)([]),b=(0,a.useRef)(null),v=(0,a.useRef)(null);(0,a.useEffect)((()=>{if(t)try{const e=localStorage.getItem("rescanvas_recent_commands");e&&w(JSON.parse(e).slice(0,5))}catch(e){console.error("[CommandPalette] Error loading recent commands:",e)}}),[t]),(0,a.useEffect)((()=>{if(!s||0===s.length)return void p([]);if(!i||""===i.trim()){const e=x.map((e=>s.find((t=>t.id===e)))).filter(Boolean),t=s.filter((e=>!x.includes(e.id)));return p([...e,...t]),void y(0)}const e=i.toLowerCase().trim(),t=e.split(/\s+/),r=s.filter((e=>{const r=[e.label,e.description,e.category,...e.keywords||[]].join(" ").toLowerCase();return t.every((e=>r.includes(e)))})).sort(((t,r)=>{const a=t.label.toLowerCase().includes(e),n=r.label.toLowerCase().includes(e);if(a&&!n)return-1;if(!a&&n)return 1;const s=t.category.toLowerCase().includes(e),o=r.category.toLowerCase().includes(e);return s&&!o?-1:!s&&o?1:t.label.localeCompare(r.label)}));p(r),y(0)}),[i,s,x]),(0,a.useEffect)((()=>{t&&(l(""),y(0),setTimeout((()=>{v.current&&v.current.focus()}),50))}),[t]),(0,a.useEffect)((()=>{if(b.current&&u.length>0){const e=b.current.children[g];e&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}}),[g,u]);const j=(0,a.useCallback)((e=>{if(!e)return;const t=[e.id,...x.filter((t=>t!==e.id))].slice(0,5);w(t);try{localStorage.setItem("rescanvas_recent_commands",JSON.stringify(t))}catch(a){console.error("[CommandPalette] Error saving recent commands:",a)}if(o)o(e);else if(e.action)try{e.action()}catch(a){console.error("[CommandPalette] Error executing command:",a)}r()}),[o,r,x]),A=(0,a.useCallback)((e=>{switch(e.key){case"ArrowDown":e.preventDefault(),y((e=>e<u.length-1?e+1:e));break;case"ArrowUp":e.preventDefault(),y((e=>e>0?e-1:e));break;case"Enter":e.preventDefault(),u[g]&&j(u[g]);break;case"Escape":e.preventDefault(),r()}}),[u,g,j,r]),k=e=>{if(!e.shortcut)return null;const{key:t,modifiers:r}=e.shortcut,a=[],n=navigator.platform.toUpperCase().indexOf("MAC")>=0;r.ctrl&&a.push(n?"\u2318":"Ctrl"),r.shift&&a.push(n?"\u21e7":"Shift"),r.alt&&a.push(n?"\u2325":"Alt");const s=1===t.length?t.toUpperCase():t;return a.push(s),a.join(" + ")},C=u.reduce(((e,t,r)=>{const a=r>0?u[r-1]:null,n=!a||a.category!==t.category;return e.push({command:t,showCategoryHeader:n,index:r}),e}),[]);return(0,R.jsxs)(m.A,{open:t,onClose:r,maxWidth:"sm",fullWidth:!0,PaperProps:{className:"command-palette-dialog",sx:{borderRadius:2,maxHeight:"70vh"}},TransitionProps:{onEntered:()=>{v.current&&v.current.focus()}},children:[(0,R.jsxs)(n.A,{sx:{p:2,pb:0},children:[(0,R.jsx)(S.A,{inputRef:v,autoFocus:!0,fullWidth:!0,placeholder:"Type a command or search...",value:i,onChange:e=>l(e.target.value),onKeyDown:A,variant:"outlined",size:"medium",InputProps:{startAdornment:(0,R.jsx)(F.A,{position:"start",children:(0,R.jsx)(_.A,{color:"action"})}),sx:{"& .MuiOutlinedInput-notchedOutline":{border:"none",borderBottom:"1px solid",borderColor:"divider",borderRadius:0},"&:hover .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main"},"&.Mui-focused .MuiOutlinedInput-notchedOutline":{borderColor:"primary.main",borderWidth:"2px"}}},sx:{mb:1}}),u.length>0&&(0,R.jsxs)(f.A,{variant:"caption",color:"text.secondary",sx:{pl:1},children:[u.length," command",1!==u.length?"s":""," found"]})]}),(0,R.jsx)(c.A,{ref:b,sx:{maxHeight:"calc(70vh - 120px)",overflow:"auto",py:1,"&::-webkit-scrollbar":{width:"8px"},"&::-webkit-scrollbar-track":{background:"transparent"},"&::-webkit-scrollbar-thumb":{background:"rgba(0,0,0,0.2)",borderRadius:"4px"}},children:0===C.length?(0,R.jsxs)(n.A,{sx:{p:4,textAlign:"center"},children:[(0,R.jsx)(H.A,{sx:{fontSize:48,color:"text.disabled",mb:1}}),(0,R.jsx)(f.A,{variant:"body2",color:"text.secondary",children:"No commands found"}),(0,R.jsx)(f.A,{variant:"caption",color:"text.disabled",children:"Try a different search term"})]}):C.map((e=>{let{command:t,showCategoryHeader:r,index:s}=e;return(0,R.jsxs)(a.Fragment,{children:[r&&(0,R.jsxs)(R.Fragment,{children:[s>0&&(0,R.jsx)(O.A,{sx:{my:1}}),(0,R.jsx)(n.A,{sx:{px:2,py:.5},children:(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",fontWeight:"600",children:t.category})})]}),(0,R.jsxs)(d.Ay,{button:!0,selected:s===g,onClick:()=>j(t),sx:{py:1.5,px:2,cursor:"pointer","&.Mui-selected":{bgcolor:"primary.light","&:hover":{bgcolor:"primary.light"}},"&:hover":{bgcolor:"action.hover"}},children:[(0,R.jsx)(h.A,{primary:t.label,secondary:t.description,primaryTypographyProps:{variant:"body2",fontWeight:500},secondaryTypographyProps:{variant:"caption",color:"text.secondary"}}),t.shortcut&&(0,R.jsx)(L.A,{label:k(t),size:"small",variant:"outlined",sx:{ml:2,fontFamily:"monospace",fontSize:"0.75rem",height:"24px"}})]})]},t.id)}))}),(0,R.jsx)(n.A,{sx:{p:1.5,borderTop:1,borderColor:"divider",bgcolor:"background.default"},children:(0,R.jsxs)(f.A,{variant:"caption",color:"text.secondary",sx:{display:"flex",gap:2},children:[(0,R.jsxs)("span",{children:[(0,R.jsx)("strong",{children:"\u2191\u2193"})," Navigate"]}),(0,R.jsxs)("span",{children:[(0,R.jsx)("strong",{children:"Enter"})," Select"]}),(0,R.jsxs)("span",{children:[(0,R.jsx)("strong",{children:"Esc"})," Close"]})]})})]})};var K=r(83625),G=r(24056),Y=r(71806),V=r(73460),X=r(28076),J=r(10039),Z=r(33438);const Q=function(e){let{open:t,onClose:r,shortcuts:s=[]}=e;const[o,c]=a.useState(0),[d,u]=a.useState(""),h=(0,a.useMemo)((()=>(d?s.filter((e=>{var t,r,a;return(null===(t=e.label)||void 0===t?void 0:t.toLowerCase().includes(d.toLowerCase()))||(null===(r=e.description)||void 0===r?void 0:r.toLowerCase().includes(d.toLowerCase()))||(null===(a=e.category)||void 0===a?void 0:a.toLowerCase().includes(d.toLowerCase()))})):s).reduce(((e,t)=>{const r=t.category||"General";return e[r]||(e[r]=[]),e[r].push(t),e}),{})),[s,d]),p=Object.keys(h).sort(),x=(p[o]||p[0],e=>{var t,r,a,n;const s=[],o=navigator.platform.toUpperCase().indexOf("MAC")>=0;null!==(t=e.modifiers)&&void 0!==t&&t.ctrl&&s.push(o?"\u2318":"Ctrl"),null!==(r=e.modifiers)&&void 0!==r&&r.shift&&s.push(o?"\u21e7":"Shift"),null!==(a=e.modifiers)&&void 0!==a&&a.alt&&s.push(o?"\u2325":"Alt");const i=1===(null===(n=e.key)||void 0===n?void 0:n.length)?e.key.toUpperCase():e.key;return s.push(i),s.join(" + ")});return a.useEffect((()=>{t||(u(""),c(0))}),[t]),(0,R.jsxs)(m.A,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2,maxHeight:"80vh"}},children:[(0,R.jsxs)(g.A,{sx:{display:"flex",alignItems:"center",pr:6},children:[(0,R.jsx)(H.A,{sx:{mr:1.5,color:"primary.main"}}),(0,R.jsx)(f.A,{variant:"h6",component:"span",children:"Keyboard Shortcuts"}),(0,R.jsx)(i.A,{onClick:r,sx:{position:"absolute",right:8,top:8,color:"text.secondary"},"aria-label":"close",children:(0,R.jsx)(Z.A,{})})]}),(0,R.jsx)(n.A,{sx:{px:3,pb:2},children:(0,R.jsx)(S.A,{fullWidth:!0,size:"small",placeholder:"Search shortcuts...",value:d,onChange:e=>u(e.target.value),InputProps:{startAdornment:(0,R.jsx)(F.A,{position:"start",children:(0,R.jsx)(_.A,{fontSize:"small"})})},sx:{maxWidth:400}})}),0===p.length?(0,R.jsx)(y.A,{children:(0,R.jsxs)(n.A,{sx:{py:4,textAlign:"center"},children:[(0,R.jsx)(H.A,{sx:{fontSize:64,color:"text.disabled",mb:2}}),(0,R.jsx)(f.A,{variant:"body1",color:"text.secondary",children:"No shortcuts found"}),d&&(0,R.jsx)(f.A,{variant:"caption",color:"text.disabled",children:"Try a different search term"})]})}):(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(K.A,{value:o,onChange:(e,t)=>c(t),variant:"scrollable",scrollButtons:"auto",sx:{borderBottom:1,borderColor:"divider",px:2},children:p.map(((e,t)=>(0,R.jsx)(G.A,{label:`${e} (${h[e].length})`,sx:{textTransform:"none",fontWeight:500}},e)))}),(0,R.jsxs)(y.A,{sx:{px:3,py:2},children:[p.map(((e,t)=>{var r;return(0,R.jsx)(n.A,{role:"tabpanel",hidden:o!==t,sx:{display:o===t?"block":"none"},children:(null===(r=h[e])||void 0===r?void 0:r.length)>0?(0,R.jsx)(l.A,{variant:"outlined",sx:{overflow:"hidden"},children:(0,R.jsx)(Y.A,{size:"small",children:(0,R.jsx)(V.A,{children:h[e].map(((e,t)=>(0,R.jsxs)(X.A,{sx:{"&:last-child td":{border:0},"&:hover":{bgcolor:"action.hover"}},children:[(0,R.jsxs)(J.A,{sx:{py:1.5,width:"60%"},children:[(0,R.jsx)(f.A,{variant:"body2",fontWeight:500,children:e.label||e.description}),e.description&&e.label&&(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",display:"block",children:e.description})]}),(0,R.jsx)(J.A,{align:"right",sx:{py:1.5},children:(0,R.jsx)(L.A,{label:x(e),size:"small",variant:"outlined",sx:{fontFamily:"monospace",fontSize:"0.75rem",fontWeight:500,borderColor:"primary.main",color:"primary.main",bgcolor:"primary.light",opacity:.8}})})]},`${e.shortcutKey||t}`)))})})}):(0,R.jsx)(n.A,{sx:{py:4,textAlign:"center"},children:(0,R.jsx)(f.A,{variant:"body2",color:"text.secondary",children:"No shortcuts in this category"})})},e)})),(0,R.jsxs)(n.A,{sx:{mt:3,p:2,bgcolor:"background.default",borderRadius:1},children:[(0,R.jsx)(f.A,{variant:"subtitle2",gutterBottom:!0,fontWeight:600,children:"\ud83d\udca1 Quick Tips"}),(0,R.jsxs)(f.A,{variant:"caption",component:"div",color:"text.secondary",sx:{mb:.5},children:["\u2022 Press ",(0,R.jsx)("strong",{children:"Ctrl/Cmd + K"})," to open the command palette for quick access"]}),(0,R.jsxs)(f.A,{variant:"caption",component:"div",color:"text.secondary",sx:{mb:.5},children:["\u2022 Use ",(0,R.jsx)("strong",{children:"Escape"})," to cancel any ongoing action or close dialogs"]}),(0,R.jsx)(f.A,{variant:"caption",component:"div",color:"text.secondary",sx:{mb:.5},children:"\u2022 Shortcuts work globally except when typing in text fields"}),(0,R.jsx)(f.A,{variant:"caption",component:"div",color:"text.secondary",children:"\u2022 Tool shortcuts (P, E, T, etc.) are single keys without modifiers"})]}),(0,R.jsx)(n.A,{sx:{mt:2,textAlign:"center"},children:(0,R.jsx)(f.A,{variant:"caption",color:"text.disabled",children:navigator.platform.toUpperCase().indexOf("MAC")>=0?(0,R.jsx)(R.Fragment,{children:"Displaying Mac keyboard shortcuts (\u2318 = Command, \u2325 = Option, \u21e7 = Shift)"}):(0,R.jsx)(R.Fragment,{children:"Displaying Windows/Linux keyboard shortcuts"})})})]})]})]})};class ee{constructor(){this.shortcuts=new Map,this.enabled=!0,this.activeModifiers={ctrl:!1,shift:!1,alt:!1},this.conflictWarnings=[]}register(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"General",s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];const o=this.getShortcutKey(e,t);if(this.shortcuts.has(o)){const e=this.shortcuts.get(o);console.warn(`Shortcut conflict detected: ${o} already bound to "${e.description}". Overwriting with "${a}".`),this.conflictWarnings.push({key:o,existing:e.description,new:a})}return this.shortcuts.set(o,{key:e,modifiers:t,action:r,description:a,category:n,allowInInput:s,enabled:!0,registeredAt:Date.now()}),o}unregister(e){return this.shortcuts.delete(e)}handleKeyDown(e){if(!this.enabled)return;const t={ctrl:e.ctrlKey||e.metaKey,shift:e.shiftKey,alt:e.altKey},r=this.getShortcutKey(e.key,t),a=this.shortcuts.get(r);if(a&&a.enabled){if(!a.allowInInput&&this.isInputElement(e.target))return;e.preventDefault(),e.stopPropagation();try{a.action(e)}catch(n){console.error(`[KeyboardShortcuts] Error executing shortcut "${r}":`,n)}}}getShortcutKey(e,t){const r=[];t.ctrl&&r.push("Ctrl"),t.shift&&r.push("Shift"),t.alt&&r.push("Alt");const a=this.normalizeKey(e);return r.push(a),r.join("+")}normalizeKey(e){return{" ":"Space","+":"Plus","=":"Equal","-":"Minus",_:"Underscore","[":"BracketLeft","]":"BracketRight","{":"BraceLeft","}":"BraceRight","/":"Slash","\\":"Backslash",",":"Comma",".":"Period","<":"Less",">":"Greater","?":"Question"}[e]||e.toLowerCase()}isInputElement(e){var t,r,a,n,s,o;if(!e)return!1;const i=null===(t=e.tagName)||void 0===t?void 0:t.toLowerCase();if(!i)return!1;if("textarea"===i)return!0;if("input"===i&&["text","password","email","search","tel","url","number"].includes(null===(r=e.type)||void 0===r?void 0:r.toLowerCase()))return!0;const l=null===(a=e.getAttribute)||void 0===a?void 0:a.call(e,"contenteditable");return"true"===l||""===l||("true"===e.contentEditable||(!0===e.isContentEditable||!!(null!==(n=e.closest)&&void 0!==n&&n.call(e,".MuiInputBase-root")||null!==(s=e.closest)&&void 0!==s&&s.call(e,'[contenteditable="true"]')||null!==(o=e.closest)&&void 0!==o&&o.call(e,'[contenteditable=""]'))))}disable(){this.enabled=!1}enable(){this.enabled=!0}toggle(){return this.enabled=!this.enabled,this.enabled}getAllShortcuts(){return Array.from(this.shortcuts.entries()).map((e=>{let[t,r]=e;return{shortcutKey:t,...r}}))}getShortcutsByCategory(e){const t=this.getAllShortcuts();if(e)return t.filter((t=>t.category===e));const r={};return t.forEach((e=>{r[e.category]||(r[e.category]=[]),r[e.category].push(e)})),r}getConflicts(){return this.conflictWarnings}clear(){this.shortcuts.clear(),this.conflictWarnings=[]}formatShortcut(e){const{key:t,modifiers:r={}}=e,a=[],n=navigator.platform.toUpperCase().indexOf("MAC")>=0;r.ctrl&&a.push(n?"\u2318":"Ctrl"),r.shift&&a.push(n?"\u21e7":"Shift"),r.alt&&a.push(n?"\u2325":"Alt");const s=1===t.length?t.toUpperCase():t;return a.push(s),a.join(n?"":"+")}has(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=this.getShortcutKey(e,t);return this.shortcuts.has(r)}setShortcutEnabled(e,t,r){const a=this.getShortcutKey(e,t),n=this.shortcuts.get(a);return!!n&&(n.enabled=r,!0)}}new ee;class te{constructor(){this.commands=new Map,this.listeners=[],this._listeners={beforeExecute:[],afterExecute:[],register:[],unregister:[],error:[],clear:[]}}register(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e.id)throw new Error("[CommandRegistry] Command must have an id");if(this.commands.has(e.id)&&!t.allowOverwrite)throw new Error(`Command with id ${e.id} already registered`);e.action&&"function"===typeof e.action||console.error("[CommandRegistry] Command must have an action function:",e);const r={id:e.id,label:e.label||e.id,description:e.description||"",keywords:e.keywords||[],tags:e.tags||[],action:e.action||(()=>{}),category:e.category,shortcut:e.shortcut||null,icon:e.icon||null,enabled:e.enabled||(()=>!0),visible:e.visible||(()=>!0),_hasExplicitEnabled:e.hasOwnProperty("enabled"),registeredAt:Date.now()};return this.commands.set(e.id,r),this.notifyListeners("register",r),!0}unregister(e){const t=this.commands.get(e),r=this.commands.delete(e);return r&&this.notifyListeners("unregister",t),r}async execute(e){const t=this.commands.get(e);if(!t)throw new Error(`Command ${e} not found`);if("function"===typeof t.enabled&&!t.enabled())throw new Error(`Command ${e} is disabled`);try{this.notifyListeners("before-execute",t);for(var r=arguments.length,a=new Array(r>1?r-1:0),n=1;n<r;n++)a[n-1]=arguments[n];const e=await t.action(...a);return this.notifyListeners("after-execute",t,e),e}catch(s){throw console.error(`[CommandRegistry] Error executing command "${e}":`,s),this.notifyListeners("error",t,s),s}}get(e){return this.commands.get(e)}has(e){return this.commands.has(e)}getAll(){return Array.from(this.commands.values()).filter((e=>{try{return"function"!==typeof e.visible||e.visible()}catch(t){return console.error(`[CommandRegistry] Error checking visibility for "${e.id}":`,t),!0}})).map((e=>({...e})))}getByCategory(e){return this.getAll().filter((t=>t.category===e))}getCategories(){const e=new Set;return this.commands.forEach((t=>e.add(t.category))),Array.from(e).sort()}search(e){if(!e||""===e.trim())return this.getAll();const t=e.toLowerCase().trim(),r=t.split(/\s+/);return this.getAll().filter((e=>{const t=[e.label,e.description,e.category,...e.keywords];return r.every((e=>t.some((t=>{if(!t)return!1;const r=t.toLowerCase();return r===e||r.startsWith(e+" ")||r.endsWith(" "+e)||r.includes(" "+e+" ")||r.startsWith(e)}))))})).sort(((e,r)=>{const a=e.label.toLowerCase()===t,n=r.label.toLowerCase()===t;if(a&&!n)return-1;if(!a&&n)return 1;const s=e.label.toLowerCase().startsWith(t),o=r.label.toLowerCase().startsWith(t);if(s&&!o)return-1;if(!s&&o)return 1;const i=e.category.toLowerCase().includes(t),l=r.category.toLowerCase().includes(t);return i&&!l?-1:!i&&l?1:e.label.localeCompare(r.label)}))}getCommandsWithShortcuts(){return this.getAll().filter((e=>null!==e.shortcut))}clear(){const e=Array.from(this.commands.keys());this.commands.clear(),this.notifyListeners("clear",e)}on(e,t){return this._listeners[e]&&this._listeners[e].push(t),()=>{this._listeners[e]&&(this._listeners[e]=this._listeners[e].filter((e=>e!==t)))}}addListener(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter((t=>t!==e))}}notifyListeners(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),a=1;a<t;a++)r[a-1]=arguments[a];this.listeners.forEach((t=>{try{t(e,...r)}catch(a){console.error("[CommandRegistry] Error in listener:",a)}}));const n={register:"register",unregister:"unregister","before-execute":"beforeExecute","after-execute":"afterExecute",error:"error",clear:"clear"}[e]||e;this._listeners[n]&&this._listeners[n].forEach((e=>{try{e(...r)}catch(t){console.error("[CommandRegistry] Error in listener:",t)}}))}getStats(){const e=Array.from(this.commands.values()),t=this.getAll(),r=t.filter((e=>{try{return e._hasExplicitEnabled&&e.enabled()}catch(t){return!1}})),a=t.filter((e=>{try{return e._hasExplicitEnabled&&!e.enabled()}catch(t){return!1}}));return{total:e.length,byCategory:this.getCategories().reduce(((e,t)=>(e[t]=this.getByCategory(t).length,e)),{}),categories:this.getCategories().length,withShortcuts:this.getCommandsWithShortcuts().length,enabled:r.length,disabled:a.length,visible:t.length}}registerBatch(e){return e.map((e=>({id:e.id,success:this.register(e)})))}export(){return Array.from(this.commands.entries()).map((e=>{let[t,r]=e;return{id:t,label:r.label,description:r.description,keywords:r.keywords,category:r.category,shortcut:r.shortcut,icon:r.icon,registeredAt:r.registeredAt}}))}}const re=new te;var ae=r(62252),ne=r(64391),se=r(59478),oe=r(77739),ie=r(48241),le=r(99070),ce=r(47805),de=r(68746),ue=r(34496),he=r(74730),pe=r(89984),me=r(21599),ge=r(14256),ye=r(32069),fe=r(47968),xe=r(44973),we=r(20006),be=r(79417),ve=r(69320),je=r(688),Ae=r(32143),Se=r(2050),ke=r(50388),Ce=r(51387),De=r(50661),Te=r(40191),Ie=r(48567);function Pe(e){let{drawMode:t="freehand",setDrawMode:r,color:n,previousColor:s,setColor:o,setPreviousColor:l,controlsDisabled:c=!1}=e;const[d,u]=(0,a.useState)(null),p=Boolean(d),m={freehand:{icon:(0,R.jsx)(ke.A,{}),label:"Freehand"},eraser:{icon:(0,R.jsx)(Ce.A,{}),label:"Eraser"},shape:{icon:(0,R.jsx)(De.A,{}),label:"Shape"},select:{icon:(0,R.jsx)(Te.A,{}),label:"Select"},paste:{icon:(0,R.jsx)(ge.A,{}),label:"Paste"},stamp:{icon:(0,R.jsx)(Ie.A,{}),label:"Stamp"}},g=m[t]?t:"freehand",y=e=>{u(null),c||e&&e!==g&&("eraser"!==g&&"eraser"===e&&(l(n),o("#FFFFFF")),"eraser"===g&&"eraser"!==e&&s&&(o(s),l(null)),r(e))};return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(oe.A,{title:m[g].label,children:(0,R.jsx)(i.A,{onClick:e=>{c||u(e.currentTarget)},sx:{borderRadius:1,width:40,height:32,padding:0,minWidth:40,"& .MuiTouchRipple-root":{borderRadius:1}},disabled:c,children:m[g].icon})}),(0,R.jsx)(je.A,{anchorEl:d,open:p,onClose:()=>y(),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:Object.entries(m).map((e=>{let[t,{icon:r,label:a}]=e;return(0,R.jsxs)(Ae.A,{selected:t===g,onClick:()=>y(t),disabled:c,children:[(0,R.jsx)(Se.A,{children:r}),(0,R.jsx)(h.A,{primary:a})]},t)}))})]})}var Re=r(56620),Ee=r(25183),Me=r(96542),Ue=r(16851);function Be(e){let{shapeType:t,setShapeType:r,controlsDisabled:n=!1}=e;const[s,o]=(0,a.useState)(null),l=Boolean(s),c={circle:{icon:(0,R.jsx)(Re.A,{}),label:"Circle"},rectangle:{icon:(0,R.jsx)(Ee.A,{}),label:"Rectangle"},hexagon:{icon:(0,R.jsx)(Me.A,{}),label:"Hexagon"},line:{icon:(0,R.jsx)(Ue.A,{}),label:"Line"}},d=e=>{o(null),n||e&&e!==t&&r(e)};return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(oe.A,{title:c[t].label,children:(0,R.jsx)(i.A,{onClick:e=>{n||o(e.currentTarget)},sx:{borderRadius:1,width:50,height:32,padding:0,"& .MuiTouchRipple-root":{borderRadius:1}},disabled:n,children:c[t].icon})}),(0,R.jsx)(je.A,{anchorEl:s,open:l,onClose:()=>d(),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},children:Object.entries(c).map((e=>{let[r,{icon:a,label:s}]=e;return(0,R.jsxs)(Ae.A,{selected:r===t,onClick:()=>d(r),disabled:n,children:[(0,R.jsx)(Se.A,{children:a}),(0,R.jsx)(h.A,{primary:s})]},r)}))})]})}function We(e){let{brushId:t,params:r={}}=e;const n=(0,a.useRef)();(0,a.useEffect)((()=>{const e=n.current;if(!e)return;const a=e.getContext("2d");a.clearRect(0,0,e.width,e.height),a.fillStyle="#f8f9fa",a.fillRect(0,0,e.width,e.height);const h=(r.intensity||50)/50,p=(r.variation||50)/100,m=(r.flow||50)/100;switch(t){case"normal":default:s(a,h,p,m);break;case"wacky":o(a,h,p,m);break;case"drip":i(a,h,p,m);break;case"scatter":l(a,h,p,m);break;case"neon":c(a,h,p,m);break;case"chalk":d(a,h,p,m);break;case"spray":u(a,h,p,m)}}),[t,r]);const s=(e,t,r,a)=>{e.strokeStyle="#333",e.lineWidth=3*t,e.lineCap="round",e.beginPath(),e.moveTo(20,50),e.quadraticCurveTo(75,20,130,50),e.stroke()},o=(e,t,r,a)=>{const n=Math.floor(25*t);for(let s=0;s<n;s++){const o=20+s/n*110,i=50+15*Math.sin(.3*s)*r,l=(2+6*Math.random())*t;e.beginPath(),e.arc(o,i,l,0,2*Math.PI),e.fillStyle=`hsl(${20*s%360}, 80%, 60%)`,e.globalAlpha=a,e.fill()}e.globalAlpha=1},i=(e,t,r,a)=>{e.strokeStyle="#4a90e2",e.lineWidth=4*t,e.lineCap="round",e.beginPath(),e.moveTo(20,40),e.quadraticCurveTo(75,20,130,40),e.stroke();for(let n=0;n<5;n++){const s=30+25*n,o=(10+20*Math.random())*r;e.beginPath(),e.arc(s,40+o,2*t,0,2*Math.PI),e.fillStyle="#4a90e2",e.globalAlpha=a,e.fill()}e.globalAlpha=1},l=(e,t,r,a)=>{const n=Math.floor(40*t);for(let s=0;s<n;s++){const n=20+110*Math.random(),s=50+30*(Math.random()-.5)*r,o=(1+4*Math.random())*t;e.beginPath(),e.arc(n,s,o,0,2*Math.PI),e.fillStyle="#e74c3c",e.globalAlpha=.8*a,e.fill()}e.globalAlpha=1},c=(e,t,r,a)=>{e.save(),e.shadowColor="#00ff88",e.shadowBlur=10*t,e.strokeStyle="#00ff88",e.lineWidth=3*t,e.lineCap="round",e.globalAlpha=a,e.beginPath(),e.moveTo(20,50),e.quadraticCurveTo(75,30+10*r,130,50),e.stroke(),e.restore()},d=(e,t,r,a)=>{const n=[];for(let s=20;s<=130;s+=2){const e=50+10*Math.sin(.05*s);n.push({x:s,y:e})}n.forEach((n=>{for(let s=0;s<3;s++){const s=4*(Math.random()-.5)*r,o=4*(Math.random()-.5)*r;e.beginPath(),e.arc(n.x+s,n.y+o,1.5*t,0,2*Math.PI),e.fillStyle="#f39c12",e.globalAlpha=a*(.3+.4*Math.random()),e.fill()}})),e.globalAlpha=1},u=(e,t,r,a)=>{const n=Math.floor(60*t);for(let s=0;s<n;s++){const t=20+110*(s/n),o=Math.random()*Math.PI*2,i=15*Math.random()*r,l=t+Math.cos(o)*i,c=50+Math.sin(o)*i;e.beginPath(),e.arc(l,c,1,0,2*Math.PI),e.fillStyle="#9b59b6",e.globalAlpha=.6*a,e.fill()}e.globalAlpha=1};return(0,R.jsx)("canvas",{ref:n,width:150,height:100,style:{border:"1px solid #e0e0e0",borderRadius:"4px",background:"#fff"}})}const $e=[{id:"normal",name:"Normal",icon:"\ud83d\udd8c\ufe0f",description:"Classic smooth brush"},{id:"wacky",name:"Wacky",icon:"\ud83c\udfa8",description:"Colorful scattered particles"},{id:"drip",name:"Drip",icon:"\ud83d\udca7",description:"Paint that drips and flows"},{id:"scatter",name:"Scatter",icon:"\u2728",description:"Random scattered dots"},{id:"neon",name:"Neon",icon:"\ud83d\udcab",description:"Glowing neon effect"},{id:"chalk",name:"Chalk",icon:"\ud83d\udccf",description:"Textured chalk strokes"},{id:"spray",name:"Spray",icon:"\ud83d\udda8\ufe0f",description:"Spray paint effect"}];function ze(e){let{onSelect:t,onParamsChange:r,selectedBrush:s="normal",onClose:o}=e;const[l,c]=(0,a.useState)(s),[d,u]=(0,a.useState)({intensity:50,variation:50,flow:50}),h=(e,t)=>{const a={...d,[e]:t};u(a),r&&r(a)},p=$e.find((e=>e.id===l));return(0,R.jsxs)("div",{className:"brush-panel",children:[(0,R.jsxs)(n.A,{sx:{mb:2,display:"flex",alignItems:"flex-start",justifyContent:"space-between"},children:[(0,R.jsxs)(n.A,{children:[(0,R.jsx)(f.A,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:"\ud83c\udfa8 Brush Panel"}),(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",children:"Choose your creative brush"})]}),o&&(0,R.jsx)(i.A,{onClick:o,size:"small",sx:{mt:-.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:(0,R.jsx)(Z.A,{fontSize:"small"})})]}),(0,R.jsx)("div",{className:"brush-grid",children:$e.map((e=>(0,R.jsxs)("button",{className:"brush-card "+(l===e.id?"active":""),onClick:()=>{return r=e.id,c(r),void(t&&t(r));var r},title:e.description,children:[(0,R.jsx)("div",{className:"brush-icon",children:e.icon}),(0,R.jsx)("div",{className:"brush-name",children:e.name})]},e.id)))}),p&&(0,R.jsx)(n.A,{sx:{mt:2},children:(0,R.jsx)(L.A,{label:p.description,size:"small",color:"primary",variant:"outlined",sx:{mb:2}})}),(0,R.jsxs)("div",{className:"brush-preview",children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{mb:1},children:"Preview:"}),(0,R.jsx)(We,{brushId:l,params:d})]}),(0,R.jsx)(O.A,{sx:{my:2}}),(0,R.jsxs)(n.A,{sx:{mt:2},children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{mb:2},children:"Brush Settings:"}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsx)(f.A,{variant:"caption",children:"Intensity"}),(0,R.jsx)(le.Ay,{size:"small",value:d.intensity,onChange:(e,t)=>h("intensity",t),min:10,max:100,valueLabelDisplay:"auto"})]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsx)(f.A,{variant:"caption",children:"Variation"}),(0,R.jsx)(le.Ay,{size:"small",value:d.variation,onChange:(e,t)=>h("variation",t),min:0,max:100,valueLabelDisplay:"auto"})]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsx)(f.A,{variant:"caption",children:"Flow"}),(0,R.jsx)(le.Ay,{size:"small",value:d.flow,onChange:(e,t)=>h("flow",t),min:10,max:100,valueLabelDisplay:"auto"})]})]})]})}var Ne=r(80683),Fe=r(75682),Oe=r(59506);const Le=[{id:"blur",name:"Blur",icon:"\ud83d\udca8",description:"Soften sharp edges",params:{intensity:{min:1,max:5,default:2}}},{id:"hueShift",name:"Hue Shift",icon:"\ud83c\udf08",description:"Change color tones",params:{hue:{min:-180,max:180,default:30},saturation:{min:-100,max:100,default:0}}},{id:"chalk",name:"Chalk",icon:"\ud83d\udccf",description:"Chalky texture effect",params:{roughness:{min:0,max:100,default:50},opacity:{min:10,max:100,default:80}}},{id:"fade",name:"Fade",icon:"\ud83c\udf2b\ufe0f",description:"Reduce opacity gradually",params:{amount:{min:10,max:90,default:30},gradient:{min:0,max:100,default:50}}},{id:"vintage",name:"Vintage",icon:"\ud83d\udcf7",description:"Old photo effect",params:{sepia:{min:0,max:100,default:60},vignette:{min:0,max:100,default:40}}},{id:"neon",name:"Neon Glow",icon:"\ud83d\udcab",description:"Electric glow effect",params:{intensity:{min:0,max:50,default:15},color:{min:0,max:360,default:180}}}];function _e(e){let{onApply:t,onPreview:r,onUndo:s,onClearAll:o,canUndo:c=!1,canClearAll:d=!1,appliedFilters:u=[],onClose:h}=e;const[p,m]=(0,a.useState)(null),[g,y]=(0,a.useState)({}),[x,b]=(0,a.useState)(!1),v=((0,a.useRef)(null),u.reduce(((e,t)=>(t.filterType&&(e[t.filterType]=t),e)),{})),j=p&&v[p];(0,a.useEffect)((()=>{if(p){const e=Le.find((e=>e.id===p));if(e){const t=v[p];if(t&&t.filterParams)y({...t.filterParams});else{const t={};Object.entries(e.params).forEach((e=>{let[r,a]=e;t[r]=a.default})),y(t)}}}}),[p,u]);const A=Le.find((e=>e.id===p));return(0,R.jsxs)("div",{className:"mixer-panel",children:[(0,R.jsxs)(n.A,{sx:{mb:2,display:"flex",alignItems:"flex-start",justifyContent:"space-between"},children:[(0,R.jsxs)(n.A,{children:[(0,R.jsx)(f.A,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:"\ud83e\uddea Mixer Tool"}),(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",children:"Apply non-destructive filters"})]}),h&&(0,R.jsx)(i.A,{onClick:()=>{x&&s&&s(),b(!1),h&&h()},size:"small",sx:{mt:-.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:(0,R.jsx)(Z.A,{fontSize:"small"})})]}),d&&(0,R.jsx)(n.A,{sx:{mb:2},children:(0,R.jsx)(w.A,{variant:"outlined",color:"error",size:"small",fullWidth:!0,onClick:()=>{o&&(o(),b(!1),m(null))},sx:{textTransform:"none"},children:"\ud83d\uddd1\ufe0f Clear All Filters"})}),(0,R.jsx)("div",{className:"filter-grid",children:Le.map((e=>(0,R.jsxs)("button",{className:"filter-card "+(p===e.id?"active":""),onClick:()=>{return t=e.id,m(t),void b(!1);var t},title:e.description,children:[(0,R.jsx)("div",{className:"filter-icon",children:e.icon}),(0,R.jsx)("div",{className:"filter-name",children:e.name})]},e.id)))}),A&&(0,R.jsx)(n.A,{sx:{mt:2},children:(0,R.jsxs)(l.A,{sx:{p:2,bgcolor:"grey.50"},children:[(0,R.jsxs)(f.A,{variant:"subtitle2",sx:{mb:1,display:"flex",alignItems:"center",gap:1},children:[A.icon," ",A.name]}),(0,R.jsx)(L.A,{label:A.description,size:"small",color:"primary",variant:"outlined",sx:{mb:2}}),j&&(0,R.jsxs)(n.A,{sx:{mb:2,p:1.5,bgcolor:"info.light",borderRadius:1},children:[(0,R.jsxs)(f.A,{variant:"caption",sx:{display:"block",fontWeight:"bold",color:"info.dark"},children:["\u2139\ufe0f ",A.name," filter is active"]}),(0,R.jsxs)(f.A,{variant:"caption",sx:{display:"block",color:"info.dark",mt:.5},children:["Adjust parameters below and click Update to tune the filter. Only one ",A.name.toLowerCase()," filter can be applied at a time."]})]}),(0,R.jsx)(n.A,{sx:{mt:2},children:Object.entries(A.params).map((e=>{let[t,a]=e;return(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsxs)(f.A,{variant:"caption",sx:{textTransform:"capitalize"},children:[t.replace(/([A-Z])/g," $1"),": ",g[t]||a.default]}),(0,R.jsx)(le.Ay,{size:"small",value:g[t]||a.default,onChange:(e,a)=>((e,t)=>{const a={...g,[e]:t};y(a),x&&r&&r(p,a)})(t,a),min:a.min,max:a.max,step:"hue"===t?5:1,valueLabelDisplay:"auto"})]},t)}))}),(0,R.jsx)(O.A,{sx:{my:2}}),(0,R.jsxs)(Ne.A,{direction:"row",spacing:1,sx:{mt:2},children:[(0,R.jsx)(w.A,{variant:"outlined",size:"small",startIcon:(0,R.jsx)(Fe.A,{}),onClick:()=>{p&&r&&(b(!0),r(p,g))},disabled:!p,children:"Preview"}),(0,R.jsx)(w.A,{variant:"contained",size:"small",startIcon:(0,R.jsx)(Oe.A,{}),onClick:()=>{p&&t&&(t(p,g),b(!1))},disabled:!p,color:"primary",children:j?"Update":"Apply"}),c&&(0,R.jsx)(i.A,{size:"small",onClick:()=>{s&&(s(),b(!1))},title:"Undo filter",children:(0,R.jsx)(he.A,{})})]}),x&&(0,R.jsx)(f.A,{variant:"caption",color:"info.main",sx:{mt:1,display:"block"},children:"Preview mode active - Click Apply to commit changes"})]})})]})}var He=r(53193),qe=r(79190),Ke=r(72221),Ge=r(68903),Ye=r(43374),Ve=r(88466),Xe=r(75475);const Je=["\ud83c\udfa8","\u2728","\ud83c\udf1f","\ud83d\udcab","\ud83d\udd25","\ud83d\udca7","\ud83c\udf08","\u2600\ufe0f","\ud83c\udf19","\u2b50","\ud83c\udf38","\ud83c\udf3a","\ud83c\udf3b","\ud83c\udf37","\ud83c\udf39","\ud83c\udf40","\ud83c\udf3f","\ud83c\udf31","\ud83c\udf33","\ud83c\udf32","\ud83e\udd8b","\ud83d\udc1d","\ud83d\udc20","\ud83d\udc21","\ud83d\udc19","\ud83e\udd84","\ud83d\udc31","\ud83d\udc36","\ud83d\udc30","\ud83d\udc38","\u2764\ufe0f","\ud83d\udc99","\ud83d\udc9a","\ud83d\udc9b","\ud83d\udc9c","\ud83e\udde1","\ud83d\udda4","\ud83e\udd0d","\ud83d\udc97","\ud83d\udc96","\ud83d\ude80","\u26a1","\ud83d\udc8e","\ud83c\udfb5","\ud83c\udfb6","\ud83c\udfad","\ud83c\udfaa","\ud83c\udfa8","\ud83c\udfaf","\ud83c\udfb2"],Ze=[{value:"nature",label:"Nature"},{value:"shapes",label:"Shapes"},{value:"animals",label:"Animals"},{value:"objects",label:"Objects"},{value:"symbols",label:"Symbols"}];function Qe(e){let{onSave:t,onClose:r}=e;const[s,o]=(0,a.useState)({name:"",emoji:"\ud83c\udfa8",category:"objects",image:null}),[c,d]=(0,a.useState)("emoji"),u=(0,a.useRef)(null),[h,p]=(0,a.useState)(null),[m,b]=(0,a.useState)("");return(0,R.jsxs)(R.Fragment,{children:[(0,R.jsxs)(g.A,{sx:{display:"flex",alignItems:"center",gap:1},children:[(0,R.jsx)(Ve.A,{}),"Create Custom Stamp"]}),(0,R.jsxs)(y.A,{sx:{minWidth:500},children:[m&&(0,R.jsx)(T.A,{severity:"error",sx:{mb:2},children:m}),(0,R.jsxs)(n.A,{sx:{mb:3},children:[(0,R.jsx)(S.A,{fullWidth:!0,label:"Stamp Name",value:s.name,onChange:e=>o({...s,name:e.target.value}),placeholder:"Enter a name for your stamp",sx:{mb:2}}),(0,R.jsxs)(He.A,{fullWidth:!0,sx:{mb:2},children:[(0,R.jsx)(qe.A,{children:"Category"}),(0,R.jsx)(Ke.A,{value:s.category,onChange:e=>o({...s,category:e.target.value}),label:"Category",children:Ze.map((e=>(0,R.jsx)(Ae.A,{value:e.value,children:e.label},e.value)))})]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsx)(w.A,{variant:"emoji"===c?"contained":"outlined",onClick:()=>d("emoji"),startIcon:(0,R.jsx)(Ve.A,{}),sx:{mr:1},children:"Emoji"}),(0,R.jsx)(w.A,{variant:"image"===c?"contained":"outlined",onClick:()=>d("image"),startIcon:(0,R.jsx)(Xe.A,{}),children:"Image"})]})]}),"emoji"===c&&(0,R.jsxs)(n.A,{children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{mb:1},children:"Choose an Emoji:"}),(0,R.jsx)(l.A,{sx:{p:2,maxHeight:200,overflowY:"auto",mb:2},children:(0,R.jsx)(Ge.Ay,{container:!0,spacing:1,children:Je.map(((e,t)=>(0,R.jsx)(Ge.Ay,{item:!0,children:(0,R.jsx)(i.A,{onClick:()=>(e=>{o({...s,emoji:e})})(e),sx:{fontSize:"1.5rem",border:s.emoji===e?2:1,borderColor:s.emoji===e?"primary.main":"grey.300",borderStyle:"solid"},children:e})},t)))})}),(0,R.jsx)(S.A,{fullWidth:!0,label:"Or enter custom emoji/symbol",value:s.emoji,onChange:e=>o({...s,emoji:e.target.value}),placeholder:"\ud83c\udfa8",sx:{mb:2}})]}),"image"===c&&(0,R.jsxs)(n.A,{children:[(0,R.jsx)("input",{type:"file",ref:u,onChange:e=>{const t=e.target.files[0];if(t){if(t.size>1048576)return void b("Image must be less than 1MB");const e=new FileReader;e.onload=e=>{p(e.target.result),o({...s,image:e.target.result}),b("")},e.readAsDataURL(t)}},accept:"image/*",style:{display:"none"}}),(0,R.jsx)(w.A,{variant:"outlined",onClick:()=>{var e;return null===(e=u.current)||void 0===e?void 0:e.click()},startIcon:(0,R.jsx)(Ye.A,{}),fullWidth:!0,sx:{mb:2},children:"Upload Image"}),h&&(0,R.jsxs)(n.A,{sx:{textAlign:"center",mb:2},children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{mb:1},children:"Preview:"}),(0,R.jsx)("img",{src:h,alt:"Preview",style:{maxWidth:100,maxHeight:100,border:"1px solid #ccc",borderRadius:4}})]})]}),(0,R.jsx)(O.A,{sx:{my:2}}),(0,R.jsxs)(n.A,{sx:{textAlign:"center",p:2,bgcolor:"grey.50",borderRadius:1},children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{mb:1},children:"Preview:"}),(0,R.jsx)("div",{style:{fontSize:"3rem"},children:"emoji"===c?s.emoji:h?(0,R.jsx)("img",{src:h,alt:"Preview",style:{width:60,height:60,objectFit:"contain"}}):"\ud83d\udcf7"}),(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",children:s.name||"Untitled Stamp"})]})]}),(0,R.jsxs)(x.A,{children:[(0,R.jsx)(w.A,{onClick:r,children:"Cancel"}),(0,R.jsx)(w.A,{onClick:()=>{if(!s.name.trim())return void b("Please enter a stamp name");if("emoji"===c&&!s.emoji)return void b("Please select an emoji");if("image"===c&&!s.image)return void b("Please upload an image");const e={name:s.name.trim(),category:s.category,[c]:"emoji"===c?s.emoji:s.image};t(e),r()},variant:"contained",children:"Save Stamp"})]})]})}var et=r(12110),tt=r(26494),rt=r(70141),at=r(83560),nt=r(63713),st=r(67652);const ot=[{id:"flower",emoji:"\ud83c\udf38",name:"Flower",category:"nature"},{id:"star",emoji:"\u2b50",name:"Star",category:"shapes"},{id:"clover",emoji:"\ud83c\udf40",name:"Clover",category:"nature"},{id:"fish",emoji:"\ud83d\udc20",name:"Fish",category:"animals"},{id:"heart",emoji:"\u2764\ufe0f",name:"Heart",category:"shapes"},{id:"sun",emoji:"\u2600\ufe0f",name:"Sun",category:"nature"},{id:"moon",emoji:"\ud83c\udf19",name:"Moon",category:"nature"},{id:"tree",emoji:"\ud83c\udf33",name:"Tree",category:"nature"},{id:"butterfly",emoji:"\ud83e\udd8b",name:"Butterfly",category:"animals"},{id:"rainbow",emoji:"\ud83c\udf08",name:"Rainbow",category:"nature"},{id:"cat",emoji:"\ud83d\udc31",name:"Cat",category:"animals"},{id:"rocket",emoji:"\ud83d\ude80",name:"Rocket",category:"objects"}];function it(e){let{onSelect:t,onStampChange:r,backendStamps:s=[],onClose:o,selectedStamp:l}=e;const[c,d]=(0,a.useState)(!1),[u,h]=(0,a.useState)(ot),[p,g]=(0,a.useState)(null),[y,x]=(0,a.useState)({size:50,rotation:0,opacity:100}),[b,v]=(0,a.useState)("all");(0,a.useEffect)((()=>{const e=localStorage.getItem("rescanvas-stamps");let t=[];if(e)try{t=JSON.parse(e)}catch(n){console.warn("Failed to load saved stamps:",n)}const r=new Map;ot.forEach((e=>{const t=e.id;r.set(t,e)})),t.forEach((e=>{var t;const a=e.id||(e.emoji?`emoji-${e.emoji}`:`image-${null===(t=e.image)||void 0===t?void 0:t.substring(0,50)}`);r.has(a)||r.set(a,{...e,id:e.id||a})})),s.forEach((e=>{var t;const a=e.emoji?`emoji-${e.emoji}`:`image-${null===(t=e.image)||void 0===t?void 0:t.substring(0,50)}`;r.has(a)||r.set(a,{id:e.id||a,name:e.name||"Custom Stamp",category:e.category||"custom",emoji:e.emoji,image:e.image})}));const a=Array.from(r.values());h(a),console.log("StampPanel: Merged stamps",{defaultCount:ot.length,localCount:t.length,backendCount:s.length,totalUnique:a.length})}),[s]),(0,a.useEffect)((()=>{l&&g(l)}),[l]);const j=e=>{const t=e.filter((e=>!ot.find((t=>t.id===e.id))));localStorage.setItem("rescanvas-stamps",JSON.stringify(t))},A=(e,t)=>{const a={...y,[e]:t};x(a),p&&r&&r(p,a)},S="all"===b?u:u.filter((e=>e.category===b));return(0,R.jsxs)("div",{className:"stamp-panel",children:[(0,R.jsxs)(n.A,{sx:{mb:2,display:"flex",alignItems:"flex-start",justifyContent:"space-between"},children:[(0,R.jsxs)(n.A,{children:[(0,R.jsx)(f.A,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:"\ud83d\udcdc Stamp Library"}),(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",children:"Click stamps to place on canvas"})]}),o&&(0,R.jsx)(i.A,{onClick:o,size:"small",sx:{mt:-.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:(0,R.jsx)(Z.A,{fontSize:"small"})})]}),(0,R.jsx)(n.A,{sx:{mb:2},children:(0,R.jsx)(Ne.A,{direction:"row",spacing:1,sx:{flexWrap:"wrap",gap:.5},children:["all","nature","shapes","animals","objects","custom"].map((e=>(0,R.jsx)(L.A,{label:e.charAt(0).toUpperCase()+e.slice(1),size:"small",variant:b===e?"filled":"outlined",onClick:()=>v(e),color:b===e?"primary":"default"},e)))})}),(0,R.jsx)(Ge.Ay,{container:!0,spacing:1,sx:{mb:2,maxHeight:200,overflowY:"auto"},children:S.map((e=>(0,R.jsx)(Ge.Ay,{item:!0,xs:3,children:(0,R.jsx)(et.A,{sx:{cursor:"pointer",border:(null===p||void 0===p?void 0:p.id)===e.id?2:1,borderColor:(null===p||void 0===p?void 0:p.id)===e.id?"primary.main":"grey.300","&:hover":{bgcolor:"grey.50"},position:"relative"},onClick:()=>(e=>{g(e),t&&t(e,y)})(e),children:(0,R.jsxs)(tt.A,{sx:{p:1,textAlign:"center","&:last-child":{pb:1}},children:[(0,R.jsx)(n.A,{sx:{height:40,display:"flex",alignItems:"center",justifyContent:"center",mb:.5},children:e.emoji?(0,R.jsx)(f.A,{variant:"h4",children:e.emoji}):e.image?(0,R.jsx)("img",{src:e.image,alt:e.name,style:{maxWidth:"40px",maxHeight:"40px",objectFit:"contain"}}):null}),(0,R.jsx)(f.A,{variant:"caption",sx:{fontSize:"0.7rem"},children:e.name}),!ot.find((t=>t.id===e.id))&&(0,R.jsx)(i.A,{size:"small",sx:{position:"absolute",top:0,right:0,p:.5},onClick:t=>{t.stopPropagation(),(e=>{if(ot.find((t=>t.id===e)))return;const t=u.filter((t=>t.id!==e));h(t),j(t),(null===p||void 0===p?void 0:p.id)===e&&g(null)})(e.id)},children:(0,R.jsx)(Ce.A,{fontSize:"small"})})]})})},e.id)))}),(0,R.jsx)(w.A,{variant:"outlined",startIcon:(0,R.jsx)(rt.A,{}),onClick:()=>d(!0),size:"small",fullWidth:!0,sx:{mb:2},children:"Add Custom Stamp"}),p&&(0,R.jsxs)(n.A,{children:[(0,R.jsx)(O.A,{sx:{my:2}}),(0,R.jsxs)(f.A,{variant:"subtitle2",sx:{mb:2,display:"flex",alignItems:"center",gap:1},children:[(0,R.jsx)(at.A,{fontSize:"small"}),"Stamp Settings"]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsxs)(f.A,{variant:"caption",sx:{display:"flex",alignItems:"center",gap:1},children:[(0,R.jsx)(st.A,{fontSize:"small"}),"Size: ",y.size,"%"]}),(0,R.jsx)(le.Ay,{size:"small",value:y.size,onChange:(e,t)=>A("size",t),min:10,max:200,valueLabelDisplay:"auto"})]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsxs)(f.A,{variant:"caption",sx:{display:"flex",alignItems:"center",gap:1},children:[(0,R.jsx)(nt.A,{fontSize:"small"}),"Rotation: ",y.rotation,"\xb0"]}),(0,R.jsx)(le.Ay,{size:"small",value:y.rotation,onChange:(e,t)=>A("rotation",t),min:-180,max:180,step:15,valueLabelDisplay:"auto"})]}),(0,R.jsxs)(n.A,{sx:{mb:2},children:[(0,R.jsxs)(f.A,{variant:"caption",children:["Opacity: ",y.opacity,"%"]}),(0,R.jsx)(le.Ay,{size:"small",value:y.opacity,onChange:(e,t)=>A("opacity",t),min:10,max:100,valueLabelDisplay:"auto"})]}),(0,R.jsxs)(n.A,{sx:{p:1,bgcolor:"grey.50",borderRadius:1,textAlign:"center"},children:[(0,R.jsx)(f.A,{variant:"caption",color:"text.secondary",children:"Preview:"}),(0,R.jsx)("div",{style:{display:"inline-block",margin:"8px"},children:p.emoji?(0,R.jsx)("div",{style:{fontSize:.5*y.size+"px",transform:`rotate(${y.rotation}deg)`,opacity:y.opacity/100,display:"inline-block"},children:p.emoji}):p.image?(0,R.jsx)("img",{src:p.image,alt:p.name,style:{width:`${y.size}px`,height:`${y.size}px`,transform:`rotate(${y.rotation}deg)`,opacity:y.opacity/100,objectFit:"contain"}}):null})]})]}),(0,R.jsx)(m.A,{open:c,onClose:()=>d(!1),maxWidth:"md",fullWidth:!0,children:(0,R.jsx)(Qe,{onSave:e=>{const t=[...u,{...e,id:Date.now().toString()}];h(t),j(t)},onClose:()=>d(!1)})})]})}const lt={borderRadius:1,width:40,height:32,padding:0,minWidth:40,"& .MuiTouchRipple-root":{borderRadius:1}},ct=e=>{let{drawMode:t,setDrawMode:r,shapeType:n,setShapeType:s,color:o,setColor:l,showColorPicker:c,toggleColorPicker:d,closeColorPicker:u,lineWidth:h,setLineWidth:p,previousColor:m,setPreviousColor:g,refreshCanvasButtonHandler:y,undo:f,undoAvailable:x,redo:w,redoAvailable:b,selectionRect:v,handleCutSelection:j,cutImageData:A,setClearDialogOpen:S,handleExportCanvas:k,handleImportCanvas:C,openHistoryDialog:D,exitHistoryMode:T,historyMode:I,controlsDisabled:P,onOpenSettings:E,currentBrushType:M,onBrushSelect:U,onBrushParamsChange:B,selectedStamp:W,onStampSelect:$,onStampChange:z,backendStamps:N,onFilterApply:F,onFilterPreview:O,onFilterUndo:L,onClearAllFilters:_,canUndoFilter:H,canClearFilters:q,appliedFilters:K}=e;const[G,Y]=(0,a.useState)(null),[V,X]=(0,a.useState)(null),J=(e,t)=>{X(e.currentTarget),Y(t)},Q=()=>{X(null),Y(null)};return(0,R.jsxs)("div",{className:"Canvas-toolbar",children:[(0,R.jsxs)("div",{className:"Canvas-tools",children:[(0,R.jsx)(oe.A,{title:"Brushes",children:(0,R.jsx)(i.A,{onClick:e=>J(e,"brush"),sx:lt,children:(0,R.jsx)(we.A,{})})}),(0,R.jsx)(oe.A,{title:"Mixer",children:(0,R.jsx)(i.A,{onClick:e=>J(e,"mixer"),sx:lt,children:(0,R.jsx)(be.A,{})})}),(0,R.jsx)(oe.A,{title:"Stamps",children:(0,R.jsx)(i.A,{onClick:e=>J(e,"stamp"),sx:lt,children:(0,R.jsx)(ve.A,{})})}),(0,R.jsxs)(ie.Ay,{open:Boolean(V),anchorEl:V,onClose:Q,anchorOrigin:{vertical:"center",horizontal:"right"},transformOrigin:{vertical:"center",horizontal:"left"},PaperProps:{sx:{borderRadius:2,boxShadow:3}},children:["brush"===G&&(0,R.jsx)(ze,{selectedBrush:M,onSelect:U,onParamsChange:B,onClose:Q}),"mixer"===G&&(0,R.jsx)(_e,{onApply:F,onPreview:O,onUndo:L,onClearAll:_,canUndo:H,canClearAll:q,appliedFilters:K||[],onClose:Q}),"stamp"===G&&(0,R.jsx)(it,{onSelect:$,onStampChange:z,backendStamps:N,selectedStamp:W,onClose:Q})]})]}),(0,R.jsx)("div",{className:"Canvas-label-group",children:(0,R.jsx)(Pe,{drawMode:t,setDrawMode:r,color:o,previousColor:m,setColor:l,setPreviousColor:g,controlsDisabled:P})}),"shape"===t&&(0,R.jsx)("div",{className:"Canvas-label-group",children:(0,R.jsx)(Be,{shapeType:n,setShapeType:s,controlsDisabled:P})}),["freehand","shape","eraser"].includes(t)&&(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)("div",{className:"Canvas-label-group",style:{flexDirection:"column",alignItems:"flex-start"},children:(0,R.jsx)(le.Ay,{orientation:"vertical",value:h,onChange:(e,t)=>p(t),min:1,max:20,disabled:P,sx:{height:100,"& .MuiSlider-track":{color:"#007bff"},"& .MuiSlider-thumb":{backgroundColor:"#007bff",width:14,height:14},"& .MuiSlider-rail":{color:"#ccc"}}})}),"eraser"!==t&&(0,R.jsx)("div",{className:"Canvas-label-group",children:(0,R.jsxs)("div",{style:{position:"relative"},children:[(0,R.jsx)("div",{className:"Canvas-color-display",style:{backgroundColor:o,cursor:P?"not-allowed":"pointer"},onClick:P?void 0:d}),(0,R.jsx)(ie.Ay,{open:c,onClose:u,anchorEl:document.querySelector(".Canvas-color-display"),anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},PaperProps:{sx:{p:2}},children:(0,R.jsx)(se.Xq,{color:o,onChange:e=>l(e.hex),disableAlpha:!1})})]})})]}),(0,R.jsx)(oe.A,{title:"Refresh",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:P?void 0:y,sx:lt,disabled:P,children:(0,R.jsx)(ce.A,{})})})}),"function"===typeof E&&(0,R.jsx)(oe.A,{title:"Room settings",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:E,sx:lt,disabled:P,children:(0,R.jsx)(ye.A,{})})})}),I?(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(oe.A,{title:"Change History Range",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:D,sx:lt,disabled:!1,children:(0,R.jsx)(de.A,{})})})}),(0,R.jsx)(oe.A,{title:"Exit History Recall Mode",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:T,sx:lt,disabled:!1,children:(0,R.jsx)(Z.A,{})})})})]}):(0,R.jsx)(oe.A,{title:"History Recall",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:P?void 0:D,sx:lt,disabled:P,children:(0,R.jsx)(de.A,{})})})}),(0,R.jsx)(oe.A,{title:"Export Canvas",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:k,disabled:!1,sx:lt,children:(0,R.jsx)(fe.A,{})})})}),(0,R.jsx)(oe.A,{title:"Import Canvas",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:C,disabled:P,sx:lt,children:(0,R.jsx)(xe.A,{})})})}),(0,R.jsx)(oe.A,{title:"Clear Canvas",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:()=>S(!0),disabled:P,sx:lt,children:(0,R.jsx)(ue.A,{})})})}),(0,R.jsx)(oe.A,{title:"Undo",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:f,disabled:P||!x,sx:lt,children:(0,R.jsx)(he.A,{})})})}),(0,R.jsx)(oe.A,{title:"Redo",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:w,disabled:P||!b,sx:lt,children:(0,R.jsx)(pe.A,{})})})}),"select"===t&&v&&(0,R.jsx)(oe.A,{title:"Cut Selection",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:j,sx:lt,disabled:P,children:(0,R.jsx)(me.A,{})})})}),A&&A.length>0&&(0,R.jsx)(oe.A,{title:"Paste",children:(0,R.jsx)("span",{children:(0,R.jsx)(i.A,{onClick:()=>r("paste"),sx:lt,disabled:P,children:(0,R.jsx)(ge.A,{})})})})]})};var dt=r(21926),ut=r.n(dt),ht=r(89405),pt=r(88133),mt=r(49521),gt=r(80504),yt=r.n(gt),ft=r(31666);const xt=new mt.A;let wt=!1,bt=null;const vt="undefined"!==typeof window&&window.location&&("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname);function jt(){return{connected:wt,publicKey:bt}}async function At(){return new Promise(((e,t)=>{const r=n=>{try{const s=n&&n.data||{};vt&&console.debug("[resvault] getPublicKey handler got event:",s);const o=s&&"FROM_CONTENT_SCRIPT"===s.type&&s.data?s.data:s,i=o.resvault||o.payload||o.data||o,l=i.publicKey||i.pubkey||i.data&&i.data.publicKey||i.data&&i.data.pubkey;if(("getPublicKey"===i.type&&"response"===i.direction||l)&&(xt.removeMessageListener(r),clearTimeout(a),l?(bt=l,e(l)):t(new Error("No public key returned from wallet"))),"undefined"!==typeof i.success&&!1===i.success){xt.removeMessageListener(r),clearTimeout(a);const e=i.error||i.message||"Wallet extension returned failure";t(new Error(e))}}catch(s){vt&&console.error("[resvault] getPublicKey handler error",s)}},a=setTimeout((()=>{xt.removeMessageListener(r),t(new Error("Wallet extension not responding"))}),1e4);xt.addMessageListener(r),xt.sendMessage({type:"getPublicKey",direction:"request"})}))}async function St(e,t){try{const a=await At(),n=ft.A.decode(a),s=Array.from(n).map((e=>e.toString(16).padStart(2,"0"))).join(""),o={roomId:e,user:t.user,color:t.color,lineWidth:t.lineWidth,pathData:t.pathData,timestamp:t.timestamp||t.ts};function i(e){return Array.isArray(e)?e.map((e=>i(e))):null!==e&&"object"===typeof e?Object.keys(e).sort().reduce(((t,r)=>(t[r]=i(e[r]),t)),{}):e}const l=i(o),c=JSON.stringify(l);vt&&(console.log("[resvault] Data to sign:",o),console.log("[resvault] Canonical JSON:",c));const d=(new TextEncoder).encode(c),u=await async function(e){return new Promise(((t,r)=>{const a=s=>{try{const i=s&&s.data||{};vt&&console.debug("[resvault] sign handler got event:",i);const l=i&&"FROM_CONTENT_SCRIPT"===i.type&&i.data?i.data:i,c=l.resvault||l.payload||l.data||l;if("signWithKeys"===c.type&&"request"===c.direction){vt&&console.debug("[resvault] received keys for signing, performing local signature"),xt.removeMessageListener(a),clearTimeout(n);try{const r=ft.A.decode(c.privateKey);let a;if(32===r.length)a=yt().sign.keyPair.fromSeed(r);else{if(64!==r.length)throw new Error("Invalid private key length: "+r.length);a=yt().sign.keyPair.fromSecretKey(r)}const n=yt().sign.detached(e,a.secretKey),s=Array.from(n).map((e=>e.toString(16).padStart(2,"0"))).join("");vt&&console.debug("[resvault] signature generated:",s),t(s)}catch(o){console.error("[resvault] error during local signing:",o),r(new Error("Local signing failed: "+o.message))}return}const d=c.signature||c.sig||c.data&&c.data.signature;if("sign"===c.type&&"response"===c.direction||d)if(xt.removeMessageListener(a),clearTimeout(n),d)t(d);else{const e=c.error||c.message||"Signing failed";r(new Error(e))}if("undefined"!==typeof c.success&&!1===c.success){xt.removeMessageListener(a),clearTimeout(n);const e=c.error||c.message||"Wallet signing failed";r(new Error(e))}}catch(i){vt&&console.error("[resvault] sign handler error",i)}},n=setTimeout((()=>{xt.removeMessageListener(a),r(new Error("Wallet signing timeout"))}),15e3);xt.addMessageListener(a),xt.sendMessage({type:"sign",direction:"request",payload:Array.from(e)})}))}(d);return vt&&(console.log("[resvault] Signature generated:",u.substring(0,32)+"..."),console.log("[resvault] Public key (Base58):",a),console.log("[resvault] Public key (Hex):",s.substring(0,32)+"...")),{signature:u,signerPubKey:s}}catch(r){throw console.error("Failed to sign stroke:",r),new Error(`Wallet signing failed: ${r.message}`)}}function kt(){return wt&&null!==bt}function Ct(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:null)||bt;return e?e.length<=16?e:`${e.slice(0,8)}...${e.slice(-8)}`:"Not connected"}class Dt{constructor(e,t,r,a,n,s){let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{};this.drawingId=e,this.color=t,this.lineWidth=r,this.pathData=a,this.timestamp=n,this.user=s,this.brushStyle=o.brushStyle||"round",this.order=n,this.brushType=o.brushType||"normal",this.brushParams=o.brushParams||{},this.drawingType=o.drawingType||"stroke",this.stampData=o.stampData||null,this.stampSettings=o.stampSettings||null,this.filterType=o.filterType||null,this.filterParams=o.filterParams||{},this.isPending=o.isPending||!1,this.opacity=void 0!==o.opacity?o.opacity:1,this._metadataCache=null}getMetadata(){return this._metadataCache||(this._metadataCache={brushStyle:this.brushStyle,brushType:this.brushType,brushParams:this.brushParams,drawingType:this.drawingType,stampData:this.stampData,stampSettings:this.stampSettings,filterType:this.filterType,filterParams:this.filterParams,isPending:this.isPending,opacity:this.opacity}),this._metadataCache}invalidateMetadataCache(){this._metadataCache=null}static fromBackendData(e){const t=e.metadata||{},r={brushStyle:e.brushStyle||t.brushStyle||"round",brushType:e.brushType||e.brush_type||t.brushType||"normal",brushParams:e.brushParams||e.brush_params||t.brushParams||{},drawingType:e.drawingType||t.drawingType||"stroke",stampData:e.stampData||t.stampData||null,stampSettings:e.stampSettings||t.stampSettings||null,filterType:e.filterType||t.filterType||null,filterParams:e.filterParams||t.filterParams||{},isPending:e.isPending||t.isPending||!1,opacity:void 0!==e.opacity?e.opacity:void 0!==t.opacity?t.opacity:1};return new Dt(e.drawingId||e.id,e.color,e.lineWidth,e.pathData,e.timestamp||e.ts,e.user,r)}}const Tt=async function(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let l=0;l<r;l++)try{return await e()}catch(i){var n,s,o;if(t=i,401===(null===(n=i.response)||void 0===n?void 0:n.status)||403===(null===(s=i.response)||void 0===s?void 0:s.status)||400===(null===(o=i.response)||void 0===o?void 0:o.status))throw i;if(l===r-1)break;const e=a*Math.pow(2,l);console.log(`Retry attempt ${l+1}/${r} after ${e}ms delay`),await new Promise((t=>setTimeout(t,e)))}throw t},It=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;const s=(null===t||void 0===t?void 0:t.token)||(0,ht.c4)();if(s&&r.roomId)try{let c=null;try{c=(0,j.T)(t)}catch(i){c=null}c||(c="Unknown"),console.log("=== SUBMIT STROKE DEBUG ==="),console.log("Drawing object:",e),console.log("Drawing.getMetadata exists?",typeof e.getMetadata),console.log("Drawing fields:",{stampData:e.stampData,stampSettings:e.stampSettings,drawingType:e.drawingType,brushType:e.brushType});const d=e.getMetadata?e.getMetadata():{brushStyle:e.brushStyle||"round",brushType:e.brushType||"normal",brushParams:e.brushParams||{},drawingType:e.drawingType||"stroke",stampData:e.stampData||null,stampSettings:e.stampSettings||null,filterType:e.filterType||null,filterParams:e.filterParams||{}};console.log("Extracted metadata:",d);const u={drawingId:e.drawingId,color:e.color,lineWidth:e.lineWidth,pathData:e.pathData,timestamp:e.timestamp,user:c,roomId:r.roomId,skipUndoStack:r.skipUndoStack||!1,brushStyle:d.brushStyle,brushType:d.brushType,brushParams:d.brushParams,drawingType:d.drawingType,stampData:d.stampData,stampSettings:d.stampSettings,filterType:d.filterType,filterParams:d.filterParams,metadata:d};e.parentPasteId?u.parentPasteId=e.parentPasteId:e.pathData&&e.pathData.parentPasteId&&(u.parentPasteId=e.pathData.parentPasteId);let h=null,p=null;if("secure"===r.roomType){if(!kt())throw(0,pt.A)("Please connect your wallet to draw in this secure room","warning"),new Error("Wallet not connected for secure room");try{var o;const e=await St(r.roomId,u);h=e.signature,p=e.signerPubKey,console.log("Stroke signed for secure room:",{signerPubKey:(null===(o=p)||void 0===o?void 0:o.substring(0,16))+"..."})}catch(l){throw console.error("Failed to sign stroke:",l),(0,pt.A)("Failed to sign stroke with wallet: "+l.message,"error"),l}}console.log("Submitting stroke data:",{drawingId:u.drawingId,brushType:u.brushType,brushParams:u.brushParams,metadata:u.metadata,roomType:r.roomType,parentPasteId:u.parentPasteId||"NOT SET"}),console.log("Full strokeData object:",u),await Tt((async()=>{await(0,v.postRoomStroke)(s,r.roomId,u,h,p)}),3,1e3),!r.skipUndoCheck&&a&&n&&await Et({token:s},a,n,r.roomId)}catch(c){throw console.error("Error submitting stroke:",c),c}else console.error("submitToDatabase: Missing auth token or roomId")},Pt=async function(e,t,r,a,n){var s;let o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};const i=(null===(s=o.auth)||void 0===s?void 0:s.token)||(0,ht.c4)();if(!i||!o.roomId)return console.warn("refreshCanvas: Missing auth token or roomId"),0;try{const e=await(0,v.getRoomStrokes)(i,o.roomId,{start:a,end:n});if(e.length>0){console.log("Received strokes from backend:",{count:e.length,firstStroke:e[0],lastStroke:e[e.length-1]}),console.log("=== BACKEND STROKE ANALYSIS ==="),console.log("Total strokes received:",e.length);const t=e.filter((e=>e.brushType&&"normal"!==e.brushType||e.metadata&&e.metadata.brushType&&"normal"!==e.metadata.brushType));if(console.log("Advanced brush strokes:",t.length),e.length>0){const t=e[0];console.log("First stroke complete object:",t),console.log("First stroke keys:",Object.keys(t)),console.log("First stroke brush analysis:",{hasBrushType:"brushType"in t,hasBrush_type:"brush_type"in t,hasMetadata:"metadata"in t,brushTypeValue:t.brushType,brush_typeValue:t.brush_type,metadataValue:t.metadata})}t.length>0&&console.log("Sample advanced brush stroke:",t[0])}const s=e.map((e=>{let t=e.metadata||{};const r={brushStyle:t.brushStyle||e.brushStyle||"round",brushType:t.brushType||e.brushType||e.brush_type||"normal",brushParams:t.brushParams||e.brushParams||e.brush_params||{},drawingType:t.drawingType||e.drawingType||"stroke",stampData:t.stampData||e.stampData||null,stampSettings:t.stampSettings||e.stampSettings||null,filterType:t.filterType||e.filterType||null,filterParams:t.filterParams||e.filterParams||{}};"stamp"!==r.drawingType&&"normal"===r.brushType||console.log("Reconstructing special drawing from backend:",{id:e.drawingId||e.id,drawingType:r.drawingType,brushType:r.brushType,stampData:r.stampData,stampSettings:r.stampSettings,rawStroke:e,extractedMetadata:r});const a=new Dt(e.drawingId||e.id||`stroke_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,e.color||"#000000",e.lineWidth||5,e.pathData||[],e.timestamp||e.ts||Date.now(),e.user||"",r);return a.order=e.order||e.timestamp||0,a.roomId=e.roomId||o.roomId,"stamp"!==r.drawingType&&"normal"===r.brushType||(console.log("Created Drawing object with special features:",{id:a.drawingId,drawingType:a.drawingType,brushType:a.brushType,stampData:a.stampData,stampSettings:a.stampSettings,hasStampData:!!a.stampData,hasStampSettings:!!a.stampSettings,pathData:a.pathData,pathDataIsArray:Array.isArray(a.pathData),pathDataLength:a.pathData?a.pathData.length:0,metadata:a.getMetadata()}),a.stampData&&a.stampData.image&&(console.log("Stamp image data length from backend:",a.stampData.image.length),console.log("Stamp image preview:",a.stampData.image.substring(0,100)+"..."))),a})).filter((e=>!(a&&e.timestamp<a)&&!(n&&e.timestamp>n)));return s.sort(((e,t)=>(e.order||e.timestamp)-(t.order||t.timestamp))),console.log("[refreshCanvas] About to update userData.drawings:",{oldCount:t.drawings?t.drawings.length:0,newCount:s.length,newDrawingsSample:s.slice(0,3).map((e=>({id:e.drawingId,brushType:e.brushType})))}),o.clearLastDrawnState&&o.clearLastDrawnState(),t.drawings=s,console.log("[refreshCanvas] Updated userData.drawings:",{count:t.drawings.length,firstDrawing:t.drawings[0]?{id:t.drawings[0].drawingId,brushType:t.drawings[0].brushType}:null,allDrawingIds:t.drawings.map((e=>e.drawingId)).join(",").substring(0,200),pastedStrokesStillPresent:t.drawings.filter((e=>e.parentPasteId||e.pathData&&e.pathData.parentPasteId)).length}),r&&(console.log("[refreshCanvas] Calling drawAllDrawings..."),r()),t.drawings.length}catch(l){return console.error("Error refreshing canvas:",l),t.drawings?t.drawings.length:0}};let Rt=!1;const Et=async(e,t,r,a)=>{try{const n=(null===e||void 0===e?void 0:e.token)||(0,ht.c4)();if(!n||!a)return t&&t(!1),void(r&&r(!1));const s=await(0,v.getUndoRedoStatus)(n,a);if("ok"===s.status)return t&&t(s.undo_available),r&&r(s.redo_available),console.log("Undo/redo status updated:",s),s}catch(n){console.error("Error checking undo/redo availability:",n)}return t&&t(!1),r&&r(!1),{undo_available:!1,redo_available:!1}};function Mt(e,t,r,n,s,o,i,l,c,d,u){const[h,p]=(0,a.useState)(null),[m,g]=(0,a.useState)(null),[y,f]=(0,a.useState)(null),[x,w]=(0,a.useState)(new Set),[b,v]=(0,a.useState)({}),j=(e,t,r)=>{const a=[];if(t.x-e.x!==0){const n=(r.x-e.x)/(t.x-e.x);if(n>=0&&n<=1){const s=e.y+n*(t.y-e.y);s>=r.y&&s<=r.y+r.height&&a.push({t:n,point:{x:r.x,y:s}})}const s=(r.x+r.width-e.x)/(t.x-e.x);if(s>=0&&s<=1){const n=e.y+s*(t.y-e.y);n>=r.y&&n<=r.y+r.height&&a.push({t:s,point:{x:r.x+r.width,y:n}})}}if(t.y-e.y!==0){const n=(r.y-e.y)/(t.y-e.y);if(n>=0&&n<=1){const s=e.x+n*(t.x-e.x);s>=r.x&&s<=r.x+r.width&&a.push({t:n,point:{x:s,y:r.y}})}const s=(r.y+r.height-e.y)/(t.y-e.y);if(s>=0&&s<=1){const n=e.x+s*(t.x-e.x);n>=r.x&&n<=r.x+r.width&&a.push({t:s,point:{x:n,y:r.y+r.height}})}}a.sort(((e,t)=>e.t-t.t));const n=[];return a.forEach((e=>{n.some((t=>Math.abs(t.t-e.t)<1e-6))||n.push(e)})),n};return{selectionStart:h,setSelectionStart:p,selectionRect:m,setSelectionRect:g,cutImageData:y,setCutImageData:f,handleCutSelection:async()=>{if(!m)return;const{start:e,end:a}=m,h=Math.min(e.x,a.x),p=Math.min(e.y,a.y),g=Math.abs(a.x-e.x),y=Math.abs(a.y-e.y);if(!g||!y)return;f([]),await new Promise((e=>setTimeout(e,10)));const x={x:h,y:p,width:g,height:y};let b=[],A=[],S=[],k=[];const C=new Set,D={},T=r.drawings.length;let I=0;r.drawings.forEach((e=>{if(I++,u&&u(`Processing cut... ${I}/${T} strokes analyzed.`),Array.isArray(e.pathData)){const t=e.pathData;if(1===t.length){const r=t[0];if(!(r.x>=x.x&&r.x<=x.x+x.width&&r.y>=x.y&&r.y<=x.y+x.height))return void S.push(e);k.push(e),C.add(e.drawingId);const a={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},s=new Dt(n(),e.color,e.lineWidth,t,Date.now(),e.user,a);return A.push(s),void(D[e.drawingId]=[])}if(!t.some((e=>e.x>=x.x&&e.x<=x.x+x.width&&e.y>=x.y&&e.y<=x.y+x.height)))return void S.push(e);k.push(e),C.add(e.drawingId);const r=((e,t)=>{const r=e=>e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height,a=[];let n=[];for(let s=0;s<e.length-1;s++){const o=e[s],i=e[s+1];if(r(o)||0===n.length&&n.push(o),r(o)!==r(i)){const e=j(o,i,t);if(e.length>0){const t=e[0].point;r(o)?(n=[],n.push(t)):(n.push(t),a.push(n),n=[])}}else r(o)||r(i)||n.length>0&&n.push(i)}return n.length>=2&&a.push(n),a})(t,x),a=((e,t)=>{const r=e=>e.x>=t.x&&e.x<=t.x+t.width&&e.y>=t.y&&e.y<=t.y+t.height,a=[];let n=[];for(let s=0;s<e.length-1;s++){const o=e[s],i=e[s+1];if(r(o)&&0===n.length&&n.push(o),r(o)!==r(i)){const e=j(o,i,t);if(e.length>0){const t=e[0].point;r(o)?(n.push(t),a.push(n),n=[]):(n=[],n.push(t))}}else r(o)&&r(i)&&n.length>0&&n.push(i)}return n.length>=2&&a.push(n),a})(t,x),s=[];r.forEach((t=>{if(t.length>1){const r={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},a=new Dt(n(),e.color,e.lineWidth,t,Date.now(),e.user,r);s.push(a),S.push(a)}})),D[e.drawingId]=s,a.forEach((t=>{if(t.length>1){const r={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},a=new Dt(n(),e.color,e.lineWidth,t,Date.now(),e.user,r);A.push(a);const s=new Dt(n(),"#ffffff",e.lineWidth+4,t,Date.now(),e.user);b.push(s)}}))}else if(e.pathData&&"shape"===e.pathData.tool){const t=e.pathData;let r=[];if(t.points&&Array.isArray(t.points))r=t.points;else if("circle"===t.type){const e={x:t.start.x,y:t.start.y},a=Math.sqrt((t.end.x-t.start.x)**2+(t.end.y-t.start.y)**2),n=30;for(let t=0;t<n;t++){const s=2*Math.PI*t/n;r.push({x:e.x+a*Math.cos(s),y:e.y+a*Math.sin(s)})}r.push(r[0])}else if("rectangle"===t.type)r=[{x:t.start.x,y:t.start.y},{x:t.end.x,y:t.start.y},{x:t.end.x,y:t.end.y},{x:t.start.x,y:t.end.y},{x:t.start.x,y:t.start.y}];else if("hexagon"===t.type){const e={x:t.start.x,y:t.start.y},a=Math.sqrt((t.end.x-t.start.x)**2+(t.end.y-t.start.y)**2);for(let t=0;t<6;t++){const n=Math.PI/3*t;r.push({x:e.x+a*Math.cos(n),y:e.y+a*Math.sin(n)})}r.push(r[0])}else"line"===t.type&&(r=[t.start,t.end]);const a=r.map((e=>e.x)),s=r.map((e=>e.y)),o=Math.min(...a),i=Math.max(...a),l=Math.min(...s),c=Math.max(...s);if(i<x.x||o>x.x+x.width||c<x.y||l>x.y+x.height)return void S.push(e);if(k.push(e),C.add(e.drawingId),"line"!==t.type){const t=r.map((e=>({X:e.x,Y:e.y}))),a=[{X:x.x,Y:x.y},{X:x.x+x.width,Y:x.y},{X:x.x+x.width,Y:x.y+x.height},{X:x.x,Y:x.y+x.height}];let s=new(ut().Clipper);s.AddPath(t,ut().PolyType.ptSubject,!0),s.AddPath(a,ut().PolyType.ptClip,!0);let o=new(ut().Paths);s.Execute(ut().ClipType.ctIntersection,o,ut().PolyFillType.pftNonZero,ut().PolyFillType.pftNonZero);let i=new(ut().Clipper);i.AddPath(t,ut().PolyType.ptSubject,!0),i.AddPath(a,ut().PolyType.ptClip,!0);let l=new(ut().Paths);if(i.Execute(ut().ClipType.ctDifference,l,ut().PolyFillType.pftNonZero,ut().PolyFillType.pftNonZero),l.forEach((t=>{if(t.length>=3){const r=t.map((e=>({x:e.X,y:e.Y}))),a={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},s=new Dt(n(),e.color,e.lineWidth,{tool:"shape",type:"polygon",points:r},Date.now(),e.user,a);S.push(s),D[e.drawingId]||(D[e.drawingId]=[]),D[e.drawingId].push(s)}})),o.length>0){let t=0,r=null;if(o.forEach((e=>{if(e.length>=3){let a=Math.abs(ut().Clipper.Area(e));a>t&&(t=a,r=e)}})),r){const t=r.map((e=>({x:e.X,y:e.Y}))),a={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},s=new Dt(n(),e.color,e.lineWidth,{tool:"shape",type:"polygon",points:t},Date.now(),e.user,a);A.push(s);const o=new Dt(n(),"#ffffff",e.lineWidth+4,{tool:"shape",type:"polygon",points:t},Date.now(),e.user);b.push(o)}}}else{const[t,a]=r,s=j(t,a,x).map((e=>e.point)),o=e=>e.x>=x.x&&e.x<=x.x+x.width&&e.y>=x.y&&e.y<=x.y+x.height;let i=[],l=[];if(o(t)&&o(a))l.push([t,a]);else if(2===s.length)l.push([s[0],s[1]]),i.push([t,s[0]],[s[1],a]);else{if(1!==s.length)return S.push(e),void(D[e.drawingId]=[]);o(t)?(l.push([t,s[0]]),i.push([s[0],a])):(l.push([s[0],a]),i.push([t,s[0]]))}const c=i.map((t=>{let[r,a]=t;const s={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},o=new Dt(n(),e.color,e.lineWidth,{tool:"shape",type:"line",start:r,end:a},Date.now(),e.user,s);return S.push(o),o}));D[e.drawingId]=c,l.forEach((t=>{let[r,a]=t;const s={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams},o=new Dt(n(),e.color,e.lineWidth,{tool:"shape",type:"line",start:r,end:a},Date.now(),e.user,s);A.push(o);const i=new Dt(n(),"#ffffff",e.lineWidth+4,{tool:"shape",type:"line",start:r,end:a},Date.now(),e.user);b.push(i)}))}}else S.push(e)})),f(A),w(C),v(D);const P=Object.values(D).flat(),R=P.map((e=>e.drawingId));let E=0;for(const t of P)try{await It(t,c,{roomId:o,roomType:d,skipUndoCheck:!0,skipUndoStack:!0},i,l),E++,u&&P.length>0&&u(`Saving cut segments... ${E}/${P.length} saved.`)}catch(U){console.error("Failed to submit replacement segment:",t,U)}r.drawings=S;const M=new Dt(n(),"#FFFFFF",1,{tool:"cut",rect:x,cut:!0,originalStrokeIds:Array.from(C),replacementSegmentIds:R},Date.now(),t);r.addDrawing(M),await It(M,c,{roomId:o,roomType:d},i,l),s();return{updatedDrawings:S,compositeCutAction:{type:"cut",cutRecord:M,eraseStrokes:b,affectedDrawings:k,replacementSegments:D,backendCount:1}}}}}var Ut=r(73794);var Bt=r(17682),Wt=r(81303),$t=r(94302);class zt{constructor(e,t){this.userId=e,this.username=t,this.drawings=[]}addDrawing(e){this.drawings.push(e)}clearDrawings(){this.drawings=[]}}const Nt=function(e){var t,o;let{auth:c,setUserList:d,selectedUser:u,setSelectedUser:h,currentRoomId:p,canvasRefreshTrigger:b=0,currentRoomName:D="Master (not in a room)",onExitRoom:T=()=>{},onOpenSettings:I=null,viewOnly:P=!1,isOwner:M=!1,roomType:F="public",walletConnected:O=!1,templateId:L=null}=e;const _=(0,a.useRef)(null),H=(0,a.useRef)(null),K=(0,a.useRef)([]),G=(e,t,r)=>Math.min(r,Math.max(t,e)),Y=(0,a.useRef)(null);if(null===Y.current)try{const e=(0,j.T)(c)||`anon_${Date.now()}_${Math.random().toString(36).substr(2,5)}`;Y.current=`${e}|${Date.now()}`}catch(ua){Y.current=`anon_${Date.now()}_${Math.random().toString(36).substr(2,5)}`}const V=Y.current,[X,J]=(0,a.useState)(!1),[Z,te]=(0,a.useState)("#000000"),[se,oe]=(0,a.useState)(5),[ie,le]=(0,a.useState)("freehand"),[ce,de]=(0,a.useState)("circle"),[ue]=(0,a.useState)("round"),[he,pe]=(0,a.useState)(null),me=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const[t,r]=(0,a.useState)("normal"),[n,s]=(0,a.useState)({}),o=(0,a.useRef)(e),i=(0,a.useRef)([]),l=(0,a.useRef)(null),c={normal:{size:1,opacity:1},wacky:{scatter:5,colors:!0,particles:3},drip:{droplets:2,gravity:.5,viscosity:.3},scatter:{spread:20,density:5,variation:.8},neon:{glow:10,intensity:.9},chalk:{texture:!0,opacity:.7,roughness:.5},spray:{density:15,spread:25,pressure:.6}},d=(0,a.useCallback)(((e,t,r,a)=>{o.current&&(o.current.lineTo(e,t),o.current.stroke(),o.current.beginPath(),o.current.moveTo(e,t))}),[]),u=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.wacky;for(let s=0;s<n.particles;s++){const s=(Math.random()-.5)*n.scatter*r,i=(Math.random()-.5)*n.scatter*r,l=Math.random()*r*.8+.2*r;o.current.save(),o.current.beginPath(),o.current.arc(e+s,t+i,l,0,2*Math.PI),n.colors?o.current.fillStyle=`hsl(${360*Math.random()}, 80%, 60%)`:o.current.fillStyle=a,o.current.fill(),o.current.restore()}}),[]),h=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.drip;if(o.current.strokeStyle=a,o.current.lineWidth=r,o.current.lineTo(e,t),o.current.stroke(),Math.random()<.2)for(let s=0;s<n.droplets;s++){const s=e+(Math.random()-.5)*r*2,i=t+Math.random()*r*4,l=(.4*Math.random()+.2)*r;o.current.save(),o.current.beginPath(),o.current.arc(s,i,l,0,2*Math.PI),o.current.fillStyle=a,o.current.globalAlpha=n.viscosity,o.current.fill(),o.current.restore()}}),[]),p=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.scatter;for(let s=0;s<n.density;s++){const s=Math.random()*Math.PI*2,i=Math.random()*n.spread,l=e+Math.cos(s)*i,c=t+Math.sin(s)*i,d=Math.random()*r*n.variation+.2*r;o.current.save(),o.current.beginPath(),o.current.arc(l,c,d,0,2*Math.PI),o.current.fillStyle=a,o.current.globalAlpha=.6,o.current.fill(),o.current.restore()}}),[]),m=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.neon;o.current.save(),o.current.strokeStyle=a,o.current.lineWidth=r,o.current.shadowColor=a,o.current.shadowBlur=n.glow,o.current.globalAlpha=n.intensity,o.current.lineTo(e,t),o.current.stroke(),o.current.restore()}),[]),g=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.chalk;for(let s=0;s<3;s++){const s=(Math.random()-.5)*r*n.roughness,i=(Math.random()-.5)*r*n.roughness;o.current.save(),o.current.globalAlpha=n.opacity*(.3+.7*Math.random()),o.current.beginPath(),o.current.arc(e+s,t+i,.8*r,0,2*Math.PI),o.current.fillStyle=a,o.current.fill(),o.current.restore()}}),[]),y=(0,a.useCallback)(((e,t,r,a)=>{if(!o.current)return;const n=c.spray,s=n.spread*(r/5),i=r/5;for(let l=0;l<n.density;l++){const r=Math.random()*Math.PI*2,l=Math.random()*s*n.pressure,c=e+Math.cos(r)*l,d=t+Math.sin(r)*l,u=Math.random()*i+.5*i;o.current.save(),o.current.beginPath(),o.current.arc(c,d,u,0,2*Math.PI),o.current.fillStyle=a,o.current.globalAlpha=.3,o.current.fill(),o.current.restore()}}),[]),f=(0,a.useCallback)(((e,r,a,n)=>{if(o.current){switch(console.log("BrushEngine: Drawing with brush type:",t),t){case"normal":default:d(e,r,a,n);break;case"wacky":u(e,r,a,n);break;case"drip":h(e,r,a,n);break;case"scatter":p(e,r,a,n);break;case"neon":m(e,r,a,n);break;case"chalk":g(e,r,a,n);break;case"spray":y(e,r,a,n)}l.current={x:e,y:r}}else console.log("BrushEngine: No context available")}),[t,d,u,h,p,m,g,y]),x=(0,a.useCallback)(((e,t,r,a,n)=>{if(o.current){switch(n){case"normal":default:d(e,t,r,a);break;case"wacky":u(e,t,r,a);break;case"drip":h(e,t,r,a);break;case"scatter":p(e,t,r,a);break;case"neon":m(e,t,r,a);break;case"chalk":g(e,t,r,a);break;case"spray":y(e,t,r,a)}l.current={x:e,y:t}}else console.log("BrushEngine: No context available")}),[d,u,h,p,m,g,y]),w=(0,a.useCallback)(((e,r)=>{o.current&&(l.current={x:e,y:r},i.current=[],"normal"===t&&(o.current.beginPath(),o.current.moveTo(e,r)))}),[t]),b=(0,a.useCallback)((()=>c[t]||c.normal),[t,c]),v=(0,a.useCallback)((e=>{o.current=e}),[]);return{brushType:t,setBrushType:r,brushParams:n,setBrushParams:s,draw:f,drawWithType:x,startStroke:w,getBrushConfig:b,updateContext:v,availableBrushes:Object.keys(c)}}(),[ge,ye]=(0,a.useState)("normal"),[fe,xe]=(0,a.useState)({}),[we,be]=(0,a.useState)(null),[ve,je]=(0,a.useState)({size:50,rotation:0,opacity:100}),[Ae,Se]=(0,a.useState)([]),[ke,Ce]=(0,a.useState)(null),De=(0,a.useRef)(null),[Te,Ie]=(0,a.useState)(null),[Pe,Re]=(0,a.useState)({}),[Ee,Me]=(0,a.useState)(!1),Ue=((0,a.useRef)(null),(0,a.useRef)(null)),Be=(0,a.useRef)(null),[We,$e]=(0,a.useState)(!1),[ze,Ne]=(0,a.useState)(!1),[Fe,Oe]=(0,a.useState)(null),[Le,_e]=(0,a.useState)(!1),[He,qe]=(0,a.useState)([]),[Ke,Ge]=(0,a.useState)([]),[Ye,Ve]=(0,a.useState)(!1),[Xe,Je]=(0,a.useState)(!1),[Ze,Qe]=(0,a.useState)(!1),[et,tt]=(0,a.useState)([]),rt=(0,a.useRef)([]);(0,a.useEffect)((()=>{rt.current=et}),[et]);const at=3e3,nt=2e3,[st,ot]=(0,a.useState)({x:0,y:0}),[it,lt]=(0,a.useState)(!1),dt=(0,a.useRef)({x:0,y:0}),ut=(0,a.useRef)({x:0,y:0}),mt=2e3,gt=(0,a.useRef)(0),yt=(0,a.useRef)(!1),ft=(0,a.useRef)(null),xt=(0,a.useRef)(!1),[wt,bt]=(0,a.useState)([]),vt=(0,a.useRef)(null),jt=(0,a.useRef)([]),At=(0,a.useRef)(!1),Ct=(0,a.useRef)(new Set),Nt=(0,a.useRef)(null),Ft=(0,a.useRef)(!1),Ot=(0,a.useRef)(null),Lt=(0,a.useRef)(null),_t=(0,a.useRef)(new Set),Ht=(0,a.useRef)(!1),qt=(0,a.useRef)(null),Kt=(0,a.useRef)(null),[Gt,Yt]=(0,a.useState)(!1),[Vt,Xt]=(0,a.useState)(null),[Jt,Zt]=(0,a.useState)(!1),[Qt,er]=(0,a.useState)(""),[tr,rr]=(0,a.useState)(""),[ar,nr]=(0,a.useState)(!1),[sr,or]=(0,a.useState)({open:!1,message:"",duration:4e3}),[ir,lr]=(0,a.useState)(!1),[cr,dr]=(0,a.useState)(""),ur=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4e3;return or({open:!0,message:String(e),duration:t})},hr=!(Gt||u&&""!==u||P||"secure"===F&&!O),[pr,mr]=(0,a.useState)(!1),[gr,yr]=(0,a.useState)(!1),fr=(0,a.useRef)(null),[xr,wr]=(0,a.useState)(!0),[br,vr]=(0,a.useState)(0),jr=(0,a.useRef)({}),Ar=(0,a.useRef)(null),Sr=(0,a.useRef)(!1),kr=(0,a.useRef)(null),Cr=((0,a.useRef)(null),(0,a.useRef)({})),Dr=(0,a.useRef)({}),Tr=(0,a.useRef)({}),Ir=(0,a.useRef)(null);(0,a.useEffect)((()=>{var e,t,r,a,n,s,o,i,l;if(!p)return;const c=jr.current[p]||JSON.parse(localStorage.getItem(`rescanvas:toolbar:${p}`)||"null")||{};c.color&&te(c.color),c.lineWidth&&oe(c.lineWidth),c.drawMode&&le(c.drawMode),c.shapeType&&de(c.shapeType),void 0!==c.previousColor&&Oe(c.previousColor),c.selectedStamp&&be(c.selectedStamp),c.stampSettings&&je(c.stampSettings),c.currentBrushType&&(ye(c.currentBrushType),me.setBrushType(c.currentBrushType)),c.brushParams&&(xe(c.brushParams),me.setBrushParams(c.brushParams)),jr.current[p]={color:null!==(e=c.color)&&void 0!==e?e:Z,lineWidth:null!==(t=c.lineWidth)&&void 0!==t?t:se,drawMode:null!==(r=c.drawMode)&&void 0!==r?r:ie,shapeType:null!==(a=c.shapeType)&&void 0!==a?a:ce,previousColor:null!==(n=c.previousColor)&&void 0!==n?n:Fe,selectedStamp:null!==(s=c.selectedStamp)&&void 0!==s?s:we,stampSettings:null!==(o=c.stampSettings)&&void 0!==o?o:ve,currentBrushType:null!==(i=c.currentBrushType)&&void 0!==i?i:ge,brushParams:null!==(l=c.brushParams)&&void 0!==l?l:fe};const d=Cr.current[p]||{undo:[],redo:[]};qe(d.undo),Ge(d.redo);const u=Dr.current[p]||null;ta&&ta(u)}),[p]),(0,a.useEffect)((()=>{if(!L)return tt([]),qt.current=null,void(Kt.current=null);const e=$t.j.find((e=>e.id===L));e&&e.canvas&&e.canvas.objects?(tt(e.canvas.objects),qt.current=null,Kt.current=null):(tt([]),qt.current=null,Kt.current=null)}),[L,p]),(0,a.useEffect)((()=>{if(!et||0===et.length)return;const e=setTimeout((()=>{Ir.current?(Nt.current=null,Ir.current()):console.warn("drawAllDrawingsRef not ready yet")}),100);return()=>clearTimeout(e)}),[et]),(0,a.useEffect)((()=>{U?console.warn("[ResilientDB Monitor] Already monitoring"):(console.log("[ResilientDB Monitor] Starting health checks"),setTimeout((()=>{N()}),5e3),U=setInterval((()=>{N()}),6e4));const e=(t=e=>{let{isHealthy:t,queueSize:r}=e;wr(t),vr(r||0),t?console.log("[Canvas] ResilientDB is healthy - blockchain persistence active"):console.warn(`[Canvas] ResilientDB is down - ${r} strokes queued for sync`)},z.push(t),W&&t({isHealthy:B,queueSize:$,timestamp:W}),()=>{z=z.filter((e=>e!==t))});var t;return()=>{U&&(clearInterval(U),U=null,console.log("[ResilientDB Monitor] Stopped health checks")),e()}}),[]),(0,a.useEffect)((()=>{if(!p)return;const e={color:Z,lineWidth:se,drawMode:ie,shapeType:ce,previousColor:Fe,selectedStamp:we,stampSettings:ve,currentBrushType:ge,brushParams:fe};jr.current[p]=e;try{localStorage.setItem(`rescanvas:toolbar:${p}`,JSON.stringify(e))}catch{}}),[p,Z,se,ie,ce,Fe,we,ve,ge,fe]),(0,a.useEffect)((()=>{if(!p)return;const e=Cr.current[p]||{undo:[],redo:[]};e.undo=He,Cr.current[p]=e}),[p,He]),(0,a.useEffect)((()=>{if(!p)return;const e=Cr.current[p]||{undo:[],redo:[]};e.redo=Ke,Cr.current[p]=e}),[p,Ke]),(0,a.useEffect)((()=>{const e=()=>{lt(!1),ut.current={...st};try{ft.current&&(clearTimeout(ft.current),ft.current=null),yt.current&&(yt.current=!1,na("pan-mouseup-skipped").finally((()=>{try{nr(!1)}catch(ua){}}))),xt.current&&(xt.current=!1,na("pan-mouseup-pending").finally((()=>{try{nr(!1)}catch(ua){}})))}catch(ua){}};return document.addEventListener("mouseup",e),()=>document.removeEventListener("mouseup",e)}),[st]);const Pr=async()=>{if(!At.current&&0!==jt.current.length){for(At.current=!0;jt.current.length>0;){const t=jt.current.shift();try{await t()}catch(e){console.error("Error processing queued submission:",e)}}At.current=!1,vt.current&&clearTimeout(vt.current),vt.current=setTimeout((()=>{na("post-queue").catch((e=>console.error("Error during post-queue refresh:",e))),vt.current=null}),500)}};(0,a.useEffect)((()=>{if(null===c||void 0===c||!c.token||!p)return;try{(0,Bt.FP)(c.token)}catch(ua){}const e=(0,Bt.Ol)(c.token);try{e.emit("join_room",{roomId:p,token:null===c||void 0===c?void 0:c.token})}catch(ua){e.emit("join_room",{roomId:p})}const t=[];let r=null;const a=()=>{if(0===t.length)return;const e=[...t];t.length=0,bt((t=>[...t,...e])),requestAnimationFrame((()=>{Gr()})),function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300;try{vt.current&&clearTimeout(vt.current)}catch(ua){}vt.current=setTimeout((()=>{na().catch((e=>console.error("Error during scheduled refresh:",e))),vt.current=null}),e)}(350)},n=e=>{try{const t=(0,j.T)(c);if(e.user===t){const t=e.stroke;return void(t&&t.drawingId&&Ct.current.add(t.drawingId))}}catch(ua){try{const t=(0,Wt.W)(c)||{};if(e.user===t.username){const t=e.stroke;return void(t&&t.drawingId&&Ct.current.add(t.drawingId))}}catch(i){}}const n=e.stroke,s={brushStyle:n.brushStyle,brushType:n.brushType,brushParams:n.brushParams,drawingType:n.drawingType,stampData:n.stampData,stampSettings:n.stampSettings,filterType:n.filterType,filterParams:n.filterParams},o=new Dt(n.drawingId||`remote_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,n.color||"#000000",n.lineWidth||5,n.pathData||[],n.ts||n.timestamp||Date.now(),n.user||"Unknown",s);try{const e=Tr.current[p];if(e&&(o.timestamp||o.ts||Date.now())<e)return}catch(ua){}t.push(o),"stamp"===o.drawingType&&o.stampData&&o.stampData.image&&Se((e=>{const t=o.stampData.image.substring(0,100);return e.some((e=>e.image&&e.image.substring(0,100)===t))?e:(console.log("Adding new custom stamp from Socket.IO:",o.stampData.name||"Custom Stamp"),[...e,{id:`stamp-${Date.now()}-${e.length}`,name:o.stampData.name||"Custom Stamp",category:o.stampData.category||"custom",image:o.stampData.image,emoji:o.stampData.emoji}])})),clearTimeout(r),r=setTimeout(a,50)},s=e=>{try{if(!e)return;if(e.roomId!==p)return;console.debug("socket user_joined event",e),e.username&&ur(`${e.username} joined the canvas.`)}catch(ua){}},o=e=>{try{if(!e)return;if(e.roomId!==p)return;console.debug("socket user_left event",e),e.username&&ur(`${e.username} left the canvas.`)}catch(ua){}},i=e=>{console.log("Stroke undone event received:",e),Ht.current=!0,Nt.current=null,vt.current&&clearTimeout(vt.current),vt.current=setTimeout((()=>{na("undo-event"),vt.current=null}),100),p&&Et(c,Ve,Je,p)},l=e=>{console.log("Canvas cleared event received:",e);const t=e&&e.clearedAt?e.clearedAt:Date.now();p&&(Tr.current[p]=t);try{Ur.clearDrawings()}catch(ua){}bt([]),$r.current=0,qe([]),Ge([]),Ve(!1),Je(!1);try{p&&(Cr.current[p]={undo:[],redo:[]},Dr.current[p]=null)}catch(ua){}Rr(),Gr(),p&&Et(c,Ve,Je,p)};return e.on("new_stroke",n),e.on("stroke_undone",i),e.on("canvas_cleared",l),e.on("user_joined",s),e.on("user_left",o),e.on("user_joined_debug",(e=>{console.debug("socket user_joined_debug",e)})),()=>{e.off("new_stroke",n),e.off("stroke_undone",i),e.off("canvas_cleared",l),e.off("user_joined",s),e.off("user_left",o);try{e.emit("leave_room",{roomId:p,token:null===c||void 0===c?void 0:c.token})}catch(ua){e.emit("leave_room",{roomId:p})}try{vt.current&&clearTimeout(vt.current)}catch(ua){}try{r&&clearTimeout(r)}catch(ua){}}}),[null===c||void 0===c?void 0:c.token,p,null===c||void 0===c||null===(t=c.user)||void 0===t?void 0:t.username]),(0,a.useEffect)((()=>{(async()=>{try{if(qe([]),Ge([]),Ve(!1),Je(!1),p&&(Cr.current[p]={undo:[],redo:[]}),Ar.current=null,Sr.current=!1,kr.current=null,null!==c&&void 0!==c&&c.token&&p){try{await(0,v.resetMyStacks)(c.token,p)}catch(ua){}try{var e,t;const r=await(async(e,t,r,a,n,s)=>{try{const o=(null===e||void 0===e?void 0:e.token)||(0,ht.c4)();if(!o||!t)return console.log("Cannot restore stacks: missing token or roomId"),{undo:[],redo:[]};const i=await(0,v.getUndoRedoStacks)(o,t);if("ok"===i.status){const e=i.undo_stack||[],o=i.redo_stack||[];console.log(`Restoring undo/redo stacks: ${e.length} undo, ${o.length} redo items`);const l=e=>{if("cut"===e.type||"paste"===e.type)return e;const r=e.metadata||{brushStyle:e.brushStyle||"round",brushType:e.brushType||"normal",brushParams:e.brushParams||{},drawingType:e.drawingType||"stroke",stampData:e.stampData||null,stampSettings:e.stampSettings||null,filterType:e.filterType||null,filterParams:e.filterParams||{}},a=new Dt(e.drawingId||e.id,e.color||"#000000",e.lineWidth||5,e.pathData||[],e.timestamp||e.ts||Date.now(),e.user||"",r);return a.roomId=e.roomId||t,a},c=e.map(l),d=o.map(l);return r(c),a(d),n&&n(c.length>0),s&&s(d.length>0),{undo:c,redo:d}}}catch(o){console.error("Error restoring undo/redo stacks:",o)}return{undo:[],redo:[]}})(c,p,qe,Ge,Ve,Je);p&&r&&(Cr.current[p]={undo:r.undo||[],redo:r.redo||[]}),console.log(`Restored stacks for room ${p}:`,{undoCount:(null===(e=r.undo)||void 0===e?void 0:e.length)||0,redoCount:(null===(t=r.redo)||void 0===t?void 0:t.length)||0})}catch(ua){console.warn("Failed to restore undo/redo stacks:",ua);try{await Et(c,Ve,Je,p)}catch(r){}}}}catch(ua){}})()}),[null===c||void 0===c?void 0:c.token,p]),(0,a.useEffect)((()=>{if(!p||null===c||void 0===c||!c.token)return;const e=(t=u)&&""!==t?"string"===typeof t?t:"object"===typeof t?JSON.stringify({user:t.user,periodStart:t.periodStart}):String(t):"";var t;if(e===Ar.current)return;if(Sr.current)return console.debug("[selectedUser] Refresh in progress, queuing new selection:",e),void(kr.current=e);const r=async e=>{Sr.current=!0;try{nr(!0),Ar.current=e,Ur.drawings=[],bt([]),$r.current=0,Nt.current=null;const t=!u||""===u?"selectedUser-deselect":"selectedUser-select";console.debug(`[selectedUser] Performing full refresh: ${t}`,{to:e}),await Rr(),await na(t),await Gr()}catch(t){console.error("Error refreshing on selectedUser change:",t)}finally{if(nr(!1),Sr.current=!1,null!==kr.current){const t=kr.current;kr.current=null,t!==e&&(console.debug("[selectedUser] Processing queued selection:",t),setTimeout((()=>r(t)),0))}}};r(e)}),[u,p]);const Rr=async()=>{const e=_.current;if(!e)return;const t=e.getContext("2d");t&&(t.clearRect(0,0,at,nt),Br(Mr()),bt([]),$r.current=0,Qr(null),Jr(null),"select"===ie&&le("freehand"))},Er=async()=>{if(!ze){Ne(!0),nr(!0);try{Ur.drawings=[],bt([]),$r.current=0,Nt.current=null,await Rr(),await na("refresh-button"),await Gr(),zr()}catch(e){console.error("Error during canvas refresh:",e),(0,ht.tu)(e)}finally{Ne(!1),nr(!1)}}},Mr=()=>{var e,t;const r=(null===c||void 0===c||null===(e=c.user)||void 0===e?void 0:e.id)||`user_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,a=(null===c||void 0===c||null===(t=c.user)||void 0===t?void 0:t.username)||"MainUser";return new zt(r,a)},[Ur,Br]=(0,a.useState)((()=>Mr())),Wr=()=>`drawing_${Date.now()}_${Math.random().toString(36).substr(2,5)}`,$r=(0,a.useRef)(0),zr=()=>{Br((e=>{const t=e.drawings.some((e=>"filter"===e.drawingType)),r=e.drawings.filter((e=>"filter"===e.drawingType)).length;return console.log(`[updateFilterState] filterExists=${t}, filterCount=${r}`),Qe(t),e}))},Nr=async(e,t,r)=>{const a=Ur.drawings.findIndex((e=>"filter"===e.drawingType&&e.filterType===t));if(-1!==a){const e=[...Ur.drawings];Ur.drawings=Ur.drawings.filter(((e,t)=>t!==a)),Nt.current=null,Ht.current=!0,await Gr(),Ur.drawings=e}const n=e.getContext("2d"),s=n.getImageData(0,0,e.width,e.height),o=Fr(s,t,r);n.putImageData(o,0,0),Me(!0)},Fr=(e,t,r)=>{const a=e.data,n=new ImageData(new Uint8ClampedArray(a),e.width,e.height);switch(t){case"blur":return Or(n,r.intensity||5);case"hueShift":return Lr(n,r.hue||0,r.saturation||0);case"chalk":return _r(n,r.roughness||50,r.opacity||80);case"fade":return Hr(n,r.amount||30);case"vintage":return qr(n,r.sepia||60,r.vignette||40);case"neon":return Kr(n,r.intensity||15,r.color||180);default:return n}},Or=(e,t)=>{const r=e.data,a=e.width,n=e.height,s=Math.max(1,Math.floor(t)),o=new Uint8ClampedArray(r),i=new Uint8ClampedArray(r);for(let l=0;l<n;l++){let e=0,t=0,n=0,i=0,c=0;for(let o=-s;o<=s;o++)if(o>=0&&o<a){const s=4*(l*a+o);e+=r[s],t+=r[s+1],n+=r[s+2],i+=r[s+3],c++}for(let d=0;d<a;d++){const u=4*(l*a+d);o[u]=e/c,o[u+1]=t/c,o[u+2]=n/c,o[u+3]=i/c;const h=d-s;if(h>=0){const s=4*(l*a+h);e-=r[s],t-=r[s+1],n-=r[s+2],i-=r[s+3],c--}const p=d+s+1;if(p<a){const s=4*(l*a+p);e+=r[s],t+=r[s+1],n+=r[s+2],i+=r[s+3],c++}}}for(let l=0;l<a;l++){let e=0,t=0,r=0,c=0,d=0;for(let i=-s;i<=s;i++)if(i>=0&&i<n){const n=4*(i*a+l);e+=o[n],t+=o[n+1],r+=o[n+2],c+=o[n+3],d++}for(let u=0;u<n;u++){const h=4*(u*a+l);i[h]=e/d,i[h+1]=t/d,i[h+2]=r/d,i[h+3]=c/d;const p=u-s;if(p>=0){const n=4*(p*a+l);e-=o[n],t-=o[n+1],r-=o[n+2],c-=o[n+3],d--}const m=u+s+1;if(m<n){const n=4*(m*a+l);e+=o[n],t+=o[n+1],r+=o[n+2],c+=o[n+3],d++}}}return new ImageData(i,a,n)},Lr=(e,t,r)=>{const a=e.data;for(let n=0;n<a.length;n+=4){const e=a[n],s=a[n+1],o=a[n+2],i=Math.max(e,s,o)/255,l=Math.min(e,s,o)/255,c=i-l,d=i+l;let u=0;const h=d/2,p=0===c?0:h>.5?c/(2-d):c/d;if(0!==c){switch(i){case e/255:u=(s-o)/255/c+(s<o?6:0);break;case s/255:u=(o-e)/255/c+2;break;case o/255:u=(e-s)/255/c+4}u/=6}u=(u+t/360)%1;const m=Math.max(0,Math.min(1,p+r/100)),g=(e,t,r)=>(r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e);let y,f,x;if(0===m)y=f=x=h;else{const e=h<.5?h*(1+m):h+m-h*m,t=2*h-e;y=g(t,e,u+1/3),f=g(t,e,u),x=g(t,e,u-1/3)}a[n]=Math.round(255*y),a[n+1]=Math.round(255*f),a[n+2]=Math.round(255*x)}return e},_r=(e,t,r)=>{const a=e.data;for(let n=0;n<a.length;n+=4){const e=(Math.random()-.5)*(t/100)*255,s=r/100;a[n]=Math.max(0,Math.min(255,a[n]+e))*s,a[n+1]=Math.max(0,Math.min(255,a[n+1]+e))*s,a[n+2]=Math.max(0,Math.min(255,a[n+2]+e))*s,a[n+3]=a[n+3]*s}return e},Hr=(e,t)=>{const r=e.data,a=1-t/100;for(let n=0;n<r.length;n+=4)r[n+3]=r[n+3]*a;return e},qr=(e,t,r)=>{const a=e.data,n=e.width,s=e.height,o=t/100;for(let i=0;i<a.length;i+=4){const e=a[i],t=a[i+1],l=a[i+2];a[i]=Math.min(255,(.393*e+.769*t+.189*l)*o+e*(1-o)),a[i+1]=Math.min(255,(.349*e+.686*t+.168*l)*o+t*(1-o)),a[i+2]=Math.min(255,(.272*e+.534*t+.131*l)*o+l*(1-o));const c=i/4%n,d=Math.floor(i/4/n),u=n/2,h=s/2,p=1-Math.sqrt((c-u)**2+(d-h)**2)/Math.sqrt(u**2+h**2)*(r/100);a[i]*=p,a[i+1]*=p,a[i+2]*=p}return e},Kr=(e,t,r)=>{const a=e.data,n=e.width,s=e.height,o=t/25,i=new Uint8ClampedArray(a),l=r/360,c=255*Math.abs(Math.sin(l*Math.PI*2)),d=255*Math.abs(Math.sin((l+.333)*Math.PI*2)),u=255*Math.abs(Math.sin((l+.666)*Math.PI*2));for(let h=0;h<a.length;h+=4){const e=a[h+3];if(e>5){const t=a[h],r=a[h+1],n=a[h+2],s=o*(e/255),l=1+.8*o;i[h]=Math.min(255,t*l+c*s*.7),i[h+1]=Math.min(255,r*l+d*s*.7),i[h+2]=Math.min(255,n*l+u*s*.7);const p=60*o,m=(i[h]+i[h+1]+i[h+2])/3;if(m<p){const e=p/Math.max(m,1);i[h]=Math.min(255,i[h]*e),i[h+1]=Math.min(255,i[h+1]*e),i[h+2]=Math.min(255,i[h+2]*e)}}}return new ImageData(i,n,s)},Gr=async()=>{const e=rt.current||[];if(Ft.current)return void console.log("Drawing already in progress, skipping drawAllDrawings call");Ft.current=!0;const t=me?me.brushType:null,r=me?me.brushParams:null;try{nr(!0);const t=_.current;if(!t)return nr(!1),void(Ft.current=!1);const r=t.getContext("2d");if(!r)return nr(!1),void(Ft.current=!1);const s=new Set((Ur.drawings||[]).map((e=>e.drawingId))),o=(wt||[]).filter((e=>!s.has(e.drawingId))),i=[...Ur.drawings||[],...o],l=i.filter((e=>"filter"===e.drawingType)).map((e=>`${e.drawingId}:${e.filterType}`)).join(","),c=(null===e||void 0===e?void 0:e.length)>0?e.map((e=>`${e.type}:${e.x||e.x1||e.cx}:${e.y||e.y1||e.cy}`)).join(","):"",p=`${i.length}|${l}|${wt.length}|${(null===e||void 0===e?void 0:e.length)||0}|${c}`;if(Nt.current===p)return console.log("State unchanged, skipping redraw"),nr(!1),void(Ft.current=!1);let m=[];if(Nt.current&&Lt.current&&_t.current.size>0&&i.length>_t.current.size&&0===(null===e||void 0===e?void 0:e.length)){m=i.filter((e=>!_t.current.has(e.drawingId)));const e=m.some((e=>"filter"===e.drawingType||e.pathData&&"cut"===e.pathData.tool)),t=new Set(i.map((e=>e.drawingId))),r=Array.from(_t.current).every((e=>t.has(e)));m.length>0&&r&&!e&&m.length<=5?console.log(`[Optimization] Incremental rendering: adding ${m.length} new drawings`):(m=[],Lt.current=null,_t.current.clear())}else Lt.current=null,_t.current.clear();Ht.current=!1,Nt.current=p,Ot.current&&Ot.current.width===at&&Ot.current.height===nt||(Ot.current=document.createElement("canvas"),Ot.current.width=at,Ot.current.height=nt);const g=Ot.current.getContext("2d");g.imageSmoothingEnabled=!1,m.length>0&&Lt.current?(console.log("[drawAllDrawings] Using incremental rendering - copying from cache"),g.clearRect(0,0,at,nt),g.drawImage(Lt.current,0,0)):g.clearRect(0,0,at,nt);let y=null;if(e&&e.length>0){const t=`${L}_${e.length}`;if(Kt.current===t&&qt.current)y=qt.current,console.log("[drawAllDrawings] Using cached template layer");else{y=document.createElement("canvas"),y.width=at,y.height=nt;const r=y.getContext("2d");r.imageSmoothingEnabled=!1,r.save(),r.globalAlpha=.5;let a=0;for(const t of e)try{"line"===t.type?(r.beginPath(),r.moveTo(t.x1,t.y1),r.lineTo(t.x2,t.y2),r.strokeStyle=t.color||"#333",r.lineWidth=t.lineWidth||2,r.stroke(),a++):"rectangle"===t.type?(r.strokeStyle=t.stroke||"#333",r.lineWidth=t.lineWidth||2,t.fill&&"transparent"!==t.fill&&(r.fillStyle=t.fill,r.fillRect(t.x,t.y,t.width,t.height)),r.strokeRect(t.x,t.y,t.width,t.height),a++):"circle"===t.type?(r.beginPath(),r.arc(t.cx,t.cy,t.radius,0,2*Math.PI),r.strokeStyle=t.stroke||"#333",r.lineWidth=t.lineWidth||2,t.fill&&"transparent"!==t.fill&&(r.fillStyle=t.fill,r.fill()),r.stroke(),a++):"ellipse"===t.type?(r.beginPath(),r.ellipse(t.cx,t.cy,t.rx,t.ry,0,0,2*Math.PI),r.strokeStyle=t.stroke||"#333",r.lineWidth=t.lineWidth||2,t.fill&&"transparent"!==t.fill&&(r.fillStyle=t.fill,r.fill()),r.stroke(),a++):"text"===t.type?(r.fillStyle=t.color||"#333",r.font=`${t.bold?"bold ":""}${t.fontSize||16}px Arial`,r.fillText(t.text||"",t.x,t.y),a++):console.warn("Unknown template object type:",t.type)}catch(ua){console.warn("Failed to render template object:",t,ua)}r.restore(),qt.current=y,Kt.current=t,console.log("[drawAllDrawings] Cached new template layer")}}else console.log("No template objects to render");y&&g.drawImage(y,0,0);const f=new Set;try{i.forEach((e=>{e&&e.pathData&&"cut"===e.pathData.tool&&Array.isArray(e.pathData.originalStrokeIds)&&e.pathData.originalStrokeIds.forEach((e=>f.add(e)))}))}catch(ua){}const x=i.sort(((e,t)=>(void 0!==e.order?e.order:e.timestamp||e.ts||0)-(void 0!==t.order?t.order:t.timestamp||t.ts||0))),w=[],b=[];for(const e of x)"filter"===e.drawingType?b.push(e):w.push(e);const v=new Map,j=[];for(const e of w)if("stamp"===e.drawingType&&e.stampData&&e.stampData.image&&!e.stampData.emoji){const t=e.stampData.image;if(!v.has(t)){const e=new Promise((e=>{const r=new Image;r.onload=()=>{v.set(t,r),e(r)},r.onerror=()=>{console.error("[drawAllDrawings] Failed to pre-load stamp image:",t.substring(0,100)),v.set(t,null),e(null)},r.src=t}));j.push(e)}}j.length>0&&(console.log("[drawAllDrawings] Pre-loading",j.length,"stamp images"),await Promise.race([Promise.all(j),new Promise((e=>setTimeout((()=>{console.warn("[drawAllDrawings] Stamp image loading timeout after 2s - proceeding anyway"),e()}),2e3)))]),console.log("[drawAllDrawings] Stamp images loaded (or timeout reached)"));const A=new Set;let S=!1;const k=m.length>0?m:w;console.log(`[drawAllDrawings] Rendering ${k.length} drawings (incremental: ${m.length>0})`);for(const e of k){if(e&&e.pathData&&"cut"===e.pathData.tool){S=!0;try{Array.isArray(e.pathData.originalStrokeIds)&&e.pathData.originalStrokeIds.forEach((e=>A.add(e)))}catch(ua){}if(e.pathData&&e.pathData.rect){const t=e.pathData.rect;g.save();try{g.globalCompositeOperation="destination-out",g.fillStyle="rgba(0,0,0,1)",g.fillRect(Math.floor(t.x)-2,Math.floor(t.y)-2,Math.ceil(t.width)+4,Math.ceil(t.height)+4)}finally{g.restore()}y&&g.drawImage(y,Math.floor(t.x)-2,Math.floor(t.y)-2,Math.ceil(t.width)+4,Math.ceil(t.height)+4,Math.floor(t.x)-2,Math.floor(t.y)-2,Math.ceil(t.width)+4,Math.ceil(t.height)+4)}continue}if(e&&e.drawingId&&(f.has(e.drawingId)||A.has(e.drawingId)))continue;try{if(S&&e&&e.color&&"string"===typeof e.color&&"#ffffff"===e.color.toLowerCase())continue}catch(ua){}g.globalAlpha=1;let t=null,r=null;if(u&&("string"===typeof u?t=u:"object"===typeof u&&(t=u.user,r=u.periodStart)),t&&e.user!==t)g.globalAlpha=.1;else if(null!==r){const t=e.timestamp||e.order||0;(t<r||t>=r+3e5)&&(g.globalAlpha=.1)}if(void 0!==e.opacity&&1!==e.opacity&&(g.globalAlpha*=e.opacity),"stamp"===e.drawingType&&e.stampData&&e.stampSettings&&Array.isArray(e.pathData)&&e.pathData.length>0){const t=e.stampData,r=e.stampSettings,s=e.pathData[0];try{g.save(),g.translate(s.x,s.y),g.rotate((r.rotation||0)*Math.PI/180);const e=r.size||50;if(t.emoji)g.font=`${e}px serif`,g.textAlign="center",g.textBaseline="middle",g.fillText(t.emoji,0,0),console.log("[drawAllDrawings] Rendered emoji stamp inline:",t.emoji);else if(t.image){const n=v.get(t.image);var a;if(n)g.globalAlpha=(r.opacity||100)/100*g.globalAlpha,g.drawImage(n,-e/2,-e/2,e,e),console.log("[drawAllDrawings] Rendered image stamp inline");else console.warn("[drawAllDrawings] Image stamp not in cache:",null===(a=t.image)||void 0===a?void 0:a.substring(0,100))}g.restore()}catch(n){g.restore(),console.error("[drawAllDrawings] Error rendering stamp:",n)}}else if("stamp"===e.drawingType)console.warn("[drawAllDrawings] Stamp NOT rendered - missing requirements:",{drawingId:e.drawingId,drawingType:e.drawingType,hasStampData:!!e.stampData,hasStampSettings:!!e.stampSettings,pathDataIsArray:Array.isArray(e.pathData),pathDataLength:e.pathData?e.pathData.length:0,pathDataType:typeof e.pathData,pathDataValue:e.pathData,fullDrawing:e});else if(Array.isArray(e.pathData)){const t=e.pathData;if(t.length>0)if(e.brushType&&"normal"!==e.brushType&&me){console.log("Rendering advanced brush in drawAllDrawings:",{id:e.drawingId,brushType:e.brushType,pointCount:t.length}),g.save(),me.updateContext(g),g.beginPath(),g.moveTo(t[0].x,t[0].y),me.startStroke(t[0].x,t[0].y);for(let r=1;r<t.length;r++)me.drawWithType(t[r].x,t[r].y,e.lineWidth,e.color,e.brushType);g.restore()}else{e.brushType&&"normal"!==e.brushType&&console.log("Advanced brush found but no brushEngine:",{id:e.drawingId,brushType:e.brushType,hasBrushEngine:!!me}),g.beginPath(),g.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)g.lineTo(t[e].x,t[e].y);g.strokeStyle=e.color,g.lineWidth=e.lineWidth,g.lineCap=e.brushStyle||"round",g.lineJoin=e.brushStyle||"round",g.stroke()}}else if(e.pathData&&"shape"===e.pathData.tool)if(e.pathData.points){const t=e.pathData.points;g.save(),g.beginPath(),g.moveTo(t[0].x,t[0].y);for(let e=1;e<t.length;e++)g.lineTo(t[e].x,t[e].y);g.closePath(),g.fillStyle=e.color,g.fill(),g.restore()}else{const{type:t,start:r,end:a,brushStyle:n}=e.pathData;if(g.save(),g.fillStyle=e.color,g.lineWidth=e.lineWidth,"circle"===t){const e=Math.sqrt((a.x-r.x)**2+(a.y-r.y)**2);g.beginPath(),g.arc(r.x,r.y,e,0,2*Math.PI),g.fill()}else if("rectangle"===t)g.fillRect(r.x,r.y,a.x-r.x,a.y-r.y);else if("hexagon"===t){const e=Math.sqrt((a.x-r.x)**2+(a.y-r.y)**2);g.beginPath();for(let t=0;t<6;t++){const a=Math.PI/3*t,n=r.x+e*Math.cos(a),s=r.y+e*Math.sin(a);0===t?g.moveTo(n,s):g.lineTo(n,s)}g.closePath(),g.fill()}else if("line"===t){g.beginPath(),g.moveTo(r.x,r.y),g.lineTo(a.x,a.y),g.strokeStyle=e.color,g.lineWidth=e.lineWidth;const t=n||e.brushStyle||"round";g.lineCap=t,g.lineJoin=t,g.stroke()}g.restore()}else if(e.pathData&&"image"===e.pathData.tool){const{image:t,x:r,y:a,width:n,height:s}=e.pathData;let o=new Image;o.src=t,o.onload=()=>{g.drawImage(o,r,a,n,s)}}}if(!u){const e={};[...Ur.drawings||[],...wt||[]].forEach((t=>{try{const r=t.timestamp||t.order||0,a=3e5*Math.floor(r/3e5);e[a]||(e[a]=new Set),t.user&&e[a].add(t.user)}catch(ua){}}));const t=Object.keys(e).map((t=>({periodStart:parseInt(t),users:Array.from(e[t])})));if(t.sort(((e,t)=>t.periodStart-e.periodStart)),u&&""!==u){let e=!1;if("string"===typeof u){for(const r of t)if(r.users.includes(u)){e=!0;break}}else if("object"===typeof u&&u.user)for(const r of t)if(r.periodStart===u.periodStart&&r.users.includes(u.user)){e=!0;break}if(!e)try{h("")}catch(ua){}}d(t)}if(b.length>0){console.log("[drawAllDrawings] Applying",b.length,"filter(s)");for(const e of b)try{if(e.filterType&&e.filterParams){const t=g.getImageData(0,0,at,nt),r=Fr(t,e.filterType,e.filterParams);g.putImageData(r,0,0),console.log("[drawAllDrawings] Applied filter:",e.filterType)}}catch(ua){console.error("[drawAllDrawings] Error applying filter:",e.filterType,ua)}}if(console.log("[drawAllDrawings] Copying offscreen canvas to visible canvas. Total strokes rendered:",k.length,"filters:",b.length),r.imageSmoothingEnabled=!1,r.clearRect(0,0,at,nt),r.drawImage(Ot.current,0,0),0===b.length&&!i.some((e=>e.pathData&&"cut"===e.pathData.tool))){Lt.current&&Lt.current.width===at&&Lt.current.height===nt||(Lt.current=document.createElement("canvas"),Lt.current.width=at,Lt.current.height=nt);const e=Lt.current.getContext("2d");e.clearRect(0,0,at,nt),e.drawImage(Ot.current,0,0),_t.current=new Set(i.map((e=>e.drawingId))),console.log(`[drawAllDrawings] Cached ${_t.current.size} drawings for future incremental rendering`)}console.log("[drawAllDrawings] Canvas update complete")}catch(ua){console.error("Error in drawAllDrawings:",ua)}finally{me&&t&&(me.setBrushType(t),r&&me.setBrushParams(r)),nr(!1),Ft.current=!1}};Ir.current=Gr;const Yr=async()=>{if(hr){if(0!==He.length)if(ze)ur("Please wait for the canvas to refresh before undoing again.");else try{await(async e=>{let{auth:t,currentUser:r,undoStack:a,setUndoStack:n,setRedoStack:s,userData:o,drawAllDrawings:i,refreshCanvasButtonHandler:l,checkUndoRedoAvailability:c,roomId:d}=e;if(0!==a.length)if(Rt)console.log("UNDO DEBUG: Another undo/redo is in progress, skipping");else{Rt=!0;try{const e=a[a.length-1];console.log("UNDO DEBUG: undoStack.length =",a.length),console.log("UNDO DEBUG: lastAction =",e);let r=!1;try{if("cut"===e.type){console.log("UNDO DEBUG: Processing cut operation undo"),o.drawings=o.drawings.filter((t=>{if(t.drawingId===e.cutRecord.drawingId)return!1;for(const r of Object.values(e.replacementSegments))if(r.some((e=>e.drawingId===t.drawingId)))return!1;return!0})),e.affectedDrawings.forEach((e=>{o.drawings.push(e)})),i();const a=await(0,v.undoRoomAction)(t.token,d);"ok"===a.status||"success"===a.status?(console.log("UNDO DEBUG: Cut record undone on backend"),r=!1):"noop"===a.status?console.log("Backend has no more undo actions available"):console.error("Undo failed:",a.message)}else if("paste"===e.type){console.log("UNDO DEBUG: Processing paste operation undo"),console.log("UNDO DEBUG: Paste undo - pastedDrawings count:",e.pastedDrawings.length),console.log("UNDO DEBUG: Paste undo - pastedDrawing IDs:",e.pastedDrawings.map((e=>e.drawingId)).join(",")),console.log("UNDO DEBUG: Paste undo - userData.drawings before filter:",o.drawings.length);const a=await(0,v.undoRoomAction)(t.token,d);"ok"===a.status||"success"===a.status?r=!1:"noop"===a.status?console.log("Backend has no more undo actions available"):console.error("Undo failed:",a.message);const n=o.drawings.length;o.drawings=o.drawings.filter((t=>!e.pastedDrawings.some((e=>e.drawingId===t.drawingId))));const s=o.drawings.length;console.log("UNDO DEBUG: Paste undo - userData.drawings after filter:",s,"(removed",n-s,"drawings)"),i()}else{console.log("UNDO DEBUG: lastAction =",e),console.log("UNDO DEBUG: userData.drawings before filter =",o.drawings.length),console.log("UNDO DEBUG: looking for drawingId =",e.drawingId),o.drawings=o.drawings.filter((t=>(console.log("UNDO DEBUG: comparing",t.drawingId,"vs",e.drawingId),t.drawingId!==e.drawingId))),console.log("UNDO DEBUG: userData.drawings after filter =",o.drawings.length),i();const a=await(0,v.undoRoomAction)(t.token,d);console.log("UNDO DEBUG: backend result =",a),"noop"===a.status?(console.log("UNDO DEBUG: Backend has nothing to undo, but we already removed locally"),r=!1):"ok"===a.status||"success"===a.status?(console.log("UNDO DEBUG: Backend undo successful"),r=!1):(console.error("Undo failed:",a.message),o.drawings.push(e),i(),r=!1)}n(a.slice(0,a.length-1)),s((t=>[...t,e]))}catch(u){console.error("Undo error:",u),n([]),s([]),(0,pt.A)("Undo failed due to local cache being cleared out.")}finally{Rt=!1,r&&l(),c&&c()}}catch(u){console.error("Unexpected undo error:",u),Rt=!1}}})({auth:c,currentUser:(null===c||void 0===c?void 0:c.username)||"anonymous",undoStack:He,setUndoStack:qe,setRedoStack:Ge,userData:Ur,drawAllDrawings:Gr,refreshCanvasButtonHandler:Er,roomId:p});try{await Et(c,Ve,Je,p)}catch(ua){}zr()}catch(e){console.error("Error during undo:",e)}}else ur("Undo is disabled in view-only mode.")},Vr=async()=>{if(hr){if(0!==Ke.length)if(ze)ur("Please wait for the canvas to refresh before redoing again.");else try{await(async e=>{let{auth:t,currentUser:r,redoStack:a,setRedoStack:n,setUndoStack:s,userData:o,drawAllDrawings:i,refreshCanvasButtonHandler:l,checkUndoRedoAvailability:c,roomId:d}=e;if(0===a.length)return;if(Rt)return void console.log("REDO DEBUG: Another undo/redo is in progress, skipping");Rt=!0;let u=!0;try{const e=a[a.length-1];try{if("cut"===e.type){console.log("REDO DEBUG: Processing cut operation redo"),e.affectedDrawings.forEach((e=>{o.drawings=o.drawings.filter((t=>t.drawingId!==e.drawingId))})),Object.values(e.replacementSegments).forEach((e=>{e.forEach((e=>{o.drawings.push(e)}))})),o.addDrawing(e.cutRecord),i();const r=await(0,v.redoRoomAction)(t.token,d);"ok"===r.status||"success"===r.status?(console.log("REDO DEBUG: Cut record redone on backend"),u=!1):"noop"===r.status?console.log("Backend has no more redo actions available"):console.error("Redo failed:",r.message)}else if("paste"===e.type){console.log("REDO DEBUG: Processing paste operation redo");for(let r=0;r<e.backendCount;r++){const e=await(0,v.redoRoomAction)(t.token,d);"ok"===e.status||"success"===e.status||("noop"===e.status?console.log("Backend has no more redo actions available"):console.error("Redo failed:",e.message))}e.pastedDrawings.forEach((e=>{o.drawings.push(e)})),i(),u=!1}else{o.drawings.push(e),i();const r=await(0,v.redoRoomAction)(t.token,d);if("noop"===r.status)return n([]),s([]),void(0,pt.A)("Redo failed due to local cache being cleared out.");"ok"===r.status||"success"===r.status?(console.log("REDO DEBUG: Redo successful"),u=!1):"ok"!==r.status&&"success"!==r.status&&(console.error("Redo failed:",r.message),o.drawings=o.drawings.filter((t=>t.drawingId!==e.drawingId)),i())}n(a.slice(0,a.length-1)),s((t=>[...t,e]))}catch(h){console.error("Error during redo:",h)}finally{Rt=!1,u&&l(),c&&c()}}catch(h){console.error("Redo outer error:",h),Rt=!1}})({auth:c,currentUser:(null===c||void 0===c?void 0:c.username)||"anonymous",redoStack:Ke,setRedoStack:Ge,setUndoStack:qe,userData:Ur,drawAllDrawings:Gr,refreshCanvasButtonHandler:Er,roomId:p});try{await Et(c,Ve,Je,p)}catch(ua){}zr()}catch(e){console.error("Error during redo:",e)}}else ur("Redo is disabled in view-only mode.")};(0,a.useEffect)((()=>{fr.current||(fr.current=new ee);const e=fr.current,t=[{id:"commands.palette",label:"Open Command Palette",description:"Quick access to all commands",keywords:["palette","search","find"],category:"Commands",action:()=>mr(!0),shortcut:{key:"k",modifiers:{ctrl:!0}}},{id:"commands.shortcuts",label:"Show Keyboard Shortcuts",description:"View all available keyboard shortcuts",keywords:["help","shortcuts","keys"],category:"Commands",action:()=>yr(!0),shortcut:{key:"/",modifiers:{ctrl:!0}}},{id:"commands.cancel",label:"Cancel / Escape",description:"Cancel current action or close dialogs",keywords:["cancel","escape","close"],category:"Commands",action:()=>{pr?mr(!1):gr?yr(!1):X&&J(!1)},shortcut:{key:"Escape",modifiers:{}}},{id:"edit.undo",label:"Undo",description:"Undo the last action",keywords:["undo","revert"],category:"Edit",action:Yr,shortcut:{key:"z",modifiers:{ctrl:!0}},enabled:()=>hr&&He.length>0},{id:"edit.redo",label:"Redo",description:"Redo the last undone action",keywords:["redo","repeat"],category:"Edit",action:Vr,shortcut:{key:"z",modifiers:{ctrl:!0,shift:!0}},enabled:()=>hr&&Ke.length>0},{id:"canvas.clear",label:"Clear Canvas",description:"Remove all strokes from canvas",keywords:["clear","delete","reset"],category:"Canvas",action:()=>{hr?_e(!0):ur("Canvas clearing is disabled in view-only mode")},shortcut:{key:"k",modifiers:{ctrl:!0,shift:!0}},enabled:()=>hr},{id:"canvas.refresh",label:"Refresh Canvas",description:"Reload canvas from server",keywords:["refresh","reload"],category:"Canvas",action:Er,shortcut:{key:"r",modifiers:{ctrl:!0}}},{id:"canvas.settings",label:"Canvas Settings",description:"Open canvas settings",keywords:["settings","preferences"],category:"Canvas",action:()=>{I&&I()},shortcut:{key:",",modifiers:{ctrl:!0}},visible:()=>!!I},{id:"tool.pen",label:"Select Pen Tool",description:"Switch to freehand drawing",keywords:["pen","draw","brush"],category:"Tools",action:()=>{hr&&(le("freehand"),ur("Pen tool selected"))},shortcut:{key:"p",modifiers:{}},enabled:()=>hr},{id:"tool.eraser",label:"Select Eraser",description:"Switch to eraser mode",keywords:["eraser","erase","remove"],category:"Tools",action:()=>{hr&&(le("eraser"),ur("Eraser selected"))},shortcut:{key:"e",modifiers:{}},enabled:()=>hr},{id:"tool.rectangle",label:"Select Rectangle Tool",description:"Draw rectangles and squares",keywords:["rectangle","rect","square"],category:"Tools",action:()=>{hr&&(le("shape"),de("rectangle"),ur("Rectangle tool selected"))},shortcut:{key:"r",modifiers:{}},enabled:()=>hr},{id:"tool.circle",label:"Select Circle Tool",description:"Draw circles and ellipses",keywords:["circle","oval","ellipse"],category:"Tools",action:()=>{hr&&(le("shape"),de("circle"),ur("Circle tool selected"))},shortcut:{key:"c",modifiers:{}},enabled:()=>hr},{id:"tool.line",label:"Select Line Tool",description:"Draw straight lines",keywords:["line","straight"],category:"Tools",action:()=>{hr&&(le("shape"),de("line"),ur("Line tool selected"))},shortcut:{key:"l",modifiers:{}},enabled:()=>hr}];re.clear(),t.forEach((e=>{re.register(e,{allowOverwrite:!0})})),e.clear(),t.forEach((t=>{t.shortcut&&e.register(t.shortcut.key,t.shortcut.modifiers,(()=>{t.enabled&&!t.enabled()||t.action()}),t.label,t.category)}));const r=t=>e.handleKeyDown(t);return document.addEventListener("keydown",r),()=>{document.removeEventListener("keydown",r),e.clear()}}),[hr,He,Ke,Yr,Vr,Er,I,pr,gr,X]);const{selectionStart:Xr,setSelectionStart:Jr,selectionRect:Zr,setSelectionRect:Qr,cutImageData:ea,setCutImageData:ta,handleCutSelection:ra}=Mt(0,V,Ur,Wr,Gr,p,Ve,Je,c,F,ur),aa=async e=>{if(!hr)return ur("Editing is disabled in view-only mode."),void le("freehand");if(!ea||!Array.isArray(ea)||0===ea.length)return ur("No cut selection available to paste."),void le("freehand");const t=_.current,r=t.getBoundingClientRect(),a=t.width/r.width,n=t.height/r.height,s=(e.clientX-r.left)*a,o=(e.clientY-r.top)*n;let i=1/0,l=1/0;if(ea.forEach((e=>{Array.isArray(e.pathData)?e.pathData.forEach((e=>{i=Math.min(i,e.x),l=Math.min(l,e.y)})):e.pathData&&"shape"===e.pathData.tool&&(e.pathData.points&&Array.isArray(e.pathData.points)?e.pathData.points.forEach((e=>{i=Math.min(i,e.x),l=Math.min(l,e.y)})):"line"===e.pathData.type&&(e.pathData.start&&(i=Math.min(i,e.pathData.start.x),l=Math.min(l,e.pathData.start.y)),e.pathData.end&&(i=Math.min(i,e.pathData.end.x),l=Math.min(l,e.pathData.end.y))))})),i===1/0||l===1/0)return void ur("Invalid cut data.");const d=s-i,u=o-l;const h=ea.map((e=>{let t;if(Array.isArray(e.pathData))t=e.pathData.map((e=>({x:e.x+d,y:e.y+u})));else{if(!e.pathData||"shape"!==e.pathData.tool)return null;if(e.pathData.points&&Array.isArray(e.pathData.points)){const r=e.pathData.points.map((e=>({x:e.x+d,y:e.y+u})));t={...e.pathData,points:r}}else if("line"===e.pathData.type){const r={x:e.pathData.start.x+d,y:e.pathData.start.y+u},a={x:e.pathData.end.x+d,y:e.pathData.end.y+u};t={...e.pathData,start:r,end:a}}}const r={brushStyle:e.brushStyle,brushType:e.brushType,brushParams:e.brushParams,drawingType:e.drawingType,stampData:e.stampData,stampSettings:e.stampSettings,filterType:e.filterType,filterParams:e.filterParams};return new Dt(Wr(),e.color,e.lineWidth,t,Date.now(),V,r)})).filter(Boolean);console.log("[handlePaste] Starting optimistic paste operation:",{drawingCount:h.length,drawingTypes:h.map((e=>e.drawingType||"stroke"))});const m=Wr();for(const c of h)c.roomId=p,c.parentPasteId=m,c.pathData||(c.pathData={}),c.pathData.parentPasteId=m,Ur.addDrawing(c);console.log("[handlePaste] Attached parentPasteId to all drawings:",m),Gr(),Ge([]);try{const t=await async function(t,r){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0;const i=(null===r||void 0===r?void 0:r.token)||(0,ht.c4)();if(!i||!a.roomId)throw console.error("submitBatchToDatabase: Missing auth token or roomId"),new Error("Missing auth token or roomId");if(!Array.isArray(t)||0===t.length)return{processed:0,failed:0};try{let c=null;try{c=(0,j.T)(r)}catch(e){c=null}c||(c="Unknown");const d=50;let u=0,h=0;for(let e=0;e<t.length;e+=d){const r=t.slice(e,e+d),n=r.map((e=>{const t=e.getMetadata?e.getMetadata():{brushStyle:e.brushStyle||"round",brushType:e.brushType||"normal",brushParams:e.brushParams||{},drawingType:e.drawingType||"stroke",stampData:e.stampData||null,stampSettings:e.stampSettings||null,filterType:e.filterType||null,filterParams:e.filterParams||{}},r={drawingId:e.drawingId,color:e.color,lineWidth:e.lineWidth,pathData:e.pathData,timestamp:e.timestamp,user:c,roomId:a.roomId,skipUndoStack:a.skipUndoStack||!1,brushStyle:t.brushStyle,brushType:t.brushType,brushParams:t.brushParams,drawingType:t.drawingType,stampData:t.stampData,stampSettings:t.stampSettings,filterType:t.filterType,filterParams:t.filterParams,metadata:t};return e.parentPasteId?r.parentPasteId=e.parentPasteId:e.pathData&&e.pathData.parentPasteId&&(r.parentPasteId=e.pathData.parentPasteId),r}));let s=null,p=null;if("secure"===a.roomType){if(!kt())throw(0,pt.A)("Please connect your wallet to draw in this secure room","warning"),new Error("Wallet not connected for secure room");try{const e=await St(a.roomId,n[0]);s=e.signature,p=e.signerPubKey}catch(l){throw console.error("Failed to sign batch strokes:",l),(0,pt.A)("Failed to sign strokes with wallet: "+l.message,"error"),l}}console.log(`Submitting batch ${e/d+1}: ${n.length} strokes`);const m=await Tt((async()=>await(0,v.postRoomStrokesBatch)(i,a.roomId,n,{skipUndoStack:a.skipUndoStack||!1,signature:s,signerPubKey:p})),3,1e3);u+=m.processed||0,h+=m.failed||0,o&&o({current:e+r.length,total:t.length,processed:u,failed:h}),e+d<t.length&&await new Promise((e=>setTimeout(e,100)))}return!a.skipUndoCheck&&n&&s&&await Et({token:i},n,s,a.roomId),{processed:u,failed:h}}catch(c){throw console.error("Error submitting batch strokes:",c),c}}(h,c,{roomId:p,roomType:F,skipUndoStack:!0},Ve,Je);console.log("[handlePaste] Batch submission complete:",t);const r=h.map((e=>e.drawingId)),a=new Dt(m,"#FFFFFF",1,{tool:"paste",cut:!1,pastedDrawingIds:r},Date.now(),V);await It(a,c,{roomId:p,roomType:F},Ve,Je),console.log("[handlePaste] Paste record submitted successfully"),qe((e=>[...e,{type:"paste",pastedDrawings:h,backendCount:1}])),p&&Et(c,Ve,Je,p),ta([]),le("freehand")}catch(g){console.error("Failed to complete paste operation:",g),Ur.drawings=Ur.drawings.filter((e=>e.parentPasteId!==m)),Gr(),(0,ht.tu)(g)}K.current=[]},na=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;try{e?(console.log("mergedRefreshCanvas called from:",e,"==="),console.debug("mergedRefreshCanvas called from:",e)):(console.log("mergedRefreshCanvas called (no label) ==="),console.debug("mergedRefreshCanvas called"))}catch(ua){}try{if(it)return console.debug("[mergedRefreshCanvas] deferring because isPanning=true, marking pendingPanRefreshRef"),void(xt.current=!0)}catch(ua){}"undo-event"!==e&&"redo-event"!==e||(console.log("[mergedRefreshCanvas] Forcing complete state reset for undo/redo"),Nt.current=null),nr(!0);const t=await Pt($r.current,Ur,Gr,Vt?Vt.start:void 0,Vt?Vt.end:void 0,{roomId:p,auth:c,clearLastDrawnState:()=>{console.log("[mergedRefreshCanvas] Clearing lastDrawnStateRef to force redraw"),Nt.current=null}}),r=[...wt];$r.current=t;const a=(e,t)=>{if(!e||!t)return!1;if(e.drawingId&&t.drawingId&&e.drawingId===t.drawingId)return!0;try{const r=e.user===t.user,a=e.timestamp||e.ts||0,n=t.timestamp||t.ts||0,s=Math.abs(a-n)<1e3,o=Array.isArray(e.pathData)?e.pathData.length:e.pathData&&e.pathData.points?e.pathData.points.length:0,i=Array.isArray(t.pathData)?t.pathData.length:t.pathData&&t.pathData.points?t.pathData.points.length:0,l=Math.abs(o-i)<=1;return r&&s&&l}catch(ua){return!1}};try{const e=new Set;(Ur.drawings||[]).forEach((t=>{t.pathData&&"cut"===t.pathData.tool&&Array.isArray(t.pathData.originalStrokeIds)&&t.pathData.originalStrokeIds.forEach((t=>e.add(t)))})),e.size>0&&(Ur.drawings=(Ur.drawings||[]).filter((t=>!e.has(t.drawingId))))}catch(ua){}const n=p?Tr.current[p]:null,s=[];r.forEach((e=>{try{const t=e.timestamp||e.ts||0;if(n&&t<n)return}catch(ua){}const t=Ur.drawings.find((t=>a(t,e)));if(t){if("stamp"===e.drawingType&&e.stampData){const r=t;if(!r.stampData||!r.stampData.image&&e.stampData.image){console.warn("Backend stamp missing stampData, using pending version:",{drawingId:e.drawingId,pendingHasStampData:!!e.stampData,backendHasStampData:!!r.stampData,pendingImageLength:e.stampData.image?e.stampData.image.length:0,backendImageLength:r.stampData&&r.stampData.image?r.stampData.image.length:0});const t=Ur.drawings.findIndex((t=>a(t,e)));-1!==t&&(Ur.drawings[t]=e)}}e.drawingId&&Ct.current.add(e.drawingId)}else Ur.drawings.push(e),s.push(e)})),bt(s);const o=new Map,i=[];(Ur.drawings||[]).forEach((e=>{if("filter"===e.drawingType&&e.filterType){const t=o.get(e.filterType);(!t||(e.timestamp||0)>(t.timestamp||0))&&o.set(e.filterType,e)}else i.push(e)}));const l=[...i,...Array.from(o.values())];console.log(`[mergedRefreshCanvas] Deduplicated filters. Filter count: ${o.size}, Total drawings: ${l.length}`),Ur.drawings=l;const d=new zt(Ur.userId,Ur.username);d.drawings=l,Br(d),sa(),requestAnimationFrame((()=>{Gr(),nr(!1),zr()}))},sa=()=>{try{const e=[],t=new Map;(Ur.drawings||[]).forEach((r=>{if("stamp"===r.drawingType&&r.stampData){const a=r.stampData;if(a.emoji&&!a.image)return;if(a.image){const r=a.image.substring(0,100);t.has(r)||(t.set(r,!0),e.push({id:`stamp-${Date.now()}-${e.length}`,name:a.name||"Custom Stamp",category:a.category||"custom",image:a.image,emoji:a.emoji}))}}})),e.length>0&&(console.log("Extracted custom stamps from backend:",e.length),Se(e))}catch(e){console.error("Error extracting custom stamps:",e)}},oa=async e=>{if(it&&1===e.button)return void lt(!1);if(!X)return;if(J(!1),!hr)return void(K.current=[]);H.current=null;const t=_.current,r=t.getBoundingClientRect(),a=e.clientX-r.left,n=e.clientY-r.top;if("eraser"===ie||"freehand"===ie){const e=new Dt(`drawing_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,Z,se,K.current,Date.now(),V,{brushStyle:ue,brushType:ge,brushParams:fe,drawingType:"stroke"});e.roomId=p,e.brushType=ge,e.brushParams=fe,qe((t=>[...t,e])),Ge([]);try{Ur.addDrawing(e),bt((t=>[...t,e])),requestAnimationFrame((()=>{Gr()}));const t=async()=>{try{console.log("Submitting queued stroke:",{drawingId:e.drawingId,pathLength:K.current.length}),await It(e,c,{roomId:p,roomType:F},Ve,Je),Ct.current.add(e.drawingId),p&&Et(c,Ve,Je,p)}catch(t){console.error("Error during queued freehand submission:",t),bt((t=>t.filter((t=>t.drawingId!==e.drawingId)))),(0,ht.tu)(t)}};jt.current.push(t),Pr()}catch(s){console.error("Error preparing freehand stroke:",s),(0,ht.tu)(s)}finally{Ne(!1)}K.current=[]}else if("shape"===ie){if(!he)return;const e={x:a,y:n},r=t.getContext("2d");if(r.save(),r.fillStyle=Z,r.lineWidth=se,r.setLineDash([]),"circle"===ce){const t=Math.sqrt((e.x-he.x)**2+(e.y-he.y)**2);r.beginPath(),r.arc(he.x,he.y,t,0,2*Math.PI),r.fill()}else if("rectangle"===ce)r.fillRect(he.x,he.y,e.x-he.x,e.y-he.y);else if("hexagon"===ce){const t=Math.sqrt((e.x-he.x)**2+(e.y-he.y)**2);r.beginPath();for(let e=0;e<6;e++){const a=Math.PI/3*e,n=he.x+t*Math.cos(a),s=he.y+t*Math.sin(a);0===e?r.moveTo(n,s):r.lineTo(n,s)}r.closePath(),r.fill()}else"line"===ce&&(r.beginPath(),r.moveTo(he.x,he.y),r.lineTo(e.x,e.y),r.strokeStyle=Z,r.lineWidth=se,r.lineCap=ue,r.lineJoin=ue,r.stroke());r.restore();const o={tool:"shape",type:ce,start:he,end:e,brushStyle:"line"===ce?ue:void 0},i=new Dt(`drawing_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,Z,se,o,Date.now(),V,{brushStyle:"line"===ce?ue:"round",brushType:ge,brushParams:fe,drawingType:"shape"});i.roomId=p,Ur.addDrawing(i),bt((e=>[...e,i])),requestAnimationFrame((()=>{Gr()})),qe((e=>[...e,i])),Ge([]);const l=async()=>{try{await It(i,c,{roomId:p,roomType:F},Ve,Je),Ct.current.add(i.drawingId),p&&Et(c,Ve,Je,p)}catch(s){console.error("Error during queued shape submission:",s),bt((e=>e.filter((e=>e.drawingId!==i.drawingId)))),(0,ht.tu)(s)}};jt.current.push(l),Pr(),pe(null)}else if("select"===ie){J(!1);try{await na()}catch(s){console.error("Error during select submission or refresh:",s)}finally{Ne(!1)}na()}else if("stamp"===ie&&De.current){const{x:e,y:t,stamp:r,settings:a}=De.current;await(async(e,t,r,a)=>{const n=_.current;if(!n||!r)return;const o=n.getContext("2d");if(r.emoji){o.save(),o.globalAlpha=a.opacity/100,o.translate(e,t),o.rotate(a.rotation*Math.PI/180);const n=a.size;o.font=`${n}px serif`,o.textAlign="center",o.textBaseline="middle",o.fillText(r.emoji,0,0),o.restore()}else if(r.image)try{const n=await new Promise(((e,t)=>{const a=new Image;a.onload=()=>e(a),a.onerror=()=>t(new Error("Failed to load image")),a.src=r.image}));o.save(),o.globalAlpha=a.opacity/100,o.translate(e,t),o.rotate(a.rotation*Math.PI/180);const s=a.size;o.drawImage(n,-s/2,-s/2,s,s),o.restore()}catch(s){var i;console.error("Failed to load stamp image:",null===(i=r.image)||void 0===i?void 0:i.substring(0,100),s)}const l=new Dt(Wr(),Z,se,[{x:e,y:t}],Date.now(),V,{drawingType:"stamp",stampData:r,stampSettings:a});l.roomId=p,Ur.addDrawing(l),bt((e=>[...e,l])),qe((e=>[...e,l])),Ge([]);try{const e=async()=>{try{console.log("Submitting queued stamp:",{drawingId:l.drawingId,stampData:l.stampData}),await It(l,c,{roomId:p,roomType:F},Ve,Je),console.log("Stamp submitted successfully:",l.drawingId),Ct.current.add(l.drawingId),p&&Et(c,Ve,Je,p)}catch(s){console.error("Error during queued stamp submission:",s),bt((e=>e.filter((e=>e.drawingId!==l.drawingId)))),(0,ht.tu)(s),ur("Failed to save stamp. Please try again.")}};jt.current.push(e),Pr()}catch(s){console.error("Error preparing stamp submission:",s),(0,ht.tu)(s),ur("Failed to prepare stamp. Please try again.")}})(e,t,r,a),Ce(null),De.current=null}};(0,a.useEffect)((()=>{Ur.drawings=[],Ne(!0);try{if(_.current){const e=_.current.getContext("2d");e&&e.clearRect(0,0,_.current.width,_.current.height),Gr()}}catch{}(async()=>{try{await na()}finally{Ne(!1)}})()}),[p,b]),(0,a.useEffect)((()=>{Ne(!0),Rr(),na().then((()=>{setTimeout((()=>{Ne(!1)}),500)}))}),[u]),(0,a.useEffect)((()=>{Ve(He.length>0),Je(Ke.length>0)}),[He,Ke]);const[ia,la]=(0,a.useState)(!0),[ca,da]=(0,a.useState)(!1);return(0,R.jsxs)("div",{className:"Canvas-wrapper",style:{pointerEvents:"auto"},children:[(0,R.jsxs)(n.A,{sx:{position:"absolute",top:8,left:"50%",transform:"translateX(-50%)",zIndex:2100,bgcolor:"background.paper",px:2,py:.5,borderRadius:1.5,display:"flex",alignItems:"center",gap:1,boxShadow:"0 6px 14px rgba(0,0,0,0.12)",border:"1px solid rgba(0,0,0,0.08)"},children:[(0,R.jsx)(f.A,{variant:"subtitle2",sx:{fontWeight:"bold"},children:D||"Master (not in a room)"}),Gt&&Vt&&(0,R.jsxs)(f.A,{variant:"caption",sx:{whiteSpace:"nowrap",ml:1},children:[new Date(Vt.start).toLocaleString()," \u2014"," ",new Date(Vt.end).toLocaleString()]}),p&&(0,R.jsx)(w.A,{size:"small",onClick:()=>{try{Yt(!1),Xt(null),er(""),rr(""),h("")}catch(ua){}T()},sx:{ml:1},children:"Return to Master"})]}),P&&(0,R.jsx)(n.A,{sx:{position:"absolute",top:56,left:"50%",transform:"translateX(-50%)",zIndex:2200,pointerEvents:"none"},children:(0,R.jsxs)(l.A,{elevation:6,sx:{px:2,py:.5,bgcolor:"rgba(33,33,33,0.86)",color:"white",borderRadius:1},children:[(0,R.jsx)(f.A,{variant:"caption",sx:{fontWeight:"bold",letterSpacing:.5},children:"Archived \u2014 View Only"}),M&&(0,R.jsx)(n.A,{sx:{mt:1,display:"flex",justifyContent:"center"},children:(0,R.jsx)(w.A,{size:"small",color:"error",variant:"contained",onClick:()=>lr(!0),sx:{pointerEvents:"all"},children:"Delete permanently"})})]})}),"secure"===F&&!O&&(0,R.jsx)(n.A,{sx:{position:"absolute",top:56,left:"50%",transform:"translateX(-50%)",zIndex:2200,pointerEvents:"none"},children:(0,R.jsx)(l.A,{elevation:6,sx:{px:2,py:.5,bgcolor:"rgba(255, 152, 0, 0.9)",color:"white",borderRadius:1},children:(0,R.jsx)(f.A,{variant:"caption",sx:{fontWeight:"bold",letterSpacing:.5},children:"\u26a0 Wallet Not Connected \u2014 Canvas Locked"})})}),(0,R.jsx)(n.A,{sx:{position:"fixed",top:72,left:"50%",transform:"translateX(-50%)",zIndex:2150,maxWidth:"90%",width:"600px"},children:(0,R.jsx)(E,{isHealthy:xr,queueSize:br})}),(0,R.jsxs)(m.A,{open:ir,onClose:()=>{lr(!1),dr("")},children:[(0,R.jsx)(g.A,{children:"Permanently delete room"}),(0,R.jsxs)(y.A,{children:[(0,R.jsx)(A.A,{color:"error",children:"This will permanently delete this room and all its data for every user. This action is irreversible."}),(0,R.jsxs)(A.A,{sx:{mt:1},children:["To confirm, type ",(0,R.jsx)("strong",{children:"DELETE"})," below."]}),(0,R.jsx)(S.A,{fullWidth:!0,value:cr,onChange:e=>dr(e.target.value),placeholder:"Type DELETE to confirm",sx:{mt:1}})]}),(0,R.jsxs)(x.A,{children:[(0,R.jsx)(w.A,{onClick:()=>{lr(!1),dr("")},children:"Cancel"}),(0,R.jsx)(w.A,{variant:"contained",color:"error",disabled:"DELETE"!==cr,onClick:async()=>{try{const{deleteRoom:e}=await Promise.resolve().then(r.bind(r,75267));await e(c.token,p),or({open:!0,message:"Room permanently deleted",duration:4e3});try{T()}catch(ua){}}catch(ua){console.error("Permanent delete failed",ua),or({open:!0,message:"Failed to delete room: "+((null===ua||void 0===ua?void 0:ua.message)||ua),duration:4e3})}finally{lr(!1),dr("")}},children:"Delete permanently"})]})]}),(0,R.jsx)("canvas",{ref:_,width:at,height:nt,className:"Canvas-element",style:{transform:`translate(${st.x}px, ${st.y}px)`},onMouseDown:e=>{const t=_.current,r=t.getBoundingClientRect(),a=e.clientX-r.left,n=e.clientY-r.top;if(1!==e.button){if(hr)if("eraser"===ie||"freehand"===ie){const e=t.getContext("2d");e.strokeStyle=Z,e.lineWidth=se,e.lineCap=ue,e.lineJoin=ue,me?(me.updateContext(e),me.startStroke(a,n),"normal"===ge&&(e.beginPath(),e.moveTo(a,n))):(e.beginPath(),e.moveTo(a,n)),K.current=[{x:a,y:n}],J(!0)}else if("shape"===ie){pe({x:a,y:n}),J(!0);const e=t.toDataURL();let r=new Image;r.src=e,H.current=r}else if("select"===ie){Jr({x:a,y:n}),Qr(null),J(!0);const e=t.toDataURL();let r=new Image;r.src=e,H.current=r}else"paste"===ie?aa(e):"stamp"===ie&&we&&ve&&(Ce({x:a,y:n,stamp:we,settings:ve}),De.current={x:a,y:n,stamp:we,settings:ve},J(!0))}else{lt(!0),dt.current={x:e.clientX,y:e.clientY},ut.current={...st},nr(!0);try{const e=Date.now(),t=e-gt.current;console.debug(`[pan] now=${e} lastRefresh=${gt.current} diff=${t} cooldown=2000`),t>mt?(gt.current=e,console.debug("[pan] triggering immediate mergedRefreshCanvas"),na("pan-start").finally((()=>nr(!1)))):(yt.current=!0,console.debug("[pan] skipped immediate refresh; scheduling deferred refresh on mouseup"),ft.current&&clearTimeout(ft.current),ft.current=setTimeout((()=>{yt.current&&(yt.current=!1,gt.current=Date.now(),console.debug("[pan] deferred timer firing mergedRefreshCanvas"),na("pan-deferred").finally((()=>nr(!1)))),ft.current=null}),Math.max(200,mt-t)),nr(!1))}catch(e){na().finally((()=>nr(!1)))}}},onMouseMove:e=>{if(it)return void(e=>{if(!it)return;if(!(4&e.buttons))return lt(!1),void(ut.current={...st});const t=e.clientX-dt.current.x,r=e.clientY-dt.current.y;let a=ut.current.x+t,n=ut.current.y+r;const s=window.innerWidth,o=window.innerHeight-nt;a=G(a,s-at,0),n=G(n,o,0),ot({x:a,y:n})})(e);if(!hr)return;if(!X)return;const t=_.current,r=t.getBoundingClientRect(),a=e.clientX-r.left,n=e.clientY-r.top;if(console.log("Drawing with brush type:",ge,"drawMode:",ie),"stamp"===ie&&De.current)return Ce({...De.current,x:a,y:n}),void(De.current={...De.current,x:a,y:n});if("eraser"===ie||"freehand"===ie){const e=t.getContext("2d");me&&"normal"!==ge?(console.log("Drawing with advanced brush engine:",ge),me.updateContext(e),me.brushType!==ge&&me.setBrushType(ge),JSON.stringify(me.brushParams)!==JSON.stringify(fe)&&me.setBrushParams(fe),me.draw(a,n,se,Z)):(console.log("Drawing with normal brush"),e.lineTo(a,n),e.stroke(),e.beginPath(),e.moveTo(a,n)),K.current.push({x:a,y:n})}else if("shape"===ie&&X){if(H.current&&H.current.complete){const e=t.getContext("2d");e.clearRect(0,0,at,nt),e.drawImage(H.current,0,0)}((e,t,r,a,n)=>{if(!e||!t)return;const s=_.current.getContext("2d");if(s.save(),s.strokeStyle=a,s.lineWidth=n,s.setLineDash([5,3]),"circle"===r){const r=Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2);s.beginPath(),s.arc(e.x,e.y,r,0,2*Math.PI),s.stroke()}else if("rectangle"===r)s.strokeRect(e.x,e.y,t.x-e.x,t.y-e.y);else if("hexagon"===r){const r=Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2);s.beginPath();for(let t=0;t<6;t++){const a=Math.PI/3*t,n=e.x+r*Math.cos(a),o=e.y+r*Math.sin(a);0===t?s.moveTo(n,o):s.lineTo(n,o)}s.closePath(),s.stroke()}else"line"===r&&(s.beginPath(),s.moveTo(e.x,e.y),s.lineTo(t.x,t.y),s.lineCap=ue,s.lineJoin=ue,s.stroke());s.restore()})(he,{x:a,y:n},ce,Z,se)}else if("select"===ie&&X){if(Qr({start:Xr,end:{x:a,y:n}}),H.current&&H.current.complete){const e=t.getContext("2d");e.clearRect(0,0,at,nt),e.drawImage(H.current,0,0)}const e=t.getContext("2d");e.save(),e.strokeStyle="blue",e.lineWidth=1,e.setLineDash([6,3]);const r=Xr,s=Math.min(r.x,a),o=Math.min(r.y,n),i=Math.abs(a-r.x),l=Math.abs(n-r.y);e.strokeRect(s,o,i,l),e.restore()}},onMouseUp:oa,onMouseLeave:oa}),ke&&(0,R.jsx)(n.A,{sx:{position:"absolute",left:ke.x+st.x,top:ke.y+st.y,pointerEvents:"none",transform:`translate(-50%, -50%) rotate(${ke.settings.rotation||0}deg)`,opacity:(ke.settings.opacity||100)/100*.7,zIndex:999},children:ke.stamp.emoji?(0,R.jsx)(f.A,{sx:{fontSize:`${ke.settings.size||50}px`,lineHeight:1,userSelect:"none"},children:ke.stamp.emoji}):ke.stamp.image?(0,R.jsx)("img",{src:ke.stamp.image,alt:"Stamp preview",style:{width:ke.settings.size||50,height:ke.settings.size||50,objectFit:"contain"}}):null}),(0,R.jsxs)(n.A,{sx:{position:"absolute",top:"50%",transform:"translateY(-50%)",left:ia?0:-100,width:100,transition:"left 0.3s ease",pointerEvents:"all",zIndex:1e3},onMouseEnter:()=>da(!0),onMouseLeave:()=>da(!1),children:[(0,R.jsx)(n.A,{onClick:()=>la((e=>!e)),sx:{position:"absolute",right:ia?0:-20,top:"50%",transform:"translateY(-50%)",width:20,height:60,display:"flex",alignItems:"center",justifyContent:"center",opacity:ca?1:0,transition:"opacity 0.2s",bgcolor:"rgba(0,0,0,0.2)",cursor:"pointer",zIndex:1001},children:(0,R.jsx)(i.A,{size:"small",sx:{p:0,color:"white"},children:ia?(0,R.jsx)(ae.A,{fontSize:"small"}):(0,R.jsx)(ne.A,{fontSize:"small"})})}),(0,R.jsx)(ct,{drawMode:ie,setDrawMode:le,shapeType:ce,setShapeType:de,color:Z,setColor:te,showColorPicker:We,toggleColorPicker:e=>{const t=window.innerHeight,r=e.target.getBoundingClientRect(),a=document.querySelector(".Canvas-color-picker");$e(!We),r.bottom+350>t&&a?a.classList.add("Canvas-color-picker--adjust-bottom"):a&&a.classList.remove("Canvas-color-picker--adjust-bottom")},closeColorPicker:()=>{$e(!1)},lineWidth:se,setLineWidth:oe,previousColor:Fe,setPreviousColor:Oe,refreshCanvasButtonHandler:Er,undo:Yr,undoAvailable:Ye,redo:Vr,redoAvailable:Xe,selectionRect:Zr,handleCutSelection:async()=>{if(hr){ur("Cutting selection... This may take a moment.");try{const e=await ra();e&&e.compositeCutAction&&qe((t=>[...t,e.compositeCutAction])),Ne(!0),ur("Syncing cut operation...");try{await na(),ur("Cut completed successfully!")}catch(ua){console.error("Error syncing cut with server:",ua),ur("Cut completed, but sync failed. Try refreshing.")}finally{Ne(!1)}}catch(ua){console.error("Error during cut:",ua),ur("Cut operation failed. Please try again.")}}else ur("Cut is disabled in view-only mode.")},cutImageData:ea,setClearDialogOpen:_e,handleExportCanvas:async()=>{if(p)try{nr(!0),ur("Exporting canvas data...");const{exportRoomCanvas:e}=await Promise.resolve().then(r.bind(r,75267));console.log("[Export] Calling API with roomId:",p),console.log("[Export] Auth token present:",!(null===c||void 0===c||!c.token));const t=await e(null===c||void 0===c?void 0:c.token,p);if(console.log("[Export] Received exportData:",{exists:!!t,type:typeof t,keys:t?Object.keys(t):[],hasStrokes:!!t&&!!t.strokes,strokeCount:t?t.strokeCount:"N/A"}),!t)return console.error("[Export] exportData is null or undefined"),void ur("Export failed: no data returned from server");if(!t.strokes)return console.error("[Export] exportData.strokes is missing:",t),void ur(`Export failed: no strokes in response (got ${t.strokeCount||0} count)`);const a=JSON.stringify(t,null,2),n=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download=`${t.roomName||"canvas"}_export_${Date.now()}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s),ur(`Exported ${t.strokeCount} strokes successfully`),console.log("[Export] Success - downloaded file")}catch(e){console.error("[Export] Error caught:",e),console.error("[Export] Error stack:",e.stack),ur(`Export failed: ${e.message||"Unknown error"}`)}finally{nr(!1)}else ur("Cannot export: not in a room")},handleImportCanvas:async()=>{if(!p)return void ur("Cannot import: not in a room");if(!hr)return void ur("Cannot import in view-only mode");const e=document.createElement("input");e.type="file",e.accept="application/json,.json",e.onchange=async e=>{const t=e.target.files[0];if(t)try{nr(!0),ur("Reading import file...");const e=await t.text(),a=JSON.parse(e);if(!a.strokes||!Array.isArray(a.strokes))return void ur("Invalid import file: missing strokes array");const n=window.confirm(`Import ${a.strokes.length} strokes?\n\nClick OK to replace current canvas, or Cancel to merge with existing drawings.`);ur(`Importing ${a.strokes.length} strokes...`);const{importRoomCanvas:s}=await Promise.resolve().then(r.bind(r,75267)),o=await s(null===c||void 0===c?void 0:c.token,p,a,n);"success"===o.status?(ur(`Import complete: ${o.imported} imported, ${o.failed} failed`,6e3),setTimeout((async()=>{try{await Rr(),await na("post-import")}catch(e){console.error("Error refreshing after import:",e)}}),500)):ur(`Import failed: ${o.message||"Unknown error"}`)}catch(a){console.error("Import error:",a),ur(`Import failed: ${a.message||"Invalid file format"}`)}finally{nr(!1)}},e.click()},currentBrushType:ge,onBrushSelect:e=>{console.log("handleBrushSelect called with:",e),ye(e),me.setBrushType(e),le("freehand"),console.log("Current brush type set to:",e)},onBrushParamsChange:e=>{xe(e),me.setBrushParams(e)},selectedStamp:we,onStampSelect:(e,t)=>{be(e),je(t),le("stamp")},onStampChange:(e,t)=>{be(e),je(t)},backendStamps:Ae,onFilterApply:async(e,t)=>{if(!_.current)return;Ee&&Me(!1),Be.current=null,Ue.current=null;const r=Ur.drawings.findIndex((t=>"filter"===t.drawingType&&t.filterType===e));let a;if(-1!==r){const n=Ur.drawings[r];n.filterParams={...t},n.timestamp=Date.now(),a=n;const o=new zt(Ur.userId,Ur.username);o.drawings=[...Ur.drawings],Br(o),Nt.current=null,Ht.current=!0,await Gr(),ur(`Updated ${e} filter`),zr();try{await It(a,c,{roomId:p,roomType:F},Ve,Je),p&&Et(c,Ve,Je,p)}catch(s){console.error("Error submitting filter update:",s),(0,ht.tu)(s)}return}a=new Dt(Wr(),"#000000",0,[],Date.now(),V,{drawingType:"filter",filterType:e,filterParams:{...t}}),a.drawingType="filter",a.filterType=e,a.filterParams={...t},a.roomId=p,Ur.addDrawing(a);const n=new zt(Ur.userId,Ur.username);n.drawings=[...Ur.drawings],Br(n),bt((e=>[...e,a])),qe((e=>[...e,a])),Ge([]),Nt.current=null,Ht.current=!0,await Gr(),ur(`Applied ${e} filter`),zr();try{await It(a,c,{roomId:p,roomType:F},Ve,Je),p&&Et(c,Ve,Je,p)}catch(s){console.error("Error submitting filter:",s),bt((e=>e.filter((e=>e.drawingId!==a.drawingId)))),(0,ht.tu)(s)}},onFilterPreview:async(e,t)=>{const r=_.current;if(r){if(Ee&&Be.current){const a=new Image;return a.onload=async()=>{const n=r.getContext("2d");n.clearRect(0,0,r.width,r.height),n.drawImage(a,0,0),await Nr(r,e,t)},void(a.src=Be.current)}Be.current||(Be.current=r.toDataURL()),await Nr(r,e,t)}},onFilterUndo:async()=>{if(Ee&&Be.current){const e=_.current;if(!e)return;const t=e.getContext("2d"),r=new Image;return r.onload=async()=>{t.clearRect(0,0,e.width,e.height),t.drawImage(r,0,0),Me(!1),Be.current=null,Ue.current=null},void(r.src=Be.current)}hr?0!==He.length?await Yr():ur("No actions to undo."):ur("Undo is disabled in view-only mode.")},onClearAllFilters:async()=>{if(Ee&&(Me(!1),Be.current=null,Ue.current=null),!hr)return void ur("Clear filters is disabled in view-only mode.");let e=[];if(Br((t=>{const r=t.drawings||[];return e=r.filter((e=>"filter"===e.drawingType)),console.log(`[clearAllFilters] Found ${e.length} filters to clear`,e),t})),0!==e.length)if(ze)ur("Please wait for the canvas to refresh.");else try{ur(`Clearing ${e.length} filter(s)...`);const a=e.map((e=>e.drawingId)).filter((e=>e));if(Br((t=>{const r=new zt(t.userId,t.username);return r.drawings=t.drawings.filter((e=>"filter"!==e.drawingType)),console.log(`[clearAllFilters] Removed ${e.length} filters, ${r.drawings.length} drawings remain`),r})),bt((e=>e.filter((e=>"filter"!==e.drawingType)))),qe((e=>e.filter((e=>"filter"!==e.drawingType)))),Nt.current=null,Ht.current=!0,await Gr(),ur(`Cleared ${e.length} filter(s).`),zr(),a.length>0)try{const{markStrokesAsUndone:n}=await Promise.resolve().then(r.bind(r,75267));try{await n(c.token,p,a),console.log(`Marked ${a.length} filters as undone in backend`)}catch(t){console.warn("markStrokesAsUndone API not available, using fallback");const{undoRoomAction:a}=await Promise.resolve().then(r.bind(r,75267));for(let r=0;r<Math.min(e.length,10);r++)try{if("noop"===(await a(c.token,p)).status)break;await new Promise((e=>setTimeout(e,50)))}catch(ua){console.warn("Error calling undoRoomAction:",ua);break}}await Et(c,Ve,Je,p)}catch(ua){console.error("Error syncing filter removal with backend:",ua)}}catch(a){console.error("Error clearing all filters:",a),ur("Failed to clear all filters. Refreshing canvas..."),await Er()}else ur("No filters to clear.")},canUndoFilter:!!Ue.current||He.some((e=>"filter"===e.drawingType)),canClearFilters:Ze,appliedFilters:(()=>{const e=Ur.drawings.filter((e=>"filter"===e.drawingType));return console.log(`[Canvas render] Passing ${e.length} applied filters to Toolbar`,e),e})(),openHistoryDialog:()=>{h(""),Zt(!0)},exitHistoryMode:async()=>{h(""),Yt(!1),Xt(null),nr(!0);try{await Rr(),$r.current=await Pt($r.current,Ur,Gr,void 0,void 0,{roomId:p,auth:c})}finally{nr(!1)}},historyMode:Gt,controlsDisabled:!hr,onOpenSettings:I})]}),ze&&(0,R.jsx)("div",{className:"Canvas-loading-overlay",children:(0,R.jsx)("div",{className:"Canvas-spinner"})}),(0,R.jsxs)(m.A,{open:Jt,onClose:()=>Zt(!1),"aria-labelledby":"history-recall-dialog",children:[(0,R.jsx)(g.A,{id:"history-recall-dialog",children:"History Recall - Select Date/Time Range"}),(0,R.jsxs)(y.A,{children:[(0,R.jsx)(A.A,{children:"Choose a start and end date/time to recall drawings from ResilientDB. Only drawings within the selected range will be loaded."}),(0,R.jsxs)(n.A,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[(0,R.jsx)(S.A,{label:"Start",type:"datetime-local",value:Qt,onChange:e=>er(e.target.value),InputLabelProps:{shrink:!0}}),(0,R.jsx)(S.A,{label:"End",type:"datetime-local",value:tr,onChange:e=>rr(e.target.value),InputLabelProps:{shrink:!0}})]})]}),(0,R.jsxs)(x.A,{children:[(0,R.jsx)(w.A,{onClick:()=>{Zt(!1)},children:"Cancel"}),(0,R.jsx)(w.A,{onClick:async()=>{const e=Qt?new Date(Qt).getTime():NaN,t=tr?new Date(tr).getTime():NaN;await(async(e,t)=>{const r=void 0!==e?e:Qt?new Date(Qt).getTime():NaN,a=void 0!==t?t:tr?new Date(tr).getTime():NaN;if(isNaN(r)||isNaN(a))ur("Please select both start and end date/time before applying History Recall.");else if(r>a)ur("Invalid time range selected. Make sure start <= end.");else{h(""),Xt({start:r,end:a}),nr(!0),await Rr(),Xt({start:r,end:a});try{const e=await Pt($r.current,Ur,Gr,r,a,{roomId:p,auth:c});if($r.current=e,!Ur.drawings||0===Ur.drawings.length)return Xt(null),void ur("No drawings were found in that date/time range. Please select another range or exit history recall mode.");Yt(!0),Zt(!1)}catch(ua){console.error("Error applying history range:",ua),Xt(null),ur("An error occurred while loading history. See console for details.")}finally{nr(!1)}}})(e,t)},children:"Apply"})]})]}),(0,R.jsx)(k.A,{in:Boolean(Gt||u&&""!==u),timeout:300,children:(0,R.jsxs)(l.A,{elevation:6,sx:{position:"fixed",bottom:16,left:"50%",transform:"translateX(-50%)",zIndex:2e3,bgcolor:"background.paper",px:2,py:.6,display:"flex",alignItems:"center",gap:1,borderRadius:1.5},children:[(0,R.jsx)(Ut.A,{fontSize:"small"}),(0,R.jsx)(f.A,{variant:"body2",sx:{whiteSpace:"nowrap"},children:Gt?"History Mode Enabled \u2014 Canvas Editing Disabled":u&&""!==u?"Viewing Past Drawing History of Selected User \u2014 Canvas Editing Disabled":""})]})}),(0,R.jsx)(k.A,{in:Boolean(ar),timeout:300,children:(0,R.jsxs)(l.A,{elevation:6,sx:{position:"absolute",left:"50%",top:"12%",transform:"translateX(-50%)",padding:"8px 12px",zIndex:2e3,display:"flex",alignItems:"center",gap:1},children:[(0,R.jsx)(s.A,{size:18}),(0,R.jsx)(f.A,{variant:"body2",children:"Loading Drawings..."})]})}),(0,R.jsxs)(m.A,{open:Le,onClose:()=>_e(!1),children:[(0,R.jsx)(g.A,{children:"Clear Canvas"}),(0,R.jsx)(y.A,{children:(0,R.jsx)(A.A,{children:"Are you sure you want to clear the canvas for everyone?"})}),(0,R.jsxs)(x.A,{children:[(0,R.jsx)(w.A,{onClick:()=>_e(!1),color:"primary",children:"No"}),(0,R.jsx)(w.A,{onClick:async()=>{await(async()=>{if(!hr)return void ur("Cannot clear canvas in view-only mode.");_.current.getContext("2d").clearRect(0,0,at,nt),Br(Mr()),qe([]),Ge([]),bt([]),$r.current=0})();try{const e=await async function(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=(null===(e=t.auth)||void 0===e?void 0:e.token)||(0,ht.c4)();if(r&&t.roomId)try{console.log("Clear canvas requested for room:",t.roomId);const e=await(0,v.clearRoomCanvas)(r,t.roomId);return console.log("Canvas cleared successfully",e),e}catch(a){throw console.error("Error clearing canvas:",a),a}else console.warn("clearBackendCanvas: Missing auth token or roomId")}({roomId:p,auth:c});e&&e.clearedAt&&p&&(Tr.current[p]=e.clearedAt)}catch(ua){console.error("Failed to clear backend:",ua)}try{await Et(c,Ve,Je,p)}catch(ua){}d([]);try{h("")}catch(ua){}_e(!1)},color:"primary",autoFocus:!0,children:"Yes"})]})]}),(0,R.jsx)(q,{open:pr,onClose:()=>mr(!1),commands:re.getAll(),onExecute:e=>{try{e.action()}catch(t){console.error("[Canvas] Error executing command:",t),ur("Error executing command")}}}),(0,R.jsx)(Q,{open:gr,onClose:()=>yr(!1),shortcuts:(null===(o=fr.current)||void 0===o?void 0:o.getAllShortcuts())||[]}),(0,R.jsx)(C.A,{open:sr.open,message:sr.message,autoHideDuration:sr.duration,onClose:()=>or({open:!1,message:"",duration:4e3})})]})};var Ft=r(82212),Ot=r(98606),Lt=r(17548);function _t(e){let{roomType:t,onConnected:r,onDisconnected:o}=e;const[i,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)(null),[h,p]=(0,a.useState)(jt());(0,a.useEffect)((()=>{const e=()=>{const e=jt();p(e)};e();const t=setInterval(e,2e3);return()=>clearInterval(t)}),[]),(0,a.useEffect)((()=>{h.connected&&r?r(h.publicKey):!h.connected&&o&&o()}),[h.connected,h.publicKey,r,o]);return"secure"!==t?null:(0,R.jsxs)(l.A,{elevation:2,sx:{p:2,mb:2,backgroundColor:h.connected?"#e8f5e9":"#fff3e0",border:h.connected?"2px solid #4caf50":"2px solid #ff9800"},children:[(0,R.jsxs)(n.A,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[(0,R.jsxs)(n.A,{display:"flex",alignItems:"center",gap:2,children:[(0,R.jsx)(Ft.A,{fontSize:"large",color:h.connected?"success":"warning"}),(0,R.jsxs)(n.A,{children:[(0,R.jsx)(f.A,{variant:"h6",component:"div",children:"Secure Room - Wallet Required"}),(0,R.jsx)(f.A,{variant:"body2",color:"text.secondary",children:h.connected?`Connected: ${Ct(h.publicKey)}`:"Connect your ResVault wallet to draw in this secure room"})]})]}),(0,R.jsx)(n.A,{display:"flex",alignItems:"center",gap:2,children:h.connected?(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(oe.A,{title:`Full public key: ${h.publicKey}`,children:(0,R.jsx)(L.A,{icon:(0,R.jsx)(Ot.A,{}),label:"Connected",color:"success",variant:"filled"})}),(0,R.jsx)(w.A,{variant:"outlined",color:"error",onClick:()=>{wt=!1,bt=null,p({connected:!1,publicKey:null})},size:"small",children:"Disconnect"})]}):(0,R.jsx)(w.A,{variant:"contained",color:"primary",onClick:async()=>{c(!0),u(null);try{const e=await async function(){try{vt&&console.log("[resvault] Checking wallet connection...");const t=await At();try{xt.sendMessage({type:"siteSignerInfo",direction:"info",signerPublicKey:t})}catch(e){vt&&console.warn("[resvault] failed to notify content script of signerPublicKey",e)}return wt=!0,bt=t,vt&&console.log("[resvault] Wallet connected successfully:",t),t}catch(d){wt=!1,bt=null,vt&&console.error("[resvault] Wallet connection check failed:",d);const t=d.message||"Wallet connection failed";if(t.includes("No keys found")||t.includes("not responding"))throw new Error("WALLET_NOT_CONNECTED: Please connect your ResVault wallet to this site first");throw d}}();p({connected:!0,publicKey:e})}catch(e){console.error("Wallet connection failed:",e);let t=e.message||"Failed to connect wallet";(t.includes("not connected")||t.includes("No keys found"))&&(t="Please connect your wallet to this site first:\n\n1. Click the ResVault extension icon in your browser\n2. Make sure you are logged in to ResVault\n3. In the ResVault dashboard, select the network you want to use\n4. Click the connection icon to connect to this site\n5. Then try connecting again here"),u(t)}finally{c(!1)}},disabled:i,startIcon:i?(0,R.jsx)(s.A,{size:20}):(0,R.jsx)(Ft.A,{}),children:i?"Connecting...":"Connect Wallet"})})]}),d&&(0,R.jsxs)(T.A,{severity:"error",icon:(0,R.jsx)(Lt.A,{}),sx:{mt:2},onClose:()=>u(null),children:[(0,R.jsx)(f.A,{variant:"body2",component:"div",children:(0,R.jsx)("strong",{children:"Wallet Connection Failed"})}),(0,R.jsx)(f.A,{variant:"body2",component:"div",sx:{mt:1,whiteSpace:"pre-line"},children:d}),d.includes("WALLET_NOT_CONNECTED")&&(0,R.jsxs)(n.A,{sx:{mt:2},children:[(0,R.jsx)(f.A,{variant:"body2",component:"div",children:(0,R.jsx)("strong",{children:"How to connect:"})}),(0,R.jsxs)(f.A,{variant:"body2",component:"ol",sx:{pl:2,mt:1},children:[(0,R.jsxs)("li",{children:["Click the ",(0,R.jsx)("strong",{children:"ResVault extension icon"})," in your browser toolbar"]}),(0,R.jsxs)("li",{children:["Make sure you're ",(0,R.jsx)("strong",{children:"logged in"})," to ResVault"]}),(0,R.jsxs)("li",{children:["Select your desired ",(0,R.jsx)("strong",{children:"network"})," (e.g., ResilientDB Mainnet)"]}),(0,R.jsxs)("li",{children:["Click the ",(0,R.jsx)("strong",{children:"globe/connection icon"})," to connect to this site"]}),(0,R.jsxs)("li",{children:["Return here and click ",(0,R.jsx)("strong",{children:'"Connect Wallet"'})," again"]})]})]}),d.includes("extension")&&(0,R.jsxs)(f.A,{variant:"caption",display:"block",sx:{mt:1},children:["Please install the ResVault Chrome extension from:"," ",(0,R.jsx)("a",{href:"https://github.com/apache/incubator-resilientdb-resvault",target:"_blank",rel:"noopener noreferrer",children:"ResVault GitHub"})]})]}),!h.connected&&!d&&(0,R.jsx)(T.A,{severity:"info",sx:{mt:2},children:(0,R.jsx)(f.A,{variant:"body2",children:"Secure rooms require all strokes to be cryptographically signed with your wallet. This ensures verifiable authorship and prevents impersonation."})})]})}var Ht=r(8925),qt=r(83034);function Kt(e){let{auth:t}=e;const{id:r}=(0,b.g)(),A=(0,b.Zp)(),[S,k]=(0,a.useState)(null),[C,D]=(0,a.useState)(!0),T=r,I=(0,a.useRef)(null),[P,E]=(0,a.useState)(""),[M,U]=(0,a.useState)([]),[B,W]=(0,a.useState)([]),[$,z]=(0,a.useState)(!0),[N,F]=(0,a.useState)(!1),[O,L]=(0,a.useState)(!1),[_,H]=(0,a.useState)(!1),[q,K]=(0,a.useState)(!1),[G,Y]=(0,a.useState)("Access denied"),[V,X]=(0,a.useState)("/dashboard"),[J,Z]=(0,a.useState)("Access denied"),[Q,ee]=(0,a.useState)(!1),[te,re]=(0,a.useState)(null),se=(0,a.useCallback)((async()=>{if(null===t||void 0===t||!t.token)return console.error("No auth token available for room loading"),void D(!1);try{D(!0);const e=await(0,v.getRoomDetails)(t.token,T);k(e);const r=await(0,v.getRoomStrokes)(t.token,T);console.log("Room strokes loaded:",r.length,"strokes")}catch(e){if(console.error("Failed to load room details:",e),!(0,ht.tu)(e)){const t=(0,Ht.NR)(e);403===(null===e||void 0===e?void 0:e.status)||null!==e&&void 0!==e&&e.message&&e.message.toLowerCase().includes("forbidden")?(Z("Access Denied"),Y(t),X("/dashboard"),K(!0)):404===(null===e||void 0===e?void 0:e.status)?(Z("Room Not Found"),Y(t),X("/dashboard"),K(!0)):(Z("Error Loading Room"),Y(t),X("/dashboard"),K(!0))}}finally{D(!1)}}),[null===t||void 0===t?void 0:t.token,T]);if((0,a.useEffect)((()=>{se()}),[se]),(0,a.useEffect)((()=>{if(null===t||void 0===t||!t.token)return;(0,Bt.FP)(t.token);const e=(0,Bt.Ol)(t.token);I.current=e,e.emit("join_room",{roomId:T});const r=e=>{(null===e||void 0===e?void 0:e.roomId)===T&&e.stroke&&console.log("Received real-time stroke for room:",T)},a=e=>{(null===e||void 0===e?void 0:e.roomId)===T&&(console.log("Role changed in room:",e),se())},n=e=>{if((null===e||void 0===e?void 0:e.roomId)===T){console.log("User removed from room:",e);try{window.dispatchEvent(new CustomEvent("rescanvas:notify",{detail:{message:e.message||"You were removed from this room",duration:4e3}}))}catch(t){}setTimeout((()=>{A("/dashboard")}),1e3)}},s=e=>{(null===e||void 0===e?void 0:e.roomId)===T&&(console.log("Room updated:",e),se())},o=e=>{if((null===e||void 0===e?void 0:e.roomId)===T){console.log("Room deleted:",e);try{window.dispatchEvent(new CustomEvent("rescanvas:notify",{detail:{message:"This room was deleted by the owner",duration:4e3}}))}catch(t){}setTimeout((()=>{A("/dashboard")}),1e3)}};return e.on("stroke",r),e.on("role_changed",a),e.on("user_removed_from_room",n),e.on("room_updated",s),e.on("room_deleted",o),()=>{try{e.off("stroke",r),e.off("role_changed",a),e.off("user_removed_from_room",n),e.off("room_updated",s),e.off("room_deleted",o),e.emit("leave_room",{roomId:T})}catch(t){}}}),[T,null===t||void 0===t?void 0:t.token,A,se]),C)return(0,R.jsx)(n.A,{sx:{p:3},children:(0,R.jsx)(s.A,{})});const oe=(()=>{const e=(null===S||void 0===S?void 0:S.myRole)||"editor";return!(null===S||void 0===S||!S.archived)||"viewer"===e})(),ie=(()=>{try{if(!S)return!1;if("owner"===(S.myRole||null))return!0;try{const e=(0,j.T)(t);if(e&&S.ownerName&&e===S.ownerName)return!0}catch(e){}return!1}catch(e){return!1}})();return(0,R.jsxs)(o.A,{theme:qt.A,children:[(0,R.jsxs)(n.A,{className:"App",sx:{height:"100%",display:"flex",flexDirection:"column"},children:[(0,R.jsxs)(n.A,{sx:{height:"calc(100vh - 200px)",position:"relative",overflow:"hidden"},children:["secure"===(null===S||void 0===S?void 0:S.type)&&(0,R.jsx)(n.A,{sx:{position:"absolute",top:80,left:20,zIndex:1200},children:(0,R.jsx)(_t,{roomType:null===S||void 0===S?void 0:S.type,onConnected:e=>{ee(!0),re(e),console.log("Wallet connected:",e)},onDisconnected:()=>{ee(!1),re(null),console.log("Wallet disconnected")}})}),(0,R.jsx)(n.A,{sx:{width:"100%",height:"100%",overflow:"hidden"},children:(0,R.jsx)(Nt,{auth:t,currentRoomId:T,currentRoomName:(null===S||void 0===S?void 0:S.name)||`Room ${T}`,setUserList:U,selectedUser:P,setSelectedUser:E,onExitRoom:()=>{A("/dashboard")},canvasRefreshTrigger:0,viewOnly:oe,isOwner:ie,roomType:(null===S||void 0===S?void 0:S.type)||"public",walletConnected:Q,templateId:null===S||void 0===S?void 0:S.templateId,onOpenSettings:S&&"viewer"!==(S.myRole||"editor")?()=>A(`/rooms/${T}/settings`):null})}),(0,R.jsxs)(n.A,{sx:{position:"absolute",top:20,right:0,bottom:20,width:$?150:20,transition:"width 0.3s ease",pointerEvents:"none"},onMouseEnter:()=>F(!0),onMouseLeave:()=>F(!1),children:[(0,R.jsx)(n.A,{onClick:()=>z((e=>!e)),sx:{position:"absolute",left:0,top:"50%",transform:"translateY(-50%)",width:16,height:50,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"all",opacity:N?1:0,transition:"opacity 0.2s",bgcolor:"rgba(0,0,0,0.1)",cursor:"pointer",zIndex:1100},children:(0,R.jsx)(i.A,{size:"small",sx:{p:0,color:"white"},children:$?(0,R.jsx)(ne.A,{fontSize:"small"}):(0,R.jsx)(ae.A,{fontSize:"small"})})}),$&&(0,R.jsxs)(l.A,{elevation:3,className:"history-panel",sx:{height:"100%",display:"flex",flexDirection:"column",borderRadius:"12px 0 0 12px",overflow:"hidden",background:"#25D8C5",pointerEvents:"all"},children:[(0,R.jsx)(n.A,{sx:{height:42,backgroundImage:"\n                      linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)),\n                      url('/toolbar/toolbar-bg.jpeg')\n                    ",backgroundPosition:"center",backgroundSize:"cover",backgroundRepeat:"no-repeat",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"bold",fontSize:"0.9rem",fontFamily:"Comic Sans MS, cursive",flexShrink:0},children:"Drawing History"}),(0,R.jsx)(n.A,{sx:{flexGrow:1,overflowY:"auto",backdropFilter:"blur(4px)",padding:.5},children:(0,R.jsx)(c.A,{dense:!0,sx:{py:0},children:M&&M.map(((e,t)=>{if(e&&void 0!==e.periodStart){const t=(e=>{const t=new Date(e);return t.toLocaleDateString()+" "+t.toLocaleTimeString()})(e.periodStart),r=B.includes(e.periodStart);return(0,R.jsxs)("div",{children:[(0,R.jsx)(d.Ay,{disablePadding:!0,sx:{py:0},children:(0,R.jsx)(u.A,{onClick:()=>{return t=e.periodStart,void(B.includes(t)?W(B.filter((e=>e!==t))):W([...B,t]));var t},sx:{py:.5,minHeight:32},children:(0,R.jsx)(h.A,{primary:t,primaryTypographyProps:{color:"#17635a",fontWeight:"bold",fontSize:"0.8rem"}})})}),r&&e.users.map(((t,r)=>{const a=t.split("|")[0],n=P&&("string"===typeof P&&P===t||"object"===typeof P&&P.user===t&&P.periodStart===e.periodStart);return(0,R.jsx)(d.Ay,{disablePadding:!0,sx:{pl:1,py:0},children:(0,R.jsxs)(u.A,{onClick:()=>E(n?"":{user:t,periodStart:e.periodStart}),selected:Boolean(n),sx:{py:.5,minHeight:32,borderRadius:1,"&.Mui-selected":{backgroundColor:qt.A.palette.action.hover,"&:hover":{backgroundColor:qt.A.palette.action.selected}}},children:[(0,R.jsx)(p.A,{sx:{bgcolor:qt.A.palette.primary.light,mr:1,width:28,height:28,fontSize:"0.9rem"},children:a.charAt(0).toUpperCase()}),(0,R.jsx)(h.A,{primary:a,primaryTypographyProps:{color:"#17635a",fontSize:"0.8rem"}})]})},`${e.periodStart}-${r}`)}))]},e.periodStart)}{const r=e,a=(r||"").split("|")[0],n=P===r;return(0,R.jsx)(d.Ay,{disablePadding:!0,sx:{py:0},children:(0,R.jsxs)(u.A,{onClick:()=>E(n?"":r),selected:Boolean(n),sx:{py:.5,minHeight:32,borderRadius:1,"&.Mui-selected":{backgroundColor:qt.A.palette.action.hover,"&:hover":{backgroundColor:qt.A.palette.action.selected}}},children:[(0,R.jsx)(p.A,{sx:{bgcolor:qt.A.palette.primary.light,mr:1,width:28,height:28,fontSize:"0.9rem"},children:a.charAt(0).toUpperCase()}),(0,R.jsx)(h.A,{primary:a,primaryTypographyProps:{color:"#17635a",fontSize:"0.8rem"}})]})},t)}}))})})]})]})]}),(0,R.jsxs)(m.A,{open:O,onClose:()=>L(!1),maxWidth:"md",fullWidth:!0,children:[(0,R.jsx)(g.A,{sx:{bgcolor:"primary.main",color:"white"},children:"ResCanvas Help"}),(0,R.jsxs)(y.A,{sx:{pt:2},children:[(0,R.jsx)(n.A,{sx:{display:"flex",justifyContent:"center",mb:3},children:(0,R.jsx)("img",{src:"../help_screen.png",alt:"ResCanvas Help Screen",style:{maxWidth:"100%",height:"auto"}})}),(0,R.jsx)(f.A,{variant:"h6",gutterBottom:!0,children:"Welcome to ResCanvas!"}),(0,R.jsx)(f.A,{paragraph:!0,children:"ResCanvas is a collaborative drawing platform that uses ResilientDB to ensure your artwork is securely stored in a decentralized manner."}),(0,R.jsx)(f.A,{variant:"h6",gutterBottom:!0,children:"How to Use:"}),(0,R.jsx)(f.A,{component:"div",children:(0,R.jsxs)("ul",{children:[(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Left Toolbar:"})," Access drawing tools, colors, and brush sizes"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Drawing History:"})," View and filter drawings by user and time period"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Real-time Collaboration:"})," See other users' drawings appear instantly"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"History Recall:"})," Load drawings from specific time periods"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Undo/Redo:"})," Use the toolbar buttons to undo or redo actions"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Room Management:"})," Create and join different drawing rooms"]})]})})]}),(0,R.jsx)(x.A,{children:(0,R.jsx)(w.A,{onClick:()=>L(!1),color:"primary",variant:"contained",children:"Got it!"})})]}),(0,R.jsxs)(m.A,{open:_,onClose:()=>H(!1),maxWidth:"lg",fullWidth:!0,children:[(0,R.jsx)(g.A,{sx:{bgcolor:"primary.main",color:"white"},children:"ResCanvas Blog"}),(0,R.jsxs)(y.A,{sx:{pt:2},children:[(0,R.jsx)(f.A,{variant:"h4",gutterBottom:!0,children:"Introducing ResCanvas: Decentralized Collaborative Drawing"}),(0,R.jsx)(f.A,{paragraph:!0,children:"ResCanvas represents a breakthrough in web-based drawing platforms that utilizes ResilientDB to ensure that user's drawings are securely stored, allowing for multiple users to collaborate and create new works of art and express ideas freely without any limits, tracking, or censorship."}),(0,R.jsx)(f.A,{variant:"h5",gutterBottom:!0,children:"Key Features"}),(0,R.jsx)(f.A,{component:"div",children:(0,R.jsxs)("ul",{children:[(0,R.jsx)("li",{children:"Real-time collaborative drawing with multiple users"}),(0,R.jsx)("li",{children:"Persistent, secure storage of drawing data in ResilientDB allowing for censorship free expression"}),(0,R.jsx)("li",{children:"Individual stroke-by-stroke caching using Redis for optimal performance"}),(0,R.jsx)("li",{children:"Advanced drawing tools including shapes, colors, and brush sizes"}),(0,R.jsx)("li",{children:"History recall functionality to view drawings from specific time periods"}),(0,R.jsx)("li",{children:"Room-based access control for private and secure drawing sessions"}),(0,R.jsx)("li",{children:"Decentralized architecture ensuring no single point of failure"})]})}),(0,R.jsx)(f.A,{variant:"h5",gutterBottom:!0,children:"Technology Stack"}),(0,R.jsx)(f.A,{paragraph:!0,children:"ResCanvas combines cutting-edge blockchain technology with modern web frameworks:"}),(0,R.jsx)(f.A,{component:"div",children:(0,R.jsxs)("ul",{children:[(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Frontend:"})," React.js with Material-UI for responsive design"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Backend:"})," Python Flask with Socket.IO for real-time communication"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Database:"})," ResilientDB for decentralized, secure data storage"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Cache:"})," Redis for high-performance stroke caching"]}),(0,R.jsxs)("li",{children:[(0,R.jsx)("strong",{children:"Authentication:"})," JWT tokens with ResVault integration"]})]})})]}),(0,R.jsx)(x.A,{children:(0,R.jsx)(w.A,{onClick:()=>H(!1),color:"primary",variant:"contained",children:"Close"})})]})]}),(0,R.jsxs)(m.A,{open:q,onClose:()=>{K(!1),A(V)},children:[(0,R.jsx)(g.A,{children:J}),(0,R.jsx)(y.A,{children:(0,R.jsx)(f.A,{children:G})}),(0,R.jsx)(x.A,{children:(0,R.jsx)(w.A,{onClick:()=>{K(!1),A(V)},autoFocus:!0,children:"OK"})})]})]})}},88133:(e,t,r)=>{"use strict";function a(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4e3;try{const r={message:String(e),duration:t},a=new CustomEvent("rescanvas:notify",{detail:r});if(window&&"function"===typeof window.dispatchEvent)return void window.dispatchEvent(a)}catch(r){}console.warn("NOTIFY:",e)}r.d(t,{A:()=>a})},71281:()=>{}}]);
//# sourceMappingURL=826.119c3c6b.chunk.js.map