{"version":3,"file":"static/js/826.119c3c6b.chunk.js","mappings":"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","sources":["components/ResilientDBWarningBanner.js","services/resilientDBMonitor.js","components/CommandPalette.jsx","components/KeyboardShortcutsHelp.jsx","services/KeyboardShortcuts.js","services/CommandRegistry.js","lib/drawModeMenu.js","lib/shapeMenu.js","components/BrushEditor/WackyBrushPreview.jsx","components/BrushEditor/BrushPanel.jsx","components/Mixer/MixerPanel.jsx","components/Stamps/StampEditor.jsx","components/Stamps/StampPanel.jsx","components/Toolbar.js","wallet/resvault.js","lib/drawing.js","services/canvasBackendJWT.js","hooks/useCanvasSelection.js","components/Canvas.js","hooks/useBrushEngine.js","components/WalletConnector.jsx","pages/Room.jsx","utils/notify.js"],"sourcesContent":["/**\n * ResilientDBWarningBanner\n * \n * Shows a persistent warning banner when ResilientDB GraphQL endpoint is down.\n * Users can still draw (saved to MongoDB), but blockchain persistence is unavailable.\n * Displays the number of strokes waiting to be synced to the blockchain.\n */\n\nimport React from 'react';\nimport { Alert, AlertTitle, Collapse } from '@mui/material';\nimport WarningIcon from '@mui/icons-material/Warning';\n\nexport default function ResilientDBWarningBanner({ isHealthy, queueSize = 0 }) {\n  return (\n    <Collapse in={!isHealthy}>\n      <Alert \n        severity=\"warning\" \n        icon={<WarningIcon />}\n        sx={{ \n          mb: 2,\n          borderRadius: 1,\n          '& .MuiAlert-message': {\n            width: '100%'\n          }\n        }}\n      >\n        <AlertTitle>Blockchain Service Temporarily Unavailable</AlertTitle>\n        Your drawings are being saved normally, but blockchain persistence is currently offline.\n        {queueSize > 0 && (\n          <> <strong>{queueSize} stroke{queueSize !== 1 ? 's' : ''}</strong> will be automatically synced once the service is restored.</>\n        )}\n        {queueSize === 0 && (\n          <> Your work will be automatically synced to the blockchain once the service is restored.</>\n        )}\n      </Alert>\n    </Collapse>\n  );\n}\n","/**\n * ResilientDB Health Monitor\n * \n * Periodically checks if ResilientDB GraphQL endpoint is operational.\n * Shows a persistent warning banner when the service is down.\n * \n * This ensures users are aware when blockchain persistence is unavailable,\n * even though their canvas operations continue to work (saved to MongoDB).\n */\n\nimport { API_BASE } from '../config/apiConfig';\n\nlet healthCheckInterval = null;\nlet isHealthy = true;\nlet lastCheckTime = null;\nlet queueSize = 0;\nlet listeners = [];\n\nconst CHECK_INTERVAL = 60000; // Check every 60 seconds\nconst INITIAL_DELAY = 5000;   // Wait 5 seconds after mount before first check\n\n/**\n * Subscribe to health status changes\n * @param {Function} callback - Called with {isHealthy: boolean, queueSize: number, timestamp: number}\n * @returns {Function} Unsubscribe function\n */\nexport function onHealthChange(callback) {\n  listeners.push(callback);\n  \n  // Immediately notify of current status if available\n  if (lastCheckTime) {\n    callback({ isHealthy, queueSize, timestamp: lastCheckTime });\n  }\n  \n  return () => {\n    listeners = listeners.filter(cb => cb !== callback);\n  };\n}\n\n/**\n * Perform a single health check\n */\nasync function checkHealth() {\n  try {\n    const response = await fetch(`${API_BASE}/health/resilientdb`, {\n      method: 'GET',\n      headers: { 'Content-Type': 'application/json' }\n    });\n    \n    const data = await response.json();\n    const wasHealthy = isHealthy;\n    const oldQueueSize = queueSize;\n    \n    isHealthy = response.ok;\n    queueSize = data.retry_queue_size || 0;\n    lastCheckTime = Date.now();\n    \n    // Notify listeners if status changed or queue size changed significantly\n    if (wasHealthy !== isHealthy || Math.abs(oldQueueSize - queueSize) > 5) {\n      console.log(`[ResilientDB Monitor] Status: ${isHealthy ? 'healthy' : 'unhealthy'}, Queue: ${queueSize}`);\n      listeners.forEach(cb => cb({ isHealthy, queueSize, timestamp: lastCheckTime }));\n    }\n    \n    return isHealthy;\n  } catch (error) {\n    const wasHealthy = isHealthy;\n    isHealthy = false;\n    lastCheckTime = Date.now();\n    \n    if (wasHealthy !== isHealthy) {\n      console.error('[ResilientDB Monitor] Health check failed:', error);\n      listeners.forEach(cb => cb({ isHealthy, queueSize, timestamp: lastCheckTime }));\n    }\n    \n    return false;\n  }\n}\n\n/**\n * Start periodic health monitoring\n */\nexport function startMonitoring() {\n  if (healthCheckInterval) {\n    console.warn('[ResilientDB Monitor] Already monitoring');\n    return;\n  }\n  \n  console.log('[ResilientDB Monitor] Starting health checks');\n  \n  // Initial check after delay\n  setTimeout(() => {\n    checkHealth();\n  }, INITIAL_DELAY);\n  \n  // Periodic checks\n  healthCheckInterval = setInterval(() => {\n    checkHealth();\n  }, CHECK_INTERVAL);\n}\n\n/**\n * Stop periodic health monitoring\n */\nexport function stopMonitoring() {\n  if (healthCheckInterval) {\n    clearInterval(healthCheckInterval);\n    healthCheckInterval = null;\n    console.log('[ResilientDB Monitor] Stopped health checks');\n  }\n}\n\n/**\n * Get current health status\n */\nexport function getHealthStatus() {\n  return {\n    isHealthy,\n    queueSize,\n    lastCheckTime\n  };\n}\n\n/**\n * Force an immediate health check\n */\nexport async function forceHealthCheck() {\n  return await checkHealth();\n}\n","import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport {\n  Dialog,\n  TextField,\n  List,\n  ListItem,\n  ListItemText,\n  Chip,\n  Box,\n  Typography,\n  Divider,\n  InputAdornment,\n  Paper\n} from '@mui/material';\nimport SearchIcon from '@mui/icons-material/Search';\nimport KeyboardIcon from '@mui/icons-material/Keyboard';\nimport '../styles/KeyboardShortcuts.css';\n\n/**\n * Command Palette Component\n * \n * VS Code-style command palette for quick action discovery and execution.\n * Features:\n * - Fuzzy search with keyword matching\n * - Keyboard navigation (arrow keys, Enter, Escape)\n * - Command categorization\n * - Shortcut display\n * - Recent commands tracking\n * \n * @param {boolean} open - Whether the palette is open\n * @param {function} onClose - Callback when palette closes\n * @param {Array} commands - Array of command objects from CommandRegistry\n * @param {function} onExecute - Callback when command is executed\n */\nexport function CommandPalette({ open, onClose, commands = [], onExecute }) {\n  const [search, setSearch] = useState('');\n  const [filteredCommands, setFilteredCommands] = useState([]);\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const [recentCommands, setRecentCommands] = useState([]);\n  const listRef = useRef(null);\n  const inputRef = useRef(null);\n\n  // Load recent commands from localStorage\n  useEffect(() => {\n    if (open) {\n      try {\n        const stored = localStorage.getItem('rescanvas_recent_commands');\n        if (stored) {\n          setRecentCommands(JSON.parse(stored).slice(0, 5));\n        }\n      } catch (error) {\n        console.error('[CommandPalette] Error loading recent commands:', error);\n      }\n    }\n  }, [open]);\n\n  // Filter commands based on search\n  useEffect(() => {\n    if (!commands || commands.length === 0) {\n      setFilteredCommands([]);\n      return;\n    }\n\n    if (!search || search.trim() === '') {\n      // Show recent commands first, then all commands\n      const recentCommandObjs = recentCommands\n        .map(id => commands.find(cmd => cmd.id === id))\n        .filter(Boolean);\n      \n      const otherCommands = commands.filter(cmd => \n        !recentCommands.includes(cmd.id)\n      );\n      \n      setFilteredCommands([...recentCommandObjs, ...otherCommands]);\n      setSelectedIndex(0);\n      return;\n    }\n\n    const normalizedSearch = search.toLowerCase().trim();\n    const searchWords = normalizedSearch.split(/\\s+/);\n\n    const filtered = commands\n      .filter(cmd => {\n        const searchText = [\n          cmd.label,\n          cmd.description,\n          cmd.category,\n          ...(cmd.keywords || [])\n        ].join(' ').toLowerCase();\n\n        // Match all search words\n        return searchWords.every(word => searchText.includes(word));\n      })\n      .sort((a, b) => {\n        // Prioritize exact label matches\n        const aLabelMatch = a.label.toLowerCase().includes(normalizedSearch);\n        const bLabelMatch = b.label.toLowerCase().includes(normalizedSearch);\n        \n        if (aLabelMatch && !bLabelMatch) return -1;\n        if (!aLabelMatch && bLabelMatch) return 1;\n        \n        // Then by category match\n        const aCategoryMatch = a.category.toLowerCase().includes(normalizedSearch);\n        const bCategoryMatch = b.category.toLowerCase().includes(normalizedSearch);\n        \n        if (aCategoryMatch && !bCategoryMatch) return -1;\n        if (!aCategoryMatch && bCategoryMatch) return 1;\n        \n        // Finally alphabetically\n        return a.label.localeCompare(b.label);\n      });\n\n    setFilteredCommands(filtered);\n    setSelectedIndex(0);\n  }, [search, commands, recentCommands]);\n\n  // Reset state when opening\n  useEffect(() => {\n    if (open) {\n      setSearch('');\n      setSelectedIndex(0);\n      // Focus input after a short delay to ensure dialog is mounted\n      setTimeout(() => {\n        if (inputRef.current) {\n          inputRef.current.focus();\n        }\n      }, 50);\n    }\n  }, [open]);\n\n  // Scroll selected item into view\n  useEffect(() => {\n    if (listRef.current && filteredCommands.length > 0) {\n      const selectedElement = listRef.current.children[selectedIndex];\n      if (selectedElement) {\n        selectedElement.scrollIntoView({\n          block: 'nearest',\n          behavior: 'smooth'\n        });\n      }\n    }\n  }, [selectedIndex, filteredCommands]);\n\n  // Execute command\n  const executeCommand = useCallback((command) => {\n    if (!command) return;\n\n    // Add to recent commands\n    const newRecent = [\n      command.id,\n      ...recentCommands.filter(id => id !== command.id)\n    ].slice(0, 5);\n    \n    setRecentCommands(newRecent);\n    try {\n      localStorage.setItem('rescanvas_recent_commands', JSON.stringify(newRecent));\n    } catch (error) {\n      console.error('[CommandPalette] Error saving recent commands:', error);\n    }\n\n    // Execute command\n    if (onExecute) {\n      onExecute(command);\n    } else if (command.action) {\n      try {\n        command.action();\n      } catch (error) {\n        console.error('[CommandPalette] Error executing command:', error);\n      }\n    }\n\n    // Close palette\n    onClose();\n  }, [onExecute, onClose, recentCommands]);\n\n  // Handle keyboard navigation\n  const handleKeyDown = useCallback((event) => {\n    switch (event.key) {\n      case 'ArrowDown':\n        event.preventDefault();\n        setSelectedIndex(prev => \n          prev < filteredCommands.length - 1 ? prev + 1 : prev\n        );\n        break;\n        \n      case 'ArrowUp':\n        event.preventDefault();\n        setSelectedIndex(prev => prev > 0 ? prev - 1 : prev);\n        break;\n        \n      case 'Enter':\n        event.preventDefault();\n        if (filteredCommands[selectedIndex]) {\n          executeCommand(filteredCommands[selectedIndex]);\n        }\n        break;\n        \n      case 'Escape':\n        event.preventDefault();\n        onClose();\n        break;\n        \n      default:\n        break;\n    }\n  }, [filteredCommands, selectedIndex, executeCommand, onClose]);\n\n  // Format shortcut for display\n  const formatShortcut = (command) => {\n    if (!command.shortcut) return null;\n    \n    const { key, modifiers } = command.shortcut;\n    const parts = [];\n    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;\n    \n    if (modifiers.ctrl) parts.push(isMac ? '' : 'Ctrl');\n    if (modifiers.shift) parts.push(isMac ? '' : 'Shift');\n    if (modifiers.alt) parts.push(isMac ? '' : 'Alt');\n    \n    const displayKey = key.length === 1 ? key.toUpperCase() : key;\n    parts.push(displayKey);\n    \n    return parts.join(' + ');\n  };\n\n  // Group commands by category for display\n  const groupedCommands = filteredCommands.reduce((acc, cmd, idx) => {\n    const prevCmd = idx > 0 ? filteredCommands[idx - 1] : null;\n    const showCategoryHeader = !prevCmd || prevCmd.category !== cmd.category;\n    \n    acc.push({ command: cmd, showCategoryHeader, index: idx });\n    return acc;\n  }, []);\n\n  return (\n    <Dialog\n      open={open}\n      onClose={onClose}\n      maxWidth=\"sm\"\n      fullWidth\n      PaperProps={{\n        className: 'command-palette-dialog',\n        sx: {\n          borderRadius: 2,\n          maxHeight: '70vh'\n        }\n      }}\n      TransitionProps={{\n        onEntered: () => {\n          if (inputRef.current) {\n            inputRef.current.focus();\n          }\n        }\n      }}\n    >\n      <Box sx={{ p: 2, pb: 0 }}>\n        <TextField\n          inputRef={inputRef}\n          autoFocus\n          fullWidth\n          placeholder=\"Type a command or search...\"\n          value={search}\n          onChange={(e) => setSearch(e.target.value)}\n          onKeyDown={handleKeyDown}\n          variant=\"outlined\"\n          size=\"medium\"\n          InputProps={{\n            startAdornment: (\n              <InputAdornment position=\"start\">\n                <SearchIcon color=\"action\" />\n              </InputAdornment>\n            ),\n            sx: {\n              '& .MuiOutlinedInput-notchedOutline': {\n                border: 'none',\n                borderBottom: '1px solid',\n                borderColor: 'divider',\n                borderRadius: 0\n              },\n              '&:hover .MuiOutlinedInput-notchedOutline': {\n                borderColor: 'primary.main'\n              },\n              '&.Mui-focused .MuiOutlinedInput-notchedOutline': {\n                borderColor: 'primary.main',\n                borderWidth: '2px'\n              }\n            }\n          }}\n          sx={{ mb: 1 }}\n        />\n        \n        {filteredCommands.length > 0 && (\n          <Typography variant=\"caption\" color=\"text.secondary\" sx={{ pl: 1 }}>\n            {filteredCommands.length} command{filteredCommands.length !== 1 ? 's' : ''} found\n          </Typography>\n        )}\n      </Box>\n\n      <List\n        ref={listRef}\n        sx={{\n          maxHeight: 'calc(70vh - 120px)',\n          overflow: 'auto',\n          py: 1,\n          '&::-webkit-scrollbar': {\n            width: '8px'\n          },\n          '&::-webkit-scrollbar-track': {\n            background: 'transparent'\n          },\n          '&::-webkit-scrollbar-thumb': {\n            background: 'rgba(0,0,0,0.2)',\n            borderRadius: '4px'\n          }\n        }}\n      >\n        {groupedCommands.length === 0 ? (\n          <Box sx={{ p: 4, textAlign: 'center' }}>\n            <KeyboardIcon sx={{ fontSize: 48, color: 'text.disabled', mb: 1 }} />\n            <Typography variant=\"body2\" color=\"text.secondary\">\n              No commands found\n            </Typography>\n            <Typography variant=\"caption\" color=\"text.disabled\">\n              Try a different search term\n            </Typography>\n          </Box>\n        ) : (\n          groupedCommands.map(({ command, showCategoryHeader, index }) => (\n            <React.Fragment key={command.id}>\n              {showCategoryHeader && (\n                <>\n                  {index > 0 && <Divider sx={{ my: 1 }} />}\n                  <Box sx={{ px: 2, py: 0.5 }}>\n                    <Typography variant=\"caption\" color=\"text.secondary\" fontWeight=\"600\">\n                      {command.category}\n                    </Typography>\n                  </Box>\n                </>\n              )}\n              \n              <ListItem\n                button\n                selected={index === selectedIndex}\n                onClick={() => executeCommand(command)}\n                sx={{\n                  py: 1.5,\n                  px: 2,\n                  cursor: 'pointer',\n                  '&.Mui-selected': {\n                    bgcolor: 'primary.light',\n                    '&:hover': {\n                      bgcolor: 'primary.light'\n                    }\n                  },\n                  '&:hover': {\n                    bgcolor: 'action.hover'\n                  }\n                }}\n              >\n                <ListItemText\n                  primary={command.label}\n                  secondary={command.description}\n                  primaryTypographyProps={{\n                    variant: 'body2',\n                    fontWeight: 500\n                  }}\n                  secondaryTypographyProps={{\n                    variant: 'caption',\n                    color: 'text.secondary'\n                  }}\n                />\n                {command.shortcut && (\n                  <Chip\n                    label={formatShortcut(command)}\n                    size=\"small\"\n                    variant=\"outlined\"\n                    sx={{\n                      ml: 2,\n                      fontFamily: 'monospace',\n                      fontSize: '0.75rem',\n                      height: '24px'\n                    }}\n                  />\n                )}\n              </ListItem>\n            </React.Fragment>\n          ))\n        )}\n      </List>\n\n      <Box sx={{ p: 1.5, borderTop: 1, borderColor: 'divider', bgcolor: 'background.default' }}>\n        <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'flex', gap: 2 }}>\n          <span><strong></strong> Navigate</span>\n          <span><strong>Enter</strong> Select</span>\n          <span><strong>Esc</strong> Close</span>\n        </Typography>\n      </Box>\n    </Dialog>\n  );\n}\n\nexport default CommandPalette;\n","import React, { useMemo } from 'react';\nimport {\n  Dialog,\n  DialogTitle,\n  DialogContent,\n  IconButton,\n  Box,\n  Typography,\n  Table,\n  TableBody,\n  TableRow,\n  TableCell,\n  Chip,\n  Paper,\n  Tabs,\n  Tab,\n  InputAdornment,\n  TextField\n} from '@mui/material';\nimport CloseIcon from '@mui/icons-material/Close';\nimport SearchIcon from '@mui/icons-material/Search';\nimport KeyboardIcon from '@mui/icons-material/Keyboard';\nimport '../styles/KeyboardShortcuts.css';\n\n/**\n * Keyboard Shortcuts Help Dialog\n * \n * Displays all available keyboard shortcuts organized by category.\n * Features:\n * - Categorized display\n * - Tab navigation between categories\n * - Search/filter shortcuts\n * - Platform-specific key display (Cmd vs Ctrl)\n * \n * @param {boolean} open - Whether the dialog is open\n * @param {function} onClose - Callback when dialog closes\n * @param {Array} shortcuts - Array of shortcut objects from KeyboardShortcutManager\n */\nexport function KeyboardShortcutsHelp({ open, onClose, shortcuts = [] }) {\n  const [selectedTab, setSelectedTab] = React.useState(0);\n  const [searchQuery, setSearchQuery] = React.useState('');\n\n  // Group shortcuts by category\n  const groupedShortcuts = useMemo(() => {\n    const filtered = searchQuery\n      ? shortcuts.filter(shortcut => \n          shortcut.label?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n          shortcut.description?.toLowerCase().includes(searchQuery.toLowerCase()) ||\n          shortcut.category?.toLowerCase().includes(searchQuery.toLowerCase())\n        )\n      : shortcuts;\n\n    return filtered.reduce((acc, shortcut) => {\n      const category = shortcut.category || 'General';\n      if (!acc[category]) {\n        acc[category] = [];\n      }\n      acc[category].push(shortcut);\n      return acc;\n    }, {});\n  }, [shortcuts, searchQuery]);\n\n  const categories = Object.keys(groupedShortcuts).sort();\n  const currentCategory = categories[selectedTab] || categories[0];\n\n  // Format shortcut for display\n  const formatShortcut = (shortcut) => {\n    const parts = [];\n    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;\n    \n    if (shortcut.modifiers?.ctrl) parts.push(isMac ? '' : 'Ctrl');\n    if (shortcut.modifiers?.shift) parts.push(isMac ? '' : 'Shift');\n    if (shortcut.modifiers?.alt) parts.push(isMac ? '' : 'Alt');\n    \n    const displayKey = shortcut.key?.length === 1 \n      ? shortcut.key.toUpperCase() \n      : shortcut.key;\n    parts.push(displayKey);\n    \n    return parts.join(' + ');\n  };\n\n  // Reset state when dialog closes\n  React.useEffect(() => {\n    if (!open) {\n      setSearchQuery('');\n      setSelectedTab(0);\n    }\n  }, [open]);\n\n  return (\n    <Dialog\n      open={open}\n      onClose={onClose}\n      maxWidth=\"md\"\n      fullWidth\n      PaperProps={{\n        sx: {\n          borderRadius: 2,\n          maxHeight: '80vh'\n        }\n      }}\n    >\n      <DialogTitle sx={{ display: 'flex', alignItems: 'center', pr: 6 }}>\n        <KeyboardIcon sx={{ mr: 1.5, color: 'primary.main' }} />\n        <Typography variant=\"h6\" component=\"span\">\n          Keyboard Shortcuts\n        </Typography>\n        <IconButton\n          onClick={onClose}\n          sx={{\n            position: 'absolute',\n            right: 8,\n            top: 8,\n            color: 'text.secondary'\n          }}\n          aria-label=\"close\"\n        >\n          <CloseIcon />\n        </IconButton>\n      </DialogTitle>\n\n      <Box sx={{ px: 3, pb: 2 }}>\n        <TextField\n          fullWidth\n          size=\"small\"\n          placeholder=\"Search shortcuts...\"\n          value={searchQuery}\n          onChange={(e) => setSearchQuery(e.target.value)}\n          InputProps={{\n            startAdornment: (\n              <InputAdornment position=\"start\">\n                <SearchIcon fontSize=\"small\" />\n              </InputAdornment>\n            )\n          }}\n          sx={{ maxWidth: 400 }}\n        />\n      </Box>\n\n      {categories.length === 0 ? (\n        <DialogContent>\n          <Box sx={{ py: 4, textAlign: 'center' }}>\n            <KeyboardIcon sx={{ fontSize: 64, color: 'text.disabled', mb: 2 }} />\n            <Typography variant=\"body1\" color=\"text.secondary\">\n              No shortcuts found\n            </Typography>\n            {searchQuery && (\n              <Typography variant=\"caption\" color=\"text.disabled\">\n                Try a different search term\n              </Typography>\n            )}\n          </Box>\n        </DialogContent>\n      ) : (\n        <>\n          <Tabs\n            value={selectedTab}\n            onChange={(e, newValue) => setSelectedTab(newValue)}\n            variant=\"scrollable\"\n            scrollButtons=\"auto\"\n            sx={{\n              borderBottom: 1,\n              borderColor: 'divider',\n              px: 2\n            }}\n          >\n            {categories.map((category, index) => (\n              <Tab\n                key={category}\n                label={`${category} (${groupedShortcuts[category].length})`}\n                sx={{ textTransform: 'none', fontWeight: 500 }}\n              />\n            ))}\n          </Tabs>\n\n          <DialogContent sx={{ px: 3, py: 2 }}>\n            {categories.map((category, index) => (\n              <Box\n                key={category}\n                role=\"tabpanel\"\n                hidden={selectedTab !== index}\n                sx={{ display: selectedTab === index ? 'block' : 'none' }}\n              >\n                {groupedShortcuts[category]?.length > 0 ? (\n                  <Paper variant=\"outlined\" sx={{ overflow: 'hidden' }}>\n                    <Table size=\"small\">\n                      <TableBody>\n                        {groupedShortcuts[category].map((shortcut, idx) => (\n                          <TableRow\n                            key={`${shortcut.shortcutKey || idx}`}\n                            sx={{\n                              '&:last-child td': { border: 0 },\n                              '&:hover': {\n                                bgcolor: 'action.hover'\n                              }\n                            }}\n                          >\n                            <TableCell sx={{ py: 1.5, width: '60%' }}>\n                              <Typography variant=\"body2\" fontWeight={500}>\n                                {shortcut.label || shortcut.description}\n                              </Typography>\n                              {shortcut.description && shortcut.label && (\n                                <Typography variant=\"caption\" color=\"text.secondary\" display=\"block\">\n                                  {shortcut.description}\n                                </Typography>\n                              )}\n                            </TableCell>\n                            <TableCell align=\"right\" sx={{ py: 1.5 }}>\n                              <Chip\n                                label={formatShortcut(shortcut)}\n                                size=\"small\"\n                                variant=\"outlined\"\n                                sx={{\n                                  fontFamily: 'monospace',\n                                  fontSize: '0.75rem',\n                                  fontWeight: 500,\n                                  borderColor: 'primary.main',\n                                  color: 'primary.main',\n                                  bgcolor: 'primary.light',\n                                  opacity: 0.8\n                                }}\n                              />\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  </Paper>\n                ) : (\n                  <Box sx={{ py: 4, textAlign: 'center' }}>\n                    <Typography variant=\"body2\" color=\"text.secondary\">\n                      No shortcuts in this category\n                    </Typography>\n                  </Box>\n                )}\n              </Box>\n            ))}\n\n            {/* Quick Tips Section */}\n            <Box sx={{ mt: 3, p: 2, bgcolor: 'background.default', borderRadius: 1 }}>\n              <Typography variant=\"subtitle2\" gutterBottom fontWeight={600}>\n                 Quick Tips\n              </Typography>\n              <Typography variant=\"caption\" component=\"div\" color=\"text.secondary\" sx={{ mb: 0.5 }}>\n                 Press <strong>Ctrl/Cmd + K</strong> to open the command palette for quick access\n              </Typography>\n              <Typography variant=\"caption\" component=\"div\" color=\"text.secondary\" sx={{ mb: 0.5 }}>\n                 Use <strong>Escape</strong> to cancel any ongoing action or close dialogs\n              </Typography>\n              <Typography variant=\"caption\" component=\"div\" color=\"text.secondary\" sx={{ mb: 0.5 }}>\n                 Shortcuts work globally except when typing in text fields\n              </Typography>\n              <Typography variant=\"caption\" component=\"div\" color=\"text.secondary\">\n                 Tool shortcuts (P, E, T, etc.) are single keys without modifiers\n              </Typography>\n            </Box>\n\n            {/* Platform Notice */}\n            <Box sx={{ mt: 2, textAlign: 'center' }}>\n              <Typography variant=\"caption\" color=\"text.disabled\">\n                {navigator.platform.toUpperCase().indexOf('MAC') >= 0 ? (\n                  <>Displaying Mac keyboard shortcuts ( = Command,  = Option,  = Shift)</>\n                ) : (\n                  <>Displaying Windows/Linux keyboard shortcuts</>\n                )}\n              </Typography>\n            </Box>\n          </DialogContent>\n        </>\n      )}\n    </Dialog>\n  );\n}\n\nexport default KeyboardShortcutsHelp;\n","/**\n * Keyboard Shortcut Manager for ResCanvas\n * \n * Handles registration, execution, and conflict detection of keyboard shortcuts.\n * Supports modifier keys (Ctrl/Cmd, Shift, Alt) and prevents conflicts with\n * input elements.\n * \n * Usage:\n *   const manager = new KeyboardShortcutManager();\n *   manager.register('k', { ctrl: true }, () => openCommandPalette(), 'Open Command Palette');\n *   manager.enable();\n */\n\nexport class KeyboardShortcutManager {\n  constructor() {\n    this.shortcuts = new Map();\n    this.enabled = true;\n    this.activeModifiers = { ctrl: false, shift: false, alt: false };\n    this.conflictWarnings = [];\n  }\n\n  /**\n   * Register a keyboard shortcut\n   * @param {string} key - The key to bind (e.g., 'k', 'Enter', 'Escape')\n   * @param {Object} modifiers - Modifier keys { ctrl, shift, alt }\n   * @param {Function} action - Callback function to execute\n   * @param {string} description - Human-readable description\n   * @param {string} category - Category for grouping (e.g., 'Tools', 'Edit')\n   * @param {boolean} allowInInput - Allow execution even in input fields\n   */\n  register(key, modifiers = {}, action, description, category = 'General', allowInInput = false) {\n    const shortcutKey = this.getShortcutKey(key, modifiers);\n\n    // Warn about conflicts\n    if (this.shortcuts.has(shortcutKey)) {\n      const existing = this.shortcuts.get(shortcutKey);\n      console.warn(`Shortcut conflict detected: ${shortcutKey} already bound to \"${existing.description}\". Overwriting with \"${description}\".`);\n      this.conflictWarnings.push({\n        key: shortcutKey,\n        existing: existing.description,\n        new: description\n      });\n    }\n\n    this.shortcuts.set(shortcutKey, {\n      key,\n      modifiers,\n      action,\n      description,\n      category,\n      allowInInput,\n      enabled: true,\n      registeredAt: Date.now()\n    });\n\n    return shortcutKey;\n  }\n\n  /**\n   * Unregister a keyboard shortcut by ID\n   * @param {string} shortcutId - The shortcut ID returned by register()\n   */\n  unregister(shortcutId) {\n    return this.shortcuts.delete(shortcutId);\n  }\n\n  /**\n   * Handle keydown events\n   */\n  handleKeyDown(event) {\n    if (!this.enabled) return;\n\n    // Determine modifiers\n    const modifiers = {\n      ctrl: event.ctrlKey || event.metaKey, // Support both Ctrl (Windows/Linux) and Cmd (Mac)\n      shift: event.shiftKey,\n      alt: event.altKey\n    };\n\n    const shortcutKey = this.getShortcutKey(event.key, modifiers);\n    const shortcut = this.shortcuts.get(shortcutKey);\n\n    if (shortcut && shortcut.enabled) {\n      // Check if we should ignore (in input field)\n      if (!shortcut.allowInInput && this.isInputElement(event.target)) {\n        return;\n      }\n\n      event.preventDefault();\n      event.stopPropagation();\n\n      try {\n        shortcut.action(event);\n      } catch (error) {\n        console.error(`[KeyboardShortcuts] Error executing shortcut \"${shortcutKey}\":`, error);\n      }\n    }\n  }\n\n  /**\n   * Generate a unique key for the shortcut map\n   */\n  getShortcutKey(key, modifiers) {\n    const parts = [];\n    if (modifiers.ctrl) parts.push('Ctrl');\n    if (modifiers.shift) parts.push('Shift');\n    if (modifiers.alt) parts.push('Alt');\n\n    // Normalize key name\n    const normalizedKey = this.normalizeKey(key);\n    parts.push(normalizedKey);\n\n    return parts.join('+');\n  }\n\n  /**\n   * Normalize key names for consistency\n   */\n  normalizeKey(key) {\n    // Special keys that need normalization\n    const keyMap = {\n      ' ': 'Space',\n      '+': 'Plus',\n      '=': 'Equal',\n      '-': 'Minus',\n      '_': 'Underscore',\n      '[': 'BracketLeft',\n      ']': 'BracketRight',\n      '{': 'BraceLeft',\n      '}': 'BraceRight',\n      '/': 'Slash',\n      '\\\\': 'Backslash',\n      ',': 'Comma',\n      '.': 'Period',\n      '<': 'Less',\n      '>': 'Greater',\n      '?': 'Question'\n    };\n\n    // Return mapped key or lowercase original\n    return keyMap[key] || key.toLowerCase();\n  }\n\n  /**\n   * Check if element is an input field where shortcuts should be disabled\n   */\n  isInputElement(element) {\n    if (!element) return false;\n\n    const tagName = element.tagName?.toLowerCase();\n    if (!tagName) return false;\n\n    const inputTypes = ['text', 'password', 'email', 'search', 'tel', 'url', 'number'];\n\n    // Check for input/textarea\n    if (tagName === 'textarea') return true;\n    if (tagName === 'input' && inputTypes.includes(element.type?.toLowerCase())) return true;\n\n    // Check for contenteditable in multiple ways (for JSDOM compatibility)\n    // Check the attribute first (most reliable in tests)\n    const contentEditableAttr = element.getAttribute?.('contenteditable');\n    if (contentEditableAttr === 'true' || contentEditableAttr === '') return true;\n\n    // Check the DOM property - but only if explicitly set to 'true', not 'inherit'\n    if (element.contentEditable === 'true') return true;\n\n    // Check the isContentEditable property\n    if (element.isContentEditable === true) return true;\n\n    // Check for Material-UI input wrappers or parent contenteditable\n    if (element.closest?.('.MuiInputBase-root') ||\n      element.closest?.('[contenteditable=\"true\"]') ||\n      element.closest?.('[contenteditable=\"\"]')) {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Disable all shortcuts\n   */\n  disable() {\n    this.enabled = false;\n  }\n\n  /**\n   * Enable all shortcuts\n   */\n  enable() {\n    this.enabled = true;\n  }\n\n  /**\n   * Toggle enabled state\n   */\n  toggle() {\n    this.enabled = !this.enabled;\n    return this.enabled;\n  }\n\n  /**\n   * Get all registered shortcuts\n   */\n  getAllShortcuts() {\n    return Array.from(this.shortcuts.entries()).map(([key, shortcut]) => ({\n      shortcutKey: key,\n      ...shortcut\n    }));\n  }\n\n  /**\n   * Get shortcuts by category\n   * @param {string} category - Optional category to filter by. If not provided, returns all shortcuts grouped by category\n   */\n  getShortcutsByCategory(category) {\n    const shortcuts = this.getAllShortcuts();\n\n    // If category is provided, filter by that category\n    if (category) {\n      return shortcuts.filter(shortcut => shortcut.category === category);\n    }\n\n    // Otherwise return all shortcuts grouped by category\n    const grouped = {};\n    shortcuts.forEach(shortcut => {\n      if (!grouped[shortcut.category]) {\n        grouped[shortcut.category] = [];\n      }\n      grouped[shortcut.category].push(shortcut);\n    });\n\n    return grouped;\n  }\n\n  /**\n   * Get conflict warnings\n   */\n  getConflicts() {\n    return this.conflictWarnings;\n  }\n\n  /**\n   * Clear all registered shortcuts\n   */\n  clear() {\n    this.shortcuts.clear();\n    this.conflictWarnings = [];\n  }\n\n  /**\n   * Format shortcut for display (e.g., \"Ctrl+K\" on Windows, \"K\" on Mac)\n   * @param {Object} shortcut - Object with {key, modifiers} properties\n   */\n  formatShortcut(shortcut) {\n    const { key, modifiers = {} } = shortcut;\n    const parts = [];\n\n    // Use platform-specific naming\n    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;\n\n    if (modifiers.ctrl) parts.push(isMac ? '' : 'Ctrl');\n    if (modifiers.shift) parts.push(isMac ? '' : 'Shift');\n    if (modifiers.alt) parts.push(isMac ? '' : 'Alt');\n\n    // Capitalize key for display\n    const displayKey = key.length === 1 ? key.toUpperCase() : key;\n    parts.push(displayKey);\n\n    // Use \"+\" for Windows/Linux, no separator for Mac\n    return parts.join(isMac ? '' : '+');\n  }\n\n  /**\n   * Check if a shortcut is registered\n   */\n  has(key, modifiers = {}) {\n    const shortcutKey = this.getShortcutKey(key, modifiers);\n    return this.shortcuts.has(shortcutKey);\n  }\n\n  /**\n   * Enable/disable specific shortcut\n   */\n  setShortcutEnabled(key, modifiers, enabled) {\n    const shortcutKey = this.getShortcutKey(key, modifiers);\n    const shortcut = this.shortcuts.get(shortcutKey);\n\n    if (shortcut) {\n      shortcut.enabled = enabled;\n      return true;\n    }\n\n    return false;\n  }\n}\n\n// Export singleton instance for convenience\nexport const keyboardShortcuts = new KeyboardShortcutManager();\n\n// Export key constants for convenience\nexport const Keys = {\n  ESCAPE: 'Escape',\n  ENTER: 'Enter',\n  SPACE: 'Space',\n  TAB: 'Tab',\n  BACKSPACE: 'Backspace',\n  DELETE: 'Delete',\n  ARROW_UP: 'ArrowUp',\n  ARROW_DOWN: 'ArrowDown',\n  ARROW_LEFT: 'ArrowLeft',\n  ARROW_RIGHT: 'ArrowRight',\n  HOME: 'Home',\n  END: 'End',\n  PAGE_UP: 'PageUp',\n  PAGE_DOWN: 'PageDown'\n};\n","/**\n * Command Registry for ResCanvas\n * \n * Central registry for all executable commands in the application.\n * Used by the Command Palette to discover and execute actions.\n * \n * Usage:\n *   import { commandRegistry } from './CommandRegistry';\n *   \n *   commandRegistry.register({\n *     id: 'canvas.clear',\n *     label: 'Clear Canvas',\n *     description: 'Remove all strokes',\n *     keywords: ['delete', 'erase', 'reset'],\n *     action: () => clearCanvas(),\n *     category: 'Canvas',\n *     shortcut: { key: 'k', modifiers: { ctrl: true, shift: true } }\n *   });\n */\n\nexport class CommandRegistry {\n  constructor() {\n    this.commands = new Map();\n    this.listeners = []; // Legacy listener array\n    this._listeners = {  // Event-specific listeners for tests\n      beforeExecute: [],\n      afterExecute: [],\n      register: [],\n      unregister: [],\n      error: [],\n      clear: []\n    };\n  }\n\n  /**\n   * Register a command\n   * @param {Object} command - Command configuration\n   * @param {string} command.id - Unique identifier (e.g., 'canvas.clear')\n   * @param {string} command.label - Display label\n   * @param {string} command.description - Longer description\n   * @param {Array<string>} command.keywords - Search keywords\n   * @param {Function} command.action - Action to execute\n   * @param {string} command.category - Category for grouping\n   * @param {Object} command.shortcut - Keyboard shortcut { key, modifiers }\n   * @param {string} command.icon - Icon name/component\n   * @param {Function} command.enabled - Function returning boolean for enabled state\n   * @param {Function} command.visible - Function returning boolean for visibility\n   */\n  register(command, options = {}) {\n    if (!command.id) {\n      throw new Error('[CommandRegistry] Command must have an id');\n    }\n\n    // Check for duplicate command ID - throw error per test expectations\n    // Allow overwriting if allowOverwrite option is true\n    if (this.commands.has(command.id) && !options.allowOverwrite) {\n      throw new Error(`Command with id ${command.id} already registered`);\n    }\n\n    // Warn if action is missing but allow registration (for testing/placeholder commands)\n    if (!command.action || typeof command.action !== 'function') {\n      console.error('[CommandRegistry] Command must have an action function:', command);\n      // Still register with a no-op action\n    }\n\n    const fullCommand = {\n      id: command.id,\n      label: command.label || command.id,\n      description: command.description || '',\n      keywords: command.keywords || [],\n      tags: command.tags || [], // Add tags property\n      action: command.action || (() => { }), // Default no-op action\n      category: command.category, // Don't default to 'General', keep as undefined if not provided\n      shortcut: command.shortcut || null,\n      icon: command.icon || null,\n      enabled: command.enabled || (() => true),\n      visible: command.visible || (() => true),\n      _hasExplicitEnabled: command.hasOwnProperty('enabled'), // Track if enabled was explicitly set\n      registeredAt: Date.now()\n    };\n\n    this.commands.set(command.id, fullCommand);\n    this.notifyListeners('register', fullCommand);\n\n    return true;\n  }\n\n  /**\n   * Unregister a command\n   */\n  unregister(commandId) {\n    const command = this.commands.get(commandId);\n    const deleted = this.commands.delete(commandId);\n\n    if (deleted) {\n      this.notifyListeners('unregister', command);\n    }\n\n    return deleted;\n  }\n\n  /**\n   * Execute a command by ID\n   */\n  async execute(commandId, ...args) {\n    const command = this.commands.get(commandId);\n\n    if (!command) {\n      throw new Error(`Command ${commandId} not found`);\n    }\n\n    if (typeof command.enabled === 'function' && !command.enabled()) {\n      throw new Error(`Command ${commandId} is disabled`);\n    }\n\n    try {\n      this.notifyListeners('before-execute', command);\n      const result = await command.action(...args);\n      this.notifyListeners('after-execute', command, result);\n\n      return result;\n    } catch (error) {\n      console.error(`[CommandRegistry] Error executing command \"${commandId}\":`, error);\n      this.notifyListeners('error', command, error);\n\n      throw error;\n    }\n  }\n\n  /**\n   * Get a command by ID\n   */\n  get(commandId) {\n    return this.commands.get(commandId);\n  }\n\n  /**\n   * Check if command exists\n   */\n  has(commandId) {\n    return this.commands.has(commandId);\n  }\n\n  /**\n   * Get all registered commands\n   * Returns copies to prevent external mutation of internal state\n   */\n  getAll() {\n    return Array.from(this.commands.values())\n      .filter(cmd => {\n        try {\n          return typeof cmd.visible === 'function' ? cmd.visible() : true;\n        } catch (error) {\n          console.error(`[CommandRegistry] Error checking visibility for \"${cmd.id}\":`, error);\n          return true;\n        }\n      })\n      .map(cmd => ({ ...cmd })); // Return shallow copies\n  }\n\n  /**\n   * Get commands by category\n   */\n  getByCategory(category) {\n    return this.getAll().filter(cmd => cmd.category === category);\n  }\n\n  /**\n   * Get all categories\n   */\n  getCategories() {\n    const categories = new Set();\n    this.commands.forEach(cmd => categories.add(cmd.category));\n    return Array.from(categories).sort();\n  }\n\n  /**\n   * Search commands by query\n   * Searches in label, description, keywords, and category using word boundaries\n   */\n  search(query) {\n    if (!query || query.trim() === '') {\n      return this.getAll();\n    }\n\n    const normalizedQuery = query.toLowerCase().trim();\n    const words = normalizedQuery.split(/\\s+/);\n\n    return this.getAll().filter(cmd => {\n      // Build searchable text segments\n      const segments = [\n        cmd.label,\n        cmd.description,\n        cmd.category,\n        ...cmd.keywords\n      ];\n\n      // Match all query words - use word boundaries for more precise matching\n      return words.every(word => {\n        return segments.some(segment => {\n          if (!segment) return false;\n          const segmentLower = segment.toLowerCase();\n          // Match whole words or at start of words\n          return segmentLower === word ||\n            segmentLower.startsWith(word + ' ') ||\n            segmentLower.endsWith(' ' + word) ||\n            segmentLower.includes(' ' + word + ' ') ||\n            segmentLower.startsWith(word);\n        });\n      });\n    }).sort((a, b) => {\n      // Prioritize exact label matches\n      const aLabelMatch = a.label.toLowerCase() === normalizedQuery;\n      const bLabelMatch = b.label.toLowerCase() === normalizedQuery;\n\n      if (aLabelMatch && !bLabelMatch) return -1;\n      if (!aLabelMatch && bLabelMatch) return 1;\n\n      // Then by label starts with\n      const aLabelStarts = a.label.toLowerCase().startsWith(normalizedQuery);\n      const bLabelStarts = b.label.toLowerCase().startsWith(normalizedQuery);\n\n      if (aLabelStarts && !bLabelStarts) return -1;\n      if (!aLabelStarts && bLabelStarts) return 1;\n\n      // Then by category match\n      const aCategoryMatch = a.category.toLowerCase().includes(normalizedQuery);\n      const bCategoryMatch = b.category.toLowerCase().includes(normalizedQuery);\n\n      if (aCategoryMatch && !bCategoryMatch) return -1;\n      if (!aCategoryMatch && bCategoryMatch) return 1;\n\n      // Finally alphabetically\n      return a.label.localeCompare(b.label);\n    });\n  }\n\n  /**\n   * Get commands with keyboard shortcuts\n   */\n  getCommandsWithShortcuts() {\n    return this.getAll().filter(cmd => cmd.shortcut !== null);\n  }\n\n  /**\n   * Clear all commands\n   */\n  clear() {\n    const commandIds = Array.from(this.commands.keys());\n    this.commands.clear();\n    this.notifyListeners('clear', commandIds);\n  }\n\n  /**\n   * Register a listener for registry events (new API matching tests)\n   * @param {string} eventName - Event name (beforeExecute, afterExecute, register, unregister, error, clear)\n   * @param {Function} callback - Callback function\n   */\n  on(eventName, callback) {\n    if (this._listeners[eventName]) {\n      this._listeners[eventName].push(callback);\n    }\n    return () => {\n      if (this._listeners[eventName]) {\n        this._listeners[eventName] = this._listeners[eventName].filter(l => l !== callback);\n      }\n    };\n  }\n\n  /**\n   * Register a listener for registry events (legacy API)\n   * Events: 'register', 'unregister', 'before-execute', 'after-execute', 'error', 'clear'\n   */\n  addListener(callback) {\n    this.listeners.push(callback);\n    return () => {\n      this.listeners = this.listeners.filter(l => l !== callback);\n    };\n  }\n\n  /**\n   * Notify all listeners of an event\n   */\n  notifyListeners(event, ...args) {\n    // Notify legacy listeners with kebab-case event names\n    this.listeners.forEach(listener => {\n      try {\n        listener(event, ...args);\n      } catch (error) {\n        console.error('[CommandRegistry] Error in listener:', error);\n      }\n    });\n\n    // Notify new listeners with camelCase event names\n    const eventMap = {\n      'register': 'register',\n      'unregister': 'unregister',\n      'before-execute': 'beforeExecute',\n      'after-execute': 'afterExecute',\n      'error': 'error',\n      'clear': 'clear'\n    };\n\n    const camelEvent = eventMap[event] || event;\n    if (this._listeners[camelEvent]) {\n      this._listeners[camelEvent].forEach(listener => {\n        try {\n          listener(...args);\n        } catch (error) {\n          console.error('[CommandRegistry] Error in listener:', error);\n        }\n      });\n    }\n  }\n\n  /**\n   * Get registry statistics\n   */\n  getStats() {\n    const all = Array.from(this.commands.values()); // Get all commands\n    const visible = this.getAll(); // Get visible commands\n\n    // Count enabled/disabled among visible commands only\n    // Only count commands that have explicit enabled functions\n    const visibleEnabled = visible.filter(cmd => {\n      try {\n        // Only count if enabled was explicitly set and returns true\n        return cmd._hasExplicitEnabled && cmd.enabled();\n      } catch (error) {\n        return false;\n      }\n    });\n\n    const visibleDisabled = visible.filter(cmd => {\n      try {\n        // Only count if enabled was explicitly set and returns false\n        return cmd._hasExplicitEnabled && !cmd.enabled();\n      } catch (error) {\n        return false;\n      }\n    });\n\n    return {\n      total: all.length, // Count of all commands (including invisible)\n      byCategory: this.getCategories().reduce((acc, cat) => {\n        acc[cat] = this.getByCategory(cat).length;\n        return acc;\n      }, {}),\n      categories: this.getCategories().length,\n      withShortcuts: this.getCommandsWithShortcuts().length,\n      enabled: visibleEnabled.length,\n      disabled: visibleDisabled.length,\n      visible: visible.length\n    };\n  }\n\n  /**\n   * Batch register multiple commands\n   */\n  registerBatch(commands) {\n    const results = commands.map(cmd => ({\n      id: cmd.id,\n      success: this.register(cmd)\n    }));\n\n    return results;\n  }\n\n  /**\n   * Export commands as JSON (for debugging/persistence)\n   */\n  export() {\n    return Array.from(this.commands.entries()).map(([id, cmd]) => ({\n      id,\n      label: cmd.label,\n      description: cmd.description,\n      keywords: cmd.keywords,\n      category: cmd.category,\n      shortcut: cmd.shortcut,\n      icon: cmd.icon,\n      registeredAt: cmd.registeredAt\n    }));\n  }\n}\n\n// Export singleton instance\nexport const commandRegistry = new CommandRegistry();\n\n// Export for testing/advanced use cases\nexport default CommandRegistry;\n","import React, { useState } from 'react';\nimport {\n  IconButton,\n  Menu,\n  MenuItem,\n  ListItemIcon,\n  ListItemText,\n  Tooltip\n} from '@mui/material';\nimport CreateIcon from '@mui/icons-material/Create';\nimport EraserIcon from '@mui/icons-material/Delete';\nimport ShapeIcon from '@mui/icons-material/ShapeLine';\nimport PanToolIcon from '@mui/icons-material/PanTool';\nimport ContentPasteIcon from '@mui/icons-material/ContentPaste';\nimport StarsIcon from '@mui/icons-material/Stars';\n\nexport default function DrawModeMenu({\n  drawMode = 'freehand',\n  setDrawMode,\n  color,\n  previousColor,\n  setColor,\n  setPreviousColor,\n  controlsDisabled = false,\n}) {\n  const [anchorEl, setAnchorEl] = useState(null);\n  const open = Boolean(anchorEl);\n\n  const modes = {\n    freehand: { icon: <CreateIcon />, label: 'Freehand' },\n    eraser: { icon: <EraserIcon />, label: 'Eraser' },\n    shape: { icon: <ShapeIcon />, label: 'Shape' },\n    select: { icon: <PanToolIcon />, label: 'Select' },\n    paste: { icon: <ContentPasteIcon />, label: 'Paste' },\n    stamp: { icon: <StarsIcon />, label: 'Stamp' },\n  };\n\n  const safeDrawMode = modes[drawMode] ? drawMode : 'freehand';\n\n  const handleClick = (e) => {\n    if (controlsDisabled) return;\n    setAnchorEl(e.currentTarget);\n  };\n  const handleClose = (mode) => {\n    setAnchorEl(null);\n    if (controlsDisabled) return;\n    if (!mode || mode === safeDrawMode) return;\n\n    // if switching *to* eraser, stash your current color\n    if (safeDrawMode !== 'eraser' && mode === 'eraser') {\n      setPreviousColor(color);\n      setColor(\"#FFFFFF\")\n    }\n\n    // if switching *off* eraser, restore the stashed color\n    if (safeDrawMode === 'eraser' && mode !== 'eraser' && previousColor) {\n      setColor(previousColor);\n      setPreviousColor(null);\n    }\n\n    setDrawMode(mode);\n  };\n\n  return (\n    <>\n      <Tooltip title={modes[safeDrawMode].label}>\n        <IconButton\n          onClick={handleClick}\n          sx={{\n            borderRadius: 1,\n            width: 40,\n            height: 32,\n            padding: 0,\n            minWidth: 40,\n            '& .MuiTouchRipple-root': {\n              borderRadius: 1,\n            },\n          }}\n          disabled={controlsDisabled}\n        >\n          {modes[safeDrawMode].icon}\n        </IconButton>\n      </Tooltip>\n\n      <Menu\n        anchorEl={anchorEl}\n        open={open}\n        onClose={() => handleClose()}\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'left' }}\n        transformOrigin={{ vertical: 'top', horizontal: 'left' }}\n      >\n        {Object.entries(modes).map(([mode, { icon, label }]) => (\n          <MenuItem\n            key={mode}\n            selected={mode === safeDrawMode}\n            onClick={() => handleClose(mode)}\n            disabled={controlsDisabled}\n          >\n            <ListItemIcon>{icon}</ListItemIcon>\n            <ListItemText primary={label} />\n          </MenuItem>\n        ))}\n      </Menu>\n    </>\n  );\n}\n","import React, { useState } from 'react';\nimport {\n  IconButton,\n  Menu,\n  MenuItem,\n  ListItemIcon,\n  ListItemText,\n  Tooltip\n} from '@mui/material';\nimport CircleIcon from '@mui/icons-material/Circle';\nimport SquareIcon from '@mui/icons-material/Square';\nimport HexagonIcon from '@mui/icons-material/Hexagon';\nimport TimelineIcon from '@mui/icons-material/Timeline';\n\nexport default function ShapeMenu({ shapeType, setShapeType, controlsDisabled = false }) {\n  const [anchorEl, setAnchorEl] = useState(null);\n  const open = Boolean(anchorEl);\n\n  const shapes = {\n    circle: { icon: <CircleIcon />, label: 'Circle' },\n    rectangle: { icon: <SquareIcon />, label: 'Rectangle' },\n    hexagon: { icon: <HexagonIcon />, label: 'Hexagon' },\n    line: { icon: <TimelineIcon />, label: 'Line' },\n  };\n\n  const handleClick = e => {\n    if (controlsDisabled) return;\n    setAnchorEl(e.currentTarget);\n  };\n  const handleClose = (type) => {\n    setAnchorEl(null);\n    if (controlsDisabled) return;\n    if (type && type !== shapeType) {\n      setShapeType(type);\n    }\n  };\n\n  const buttonSX = {\n    borderRadius: 1,\n    width: 50,\n    height: 32,\n    padding: 0,\n    '& .MuiTouchRipple-root': { borderRadius: 1 },\n  };\n\n  return (\n    <>\n      <Tooltip title={shapes[shapeType].label}>\n        <IconButton onClick={handleClick} sx={buttonSX} disabled={controlsDisabled}>\n          {shapes[shapeType].icon}\n        </IconButton>\n      </Tooltip>\n\n      <Menu\n        anchorEl={anchorEl}\n        open={open}\n        onClose={() => handleClose()}\n        anchorOrigin={{ vertical: 'bottom', horizontal: 'left' }}\n        transformOrigin={{ vertical: 'top', horizontal: 'left' }}\n      >\n        {Object.entries(shapes).map(([type, { icon, label }]) => (\n          <MenuItem\n            key={type}\n            selected={type === shapeType}\n            onClick={() => handleClose(type)}\n            disabled={controlsDisabled}\n          >\n            <ListItemIcon>{icon}</ListItemIcon>\n            <ListItemText primary={label} />\n          </MenuItem>\n        ))}\n      </Menu>\n    </>\n  );\n}\n","import React, { useEffect, useRef } from \"react\";\n\nexport default function WackyBrushPreview({ brushId, params = {} }) {\n  const canvasRef = useRef();\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n    \n    const ctx = canvas.getContext(\"2d\");\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    // Set a light background\n    ctx.fillStyle = \"#f8f9fa\";\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    const intensity = (params.intensity || 50) / 50;\n    const variation = (params.variation || 50) / 100;\n    const flow = (params.flow || 50) / 100;\n\n    // Draw brush preview based on type\n    switch (brushId) {\n      case \"normal\":\n        drawNormalPreview(ctx, intensity, variation, flow);\n        break;\n      case \"wacky\":\n        drawWackyPreview(ctx, intensity, variation, flow);\n        break;\n      case \"drip\":\n        drawDripPreview(ctx, intensity, variation, flow);\n        break;\n      case \"scatter\":\n        drawScatterPreview(ctx, intensity, variation, flow);\n        break;\n      case \"neon\":\n        drawNeonPreview(ctx, intensity, variation, flow);\n        break;\n      case \"chalk\":\n        drawChalkPreview(ctx, intensity, variation, flow);\n        break;\n      case \"spray\":\n        drawSprayPreview(ctx, intensity, variation, flow);\n        break;\n      default:\n        drawNormalPreview(ctx, intensity, variation, flow);\n    }\n  }, [brushId, params]);\n\n  const drawNormalPreview = (ctx, intensity, variation, flow) => {\n    ctx.strokeStyle = \"#333\";\n    ctx.lineWidth = 3 * intensity;\n    ctx.lineCap = \"round\";\n    ctx.beginPath();\n    ctx.moveTo(20, 50);\n    ctx.quadraticCurveTo(75, 20, 130, 50);\n    ctx.stroke();\n  };\n\n  const drawWackyPreview = (ctx, intensity, variation, flow) => {\n    const particles = Math.floor(25 * intensity);\n    for (let i = 0; i < particles; i++) {\n      const x = 20 + (i / particles) * 110;\n      const y = 50 + Math.sin(i * 0.3) * 15 * variation;\n      const size = (2 + Math.random() * 6) * intensity;\n      \n      ctx.beginPath();\n      ctx.arc(x, y, size, 0, Math.PI * 2);\n      ctx.fillStyle = `hsl(${(i * 20) % 360}, 80%, 60%)`;\n      ctx.globalAlpha = flow;\n      ctx.fill();\n    }\n    ctx.globalAlpha = 1;\n  };\n\n  const drawDripPreview = (ctx, intensity, variation, flow) => {\n    // Main stroke\n    ctx.strokeStyle = \"#4a90e2\";\n    ctx.lineWidth = 4 * intensity;\n    ctx.lineCap = \"round\";\n    ctx.beginPath();\n    ctx.moveTo(20, 40);\n    ctx.quadraticCurveTo(75, 20, 130, 40);\n    ctx.stroke();\n\n    // Drips\n    for (let i = 0; i < 5; i++) {\n      const x = 30 + i * 25;\n      const dripHeight = (10 + Math.random() * 20) * variation;\n      ctx.beginPath();\n      ctx.arc(x, 40 + dripHeight, 2 * intensity, 0, Math.PI * 2);\n      ctx.fillStyle = \"#4a90e2\";\n      ctx.globalAlpha = flow;\n      ctx.fill();\n    }\n    ctx.globalAlpha = 1;\n  };\n\n  const drawScatterPreview = (ctx, intensity, variation, flow) => {\n    const centerY = 50;\n    const points = Math.floor(40 * intensity);\n    \n    for (let i = 0; i < points; i++) {\n      const x = 20 + Math.random() * 110;\n      const y = centerY + (Math.random() - 0.5) * 30 * variation;\n      const size = (1 + Math.random() * 4) * intensity;\n      \n      ctx.beginPath();\n      ctx.arc(x, y, size, 0, Math.PI * 2);\n      ctx.fillStyle = \"#e74c3c\";\n      ctx.globalAlpha = flow * 0.8;\n      ctx.fill();\n    }\n    ctx.globalAlpha = 1;\n  };\n\n  const drawNeonPreview = (ctx, intensity, variation, flow) => {\n    ctx.save();\n    ctx.shadowColor = \"#00ff88\";\n    ctx.shadowBlur = 10 * intensity;\n    ctx.strokeStyle = \"#00ff88\";\n    ctx.lineWidth = 3 * intensity;\n    ctx.lineCap = \"round\";\n    ctx.globalAlpha = flow;\n    \n    ctx.beginPath();\n    ctx.moveTo(20, 50);\n    ctx.quadraticCurveTo(75, 30 + 10 * variation, 130, 50);\n    ctx.stroke();\n    ctx.restore();\n  };\n\n  const drawChalkPreview = (ctx, intensity, variation, flow) => {\n    const path = [];\n    for (let x = 20; x <= 130; x += 2) {\n      const y = 50 + Math.sin(x * 0.05) * 10;\n      path.push({ x, y });\n    }\n\n    path.forEach(point => {\n      for (let i = 0; i < 3; i++) {\n        const offsetX = (Math.random() - 0.5) * 4 * variation;\n        const offsetY = (Math.random() - 0.5) * 4 * variation;\n        \n        ctx.beginPath();\n        ctx.arc(point.x + offsetX, point.y + offsetY, 1.5 * intensity, 0, Math.PI * 2);\n        ctx.fillStyle = \"#f39c12\";\n        ctx.globalAlpha = flow * (0.3 + Math.random() * 0.4);\n        ctx.fill();\n      }\n    });\n    ctx.globalAlpha = 1;\n  };\n\n  const drawSprayPreview = (ctx, intensity, variation, flow) => {\n    const centerY = 50;\n    const sprayPoints = Math.floor(60 * intensity);\n    \n    for (let i = 0; i < sprayPoints; i++) {\n      const progress = i / sprayPoints;\n      const centerX = 20 + progress * 110;\n      \n      const angle = Math.random() * Math.PI * 2;\n      const distance = Math.random() * 15 * variation;\n      const x = centerX + Math.cos(angle) * distance;\n      const y = centerY + Math.sin(angle) * distance;\n      \n      ctx.beginPath();\n      ctx.arc(x, y, 1, 0, Math.PI * 2);\n      ctx.fillStyle = \"#9b59b6\";\n      ctx.globalAlpha = flow * 0.6;\n      ctx.fill();\n    }\n    ctx.globalAlpha = 1;\n  };\n\n  return (\n    <canvas \n      ref={canvasRef} \n      width={150} \n      height={100} \n      style={{ \n        border: '1px solid #e0e0e0', \n        borderRadius: '4px',\n        background: '#fff'\n      }} \n    />\n  );\n}\n","import React, { useState } from \"react\";\nimport WackyBrushPreview from \"./WackyBrushPreview\";\nimport { Slider, Typography, Box, Divider, Chip, IconButton } from \"@mui/material\";\nimport CloseIcon from '@mui/icons-material/Close';\nimport \"../../styles/brushes.css\";\n\nconst brushes = [\n  { id: \"normal\", name: \"Normal\", icon: \"\", description: \"Classic smooth brush\" },\n  { id: \"wacky\", name: \"Wacky\", icon: \"\", description: \"Colorful scattered particles\" },\n  { id: \"drip\", name: \"Drip\", icon: \"\", description: \"Paint that drips and flows\" },\n  { id: \"scatter\", name: \"Scatter\", icon: \"\", description: \"Random scattered dots\" },\n  { id: \"neon\", name: \"Neon\", icon: \"\", description: \"Glowing neon effect\" },\n  { id: \"chalk\", name: \"Chalk\", icon: \"\", description: \"Textured chalk strokes\" },\n  { id: \"spray\", name: \"Spray\", icon: \"\", description: \"Spray paint effect\" },\n];\n\nexport default function BrushPanel({ onSelect, onParamsChange, selectedBrush = \"normal\", onClose }) {\n  const [selected, setSelected] = useState(selectedBrush);\n  const [brushParams, setBrushParams] = useState({\n    intensity: 50,\n    variation: 50,\n    flow: 50\n  });\n\n  const handleSelect = (id) => {\n    setSelected(id);\n    if (onSelect) onSelect(id);\n  };\n\n  const handleParamChange = (param, value) => {\n    const newParams = { ...brushParams, [param]: value };\n    setBrushParams(newParams);\n    if (onParamsChange) onParamsChange(newParams);\n  };\n\n  const selectedBrushData = brushes.find(b => b.id === selected);\n\n  return (\n    <div className=\"brush-panel\">\n      <Box sx={{ mb: 2, display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between' }}>\n        <Box>\n          <Typography variant=\"h6\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n             Brush Panel\n          </Typography>\n          <Typography variant=\"caption\" color=\"text.secondary\">\n            Choose your creative brush\n          </Typography>\n        </Box>\n        {onClose && (\n          <IconButton\n            onClick={onClose}\n            size=\"small\"\n            sx={{\n              mt: -0.5,\n              '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.08)' }\n            }}\n          >\n            <CloseIcon fontSize=\"small\" />\n          </IconButton>\n        )}\n      </Box>\n\n      <div className=\"brush-grid\">\n        {brushes.map((brush) => (\n          <button\n            key={brush.id}\n            className={`brush-card ${selected === brush.id ? \"active\" : \"\"}`}\n            onClick={() => handleSelect(brush.id)}\n            title={brush.description}\n          >\n            <div className=\"brush-icon\">{brush.icon}</div>\n            <div className=\"brush-name\">{brush.name}</div>\n          </button>\n        ))}\n      </div>\n\n      {selectedBrushData && (\n        <Box sx={{ mt: 2 }}>\n          <Chip\n            label={selectedBrushData.description}\n            size=\"small\"\n            color=\"primary\"\n            variant=\"outlined\"\n            sx={{ mb: 2 }}\n          />\n        </Box>\n      )}\n\n      <div className=\"brush-preview\">\n        <Typography variant=\"subtitle2\" sx={{ mb: 1 }}>Preview:</Typography>\n        <WackyBrushPreview brushId={selected} params={brushParams} />\n      </div>\n\n      <Divider sx={{ my: 2 }} />\n\n      <Box sx={{ mt: 2 }}>\n        <Typography variant=\"subtitle2\" sx={{ mb: 2 }}>Brush Settings:</Typography>\n\n        <Box sx={{ mb: 2 }}>\n          <Typography variant=\"caption\">Intensity</Typography>\n          <Slider\n            size=\"small\"\n            value={brushParams.intensity}\n            onChange={(_, value) => handleParamChange('intensity', value)}\n            min={10}\n            max={100}\n            valueLabelDisplay=\"auto\"\n          />\n        </Box>\n\n        <Box sx={{ mb: 2 }}>\n          <Typography variant=\"caption\">Variation</Typography>\n          <Slider\n            size=\"small\"\n            value={brushParams.variation}\n            onChange={(_, value) => handleParamChange('variation', value)}\n            min={0}\n            max={100}\n            valueLabelDisplay=\"auto\"\n          />\n        </Box>\n\n        <Box sx={{ mb: 2 }}>\n          <Typography variant=\"caption\">Flow</Typography>\n          <Slider\n            size=\"small\"\n            value={brushParams.flow}\n            onChange={(_, value) => handleParamChange('flow', value)}\n            min={10}\n            max={100}\n            valueLabelDisplay=\"auto\"\n          />\n        </Box>\n      </Box>\n    </div>\n  );\n}\n","import React, { useState, useRef, useEffect } from \"react\";\nimport {\n  Box,\n  Typography,\n  Slider,\n  Button,\n  Chip,\n  Divider,\n  Stack,\n  Paper,\n  IconButton\n} from \"@mui/material\";\nimport PreviewIcon from '@mui/icons-material/Preview';\nimport UndoIcon from '@mui/icons-material/Undo';\nimport ApplyIcon from '@mui/icons-material/Check';\nimport CloseIcon from '@mui/icons-material/Close';\n\nconst filters = [\n  {\n    id: \"blur\",\n    name: \"Blur\",\n    icon: \"\",\n    description: \"Soften sharp edges\",\n    params: { intensity: { min: 1, max: 5, default: 2 } }\n  },\n  {\n    id: \"hueShift\",\n    name: \"Hue Shift\",\n    icon: \"\",\n    description: \"Change color tones\",\n    params: {\n      hue: { min: -180, max: 180, default: 30 },\n      saturation: { min: -100, max: 100, default: 0 }\n    }\n  },\n  {\n    id: \"chalk\",\n    name: \"Chalk\",\n    icon: \"\",\n    description: \"Chalky texture effect\",\n    params: {\n      roughness: { min: 0, max: 100, default: 50 },\n      opacity: { min: 10, max: 100, default: 80 }\n    }\n  },\n  {\n    id: \"fade\",\n    name: \"Fade\",\n    icon: \"\",\n    description: \"Reduce opacity gradually\",\n    params: {\n      amount: { min: 10, max: 90, default: 30 },\n      gradient: { min: 0, max: 100, default: 50 }\n    }\n  },\n  {\n    id: \"vintage\",\n    name: \"Vintage\",\n    icon: \"\",\n    description: \"Old photo effect\",\n    params: {\n      sepia: { min: 0, max: 100, default: 60 },\n      vignette: { min: 0, max: 100, default: 40 }\n    }\n  },\n  {\n    id: \"neon\",\n    name: \"Neon Glow\",\n    icon: \"\",\n    description: \"Electric glow effect\",\n    params: {\n      intensity: { min: 0, max: 50, default: 15 },\n      color: { min: 0, max: 360, default: 180 }\n    }\n  }\n];\n\nexport default function MixerPanel({ onApply, onPreview, onUndo, onClearAll, canUndo = false, canClearAll = false, appliedFilters = [], onClose }) {\n  const [selectedFilter, setSelectedFilter] = useState(null);\n  const [filterParams, setFilterParams] = useState({});\n  const [isPreviewMode, setIsPreviewMode] = useState(false);\n  const previewCanvasRef = useRef(null);\n  \n  const appliedFilterTypes = appliedFilters.reduce((acc, filter) => {\n    if (filter.filterType) {\n      acc[filter.filterType] = filter;\n    }\n    return acc;\n  }, {});\n\n  const isFilterAlreadyApplied = selectedFilter && appliedFilterTypes[selectedFilter];\n\n  useEffect(() => {\n    if (selectedFilter) {\n      const filter = filters.find(f => f.id === selectedFilter);\n      if (filter) {\n        const existingFilter = appliedFilterTypes[selectedFilter];\n        if (existingFilter && existingFilter.filterParams) {\n          setFilterParams({ ...existingFilter.filterParams });\n        } else {\n          const defaultParams = {};\n          Object.entries(filter.params).forEach(([key, config]) => {\n            defaultParams[key] = config.default;\n          });\n          setFilterParams(defaultParams);\n        }\n      }\n    }\n  }, [selectedFilter, appliedFilters]);\n\n  const handleFilterSelect = (filterId) => {\n    setSelectedFilter(filterId);\n    setIsPreviewMode(false);\n  };\n\n  const handleParamChange = (param, value) => {\n    const newParams = { ...filterParams, [param]: value };\n    setFilterParams(newParams);\n\n    if (isPreviewMode && onPreview) {\n      onPreview(selectedFilter, newParams);\n    }\n  };\n\n  const handlePreview = () => {\n    if (selectedFilter && onPreview) {\n      setIsPreviewMode(true);\n      onPreview(selectedFilter, filterParams);\n    }\n  };\n\n  const handleApply = () => {\n    if (selectedFilter && onApply) {\n      onApply(selectedFilter, filterParams);\n      setIsPreviewMode(false);\n    }\n  };\n\n  const handleUndo = () => {\n    if (onUndo) {\n      onUndo();\n      setIsPreviewMode(false);\n    }\n  };\n\n  const handleClearAll = () => {\n    if (onClearAll) {\n      onClearAll();\n      setIsPreviewMode(false);\n      setSelectedFilter(null);\n    }\n  };\n\n  const handleClose = () => {\n    if (isPreviewMode && onUndo) {\n      onUndo();\n    }\n    setIsPreviewMode(false);\n    if (onClose) {\n      onClose();\n    }\n  };\n\n  const selectedFilterData = filters.find(f => f.id === selectedFilter);\n\n  return (\n    <div className=\"mixer-panel\">\n      <Box sx={{ mb: 2, display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between' }}>\n        <Box>\n          <Typography variant=\"h6\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n             Mixer Tool\n          </Typography>\n          <Typography variant=\"caption\" color=\"text.secondary\">\n            Apply non-destructive filters\n          </Typography>\n        </Box>\n        {onClose && (\n          <IconButton\n            onClick={handleClose}\n            size=\"small\"\n            sx={{\n              mt: -0.5,\n              '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.08)' }\n            }}\n          >\n            <CloseIcon fontSize=\"small\" />\n          </IconButton>\n        )}\n      </Box>\n\n      {canClearAll && (\n        <Box sx={{ mb: 2 }}>\n          <Button\n            variant=\"outlined\"\n            color=\"error\"\n            size=\"small\"\n            fullWidth\n            onClick={handleClearAll}\n            sx={{ textTransform: 'none' }}\n          >\n             Clear All Filters\n          </Button>\n        </Box>\n      )}\n\n      <div className=\"filter-grid\">\n        {filters.map((filter) => (\n          <button\n            key={filter.id}\n            className={`filter-card ${selectedFilter === filter.id ? \"active\" : \"\"}`}\n            onClick={() => handleFilterSelect(filter.id)}\n            title={filter.description}\n          >\n            <div className=\"filter-icon\">{filter.icon}</div>\n            <div className=\"filter-name\">{filter.name}</div>\n          </button>\n        ))}\n      </div>\n\n      {selectedFilterData && (\n        <Box sx={{ mt: 2 }}>\n          <Paper sx={{ p: 2, bgcolor: 'grey.50' }}>\n            <Typography variant=\"subtitle2\" sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>\n              {selectedFilterData.icon} {selectedFilterData.name}\n            </Typography>\n            <Chip\n              label={selectedFilterData.description}\n              size=\"small\"\n              color=\"primary\"\n              variant=\"outlined\"\n              sx={{ mb: 2 }}\n            />\n\n            {/* Info message when filter is already applied */}\n            {isFilterAlreadyApplied && (\n              <Box sx={{ mb: 2, p: 1.5, bgcolor: 'info.light', borderRadius: 1 }}>\n                <Typography variant=\"caption\" sx={{ display: 'block', fontWeight: 'bold', color: 'info.dark' }}>\n                   {selectedFilterData.name} filter is active\n                </Typography>\n                <Typography variant=\"caption\" sx={{ display: 'block', color: 'info.dark', mt: 0.5 }}>\n                  Adjust parameters below and click Update to tune the filter. Only one {selectedFilterData.name.toLowerCase()} filter can be applied at a time.\n                </Typography>\n              </Box>\n            )}\n\n            <Box sx={{ mt: 2 }}>\n              {Object.entries(selectedFilterData.params).map(([param, config]) => (\n                <Box key={param} sx={{ mb: 2 }}>\n                  <Typography variant=\"caption\" sx={{ textTransform: 'capitalize' }}>\n                    {param.replace(/([A-Z])/g, ' $1')}: {filterParams[param] || config.default}\n                  </Typography>\n                  <Slider\n                    size=\"small\"\n                    value={filterParams[param] || config.default}\n                    onChange={(_, value) => handleParamChange(param, value)}\n                    min={config.min}\n                    max={config.max}\n                    step={param === 'hue' ? 5 : 1}\n                    valueLabelDisplay=\"auto\"\n                  />\n                </Box>\n              ))}\n            </Box>\n\n            <Divider sx={{ my: 2 }} />\n\n            <Stack direction=\"row\" spacing={1} sx={{ mt: 2 }}>\n              <Button\n                variant=\"outlined\"\n                size=\"small\"\n                startIcon={<PreviewIcon />}\n                onClick={handlePreview}\n                disabled={!selectedFilter}\n              >\n                Preview\n              </Button>\n\n              <Button\n                variant=\"contained\"\n                size=\"small\"\n                startIcon={<ApplyIcon />}\n                onClick={handleApply}\n                disabled={!selectedFilter}\n                color=\"primary\"\n              >\n                {isFilterAlreadyApplied ? 'Update' : 'Apply'}\n              </Button>\n\n              {canUndo && (\n                <IconButton\n                  size=\"small\"\n                  onClick={handleUndo}\n                  title=\"Undo filter\"\n                >\n                  <UndoIcon />\n                </IconButton>\n              )}\n            </Stack>\n\n            {isPreviewMode && (\n              <Typography variant=\"caption\" color=\"info.main\" sx={{ mt: 1, display: 'block' }}>\n                Preview mode active - Click Apply to commit changes\n              </Typography>\n            )}\n          </Paper>\n        </Box>\n      )}\n    </div>\n  );\n}\n\n","import React, { useState, useRef } from \"react\";\nimport {\n  Dialog,\n  DialogTitle,\n  DialogContent,\n  DialogActions,\n  Button,\n  TextField,\n  Select,\n  FormControl,\n  InputLabel,\n  MenuItem,\n  Box,\n  Typography,\n  Paper,\n  Grid,\n  IconButton,\n  Divider,\n  Alert\n} from \"@mui/material\";\nimport CloudUploadIcon from '@mui/icons-material/CloudUpload';\nimport EmojiEmotionsIcon from '@mui/icons-material/EmojiEmotions';\nimport ImageIcon from '@mui/icons-material/Image';\n\nconst popularEmojis = [\n  \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\n  \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\n  \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\n  \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\",\n  \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"\n];\n\nconst categories = [\n  { value: \"nature\", label: \"Nature\" },\n  { value: \"shapes\", label: \"Shapes\" },\n  { value: \"animals\", label: \"Animals\" },\n  { value: \"objects\", label: \"Objects\" },\n  { value: \"symbols\", label: \"Symbols\" }\n];\n\nexport default function StampEditor({ onSave, onClose }) {\n  const [stampData, setStampData] = useState({\n    name: \"\",\n    emoji: \"\",\n    category: \"objects\",\n    image: null\n  });\n  const [mode, setMode] = useState(\"emoji\"); // emoji or image\n  const fileInputRef = useRef(null);\n  const [previewImage, setPreviewImage] = useState(null);\n  const [error, setError] = useState(\"\");\n\n  const handleEmojiSelect = (emoji) => {\n    setStampData({ ...stampData, emoji });\n  };\n\n  const handleImageUpload = (event) => {\n    const file = event.target.files[0];\n    if (file) {\n      if (file.size > 1024 * 1024) { // 1MB limit\n        setError(\"Image must be less than 1MB\");\n        return;\n      }\n\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        setPreviewImage(e.target.result);\n        setStampData({ ...stampData, image: e.target.result });\n        setError(\"\");\n      };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleSave = () => {\n    if (!stampData.name.trim()) {\n      setError(\"Please enter a stamp name\");\n      return;\n    }\n\n    if (mode === \"emoji\" && !stampData.emoji) {\n      setError(\"Please select an emoji\");\n      return;\n    }\n\n    if (mode === \"image\" && !stampData.image) {\n      setError(\"Please upload an image\");\n      return;\n    }\n\n    const newStamp = {\n      name: stampData.name.trim(),\n      category: stampData.category,\n      [mode]: mode === \"emoji\" ? stampData.emoji : stampData.image\n    };\n\n    onSave(newStamp);\n    onClose();\n  };\n\n  return (\n    <>\n      <DialogTitle sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n        <EmojiEmotionsIcon />\n        Create Custom Stamp\n      </DialogTitle>\n      \n      <DialogContent sx={{ minWidth: 500 }}>\n        {error && (\n          <Alert severity=\"error\" sx={{ mb: 2 }}>\n            {error}\n          </Alert>\n        )}\n\n        <Box sx={{ mb: 3 }}>\n          <TextField\n            fullWidth\n            label=\"Stamp Name\"\n            value={stampData.name}\n            onChange={(e) => setStampData({ ...stampData, name: e.target.value })}\n            placeholder=\"Enter a name for your stamp\"\n            sx={{ mb: 2 }}\n          />\n\n          <FormControl fullWidth sx={{ mb: 2 }}>\n            <InputLabel>Category</InputLabel>\n            <Select\n              value={stampData.category}\n              onChange={(e) => setStampData({ ...stampData, category: e.target.value })}\n              label=\"Category\"\n            >\n              {categories.map(cat => (\n                <MenuItem key={cat.value} value={cat.value}>\n                  {cat.label}\n                </MenuItem>\n              ))}\n            </Select>\n          </FormControl>\n\n          <Box sx={{ mb: 2 }}>\n            <Button\n              variant={mode === \"emoji\" ? \"contained\" : \"outlined\"}\n              onClick={() => setMode(\"emoji\")}\n              startIcon={<EmojiEmotionsIcon />}\n              sx={{ mr: 1 }}\n            >\n              Emoji\n            </Button>\n            <Button\n              variant={mode === \"image\" ? \"contained\" : \"outlined\"}\n              onClick={() => setMode(\"image\")}\n              startIcon={<ImageIcon />}\n            >\n              Image\n            </Button>\n          </Box>\n        </Box>\n\n        {mode === \"emoji\" && (\n          <Box>\n            <Typography variant=\"subtitle2\" sx={{ mb: 1 }}>\n              Choose an Emoji:\n            </Typography>\n            <Paper sx={{ p: 2, maxHeight: 200, overflowY: 'auto', mb: 2 }}>\n              <Grid container spacing={1}>\n                {popularEmojis.map((emoji, index) => (\n                  <Grid item key={index}>\n                    <IconButton\n                      onClick={() => handleEmojiSelect(emoji)}\n                      sx={{\n                        fontSize: '1.5rem',\n                        border: stampData.emoji === emoji ? 2 : 1,\n                        borderColor: stampData.emoji === emoji ? 'primary.main' : 'grey.300',\n                        borderStyle: 'solid'\n                      }}\n                    >\n                      {emoji}\n                    </IconButton>\n                  </Grid>\n                ))}\n              </Grid>\n            </Paper>\n            \n            <TextField\n              fullWidth\n              label=\"Or enter custom emoji/symbol\"\n              value={stampData.emoji}\n              onChange={(e) => setStampData({ ...stampData, emoji: e.target.value })}\n              placeholder=\"\"\n              sx={{ mb: 2 }}\n            />\n          </Box>\n        )}\n\n        {mode === \"image\" && (\n          <Box>\n            <input\n              type=\"file\"\n              ref={fileInputRef}\n              onChange={handleImageUpload}\n              accept=\"image/*\"\n              style={{ display: 'none' }}\n            />\n            \n            <Button\n              variant=\"outlined\"\n              onClick={() => fileInputRef.current?.click()}\n              startIcon={<CloudUploadIcon />}\n              fullWidth\n              sx={{ mb: 2 }}\n            >\n              Upload Image\n            </Button>\n\n            {previewImage && (\n              <Box sx={{ textAlign: 'center', mb: 2 }}>\n                <Typography variant=\"subtitle2\" sx={{ mb: 1 }}>\n                  Preview:\n                </Typography>\n                <img\n                  src={previewImage}\n                  alt=\"Preview\"\n                  style={{ \n                    maxWidth: 100, \n                    maxHeight: 100, \n                    border: '1px solid #ccc',\n                    borderRadius: 4\n                  }}\n                />\n              </Box>\n            )}\n          </Box>\n        )}\n\n        <Divider sx={{ my: 2 }} />\n\n        <Box sx={{ textAlign: 'center', p: 2, bgcolor: 'grey.50', borderRadius: 1 }}>\n          <Typography variant=\"subtitle2\" sx={{ mb: 1 }}>\n            Preview:\n          </Typography>\n          <div style={{ fontSize: '3rem' }}>\n            {mode === \"emoji\" ? stampData.emoji : (\n              previewImage ? (\n                <img \n                  src={previewImage} \n                  alt=\"Preview\" \n                  style={{ width: 60, height: 60, objectFit: 'contain' }}\n                />\n              ) : \"\"\n            )}\n          </div>\n          <Typography variant=\"caption\" color=\"text.secondary\">\n            {stampData.name || \"Untitled Stamp\"}\n          </Typography>\n        </Box>\n      </DialogContent>\n\n      <DialogActions>\n        <Button onClick={onClose}>\n          Cancel\n        </Button>\n        <Button onClick={handleSave} variant=\"contained\">\n          Save Stamp\n        </Button>\n      </DialogActions>\n    </>\n  );\n}\n\n\n\n\n\n\n\n\n","import React, { useState, useEffect } from \"react\";\nimport StampEditor from \"./StampEditor\";\nimport {\n  Box,\n  Typography,\n  Button,\n  Grid,\n  Card,\n  CardContent,\n  IconButton,\n  Slider,\n  Stack,\n  Divider,\n  Chip,\n  Dialog\n} from \"@mui/material\";\nimport AddIcon from '@mui/icons-material/Add';\nimport EditIcon from '@mui/icons-material/Edit';\nimport DeleteIcon from '@mui/icons-material/Delete';\nimport RotateRightIcon from '@mui/icons-material/RotateRight';\nimport ZoomInIcon from '@mui/icons-material/ZoomIn';\nimport CloseIcon from '@mui/icons-material/Close';\n\nconst defaultStamps = [\n  { id: \"flower\", emoji: \"\", name: \"Flower\", category: \"nature\" },\n  { id: \"star\", emoji: \"\", name: \"Star\", category: \"shapes\" },\n  { id: \"clover\", emoji: \"\", name: \"Clover\", category: \"nature\" },\n  { id: \"fish\", emoji: \"\", name: \"Fish\", category: \"animals\" },\n  { id: \"heart\", emoji: \"\", name: \"Heart\", category: \"shapes\" },\n  { id: \"sun\", emoji: \"\", name: \"Sun\", category: \"nature\" },\n  { id: \"moon\", emoji: \"\", name: \"Moon\", category: \"nature\" },\n  { id: \"tree\", emoji: \"\", name: \"Tree\", category: \"nature\" },\n  { id: \"butterfly\", emoji: \"\", name: \"Butterfly\", category: \"animals\" },\n  { id: \"rainbow\", emoji: \"\", name: \"Rainbow\", category: \"nature\" },\n  { id: \"cat\", emoji: \"\", name: \"Cat\", category: \"animals\" },\n  { id: \"rocket\", emoji: \"\", name: \"Rocket\", category: \"objects\" },\n];\n\nexport default function StampPanel({ onSelect, onStampChange, backendStamps = [], onClose, selectedStamp: externalSelectedStamp }) {\n  const [showEditor, setShowEditor] = useState(false);\n  const [stamps, setStamps] = useState(defaultStamps);\n  const [selectedStamp, setSelectedStamp] = useState(null);\n  const [stampSettings, setStampSettings] = useState({\n    size: 50,\n    rotation: 0,\n    opacity: 100\n  });\n  const [filterCategory, setFilterCategory] = useState(\"all\");\n\n  const categories = [\"all\", \"nature\", \"shapes\", \"animals\", \"objects\", \"custom\"];\n\n  useEffect(() => {\n    // Merge stamps from multiple sources:\n    // 1. Default stamps (always present)\n    // 2. localStorage stamps (user's local custom stamps)\n    // 3. Backend stamps (custom stamps from all users in the room)\n\n    const savedStamps = localStorage.getItem('rescanvas-stamps');\n    let localCustomStamps = [];\n    if (savedStamps) {\n      try {\n        localCustomStamps = JSON.parse(savedStamps);\n      } catch (e) {\n        console.warn('Failed to load saved stamps:', e);\n      }\n    }\n\n    // Merge all stamps, avoiding duplicates\n    // Use a Map to deduplicate by a combination of emoji/image content\n    const stampMap = new Map();\n\n    // Add default stamps first\n    defaultStamps.forEach(stamp => {\n      const key = stamp.id;\n      stampMap.set(key, stamp);\n    });\n\n    // Add localStorage stamps\n    localCustomStamps.forEach(stamp => {\n      const key = stamp.id || (stamp.emoji ? `emoji-${stamp.emoji}` : `image-${stamp.image?.substring(0, 50)}`);\n      if (!stampMap.has(key)) {\n        stampMap.set(key, { ...stamp, id: stamp.id || key });\n      }\n    });\n\n    // Add backend stamps (highest priority for custom stamps)\n    backendStamps.forEach(stamp => {\n      // For backend stamps, use image content or emoji as key to avoid duplicates\n      const key = stamp.emoji ? `emoji-${stamp.emoji}` : `image-${stamp.image?.substring(0, 50)}`;\n      if (!stampMap.has(key)) {\n        // Ensure backend stamp has proper structure\n        stampMap.set(key, {\n          id: stamp.id || key,\n          name: stamp.name || 'Custom Stamp',\n          category: stamp.category || 'custom',\n          emoji: stamp.emoji,\n          image: stamp.image\n        });\n      }\n    });\n\n    const mergedStamps = Array.from(stampMap.values());\n    setStamps(mergedStamps);\n\n    console.log('StampPanel: Merged stamps', {\n      defaultCount: defaultStamps.length,\n      localCount: localCustomStamps.length,\n      backendCount: backendStamps.length,\n      totalUnique: mergedStamps.length\n    });\n  }, [backendStamps]);\n\n  // Sync internal state with external selected stamp\n  useEffect(() => {\n    if (externalSelectedStamp) {\n      setSelectedStamp(externalSelectedStamp);\n    }\n  }, [externalSelectedStamp]);\n\n  const saveStamps = (newStamps) => {\n    const customStamps = newStamps.filter(s => !defaultStamps.find(d => d.id === s.id));\n    localStorage.setItem('rescanvas-stamps', JSON.stringify(customStamps));\n  };\n\n  const handleStampSelect = (stamp) => {\n    setSelectedStamp(stamp);\n    if (onSelect) {\n      onSelect(stamp, stampSettings);\n    }\n  };\n\n  const handleSettingChange = (setting, value) => {\n    const newSettings = { ...stampSettings, [setting]: value };\n    setStampSettings(newSettings);\n\n    if (selectedStamp && onStampChange) {\n      onStampChange(selectedStamp, newSettings);\n    }\n  };\n\n  const handleAddStamp = (newStamp) => {\n    const updatedStamps = [...stamps, { ...newStamp, id: Date.now().toString() }];\n    setStamps(updatedStamps);\n    saveStamps(updatedStamps);\n  };\n\n  const handleDeleteStamp = (stampId) => {\n    // Don't allow deleting default stamps\n    if (defaultStamps.find(s => s.id === stampId)) return;\n\n    const updatedStamps = stamps.filter(s => s.id !== stampId);\n    setStamps(updatedStamps);\n    saveStamps(updatedStamps);\n\n    if (selectedStamp?.id === stampId) {\n      setSelectedStamp(null);\n    }\n  };\n\n  const filteredStamps = filterCategory === \"all\"\n    ? stamps\n    : stamps.filter(s => s.category === filterCategory);\n\n  return (\n    <div className=\"stamp-panel\">\n      <Box sx={{ mb: 2, display: 'flex', alignItems: 'flex-start', justifyContent: 'space-between' }}>\n        <Box>\n          <Typography variant=\"h6\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n             Stamp Library\n          </Typography>\n          <Typography variant=\"caption\" color=\"text.secondary\">\n            Click stamps to place on canvas\n          </Typography>\n        </Box>\n        {onClose && (\n          <IconButton\n            onClick={onClose}\n            size=\"small\"\n            sx={{\n              mt: -0.5,\n              '&:hover': { backgroundColor: 'rgba(0, 0, 0, 0.08)' }\n            }}\n          >\n            <CloseIcon fontSize=\"small\" />\n          </IconButton>\n        )}\n      </Box>\n\n      {/* Category Filter */}\n      <Box sx={{ mb: 2 }}>\n        <Stack direction=\"row\" spacing={1} sx={{ flexWrap: 'wrap', gap: 0.5 }}>\n          {categories.map(category => (\n            <Chip\n              key={category}\n              label={category.charAt(0).toUpperCase() + category.slice(1)}\n              size=\"small\"\n              variant={filterCategory === category ? \"filled\" : \"outlined\"}\n              onClick={() => setFilterCategory(category)}\n              color={filterCategory === category ? \"primary\" : \"default\"}\n            />\n          ))}\n        </Stack>\n      </Box>\n\n      {/* Stamp Grid */}\n      <Grid container spacing={1} sx={{ mb: 2, maxHeight: 200, overflowY: 'auto' }}>\n        {filteredStamps.map((stamp) => (\n          <Grid item xs={3} key={stamp.id}>\n            <Card\n              sx={{\n                cursor: 'pointer',\n                border: selectedStamp?.id === stamp.id ? 2 : 1,\n                borderColor: selectedStamp?.id === stamp.id ? 'primary.main' : 'grey.300',\n                '&:hover': { bgcolor: 'grey.50' },\n                position: 'relative'\n              }}\n              onClick={() => handleStampSelect(stamp)}\n            >\n              <CardContent sx={{ p: 1, textAlign: 'center', '&:last-child': { pb: 1 } }}>\n                <Box sx={{ height: 40, display: 'flex', alignItems: 'center', justifyContent: 'center', mb: 0.5 }}>\n                  {stamp.emoji ? (\n                    <Typography variant=\"h4\">\n                      {stamp.emoji}\n                    </Typography>\n                  ) : stamp.image ? (\n                    <img\n                      src={stamp.image}\n                      alt={stamp.name}\n                      style={{\n                        maxWidth: '40px',\n                        maxHeight: '40px',\n                        objectFit: 'contain'\n                      }}\n                    />\n                  ) : null}\n                </Box>\n                <Typography variant=\"caption\" sx={{ fontSize: '0.7rem' }}>\n                  {stamp.name}\n                </Typography>\n\n                {!defaultStamps.find(s => s.id === stamp.id) && (\n                  <IconButton\n                    size=\"small\"\n                    sx={{ position: 'absolute', top: 0, right: 0, p: 0.5 }}\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleDeleteStamp(stamp.id);\n                    }}\n                  >\n                    <DeleteIcon fontSize=\"small\" />\n                  </IconButton>\n                )}\n              </CardContent>\n            </Card>\n          </Grid>\n        ))}\n      </Grid>\n\n      <Button\n        variant=\"outlined\"\n        startIcon={<AddIcon />}\n        onClick={() => setShowEditor(true)}\n        size=\"small\"\n        fullWidth\n        sx={{ mb: 2 }}\n      >\n        Add Custom Stamp\n      </Button>\n\n      {selectedStamp && (\n        <Box>\n          <Divider sx={{ my: 2 }} />\n          <Typography variant=\"subtitle2\" sx={{ mb: 2, display: 'flex', alignItems: 'center', gap: 1 }}>\n            <EditIcon fontSize=\"small\" />\n            Stamp Settings\n          </Typography>\n\n          <Box sx={{ mb: 2 }}>\n            <Typography variant=\"caption\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n              <ZoomInIcon fontSize=\"small\" />\n              Size: {stampSettings.size}%\n            </Typography>\n            <Slider\n              size=\"small\"\n              value={stampSettings.size}\n              onChange={(_, value) => handleSettingChange('size', value)}\n              min={10}\n              max={200}\n              valueLabelDisplay=\"auto\"\n            />\n          </Box>\n\n          <Box sx={{ mb: 2 }}>\n            <Typography variant=\"caption\" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>\n              <RotateRightIcon fontSize=\"small\" />\n              Rotation: {stampSettings.rotation}\n            </Typography>\n            <Slider\n              size=\"small\"\n              value={stampSettings.rotation}\n              onChange={(_, value) => handleSettingChange('rotation', value)}\n              min={-180}\n              max={180}\n              step={15}\n              valueLabelDisplay=\"auto\"\n            />\n          </Box>\n\n          <Box sx={{ mb: 2 }}>\n            <Typography variant=\"caption\">\n              Opacity: {stampSettings.opacity}%\n            </Typography>\n            <Slider\n              size=\"small\"\n              value={stampSettings.opacity}\n              onChange={(_, value) => handleSettingChange('opacity', value)}\n              min={10}\n              max={100}\n              valueLabelDisplay=\"auto\"\n            />\n          </Box>\n\n          <Box sx={{ p: 1, bgcolor: 'grey.50', borderRadius: 1, textAlign: 'center' }}>\n            <Typography variant=\"caption\" color=\"text.secondary\">Preview:</Typography>\n            <div style={{\n              display: 'inline-block',\n              margin: '8px'\n            }}>\n              {selectedStamp.emoji ? (\n                <div style={{\n                  fontSize: `${stampSettings.size * 0.5}px`,\n                  transform: `rotate(${stampSettings.rotation}deg)`,\n                  opacity: stampSettings.opacity / 100,\n                  display: 'inline-block'\n                }}>\n                  {selectedStamp.emoji}\n                </div>\n              ) : selectedStamp.image ? (\n                <img\n                  src={selectedStamp.image}\n                  alt={selectedStamp.name}\n                  style={{\n                    width: `${stampSettings.size}px`,\n                    height: `${stampSettings.size}px`,\n                    transform: `rotate(${stampSettings.rotation}deg)`,\n                    opacity: stampSettings.opacity / 100,\n                    objectFit: 'contain'\n                  }}\n                />\n              ) : null}\n            </div>\n          </Box>\n        </Box>\n      )}\n\n      <Dialog open={showEditor} onClose={() => setShowEditor(false)} maxWidth=\"md\" fullWidth>\n        <StampEditor\n          onSave={handleAddStamp}\n          onClose={() => setShowEditor(false)}\n        />\n      </Dialog>\n    </div>\n  );\n}\n","import React, { useState } from \"react\";\nimport { SketchPicker } from \"react-color\";\nimport \"../styles/Canvas.css\";\nimport { Slider, Popover, IconButton, Tooltip } from \"@mui/material\";\nimport RefreshIcon from \"@mui/icons-material/Refresh\";\nimport HistoryIcon from \"@mui/icons-material/History\";\nimport CloseIcon from \"@mui/icons-material/Close\";\nimport ClearAllIcon from \"@mui/icons-material/ClearAll\";\nimport UndoIcon from \"@mui/icons-material/Undo\";\nimport RedoIcon from \"@mui/icons-material/Redo\";\nimport ContentCutIcon from \"@mui/icons-material/ContentCut\";\nimport ContentPasteIcon from \"@mui/icons-material/ContentPaste\";\nimport SettingsIcon from \"@mui/icons-material/Settings\";\nimport DownloadIcon from \"@mui/icons-material/Download\";\nimport UploadIcon from \"@mui/icons-material/Upload\";\nimport BrushIcon from \"@mui/icons-material/Brush\";\nimport PaletteIcon from \"@mui/icons-material/Palette\";\nimport StarIcon from \"@mui/icons-material/Star\";\nimport DrawModeMenu from \"../lib/drawModeMenu\";\nimport ShapeMenu from \"../lib/shapeMenu\";\nimport BrushPanel from \"./BrushEditor/BrushPanel\";\nimport MixerPanel from \"./Mixer/MixerPanel\";\nimport StampPanel from \"./Stamps/StampPanel\";\n\nconst actionButtonSX = {\n  borderRadius: 1,\n  width: 40,\n  height: 32,\n  padding: 0,\n  minWidth: 40,\n  \"& .MuiTouchRipple-root\": {\n    borderRadius: 1,\n  },\n};\n\nconst Toolbar = ({\n  drawMode,\n  setDrawMode,\n  shapeType,\n  setShapeType,\n  color,\n  setColor,\n  showColorPicker,\n  toggleColorPicker,\n  closeColorPicker,\n  lineWidth,\n  setLineWidth,\n  previousColor,\n  setPreviousColor,\n  refreshCanvasButtonHandler,\n  undo,\n  undoAvailable,\n  redo,\n  redoAvailable,\n  selectionRect,\n  handleCutSelection,\n  cutImageData,\n  setClearDialogOpen,\n  handleExportCanvas,\n  handleImportCanvas,\n  openHistoryDialog,\n  exitHistoryMode,\n  historyMode,\n  controlsDisabled,\n  onOpenSettings,\n  currentBrushType,\n  onBrushSelect,\n  onBrushParamsChange,\n  selectedStamp,\n  onStampSelect,\n  onStampChange,\n  backendStamps,\n  onFilterApply,\n  onFilterPreview,\n  onFilterUndo,\n  onClearAllFilters,\n  canUndoFilter,\n  canClearFilters,\n  appliedFilters\n}) => {\n  const [tool, setTool] = useState(null);\n  const [anchorEl, setAnchorEl] = useState(null);\n\n  const handleOpen = (event, selectedTool) => {\n    setAnchorEl(event.currentTarget);\n    setTool(selectedTool);\n  };\n\n  const handleClose = () => {\n    setAnchorEl(null);\n    setTool(null);\n  };\n  return (\n    <div className=\"Canvas-toolbar\">\n      <div className=\"Canvas-tools\">\n        <Tooltip title=\"Brushes\">\n          <IconButton\n            onClick={(e) => handleOpen(e, \"brush\")}\n            sx={actionButtonSX}\n          >\n            <BrushIcon />\n          </IconButton>\n        </Tooltip>\n        <Tooltip title=\"Mixer\">\n          <IconButton\n            onClick={(e) => handleOpen(e, \"mixer\")}\n            sx={actionButtonSX}\n          >\n            <PaletteIcon />\n          </IconButton>\n        </Tooltip>\n        <Tooltip title=\"Stamps\">\n          <IconButton\n            onClick={(e) => handleOpen(e, \"stamp\")}\n            sx={actionButtonSX}\n          >\n            <StarIcon />\n          </IconButton>\n        </Tooltip>\n\n        <Popover\n          open={Boolean(anchorEl)}\n          anchorEl={anchorEl}\n          onClose={handleClose}\n          anchorOrigin={{ vertical: \"center\", horizontal: \"right\" }}\n          transformOrigin={{ vertical: \"center\", horizontal: \"left\" }}\n          PaperProps={{ sx: { borderRadius: 2, boxShadow: 3 } }}\n        >\n          {tool === \"brush\" && (\n            <BrushPanel\n              selectedBrush={currentBrushType}\n              onSelect={onBrushSelect}\n              onParamsChange={onBrushParamsChange}\n              onClose={handleClose}\n            />\n          )}\n          {tool === \"mixer\" && (\n            <MixerPanel\n              onApply={onFilterApply}\n              onPreview={onFilterPreview}\n              onUndo={onFilterUndo}\n              onClearAll={onClearAllFilters}\n              canUndo={canUndoFilter}\n              canClearAll={canClearFilters}\n              appliedFilters={appliedFilters || []}\n              onClose={handleClose}\n            />\n          )}\n          {tool === \"stamp\" && (\n            <StampPanel\n              onSelect={onStampSelect}\n              onStampChange={onStampChange}\n              backendStamps={backendStamps}\n              selectedStamp={selectedStamp}\n              onClose={handleClose}\n            />\n          )}\n        </Popover>\n      </div>\n\n      <div className=\"Canvas-label-group\">\n        {/* <label className=\"Canvas-label\">Draw Mode:</label>*/}\n        <DrawModeMenu\n          drawMode={drawMode}\n          setDrawMode={setDrawMode}\n          color={color}\n          previousColor={previousColor}\n          setColor={setColor}\n          setPreviousColor={setPreviousColor}\n          controlsDisabled={controlsDisabled}\n        />\n      </div>\n\n      {drawMode === \"shape\" && (\n        <div className=\"Canvas-label-group\">\n          <ShapeMenu\n            shapeType={shapeType}\n            setShapeType={setShapeType}\n            controlsDisabled={controlsDisabled}\n          />\n        </div>\n      )}\n\n      {[\"freehand\", \"shape\", \"eraser\"].includes(drawMode) && (\n        <>\n          <div\n            className=\"Canvas-label-group\"\n            style={{ flexDirection: \"column\", alignItems: \"flex-start\" }}\n          >\n            {/*<label className=\"Canvas-label\">Line Width:</label>*/}\n            <Slider\n              orientation=\"vertical\"\n              value={lineWidth}\n              onChange={(e, v) => setLineWidth(v)}\n              min={1}\n              max={20}\n              disabled={controlsDisabled}\n              sx={{\n                height: 100,\n                \"& .MuiSlider-track\": { color: \"#007bff\" },\n                \"& .MuiSlider-thumb\": {\n                  backgroundColor: \"#007bff\",\n                  width: 14,\n                  height: 14,\n                },\n                \"& .MuiSlider-rail\": { color: \"#ccc\" },\n              }}\n            />\n          </div>\n\n          {drawMode !== \"eraser\" && (\n            <div className=\"Canvas-label-group\">\n              <div style={{ position: \"relative\" }}>\n                <div\n                  className=\"Canvas-color-display\"\n                  style={{\n                    backgroundColor: color,\n                    cursor: controlsDisabled ? \"not-allowed\" : \"pointer\",\n                  }}\n                  onClick={controlsDisabled ? undefined : toggleColorPicker}\n                />\n                <Popover\n                  open={showColorPicker}\n                  onClose={closeColorPicker}\n                  anchorEl={document.querySelector(\".Canvas-color-display\")}\n                  anchorOrigin={{\n                    vertical: \"bottom\",\n                    horizontal: \"left\",\n                  }}\n                  transformOrigin={{\n                    vertical: \"top\",\n                    horizontal: \"left\",\n                  }}\n                  PaperProps={{ sx: { p: 2 } }}\n                >\n                  <SketchPicker\n                    color={color}\n                    onChange={(newColor) => setColor(newColor.hex)}\n                    disableAlpha={false}\n                  />\n                </Popover>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n      <Tooltip title=\"Refresh\">\n        <span>\n          <IconButton\n            onClick={controlsDisabled ? undefined : refreshCanvasButtonHandler}\n            sx={actionButtonSX}\n            disabled={controlsDisabled}\n          >\n            <RefreshIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      {/* Room Settings in the left toolbar - shown when a handler is provided */}\n      {typeof onOpenSettings === \"function\" && (\n        <Tooltip title=\"Room settings\">\n          <span>\n            <IconButton\n              onClick={onOpenSettings}\n              sx={actionButtonSX}\n              disabled={controlsDisabled}\n            >\n              <SettingsIcon />\n            </IconButton>\n          </span>\n        </Tooltip>\n      )}\n\n      {historyMode ? (\n        <>\n          <Tooltip title=\"Change History Range\">\n            <span>\n              <IconButton\n                onClick={openHistoryDialog}\n                sx={actionButtonSX}\n                disabled={false}\n              >\n                <HistoryIcon />\n              </IconButton>\n            </span>\n          </Tooltip>\n          <Tooltip title=\"Exit History Recall Mode\">\n            <span>\n              <IconButton\n                onClick={exitHistoryMode}\n                sx={actionButtonSX}\n                disabled={false}\n              >\n                <CloseIcon />\n              </IconButton>\n            </span>\n          </Tooltip>\n        </>\n      ) : (\n        <Tooltip title=\"History Recall\">\n          <span>\n            <IconButton\n              onClick={controlsDisabled ? undefined : openHistoryDialog}\n              sx={actionButtonSX}\n              disabled={controlsDisabled}\n            >\n              <HistoryIcon />\n            </IconButton>\n          </span>\n        </Tooltip>\n      )}\n\n      <Tooltip title=\"Export Canvas\">\n        <span>\n          <IconButton\n            onClick={handleExportCanvas}\n            disabled={false}\n            sx={actionButtonSX}\n          >\n            <DownloadIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      <Tooltip title=\"Import Canvas\">\n        <span>\n          <IconButton\n            onClick={handleImportCanvas}\n            disabled={controlsDisabled}\n            sx={actionButtonSX}\n          >\n            <UploadIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      <Tooltip title=\"Clear Canvas\">\n        <span>\n          <IconButton\n            onClick={() => setClearDialogOpen(true)}\n            disabled={controlsDisabled}\n            sx={actionButtonSX}\n          >\n            <ClearAllIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      <Tooltip title=\"Undo\">\n        <span>\n          <IconButton\n            onClick={undo}\n            disabled={controlsDisabled || !undoAvailable}\n            sx={actionButtonSX}\n          >\n            <UndoIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      <Tooltip title=\"Redo\">\n        <span>\n          <IconButton\n            onClick={redo}\n            disabled={controlsDisabled || !redoAvailable}\n            sx={actionButtonSX}\n          >\n            <RedoIcon />\n          </IconButton>\n        </span>\n      </Tooltip>\n\n      {drawMode === \"select\" && selectionRect && (\n        <Tooltip title=\"Cut Selection\">\n          <span>\n            <IconButton\n              onClick={handleCutSelection}\n              sx={actionButtonSX}\n              disabled={controlsDisabled}\n            >\n              <ContentCutIcon />\n            </IconButton>\n          </span>\n        </Tooltip>\n      )}\n      {cutImageData && cutImageData.length > 0 && (\n        <Tooltip title=\"Paste\">\n          <span>\n            <IconButton\n              onClick={() => setDrawMode(\"paste\")}\n              sx={actionButtonSX}\n              disabled={controlsDisabled}\n            >\n              <ContentPasteIcon />\n            </IconButton>\n          </span>\n        </Tooltip>\n      )}\n    </div>\n  );\n};\n\nexport default Toolbar;\n","import ResVaultSDK from 'resvault-sdk';\nimport nacl from 'tweetnacl';\nimport bs58 from 'bs58';\n\n/**\n * Lightweight wrapper around ResVault postMessage API.\n * Requires the ResVault Chrome extension to be installed & unlocked.\n * See: https://github.com/apache/incubator-resilientdb-resvault\n */\nconst sdk = new ResVaultSDK();\n\nlet isConnected = false;\nlet currentPublicKey = null;\n\n// Enable verbose logging in development to diagnose message handshake issues\nconst isLocalhost = typeof window !== 'undefined' && window.location && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1');\nconst VERBOSE_LOG = (typeof process !== 'undefined' && process.env && process.env.NODE_ENV === 'development') || isLocalhost;\n\n/**\n * Check if ResVault wallet extension is available\n */\nexport function isWalletAvailable() {\n  return typeof window !== 'undefined' && sdk !== null;\n}\n\n/**\n * Get current connection status\n */\nexport function getConnectionStatus() {\n  return {\n    connected: isConnected,\n    publicKey: currentPublicKey\n  };\n}\n\n/**\n * Login to wallet (unlock if needed)\n */\nexport async function walletLogin() {\n  return new Promise((resolve, reject) => {\n    const handler = (event) => {\n      try {\n        const d = (event && event.data) || {};\n\n        if (VERBOSE_LOG) console.debug('[resvault] login handler got event:', d, 'source=', event && event.source);\n\n        // Support content-script wrappers which send { type: 'FROM_CONTENT_SCRIPT', data: { ... } }\n        const wrapped = (d && d.type === 'FROM_CONTENT_SCRIPT' && d.data) ? d.data : d;\n        const payload = wrapped.resvault || wrapped.payload || wrapped.data || wrapped;\n\n        // Some wrappers use 'success' or 'ok' interchangeably; normalize here\n        const ok = payload.ok === true || payload.success === true;\n\n        if ((payload.type === 'login' && payload.direction === 'response') || payload.loginResponse) {\n          sdk.removeMessageListener(handler);\n          clearTimeout(timeoutId);\n          if (ok || payload.ok) {\n            isConnected = true;\n            resolve(payload);\n          } else {\n            const errMsg = payload.error || payload.message || (payload.data && payload.data.error) || 'Wallet login failed';\n            reject(new Error(errMsg));\n          }\n        }\n\n        // Some content-script wrappers return a generic { success: boolean, error: string }\n        // Treat those as a login response when present so we don't timeout silently.\n        if (typeof payload.success !== 'undefined' || payload.error) {\n          sdk.removeMessageListener(handler);\n          clearTimeout(timeoutId);\n          if (payload.success === true) {\n            isConnected = true;\n            resolve(payload);\n          } else {\n            const errMsg = payload.error || payload.message || 'Wallet login failed';\n            reject(new Error(errMsg));\n          }\n        }\n      } catch (e) {\n        if (VERBOSE_LOG) console.error('[resvault] login handler error', e);\n      }\n    };\n\n    // Allow longer time for popup auth in slower environments\n    const timeoutId = setTimeout(() => {\n      sdk.removeMessageListener(handler);\n      reject(new Error('Wallet extension not responding. Please install ResVault extension.'));\n    }, 10000);\n\n    sdk.addMessageListener(handler);\n    sdk.sendMessage({ type: 'login', direction: 'login' });\n  });\n}\n\n/**\n * Request the wallet's public key (hex format)\n */\nexport async function getWalletPublicKey() {\n  return new Promise((resolve, reject) => {\n    const handler = (event) => {\n      try {\n        const d = (event && event.data) || {};\n        if (VERBOSE_LOG) console.debug('[resvault] getPublicKey handler got event:', d);\n\n        const wrapped = (d && d.type === 'FROM_CONTENT_SCRIPT' && d.data) ? d.data : d;\n        const payload = wrapped.resvault || wrapped.payload || wrapped.data || wrapped;\n\n        const pubKey = payload.publicKey || payload.pubkey || (payload.data && payload.data.publicKey) || (payload.data && payload.data.pubkey);\n\n        if ((payload.type === 'getPublicKey' && payload.direction === 'response') || pubKey) {\n          sdk.removeMessageListener(handler);\n          clearTimeout(timeoutId);\n          if (pubKey) {\n            currentPublicKey = pubKey;\n            resolve(pubKey);\n          } else {\n            reject(new Error('No public key returned from wallet'));\n          }\n        }\n\n        // If wrapper reported a failure without a publicKey, surface that error\n        if (typeof payload.success !== 'undefined' && payload.success === false) {\n          sdk.removeMessageListener(handler);\n          clearTimeout(timeoutId);\n          const errMsg = payload.error || payload.message || 'Wallet extension returned failure';\n          reject(new Error(errMsg));\n        }\n      } catch (e) {\n        if (VERBOSE_LOG) console.error('[resvault] getPublicKey handler error', e);\n      }\n    };\n\n    const timeoutId = setTimeout(() => {\n      sdk.removeMessageListener(handler);\n      reject(new Error('Wallet extension not responding'));\n    }, 10000);\n\n    sdk.addMessageListener(handler);\n    sdk.sendMessage({ type: 'getPublicKey', direction: 'request' });\n  });\n}\n\n/**\n * Ask ResVault to sign an arbitrary message\n * @param {Uint8Array} messageUint8Array - Message bytes to sign\n * @returns {Promise<string>} Hex-encoded signature\n */\nexport async function signMessageHex(messageUint8Array) {\n  return new Promise((resolve, reject) => {\n    let keysHandler = null;\n\n    const handler = (event) => {\n      try {\n        const d = (event && event.data) || {};\n        if (VERBOSE_LOG) console.debug('[resvault] sign handler got event:', d);\n\n        const wrapped = (d && d.type === 'FROM_CONTENT_SCRIPT' && d.data) ? d.data : d;\n        const payload = wrapped.resvault || wrapped.payload || wrapped.data || wrapped;\n\n        // Check if we received keys for signing\n        if (payload.type === 'signWithKeys' && payload.direction === 'request') {\n          if (VERBOSE_LOG) console.debug('[resvault] received keys for signing, performing local signature');\n\n          // Remove this handler since we got the keys\n          sdk.removeMessageListener(handler);\n          if (keysHandler) sdk.removeMessageListener(keysHandler);\n          clearTimeout(timeoutId);\n\n          try {\n            // Decode the Base58-encoded private key\n            const privateKeyBytes = bs58.decode(payload.privateKey);\n\n            // Generate keypair from the seed (first 32 bytes)\n            let keyPair;\n            if (privateKeyBytes.length === 32) {\n              keyPair = nacl.sign.keyPair.fromSeed(privateKeyBytes);\n            } else if (privateKeyBytes.length === 64) {\n              keyPair = nacl.sign.keyPair.fromSecretKey(privateKeyBytes);\n            } else {\n              throw new Error('Invalid private key length: ' + privateKeyBytes.length);\n            }\n\n            // Sign the message\n            const signature = nacl.sign.detached(messageUint8Array, keyPair.secretKey);\n\n            // Convert to hex\n            const signatureHex = Array.from(signature)\n              .map(b => b.toString(16).padStart(2, '0'))\n              .join('');\n\n            if (VERBOSE_LOG) console.debug('[resvault] signature generated:', signatureHex);\n            resolve(signatureHex);\n          } catch (error) {\n            console.error('[resvault] error during local signing:', error);\n            reject(new Error('Local signing failed: ' + error.message));\n          }\n          return;\n        }\n\n        const signature = payload.signature || payload.sig || (payload.data && payload.data.signature);\n\n        if ((payload.type === 'sign' && payload.direction === 'response') || signature) {\n          sdk.removeMessageListener(handler);\n          if (keysHandler) sdk.removeMessageListener(keysHandler);\n          clearTimeout(timeoutId);\n          if (signature) {\n            resolve(signature);\n          } else {\n            const errMsg = payload.error || payload.message || 'Signing failed';\n            reject(new Error(errMsg));\n          }\n        }\n\n        // If wrapper reported a failure for signing, surface it\n        if (typeof payload.success !== 'undefined' && payload.success === false) {\n          sdk.removeMessageListener(handler);\n          if (keysHandler) sdk.removeMessageListener(keysHandler);\n          clearTimeout(timeoutId);\n          const errMsg = payload.error || payload.message || 'Wallet signing failed';\n          reject(new Error(errMsg));\n        }\n      } catch (e) {\n        if (VERBOSE_LOG) console.error('[resvault] sign handler error', e);\n      }\n    };\n\n    const timeoutId = setTimeout(() => {\n      sdk.removeMessageListener(handler);\n      reject(new Error('Wallet signing timeout'));\n    }, 15000);\n\n    sdk.addMessageListener(handler);\n    sdk.sendMessage({\n      type: 'sign',\n      direction: 'request',\n      payload: Array.from(messageUint8Array)\n    });\n  });\n}\n\n/**\n * Sign a stroke object for a secure room\n * Creates canonical JSON representation matching backend verification\n * @param {string} roomId - Room ID\n * @param {object} stroke - Stroke object {user, color, lineWidth, pathData, timestamp}\n * @returns {Promise<{signature: string, signerPubKey: string}>}\n */\nexport async function signStrokeForSecureRoom(roomId, stroke) {\n  try {\n    const publicKeyBase58 = await getWalletPublicKey();\n\n    // Convert Base58 public key to hex for backend\n    const publicKeyBytes = bs58.decode(publicKeyBase58);\n    const publicKeyHex = Array.from(publicKeyBytes)\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n\n    // Create canonical JSON to match backend's exact format\n    // Backend uses: json.dumps({...}, separators=(',', ':'), sort_keys=True)\n    // This creates compact JSON with ALL keys sorted (including nested objects)\n    const dataToSign = {\n      roomId: roomId,\n      user: stroke.user,\n      color: stroke.color,\n      lineWidth: stroke.lineWidth,\n      pathData: stroke.pathData,\n      timestamp: stroke.timestamp || stroke.ts\n    };\n\n    // Deep sort all keys to match Python's sort_keys=True behavior\n    function sortKeysDeep(obj) {\n      if (Array.isArray(obj)) {\n        return obj.map(item => sortKeysDeep(item));\n      } else if (obj !== null && typeof obj === 'object') {\n        return Object.keys(obj).sort().reduce((result, key) => {\n          result[key] = sortKeysDeep(obj[key]);\n          return result;\n        }, {});\n      }\n      return obj;\n    }\n\n    const sortedData = sortKeysDeep(dataToSign);\n    const canonical = JSON.stringify(sortedData);\n\n    if (VERBOSE_LOG) {\n      console.log('[resvault] Data to sign:', dataToSign);\n      console.log('[resvault] Canonical JSON:', canonical);\n    }\n\n    const encoder = new TextEncoder();\n    const messageBytes = encoder.encode(canonical);\n\n    const signature = await signMessageHex(messageBytes);\n\n    if (VERBOSE_LOG) {\n      console.log('[resvault] Signature generated:', signature.substring(0, 32) + '...');\n      console.log('[resvault] Public key (Base58):', publicKeyBase58);\n      console.log('[resvault] Public key (Hex):', publicKeyHex.substring(0, 32) + '...');\n    }\n\n    return {\n      signature,\n      signerPubKey: publicKeyHex  // Send hex format to backend\n    };\n  } catch (error) {\n    console.error('Failed to sign stroke:', error);\n    throw new Error(`Wallet signing failed: ${error.message}`);\n  }\n}\n\n/**\n * Connect wallet for secure room usage\n * This checks if the wallet is already connected to this domain\n * If not, user must manually connect via the ResVault extension popup\n * @returns {Promise<string>} Connected wallet public key\n */\nexport async function connectWalletForSecureRoom() {\n  try {\n    if (VERBOSE_LOG) console.log('[resvault] Checking wallet connection...');\n\n    // Try to get the public key - this will work if user has already\n    // connected their wallet to this domain via the ResVault extension\n    const pubKey = await getWalletPublicKey();\n\n    // Inform content script about the public key\n    try {\n      sdk.sendMessage({ type: 'siteSignerInfo', direction: 'info', signerPublicKey: pubKey });\n    } catch (err) {\n      if (VERBOSE_LOG) console.warn('[resvault] failed to notify content script of signerPublicKey', err);\n    }\n\n    isConnected = true;\n    currentPublicKey = pubKey;\n\n    if (VERBOSE_LOG) console.log('[resvault] Wallet connected successfully:', pubKey);\n    return pubKey;\n  } catch (error) {\n    isConnected = false;\n    currentPublicKey = null;\n\n    if (VERBOSE_LOG) console.error('[resvault] Wallet connection check failed:', error);\n\n    // Provide a clear error message for users\n    const errorMsg = error.message || 'Wallet connection failed';\n    if (errorMsg.includes('No keys found') || errorMsg.includes('not responding')) {\n      throw new Error('WALLET_NOT_CONNECTED: Please connect your ResVault wallet to this site first');\n    }\n\n    throw error;\n  }\n}\n\n/**\n * Disconnect wallet\n */\nexport function disconnectWallet() {\n  isConnected = false;\n  currentPublicKey = null;\n}\n\n/**\n * Check if wallet is currently connected\n */\nexport function isWalletConnected() {\n  return isConnected && currentPublicKey !== null;\n}\n\n/**\n * Get display version of public key (shortened)\n */\nexport function getShortPublicKey(pubKey = null) {\n  const key = pubKey || currentPublicKey;\n  if (!key) return 'Not connected';\n  if (key.length <= 16) return key;\n  return `${key.slice(0, 8)}...${key.slice(-8)}`;\n}\n","export class Drawing {\n  constructor(drawingId, color, lineWidth, pathData, timestamp, user, metadata = {}) {\n    this.drawingId = drawingId;\n    this.color = color;\n    this.lineWidth = lineWidth;\n    this.pathData = pathData;\n    this.timestamp = timestamp;\n    this.user = user;\n    this.brushStyle = metadata.brushStyle || \"round\";\n    this.order = timestamp;\n\n    // Enhanced metadata for advanced brushes\n    this.brushType = metadata.brushType || \"normal\";\n    this.brushParams = metadata.brushParams || {};\n    this.drawingType = metadata.drawingType || \"stroke\"; // stroke, stamp, filter\n    this.stampData = metadata.stampData || null;\n    this.stampSettings = metadata.stampSettings || null;\n    this.filterType = metadata.filterType || null;\n    this.filterParams = metadata.filterParams || {};\n    \n    // Pending state for visual confirmation\n    this.isPending = metadata.isPending || false;\n    this.opacity = metadata.opacity !== undefined ? metadata.opacity : 1.0;\n    \n    // Metadata cache for performance optimization\n    this._metadataCache = null;\n  }\n\n  // Serialize metadata for backend storage (with caching)\n  getMetadata() {\n    // Return cached metadata if available\n    if (this._metadataCache) {\n      return this._metadataCache;\n    }\n    \n    // Create and cache metadata\n    this._metadataCache = {\n      brushStyle: this.brushStyle,\n      brushType: this.brushType,\n      brushParams: this.brushParams,\n      drawingType: this.drawingType,\n      stampData: this.stampData,\n      stampSettings: this.stampSettings,\n      filterType: this.filterType,\n      filterParams: this.filterParams,\n      isPending: this.isPending,\n      opacity: this.opacity\n    };\n    \n    return this._metadataCache;\n  }\n  \n  // Invalidate cache when metadata properties change\n  invalidateMetadataCache() {\n    this._metadataCache = null;\n  }\n\n  // Create from backend data\n  static fromBackendData(data) {\n    // Extract complete metadata from multiple possible locations\n    // Priority: data.metadata > top-level data fields > defaults\n    const metadata = data.metadata || {};\n\n    const completeMetadata = {\n      brushStyle: data.brushStyle || metadata.brushStyle || \"round\",\n      brushType: data.brushType || data.brush_type || metadata.brushType || \"normal\",\n      brushParams: data.brushParams || data.brush_params || metadata.brushParams || {},\n      drawingType: data.drawingType || metadata.drawingType || \"stroke\",\n      stampData: data.stampData || metadata.stampData || null,\n      stampSettings: data.stampSettings || metadata.stampSettings || null,\n      filterType: data.filterType || metadata.filterType || null,\n      filterParams: data.filterParams || metadata.filterParams || {},\n      isPending: data.isPending || metadata.isPending || false,\n      opacity: data.opacity !== undefined ? data.opacity : (metadata.opacity !== undefined ? metadata.opacity : 1.0)\n    };\n\n    return new Drawing(\n      data.drawingId || data.id,\n      data.color,\n      data.lineWidth,\n      data.pathData,\n      data.timestamp || data.ts,\n      data.user,\n      completeMetadata\n    );\n  }\n}\n","import {\n  getRoomStrokes,\n  postRoomStroke,\n  postRoomStrokesBatch,\n  clearRoomCanvas,\n  undoRoomAction,\n  redoRoomAction,\n  getUndoRedoStatus,\n  getUndoRedoStacks,\n} from \"../api/rooms\";\nimport { getAuthToken } from \"../utils/authUtils\";\nimport { getUsername } from \"../utils/getUsername\";\nimport notify from \"../utils/notify\";\nimport { signStrokeForSecureRoom, isWalletConnected } from \"../wallet/resvault\";\nimport { API_BASE } from \"../config/apiConfig\";\nimport { Drawing } from \"../lib/drawing\";\n\n// Retry with exponential backoff\nconst retryWithBackoff = async (fn, maxRetries = 3, baseDelay = 1000) => {\n  let lastError;\n  \n  for (let attempt = 0; attempt < maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      lastError = error;\n      \n      // Don't retry on authentication errors or validation errors\n      if (error.response?.status === 401 || error.response?.status === 403 || error.response?.status === 400) {\n        throw error;\n      }\n      \n      // If this was the last attempt, throw the error\n      if (attempt === maxRetries - 1) {\n        break;\n      }\n      \n      // Calculate exponential backoff delay: baseDelay * 2^attempt\n      const delay = baseDelay * Math.pow(2, attempt);\n      console.log(`Retry attempt ${attempt + 1}/${maxRetries} after ${delay}ms delay`);\n      \n      // Wait before retrying\n      await new Promise(resolve => setTimeout(resolve, delay));\n    }\n  }\n  \n  throw lastError;\n};\n\nexport const submitToDatabase = async (\n  drawing,\n  auth,\n  options = {},\n  setUndoAvailable,\n  setRedoAvailable\n) => {\n  const token = auth?.token || getAuthToken();\n  if (!token || !options.roomId) {\n    console.error(\"submitToDatabase: Missing auth token or roomId\");\n    return;\n  }\n\n  try {\n    let username = null;\n    try {\n      username = getUsername(auth);\n    } catch (e) {\n      username = null;\n    }\n    if (!username) username = \"Unknown\";\n\n    // Build complete metadata object with all custom features\n    console.log(\"=== SUBMIT STROKE DEBUG ===\");\n    console.log(\"Drawing object:\", drawing);\n    console.log(\"Drawing.getMetadata exists?\", typeof drawing.getMetadata);\n    console.log(\"Drawing fields:\", {\n      stampData: drawing.stampData,\n      stampSettings: drawing.stampSettings,\n      drawingType: drawing.drawingType,\n      brushType: drawing.brushType\n    });\n\n    const metadata = drawing.getMetadata\n      ? drawing.getMetadata()\n      : {\n        brushStyle: drawing.brushStyle || \"round\",\n        brushType: drawing.brushType || \"normal\",\n        brushParams: drawing.brushParams || {},\n        drawingType: drawing.drawingType || \"stroke\",\n        stampData: drawing.stampData || null,\n        stampSettings: drawing.stampSettings || null,\n        filterType: drawing.filterType || null,\n        filterParams: drawing.filterParams || {},\n      };\n\n    console.log(\"Extracted metadata:\", metadata);\n\n    const strokeData = {\n      drawingId: drawing.drawingId,\n      color: drawing.color,\n      lineWidth: drawing.lineWidth,\n      pathData: drawing.pathData,\n      timestamp: drawing.timestamp,\n      user: username,\n      roomId: options.roomId,\n      skipUndoStack: options.skipUndoStack || false,\n      brushStyle: metadata.brushStyle,\n      brushType: metadata.brushType,\n      brushParams: metadata.brushParams,\n      drawingType: metadata.drawingType,\n      stampData: metadata.stampData,\n      stampSettings: metadata.stampSettings,\n      filterType: metadata.filterType,\n      filterParams: metadata.filterParams,\n      metadata: metadata,\n    };\n\n    if (drawing.parentPasteId) {\n      strokeData.parentPasteId = drawing.parentPasteId;\n    } else if (drawing.pathData && drawing.pathData.parentPasteId) {\n      strokeData.parentPasteId = drawing.pathData.parentPasteId;\n    }\n\n    let signature = null;\n    let signerPubKey = null;\n\n    if (options.roomType === \"secure\") {\n      if (!isWalletConnected()) {\n        notify(\n          \"Please connect your wallet to draw in this secure room\",\n          \"warning\"\n        );\n        throw new Error(\"Wallet not connected for secure room\");\n      }\n\n      try {\n        const signedData = await signStrokeForSecureRoom(\n          options.roomId,\n          strokeData\n        );\n        signature = signedData.signature;\n        signerPubKey = signedData.signerPubKey;\n\n        console.log(\"Stroke signed for secure room:\", {\n          signerPubKey: signerPubKey?.substring(0, 16) + \"...\",\n        });\n      } catch (signError) {\n        console.error(\"Failed to sign stroke:\", signError);\n        notify(\n          \"Failed to sign stroke with wallet: \" + signError.message,\n          \"error\"\n        );\n        throw signError;\n      }\n    }\n\n    console.log(\"Submitting stroke data:\", {\n      drawingId: strokeData.drawingId,\n      brushType: strokeData.brushType,\n      brushParams: strokeData.brushParams,\n      metadata: strokeData.metadata,\n      roomType: options.roomType,\n      parentPasteId: strokeData.parentPasteId || \"NOT SET\"\n    });\n    console.log(\"Full strokeData object:\", strokeData);\n\n    // Submit with retry logic (max 3 attempts with exponential backoff)\n    await retryWithBackoff(\n      async () => {\n        await postRoomStroke(\n          token,\n          options.roomId,\n          strokeData,\n          signature,\n          signerPubKey\n        );\n      },\n      3,\n      1000\n    );\n\n    if (!options.skipUndoCheck && setUndoAvailable && setRedoAvailable) {\n      await checkUndoRedoAvailability(\n        { token },\n        setUndoAvailable,\n        setRedoAvailable,\n        options.roomId\n      );\n    }\n  } catch (error) {\n    console.error(\"Error submitting stroke:\", error);\n    throw error;\n  }\n};\n\nexport const submitBatchToDatabase = async (\n  drawings,\n  auth,\n  options = {},\n  setUndoAvailable,\n  setRedoAvailable,\n  onProgress\n) => {\n  const token = auth?.token || getAuthToken();\n  if (!token || !options.roomId) {\n    console.error(\"submitBatchToDatabase: Missing auth token or roomId\");\n    throw new Error(\"Missing auth token or roomId\");\n  }\n\n  if (!Array.isArray(drawings) || drawings.length === 0) {\n    return { processed: 0, failed: 0 };\n  }\n\n  try {\n    let username = null;\n    try {\n      username = getUsername(auth);\n    } catch (e) {\n      username = null;\n    }\n    if (!username) username = \"Unknown\";\n\n    // Process drawings in batches of 50 to avoid overwhelming the backend\n    const BATCH_SIZE = 50;\n    let totalProcessed = 0;\n    let totalFailed = 0;\n\n    for (let i = 0; i < drawings.length; i += BATCH_SIZE) {\n      const batch = drawings.slice(i, i + BATCH_SIZE);\n      \n      // Convert drawings to stroke data\n      const strokes = batch.map((drawing) => {\n        const metadata = drawing.getMetadata\n          ? drawing.getMetadata()\n          : {\n              brushStyle: drawing.brushStyle || \"round\",\n              brushType: drawing.brushType || \"normal\",\n              brushParams: drawing.brushParams || {},\n              drawingType: drawing.drawingType || \"stroke\",\n              stampData: drawing.stampData || null,\n              stampSettings: drawing.stampSettings || null,\n              filterType: drawing.filterType || null,\n              filterParams: drawing.filterParams || {},\n            };\n\n        const strokeData = {\n          drawingId: drawing.drawingId,\n          color: drawing.color,\n          lineWidth: drawing.lineWidth,\n          pathData: drawing.pathData,\n          timestamp: drawing.timestamp,\n          user: username,\n          roomId: options.roomId,\n          skipUndoStack: options.skipUndoStack || false,\n          brushStyle: metadata.brushStyle,\n          brushType: metadata.brushType,\n          brushParams: metadata.brushParams,\n          drawingType: metadata.drawingType,\n          stampData: metadata.stampData,\n          stampSettings: metadata.stampSettings,\n          filterType: metadata.filterType,\n          filterParams: metadata.filterParams,\n          metadata: metadata,\n        };\n\n        if (drawing.parentPasteId) {\n          strokeData.parentPasteId = drawing.parentPasteId;\n        } else if (drawing.pathData && drawing.pathData.parentPasteId) {\n          strokeData.parentPasteId = drawing.pathData.parentPasteId;\n        }\n\n        return strokeData;\n      });\n\n      // Handle secure room signing if needed\n      let signature = null;\n      let signerPubKey = null;\n\n      if (options.roomType === \"secure\") {\n        if (!isWalletConnected()) {\n          notify(\n            \"Please connect your wallet to draw in this secure room\",\n            \"warning\"\n          );\n          throw new Error(\"Wallet not connected for secure room\");\n        }\n\n        // For batch, we'll sign the first stroke as representative\n        // In production, you might want to sign each stroke individually\n        try {\n          const signedData = await signStrokeForSecureRoom(\n            options.roomId,\n            strokes[0]\n          );\n          signature = signedData.signature;\n          signerPubKey = signedData.signerPubKey;\n        } catch (signError) {\n          console.error(\"Failed to sign batch strokes:\", signError);\n          notify(\n            \"Failed to sign strokes with wallet: \" + signError.message,\n            \"error\"\n          );\n          throw signError;\n        }\n      }\n\n      console.log(`Submitting batch ${i / BATCH_SIZE + 1}: ${strokes.length} strokes`);\n\n      // Submit with retry logic (max 3 attempts with exponential backoff)\n      const result = await retryWithBackoff(\n        async () => {\n          return await postRoomStrokesBatch(\n            token,\n            options.roomId,\n            strokes,\n            {\n              skipUndoStack: options.skipUndoStack || false,\n              signature,\n              signerPubKey\n            }\n          );\n        },\n        3,\n        1000\n      );\n\n      totalProcessed += result.processed || 0;\n      totalFailed += result.failed || 0;\n\n      // Report progress\n      if (onProgress) {\n        onProgress({\n          current: i + batch.length,\n          total: drawings.length,\n          processed: totalProcessed,\n          failed: totalFailed\n        });\n      }\n\n      // Small delay between batches to avoid overwhelming the server\n      if (i + BATCH_SIZE < drawings.length) {\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n    }\n\n    if (!options.skipUndoCheck && setUndoAvailable && setRedoAvailable) {\n      await checkUndoRedoAvailability(\n        { token },\n        setUndoAvailable,\n        setRedoAvailable,\n        options.roomId\n      );\n    }\n\n    return { processed: totalProcessed, failed: totalFailed };\n  } catch (error) {\n    console.error(\"Error submitting batch strokes:\", error);\n    throw error;\n  }\n};\n\nexport const refreshCanvas = async (\n  currentCount,\n  userData,\n  drawAllDrawings,\n  startTime,\n  endTime,\n  options = {}\n) => {\n  const token = options.auth?.token || getAuthToken();\n  if (!token || !options.roomId) {\n    console.warn(\"refreshCanvas: Missing auth token or roomId\");\n    return 0;\n  }\n\n  try {\n    const strokes = await getRoomStrokes(token, options.roomId, {\n      start: startTime,\n      end: endTime,\n    });\n\n    if (strokes.length > 0) {\n      console.log(\"Received strokes from backend:\", {\n        count: strokes.length,\n        firstStroke: strokes[0],\n        lastStroke: strokes[strokes.length - 1]\n      });\n\n      console.log('=== BACKEND STROKE ANALYSIS ===');\n      console.log('Total strokes received:', strokes.length);\n\n      // Count and log advanced brush strokes\n      const advancedBrushStrokes = strokes.filter(s =>\n        s.brushType && s.brushType !== \"normal\" ||\n        (s.metadata && s.metadata.brushType && s.metadata.brushType !== \"normal\")\n      );\n      console.log('Advanced brush strokes:', advancedBrushStrokes.length);\n\n      if (strokes.length > 0) {\n        const firstStroke = strokes[0];\n        console.log('First stroke complete object:', firstStroke);\n        console.log('First stroke keys:', Object.keys(firstStroke));\n        console.log('First stroke brush analysis:', {\n          hasBrushType: 'brushType' in firstStroke,\n          hasBrush_type: 'brush_type' in firstStroke,\n          hasMetadata: 'metadata' in firstStroke,\n          brushTypeValue: firstStroke.brushType,\n          brush_typeValue: firstStroke.brush_type,\n          metadataValue: firstStroke.metadata\n        });\n      }\n\n      if (advancedBrushStrokes.length > 0) {\n        console.log('Sample advanced brush stroke:', advancedBrushStrokes[0]);\n      }\n    }\n\n    const backendDrawings = strokes.map((stroke) => {\n      let metadata = stroke.metadata || {};\n\n      // Merge top-level fields into metadata if not present\n      const extractedMetadata = {\n        brushStyle: metadata.brushStyle || stroke.brushStyle || \"round\",\n        brushType: metadata.brushType || stroke.brushType || stroke.brush_type || \"normal\",\n        brushParams: metadata.brushParams || stroke.brushParams || stroke.brush_params || {},\n        drawingType: metadata.drawingType || stroke.drawingType || \"stroke\",\n        stampData: metadata.stampData || stroke.stampData || null,\n        stampSettings: metadata.stampSettings || stroke.stampSettings || null,\n        filterType: metadata.filterType || stroke.filterType || null,\n        filterParams: metadata.filterParams || stroke.filterParams || {},\n      };\n\n      if (extractedMetadata.drawingType === \"stamp\" || extractedMetadata.brushType !== \"normal\") {\n        console.log(`Reconstructing special drawing from backend:`, {\n          id: stroke.drawingId || stroke.id,\n          drawingType: extractedMetadata.drawingType,\n          brushType: extractedMetadata.brushType,\n          stampData: extractedMetadata.stampData,\n          stampSettings: extractedMetadata.stampSettings,\n          rawStroke: stroke,\n          extractedMetadata: extractedMetadata\n        });\n      }\n\n      const drawing = new Drawing(\n        stroke.drawingId || stroke.id ||\n        `stroke_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,\n        stroke.color || \"#000000\",\n        stroke.lineWidth || 5,\n        stroke.pathData || [],\n        stroke.timestamp || stroke.ts || Date.now(),\n        stroke.user || \"\",\n        extractedMetadata\n      );\n\n      drawing.order = stroke.order || stroke.timestamp || 0;\n      drawing.roomId = stroke.roomId || options.roomId;\n\n      if (extractedMetadata.drawingType === \"stamp\" || extractedMetadata.brushType !== \"normal\") {\n        console.log(\"Created Drawing object with special features:\", {\n          id: drawing.drawingId,\n          drawingType: drawing.drawingType,\n          brushType: drawing.brushType,\n          stampData: drawing.stampData,\n          stampSettings: drawing.stampSettings,\n          hasStampData: !!drawing.stampData,\n          hasStampSettings: !!drawing.stampSettings,\n          pathData: drawing.pathData,\n          pathDataIsArray: Array.isArray(drawing.pathData),\n          pathDataLength: drawing.pathData ? drawing.pathData.length : 0,\n          metadata: drawing.getMetadata()\n        });\n\n        // For custom image stamps, verify the base64 data is intact\n        if (drawing.stampData && drawing.stampData.image) {\n          console.log(\"Stamp image data length from backend:\", drawing.stampData.image.length);\n          console.log(\"Stamp image preview:\", drawing.stampData.image.substring(0, 100) + \"...\");\n        }\n      }\n\n      return drawing;\n    });\n\n    // Filter by time range if specified\n    const filteredDrawings = backendDrawings.filter((drawing) => {\n      if (startTime && drawing.timestamp < startTime) return false;\n      if (endTime && drawing.timestamp > endTime) return false;\n      return true;\n    });\n\n    // Sort by order/timestamp\n    filteredDrawings.sort(\n      (a, b) => (a.order || a.timestamp) - (b.order || b.timestamp)\n    );\n\n    console.log(\"[refreshCanvas] About to update userData.drawings:\", {\n      oldCount: userData.drawings ? userData.drawings.length : 0,\n      newCount: filteredDrawings.length,\n      newDrawingsSample: filteredDrawings.slice(0, 3).map(d => ({ id: d.drawingId, brushType: d.brushType }))\n    });\n\n    // Clear any cached state to force a redraw\n    // This ensures the canvas renders again even if the drawing IDs are the same\n    if (options.clearLastDrawnState) {\n      options.clearLastDrawnState();\n    }\n\n    userData.drawings = filteredDrawings;\n\n    console.log(\"[refreshCanvas] Updated userData.drawings:\", {\n      count: userData.drawings.length,\n      firstDrawing: userData.drawings[0] ? {\n        id: userData.drawings[0].drawingId,\n        brushType: userData.drawings[0].brushType\n      } : null,\n      allDrawingIds: userData.drawings.map(d => d.drawingId).join(',').substring(0, 200),\n      pastedStrokesStillPresent: userData.drawings.filter(d =>\n        d.parentPasteId || (d.pathData && d.pathData.parentPasteId)\n      ).length\n    });\n\n    if (drawAllDrawings) {\n      console.log(\"[refreshCanvas] Calling drawAllDrawings...\");\n      drawAllDrawings();\n    }\n\n    return userData.drawings.length;\n  } catch (error) {\n    console.error(\"Error refreshing canvas:\", error);\n    return userData.drawings ? userData.drawings.length : 0;\n  }\n};\n\nexport const clearBackendCanvas = async (options = {}) => {\n  const token = options.auth?.token || getAuthToken();\n  if (!token || !options.roomId) {\n    console.warn(\"clearBackendCanvas: Missing auth token or roomId\");\n    return;\n  }\n\n  try {\n    console.log(\"Clear canvas requested for room:\", options.roomId);\n    const result = await clearRoomCanvas(token, options.roomId);\n    console.log(\"Canvas cleared successfully\", result);\n\n    return result;\n  } catch (error) {\n    console.error(\"Error clearing canvas:\", error);\n    throw error;\n  }\n};\n\nlet undoRedoInProgress = false;\n\nexport const undoAction = async ({\n  auth,\n  currentUser,\n  undoStack,\n  setUndoStack,\n  setRedoStack,\n  userData,\n  drawAllDrawings,\n  refreshCanvasButtonHandler,\n  checkUndoRedoAvailability,\n  roomId,\n}) => {\n  if (undoStack.length === 0) return;\n\n  if (undoRedoInProgress) {\n    console.log(\"UNDO DEBUG: Another undo/redo is in progress, skipping\");\n    return;\n  }\n\n  undoRedoInProgress = true;\n\n  try {\n    const lastAction = undoStack[undoStack.length - 1];\n\n    console.log(\"UNDO DEBUG: undoStack.length =\", undoStack.length);\n    console.log(\"UNDO DEBUG: lastAction =\", lastAction);\n\n    let shouldRefreshFromBackend = false;\n\n    try {\n      if (lastAction.type === \"cut\") {\n        console.log(\"UNDO DEBUG: Processing cut operation undo\");\n\n        userData.drawings = userData.drawings.filter((drawing) => {\n          if (drawing.drawingId === lastAction.cutRecord.drawingId)\n            return false;\n\n          for (const repArr of Object.values(lastAction.replacementSegments)) {\n            if (repArr.some((rep) => rep.drawingId === drawing.drawingId)) {\n              return false;\n            }\n          }\n\n          return true;\n        });\n\n        lastAction.affectedDrawings.forEach((original) => {\n          userData.drawings.push(original);\n        });\n\n        drawAllDrawings();\n\n        const result = await undoRoomAction(auth.token, roomId);\n\n        if (result.status === \"ok\" || result.status === \"success\") {\n          console.log(\"UNDO DEBUG: Cut record undone on backend\");\n          // No need for full refresh - we already updated locally\n          shouldRefreshFromBackend = false;\n        } else if (result.status === \"noop\") {\n          console.log(\"Backend has no more undo actions available\");\n        } else {\n          console.error(\"Undo failed:\", result.message);\n        }\n      } else if (lastAction.type === \"paste\") {\n        console.log(\"UNDO DEBUG: Processing paste operation undo\");\n        console.log(\"UNDO DEBUG: Paste undo - pastedDrawings count:\", lastAction.pastedDrawings.length);\n        console.log(\"UNDO DEBUG: Paste undo - pastedDrawing IDs:\", lastAction.pastedDrawings.map(d => d.drawingId).join(','));\n        console.log(\"UNDO DEBUG: Paste undo - userData.drawings before filter:\", userData.drawings.length);\n\n        // Call backend undo for the paste record\n        const result = await undoRoomAction(auth.token, roomId);\n\n        if (result.status === \"ok\" || result.status === \"success\") {\n          shouldRefreshFromBackend = false;\n        } else if (result.status === \"noop\") {\n          console.log(\"Backend has no more undo actions available\");\n        } else {\n          console.error(\"Undo failed:\", result.message);\n        }\n\n        // Remove pasted drawings from local state\n        const beforeCount = userData.drawings.length;\n        userData.drawings = userData.drawings.filter(\n          (drawing) =>\n            !lastAction.pastedDrawings.some(\n              (pasted) => pasted.drawingId === drawing.drawingId\n            )\n        );\n        const afterCount = userData.drawings.length;\n        console.log(\"UNDO DEBUG: Paste undo - userData.drawings after filter:\", afterCount, \"(removed\", beforeCount - afterCount, \"drawings)\");\n\n        // Redraw immediately without backend refresh\n        drawAllDrawings();\n      } else {\n        console.log(\"UNDO DEBUG: lastAction =\", lastAction);\n        console.log(\n          \"UNDO DEBUG: userData.drawings before filter =\",\n          userData.drawings.length\n        );\n        console.log(\n          \"UNDO DEBUG: looking for drawingId =\",\n          lastAction.drawingId\n        );\n\n        userData.drawings = userData.drawings.filter((drawing) => {\n          console.log(\n            \"UNDO DEBUG: comparing\",\n            drawing.drawingId,\n            \"vs\",\n            lastAction.drawingId\n          );\n          return drawing.drawingId !== lastAction.drawingId;\n        });\n\n        console.log(\n          \"UNDO DEBUG: userData.drawings after filter =\",\n          userData.drawings.length\n        );\n\n        // Redraw immediately without waiting for backend\n        drawAllDrawings();\n\n        const result = await undoRoomAction(auth.token, roomId);\n        console.log(\"UNDO DEBUG: backend result =\", result);\n\n        if (result.status === \"noop\") {\n          console.log(\n            \"UNDO DEBUG: Backend has nothing to undo, but we already removed locally\"\n          );\n          shouldRefreshFromBackend = false;\n        } else if (result.status === \"ok\" || result.status === \"success\") {\n          console.log(\"UNDO DEBUG: Backend undo successful\");\n          // No need for full refresh - local state is already correct\n          shouldRefreshFromBackend = false;\n        } else {\n          console.error(\"Undo failed:\", result.message);\n          // On failure, restore the drawing\n          userData.drawings.push(lastAction);\n          drawAllDrawings();\n          shouldRefreshFromBackend = false;\n        }\n      }\n\n      const newUndoStack = undoStack.slice(0, undoStack.length - 1);\n\n      setUndoStack(newUndoStack);\n      setRedoStack((prev) => [...prev, lastAction]);\n    } catch (error) {\n      console.error(\"Undo error:\", error);\n      setUndoStack([]);\n      setRedoStack([]);\n      notify(\"Undo failed due to local cache being cleared out.\");\n    } finally {\n      undoRedoInProgress = false;\n\n      // Only refresh if we haven't already refreshed after backend call\n      if (shouldRefreshFromBackend) {\n        refreshCanvasButtonHandler();\n      }\n\n      if (checkUndoRedoAvailability) {\n        checkUndoRedoAvailability();\n      }\n    }\n  } catch (error) {\n    console.error(\"Unexpected undo error:\", error);\n    undoRedoInProgress = false;\n  }\n};\n\nexport const redoAction = async ({\n  auth,\n  currentUser,\n  redoStack,\n  setRedoStack,\n  setUndoStack,\n  userData,\n  drawAllDrawings,\n  refreshCanvasButtonHandler,\n  checkUndoRedoAvailability,\n  roomId,\n}) => {\n  if (redoStack.length === 0) return;\n\n  if (undoRedoInProgress) {\n    console.log(\"REDO DEBUG: Another undo/redo is in progress, skipping\");\n    return;\n  }\n\n  undoRedoInProgress = true;\n  let shouldRefreshFromBackend = true; // Track if we need to refresh in finally block\n\n  try {\n    const lastUndone = redoStack[redoStack.length - 1];\n\n    try {\n      if (lastUndone.type === \"cut\") {\n        console.log(\"REDO DEBUG: Processing cut operation redo\");\n\n        lastUndone.affectedDrawings.forEach((original) => {\n          userData.drawings = userData.drawings.filter(\n            (drawing) => drawing.drawingId !== original.drawingId\n          );\n        });\n\n        Object.values(lastUndone.replacementSegments).forEach((segments) => {\n          segments.forEach((seg) => {\n            userData.drawings.push(seg);\n          });\n        });\n\n        userData.addDrawing(lastUndone.cutRecord);\n\n        drawAllDrawings();\n\n        const result = await redoRoomAction(auth.token, roomId);\n\n        if (result.status === \"ok\" || result.status === \"success\") {\n          console.log(\"REDO DEBUG: Cut record redone on backend\");\n          shouldRefreshFromBackend = false;\n        } else if (result.status === \"noop\") {\n          console.log(\"Backend has no more redo actions available\");\n        } else {\n          console.error(\"Redo failed:\", result.message);\n        }\n      } else if (lastUndone.type === \"paste\") {\n        console.log(\"REDO DEBUG: Processing paste operation redo\");\n\n        for (let i = 0; i < lastUndone.backendCount; i++) {\n          const result = await redoRoomAction(auth.token, roomId);\n\n          if (result.status === \"ok\" || result.status === \"success\") {\n          } else if (result.status === \"noop\") {\n            console.log(\"Backend has no more redo actions available\");\n          } else {\n            console.error(\"Redo failed:\", result.message);\n          }\n        }\n\n        lastUndone.pastedDrawings.forEach((pd) => {\n          userData.drawings.push(pd);\n        });\n\n        drawAllDrawings();\n\n        // No need for full refresh after paste redo - local state is already correct\n        shouldRefreshFromBackend = false; \n      } else {\n        userData.drawings.push(lastUndone);\n\n        drawAllDrawings();\n\n        const result = await redoRoomAction(auth.token, roomId);\n\n        if (result.status === \"noop\") {\n          setRedoStack([]);\n          setUndoStack([]);\n          notify(\"Redo failed due to local cache being cleared out.\");\n          return;\n        }\n\n        if (result.status === \"ok\" || result.status === \"success\") {\n          console.log(\"REDO DEBUG: Redo successful\");\n          // No need for full refresh - local state is already correct\n          shouldRefreshFromBackend = false;\n        } else if (result.status !== \"ok\" && result.status !== \"success\") {\n          console.error(\"Redo failed:\", result.message);\n          // On failure, remove the drawing we just added\n          userData.drawings = userData.drawings.filter(\n            (d) => d.drawingId !== lastUndone.drawingId\n          );\n          drawAllDrawings();\n        }\n      }\n\n      const newRedoStack = redoStack.slice(0, redoStack.length - 1);\n      setRedoStack(newRedoStack);\n      setUndoStack((prev) => [...prev, lastUndone]);\n    } catch (error) {\n      console.error(\"Error during redo:\", error);\n    } finally {\n      undoRedoInProgress = false;\n\n      // Only refresh if we haven't already refreshed after backend call\n      if (shouldRefreshFromBackend) {\n        refreshCanvasButtonHandler();\n      }\n\n      if (checkUndoRedoAvailability) {\n        checkUndoRedoAvailability();\n      }\n    }\n  } catch (error) {\n    console.error(\"Redo outer error:\", error);\n    undoRedoInProgress = false;\n  }\n};\n\nexport const restoreUndoRedoStacks = async (\n  auth,\n  roomId,\n  setUndoStack,\n  setRedoStack,\n  setUndoAvailable,\n  setRedoAvailable\n) => {\n  try {\n    const token = auth?.token || getAuthToken();\n    if (!token || !roomId) {\n      console.log(\"Cannot restore stacks: missing token or roomId\");\n      return { undo: [], redo: [] };\n    }\n\n    const result = await getUndoRedoStacks(token, roomId);\n    \n    if (result.status === \"ok\") {\n      const undoStack = result.undo_stack || [];\n      const redoStack = result.redo_stack || [];\n      \n      console.log(`Restoring undo/redo stacks: ${undoStack.length} undo, ${redoStack.length} redo items`);\n      \n      // Convert backend stroke data to Drawing objects\n      const reconstructDrawing = (stroke) => {\n        if (stroke.type === \"cut\" || stroke.type === \"paste\") {\n          return stroke;\n        }\n        \n        const metadata = stroke.metadata || {\n          brushStyle: stroke.brushStyle || \"round\",\n          brushType: stroke.brushType || \"normal\",\n          brushParams: stroke.brushParams || {},\n          drawingType: stroke.drawingType || \"stroke\",\n          stampData: stroke.stampData || null,\n          stampSettings: stroke.stampSettings || null,\n          filterType: stroke.filterType || null,\n          filterParams: stroke.filterParams || {},\n        };\n        \n        const drawing = new Drawing(\n          stroke.drawingId || stroke.id,\n          stroke.color || \"#000000\",\n          stroke.lineWidth || 5,\n          stroke.pathData || [],\n          stroke.timestamp || stroke.ts || Date.now(),\n          stroke.user || \"\",\n          metadata\n        );\n        \n        drawing.roomId = stroke.roomId || roomId;\n        \n        return drawing;\n      };\n      \n      const restoredUndoStack = undoStack.map(reconstructDrawing);\n      const restoredRedoStack = redoStack.map(reconstructDrawing);\n      \n      setUndoStack(restoredUndoStack);\n      setRedoStack(restoredRedoStack);\n      \n      setUndoAvailable && setUndoAvailable(restoredUndoStack.length > 0);\n      setRedoAvailable && setRedoAvailable(restoredRedoStack.length > 0);\n      \n      return { undo: restoredUndoStack, redo: restoredRedoStack };\n    }\n  } catch (error) {\n    console.error(\"Error restoring undo/redo stacks:\", error);\n  }\n  \n  return { undo: [], redo: [] };\n};\n\nexport const checkUndoRedoAvailability = async (\n  auth,\n  setUndoAvailable,\n  setRedoAvailable,\n  roomId\n) => {\n  try {\n    const token = auth?.token || getAuthToken();\n    if (!token || !roomId) {\n      setUndoAvailable && setUndoAvailable(false);\n      setRedoAvailable && setRedoAvailable(false);\n      return;\n    }\n\n    const result = await getUndoRedoStatus(token, roomId);\n    if (result.status === \"ok\") {\n      setUndoAvailable && setUndoAvailable(result.undo_available);\n      setRedoAvailable && setRedoAvailable(result.redo_available);\n      console.log(\"Undo/redo status updated:\", result);\n      return result;\n    }\n  } catch (error) {\n    console.error(\"Error checking undo/redo availability:\", error);\n  }\n\n  setUndoAvailable && setUndoAvailable(false);\n  setRedoAvailable && setRedoAvailable(false);\n  return { undo_available: false, redo_available: false };\n};\n","import { useState } from 'react';\nimport ClipperLib from 'clipper-lib';\nimport { submitToDatabase } from '../services/canvasBackendJWT';\nimport { Drawing } from '../lib/drawing';\n\nexport function useCanvasSelection(canvasRef, currentUser, userData, generateId, drawAllDrawings, currentRoomId, setUndoAvailable, setRedoAvailable, auth, roomType, showLocalSnack) {\n  const [selectionStart, setSelectionStart] = useState(null);\n  const [selectionRect, setSelectionRect] = useState(null);\n  const [cutImageData, setCutImageData] = useState(null);\n  const [cutOriginalIds, setCutOriginalIds] = useState(new Set());\n  const [cutStrokesMap, setCutStrokesMap] = useState({});\n\n  const computeIntersections = (p1, p2, rect) => {\n    const intersections = [];\n\n    if (p2.x - p1.x !== 0) {\n      const tLeft = (rect.x - p1.x) / (p2.x - p1.x);\n\n      if (tLeft >= 0 && tLeft <= 1) {\n        const yLeft = p1.y + tLeft * (p2.y - p1.y);\n\n        if (yLeft >= rect.y && yLeft <= rect.y + rect.height) {\n          intersections.push({ t: tLeft, point: { x: rect.x, y: yLeft } });\n        }\n      }\n\n      const tRight = ((rect.x + rect.width) - p1.x) / (p2.x - p1.x);\n\n      if (tRight >= 0 && tRight <= 1) {\n        const yRight = p1.y + tRight * (p2.y - p1.y);\n\n        if (yRight >= rect.y && yRight <= rect.y + rect.height) {\n          intersections.push({ t: tRight, point: { x: rect.x + rect.width, y: yRight } });\n        }\n      }\n    }\n\n    if (p2.y - p1.y !== 0) {\n      const tTop = (rect.y - p1.y) / (p2.y - p1.y);\n\n      if (tTop >= 0 && tTop <= 1) {\n        const xTop = p1.x + tTop * (p2.x - p1.x);\n\n        if (xTop >= rect.x && xTop <= rect.x + rect.width) {\n          intersections.push({ t: tTop, point: { x: xTop, y: rect.y } });\n        }\n      }\n\n      const tBottom = ((rect.y + rect.height) - p1.y) / (p2.y - p1.y);\n\n      if (tBottom >= 0 && tBottom <= 1) {\n        const xBottom = p1.x + tBottom * (p2.x - p1.x);\n\n        if (xBottom >= rect.x && xBottom <= rect.x + rect.width) {\n          intersections.push({ t: tBottom, point: { x: xBottom, y: rect.y + rect.height } });\n        }\n      }\n    }\n\n    intersections.sort((a, b) => a.t - b.t);\n\n    const unique = [];\n    intersections.forEach(inter => {\n      if (!unique.some(u => Math.abs(u.t - inter.t) < 1e-6)) {\n        unique.push(inter);\n      }\n    });\n    return unique;\n  };\n\n  const getOutsideSegments = (points, rect) => {\n    const isInside = pt =>\n      pt.x >= rect.x && pt.x <= rect.x + rect.width &&\n      pt.y >= rect.y && pt.y <= rect.y + rect.height;\n\n    const segments = [];\n    let currentSegment = [];\n\n    for (let i = 0; i < points.length - 1; i++) {\n      const p1 = points[i];\n      const p2 = points[i + 1];\n\n      if (!isInside(p1)) {\n        if (currentSegment.length === 0) currentSegment.push(p1);\n      }\n\n      if (isInside(p1) !== isInside(p2)) {\n        const inters = computeIntersections(p1, p2, rect);\n\n        if (inters.length > 0) {\n          const ip = inters[0].point;\n\n          if (!isInside(p1)) {\n            currentSegment.push(ip);\n            segments.push(currentSegment);\n            currentSegment = [];\n          } else {\n            currentSegment = [];\n            currentSegment.push(ip);\n          }\n        }\n      } else if (!isInside(p1) && !isInside(p2)) {\n        if (currentSegment.length > 0) currentSegment.push(p2);\n      }\n    }\n\n    if (currentSegment.length >= 2) segments.push(currentSegment);\n\n    return segments;\n  };\n\n  const getInsideSegments = (points, rect) => {\n    const isInside = pt =>\n      pt.x >= rect.x && pt.x <= rect.x + rect.width &&\n      pt.y >= rect.y && pt.y <= rect.y + rect.height;\n\n    const segments = [];\n    let currentSegment = [];\n\n    for (let i = 0; i < points.length - 1; i++) {\n      const p1 = points[i];\n      const p2 = points[i + 1];\n\n      if (isInside(p1)) {\n        if (currentSegment.length === 0) currentSegment.push(p1);\n      }\n\n      if (isInside(p1) !== isInside(p2)) {\n        const inters = computeIntersections(p1, p2, rect);\n\n        if (inters.length > 0) {\n          const ip = inters[0].point;\n\n          if (isInside(p1)) {\n            currentSegment.push(ip);\n            segments.push(currentSegment);\n            currentSegment = [];\n          } else {\n            currentSegment = [];\n            currentSegment.push(ip);\n          }\n        }\n      } else if (isInside(p1) && isInside(p2)) {\n        if (currentSegment.length > 0) currentSegment.push(p2);\n      }\n    }\n    if (currentSegment.length >= 2) segments.push(currentSegment);\n\n    return segments;\n  };\n\n  // Main handler to processes current selection into a cut operation.\n  const handleCutSelection = async () => {\n    if (!selectionRect) return;\n\n    const { start, end } = selectionRect;\n    const rectX = Math.min(start.x, end.x);\n    const rectY = Math.min(start.y, end.y);\n    const rectWidth = Math.abs(end.x - start.x);\n    const rectHeight = Math.abs(end.y - start.y);\n\n    if (!(rectWidth && rectHeight)) return;\n\n    setCutImageData([]);\n    await new Promise((resolve) => setTimeout(resolve, 10));\n\n    const cutRect = { x: rectX, y: rectY, width: rectWidth, height: rectHeight };\n    let eraseInsideSegmentsNew = [];\n    let newCutDrawings = [];\n    let updatedDrawings = [];\n    let affectedDrawings = [];\n    const newCutOriginalIds = new Set();\n    const newCutStrokesMap = {};\n\n    const totalDrawings = userData.drawings.length;\n    let processedCount = 0;\n\n    userData.drawings.forEach((drawing) => {\n      processedCount++;\n\n      if (showLocalSnack) {\n        showLocalSnack(`Processing cut... ${processedCount}/${totalDrawings} strokes analyzed.`);\n      }\n      if (Array.isArray(drawing.pathData)) {\n        const points = drawing.pathData;\n\n        // Special handling for stamps and single-point drawings\n        if (points.length === 1) {\n          const pt = points[0];\n          const isInside = pt.x >= cutRect.x &&\n            pt.x <= cutRect.x + cutRect.width &&\n            pt.y >= cutRect.y &&\n            pt.y <= cutRect.y + cutRect.height;\n\n          if (!isInside) {\n            updatedDrawings.push(drawing);\n            return;\n          }\n\n          // This single-point drawing (e.g., stamp) is inside the cut rectangle\n          affectedDrawings.push(drawing);\n          newCutOriginalIds.add(drawing.drawingId);\n\n          // Preserve all metadata from original drawing\n          const metadata = {\n            brushStyle: drawing.brushStyle,\n            brushType: drawing.brushType,\n            brushParams: drawing.brushParams,\n            drawingType: drawing.drawingType,\n            stampData: drawing.stampData,\n            stampSettings: drawing.stampSettings,\n            filterType: drawing.filterType,\n            filterParams: drawing.filterParams,\n          };\n\n          const cutDrawing = new Drawing(\n            generateId(),\n            drawing.color,\n            drawing.lineWidth,\n            points, // Keep as single-point array\n            Date.now(),\n            drawing.user,\n            metadata\n          );\n          newCutDrawings.push(cutDrawing);\n\n          // No replacement segments for single-point drawings - they're fully cut\n          newCutStrokesMap[drawing.drawingId] = [];\n          return;\n        }\n\n        // Multi-point drawings (normal strokes, wacky brushes, etc.)\n        const intersects = points.some(pt =>\n          pt.x >= cutRect.x &&\n          pt.x <= cutRect.x + cutRect.width &&\n          pt.y >= cutRect.y &&\n          pt.y <= cutRect.y + cutRect.height\n        );\n\n        if (!intersects) {\n          updatedDrawings.push(drawing);\n          return;\n        }\n\n        affectedDrawings.push(drawing);\n        newCutOriginalIds.add(drawing.drawingId);\n\n        const outsideSegments = getOutsideSegments(points, cutRect);\n        const insideSegments = getInsideSegments(points, cutRect);\n        const replacementSegments = [];\n\n        outsideSegments.forEach(seg => {\n          if (seg.length > 1) {\n            // Preserve all metadata from original drawing\n            const metadata = {\n              brushStyle: drawing.brushStyle,\n              brushType: drawing.brushType,\n              brushParams: drawing.brushParams,\n              drawingType: drawing.drawingType,\n              stampData: drawing.stampData,\n              stampSettings: drawing.stampSettings,\n              filterType: drawing.filterType,\n              filterParams: drawing.filterParams,\n            };\n            const newSeg = new Drawing(generateId(), drawing.color, drawing.lineWidth, seg, Date.now(), drawing.user, metadata);\n\n            replacementSegments.push(newSeg);\n            updatedDrawings.push(newSeg);\n          }\n        });\n\n        newCutStrokesMap[drawing.drawingId] = replacementSegments;\n\n        insideSegments.forEach(seg => {\n          if (seg.length > 1) {\n            // Preserve all metadata from original drawing\n            const metadata = {\n              brushStyle: drawing.brushStyle,\n              brushType: drawing.brushType,\n              brushParams: drawing.brushParams,\n              drawingType: drawing.drawingType,\n              stampData: drawing.stampData,\n              stampSettings: drawing.stampSettings,\n              filterType: drawing.filterType,\n              filterParams: drawing.filterParams,\n            };\n            const cutSeg = new Drawing(generateId(), drawing.color, drawing.lineWidth, seg, Date.now(), drawing.user, metadata);\n            newCutDrawings.push(cutSeg);\n\n            const eraseSeg = new Drawing(generateId(), '#ffffff', drawing.lineWidth + 4, seg, Date.now(), drawing.user);\n            eraseInsideSegmentsNew.push(eraseSeg);\n          }\n        });\n      }\n      else if (drawing.pathData && drawing.pathData.tool === \"shape\") {\n        const shapeData = drawing.pathData;\n        let shapePoints = [];\n\n        // start by checking if this is a pastedin polygon\n        // since pasted shapes come in as { tool: \"shape\", type:\"polygon\", points: [] }\n        if (shapeData.points && Array.isArray(shapeData.points)) {\n          shapePoints = shapeData.points;\n        } else if (shapeData.type === \"circle\") {\n          const center = { x: shapeData.start.x, y: shapeData.start.y };\n          const radius = Math.sqrt((shapeData.end.x - shapeData.start.x) ** 2 +\n            (shapeData.end.y - shapeData.start.y) ** 2);\n          const numPoints = 30;\n\n          for (let i = 0; i < numPoints; i++) {\n            const angle = (2 * Math.PI * i) / numPoints;\n            shapePoints.push({ x: center.x + radius * Math.cos(angle), y: center.y + radius * Math.sin(angle) });\n          }\n\n          shapePoints.push(shapePoints[0]);\n        } else if (shapeData.type === \"rectangle\") {\n          shapePoints = [\n            { x: shapeData.start.x, y: shapeData.start.y },\n            { x: shapeData.end.x, y: shapeData.start.y },\n            { x: shapeData.end.x, y: shapeData.end.y },\n            { x: shapeData.start.x, y: shapeData.end.y },\n            { x: shapeData.start.x, y: shapeData.start.y },\n          ];\n        } else if (shapeData.type === \"hexagon\") {\n          const center = { x: shapeData.start.x, y: shapeData.start.y };\n          const radius = Math.sqrt((shapeData.end.x - shapeData.start.x) ** 2 +\n            (shapeData.end.y - shapeData.start.y) ** 2);\n\n          for (let i = 0; i < 6; i++) {\n            const angle = Math.PI / 3 * i;\n            shapePoints.push({ x: center.x + radius * Math.cos(angle), y: center.y + radius * Math.sin(angle) });\n          }\n\n          shapePoints.push(shapePoints[0]);\n        } else if (shapeData.type === \"line\") {\n          shapePoints = [shapeData.start, shapeData.end];\n        }\n\n        // boundingbox overlap test to catch any slice through the shape\n        const xs = shapePoints.map(p => p.x);\n        const ys = shapePoints.map(p => p.y);\n        const minX = Math.min(...xs), maxX = Math.max(...xs);\n        const minY = Math.min(...ys), maxY = Math.max(...ys);\n\n        if (\n          maxX < cutRect.x ||\n          minX > cutRect.x + cutRect.width ||\n          maxY < cutRect.y ||\n          minY > cutRect.y + cutRect.height\n        ) {\n          updatedDrawings.push(drawing);\n          return;\n        }\n\n        affectedDrawings.push(drawing);\n        newCutOriginalIds.add(drawing.drawingId);\n\n        if (shapeData.type !== \"line\") {\n          const subj = shapePoints.map(pt => ({ X: pt.x, Y: pt.y }));\n          const clipPoly = [\n            { X: cutRect.x, Y: cutRect.y },\n            { X: cutRect.x + cutRect.width, Y: cutRect.y },\n            { X: cutRect.x + cutRect.width, Y: cutRect.y + cutRect.height },\n            { X: cutRect.x, Y: cutRect.y + cutRect.height },\n          ];\n\n          let clipper1 = new ClipperLib.Clipper();\n          clipper1.AddPath(subj, ClipperLib.PolyType.ptSubject, true);\n          clipper1.AddPath(clipPoly, ClipperLib.PolyType.ptClip, true);\n\n          let insideSolution = new ClipperLib.Paths();\n          clipper1.Execute(ClipperLib.ClipType.ctIntersection, insideSolution, ClipperLib.PolyFillType.pftNonZero, ClipperLib.PolyFillType.pftNonZero);\n\n          let clipper2 = new ClipperLib.Clipper();\n          clipper2.AddPath(subj, ClipperLib.PolyType.ptSubject, true);\n          clipper2.AddPath(clipPoly, ClipperLib.PolyType.ptClip, true);\n\n          let outsideSolution = new ClipperLib.Paths();\n          clipper2.Execute(ClipperLib.ClipType.ctDifference, outsideSolution, ClipperLib.PolyFillType.pftNonZero, ClipperLib.PolyFillType.pftNonZero);\n\n          outsideSolution.forEach(poly => {\n            if (poly.length >= 3) {\n              const newPoly = poly.map(pt => ({ x: pt.X, y: pt.Y }));\n              // Preserve all metadata from original drawing\n              const metadata = {\n                brushStyle: drawing.brushStyle,\n                brushType: drawing.brushType,\n                brushParams: drawing.brushParams,\n                drawingType: drawing.drawingType,\n                stampData: drawing.stampData,\n                stampSettings: drawing.stampSettings,\n                filterType: drawing.filterType,\n                filterParams: drawing.filterParams,\n              };\n              const newSeg = new Drawing(generateId(), drawing.color, drawing.lineWidth, { tool: \"shape\", type: \"polygon\", points: newPoly }, Date.now(), drawing.user, metadata);\n\n              updatedDrawings.push(newSeg);\n\n              if (!newCutStrokesMap[drawing.drawingId]) newCutStrokesMap[drawing.drawingId] = [];\n\n              newCutStrokesMap[drawing.drawingId].push(newSeg);\n            }\n          });\n\n          if (insideSolution.length > 0) {\n            let maxArea = 0;\n            let bestPoly = null;\n\n            insideSolution.forEach(poly => {\n              if (poly.length >= 3) {\n                let area = Math.abs(ClipperLib.Clipper.Area(poly));\n\n                if (area > maxArea) {\n                  maxArea = area;\n                  bestPoly = poly;\n                }\n              }\n            });\n\n            if (bestPoly) {\n              const insidePoly = bestPoly.map(pt => ({ x: pt.X, y: pt.Y }));\n              // Preserve all metadata from original drawing\n              const metadata = {\n                brushStyle: drawing.brushStyle,\n                brushType: drawing.brushType,\n                brushParams: drawing.brushParams,\n                drawingType: drawing.drawingType,\n                stampData: drawing.stampData,\n                stampSettings: drawing.stampSettings,\n                filterType: drawing.filterType,\n                filterParams: drawing.filterParams,\n              };\n              const cutSeg = new Drawing(generateId(), drawing.color, drawing.lineWidth, { tool: \"shape\", type: \"polygon\", points: insidePoly }, Date.now(), drawing.user, metadata);\n\n              newCutDrawings.push(cutSeg);\n\n              const eraseSeg = new Drawing(generateId(), '#ffffff', drawing.lineWidth + 4, { tool: \"shape\", type: \"polygon\", points: insidePoly }, Date.now(), drawing.user);\n              eraseInsideSegmentsNew.push(eraseSeg);\n            }\n          }\n        } else {\n          const [p1, p2] = shapePoints;\n          const inters = computeIntersections(p1, p2, cutRect).map(i => i.point);\n          const inside = pt =>\n            pt.x >= cutRect.x &&\n            pt.x <= cutRect.x + cutRect.width &&\n            pt.y >= cutRect.y &&\n            pt.y <= cutRect.y + cutRect.height;\n\n          let outsideSegs = [], insideSegs = [];\n\n          if (inside(p1) && inside(p2)) {\n            // whole line inside, so the entire segment is a cut piece\n            insideSegs.push([p1, p2]);\n          } else if (inters.length === 2) {\n            // line crosses box boundary twice, so it is inside between those two points\n            insideSegs.push([inters[0], inters[1]]);\n            outsideSegs.push([p1, inters[0]], [inters[1], p2]);\n          } else if (inters.length === 1) {\n            // one endpoint inside, so lets split at that intersection\n            if (inside(p1)) {\n              insideSegs.push([p1, inters[0]]);\n              outsideSegs.push([inters[0], p2]);\n            } else {\n              insideSegs.push([inters[0], p2]);\n              outsideSegs.push([p1, inters[0]]);\n            }\n          } else {\n            updatedDrawings.push(drawing);\n            newCutStrokesMap[drawing.drawingId] = [];\n            return;\n          }\n\n          const replacementSegments = outsideSegs.map(([s, e]) => {\n            // Preserve all metadata from original drawing\n            const metadata = {\n              brushStyle: drawing.brushStyle,\n              brushType: drawing.brushType,\n              brushParams: drawing.brushParams,\n              drawingType: drawing.drawingType,\n              stampData: drawing.stampData,\n              stampSettings: drawing.stampSettings,\n              filterType: drawing.filterType,\n              filterParams: drawing.filterParams,\n            };\n            const seg = new Drawing(\n              generateId(),\n              drawing.color,\n              drawing.lineWidth,\n              { tool: \"shape\", type: \"line\", start: s, end: e },\n              Date.now(),\n              drawing.user,\n              metadata\n            );\n            updatedDrawings.push(seg);\n            return seg;\n          });\n          newCutStrokesMap[drawing.drawingId] = replacementSegments;\n\n          insideSegs.forEach(([s, e]) => {\n            // Preserve all metadata from original drawing\n            const metadata = {\n              brushStyle: drawing.brushStyle,\n              brushType: drawing.brushType,\n              brushParams: drawing.brushParams,\n              drawingType: drawing.drawingType,\n              stampData: drawing.stampData,\n              stampSettings: drawing.stampSettings,\n              filterType: drawing.filterType,\n              filterParams: drawing.filterParams,\n            };\n            const cutSeg = new Drawing(\n              generateId(),\n              drawing.color,\n              drawing.lineWidth,\n              { tool: \"shape\", type: \"line\", start: s, end: e },\n              Date.now(),\n              drawing.user,\n              metadata\n            );\n            newCutDrawings.push(cutSeg);\n\n            const eraseSeg = new Drawing(\n              generateId(),\n              \"#ffffff\",\n              drawing.lineWidth + 4,\n              { tool: \"shape\", type: \"line\", start: s, end: e },\n              Date.now(),\n              drawing.user\n            );\n            eraseInsideSegmentsNew.push(eraseSeg);\n          });\n        }\n      } else {\n        updatedDrawings.push(drawing);\n      }\n    });\n\n    setCutImageData(newCutDrawings);\n    setCutOriginalIds(newCutOriginalIds);\n    setCutStrokesMap(newCutStrokesMap);\n    const allReplacementSegments = Object.values(newCutStrokesMap).flat();\n    const replacementSegmentIds = allReplacementSegments.map(seg => seg.drawingId);\n\n    let savedSegmentCount = 0;\n    for (const segment of allReplacementSegments) {\n      try {\n        await submitToDatabase(segment, auth, { roomId: currentRoomId, roomType, skipUndoCheck: true, skipUndoStack: true }, setUndoAvailable, setRedoAvailable);\n        savedSegmentCount++;\n\n        if (showLocalSnack && allReplacementSegments.length > 0) {\n          showLocalSnack(`Saving cut segments... ${savedSegmentCount}/${allReplacementSegments.length} saved.`);\n        }\n      } catch (error) {\n        console.error(\"Failed to submit replacement segment:\", segment, error);\n      }\n    }\n\n    userData.drawings = updatedDrawings;\n\n    const cutRecord = new Drawing(\n      generateId(),\n      \"#FFFFFF\",\n      1,\n      {\n        tool: \"cut\",\n        rect: cutRect,\n        cut: true,\n        originalStrokeIds: Array.from(newCutOriginalIds),\n        replacementSegmentIds: replacementSegmentIds  // Track replacement segments for undo\n      },\n      Date.now(),\n      currentUser\n    );\n\n    userData.addDrawing(cutRecord);\n    await submitToDatabase(cutRecord, auth, { roomId: currentRoomId, roomType }, setUndoAvailable, setRedoAvailable);\n    drawAllDrawings();\n\n    // Only 1 backend undo operation: the cut record itself\n    const backendCount = 1;\n\n    const compositeCutAction = {\n      type: 'cut',\n      cutRecord: cutRecord,\n      eraseStrokes: eraseInsideSegmentsNew,\n      affectedDrawings: affectedDrawings,\n      replacementSegments: newCutStrokesMap,\n      backendCount: backendCount\n    };\n\n    return { updatedDrawings, compositeCutAction };\n  };\n\n  return {\n    selectionStart, setSelectionStart,\n    selectionRect, setSelectionRect,\n    cutImageData, setCutImageData,\n    handleCutSelection,\n  };\n};\n","import React, { useRef, useState, useEffect } from \"react\";\nimport \"../styles/Canvas.css\";\nimport {\n  Box,\n  Fade,\n  Paper,\n  Button,\n  Dialog,\n  DialogActions,\n  DialogContent,\n  DialogContentText,\n  DialogTitle,\n  IconButton,\n  TextField,\n  Typography,\n  CircularProgress,\n} from '@mui/material';\nimport SafeSnackbar from './SafeSnackbar';\nimport ResilientDBWarningBanner from './ResilientDBWarningBanner';\nimport { startMonitoring, stopMonitoring, onHealthChange } from '../services/resilientDBMonitor';\nimport CommandPalette from './CommandPalette';\nimport KeyboardShortcutsHelp from './KeyboardShortcutsHelp';\nimport { KeyboardShortcutManager } from '../services/KeyboardShortcuts';\nimport { commandRegistry } from '../services/CommandRegistry';\nimport { DEFAULT_SHORTCUTS } from '../config/shortcuts';\nimport ChevronLeftIcon from '@mui/icons-material/ChevronLeft';\nimport ChevronRightIcon from '@mui/icons-material/ChevronRight';\nimport Toolbar from './Toolbar';\nimport { useCanvasSelection } from '../hooks/useCanvasSelection';\nimport InfoOutlinedIcon from '@mui/icons-material/InfoOutlined';\nimport useBrushEngine from \"../hooks/useBrushEngine\";\nimport {\n  submitToDatabase,\n  submitBatchToDatabase,\n  refreshCanvas as backendRefreshCanvas,\n  clearBackendCanvas,\n  undoAction,\n  redoAction,\n  checkUndoRedoAvailability,\n  restoreUndoRedoStacks\n} from '../services/canvasBackendJWT';\nimport { Drawing } from '../lib/drawing';\nimport { getSocket, setSocketToken } from '../services/socket';\nimport { handleAuthError } from '../utils/authUtils';\nimport { getUsername } from '../utils/getUsername';\nimport { getAuthUser } from '../utils/getAuthUser';\nimport { resetMyStacks } from '../api/rooms';\nimport { TEMPLATE_LIBRARY } from '../data/templates';\n\nclass UserData {\n  constructor(userId, username) {\n    this.userId = userId;\n    this.username = username;\n    this.drawings = [];\n  }\n\n  addDrawing(drawing) {\n    this.drawings.push(drawing);\n  }\n\n  clearDrawings() {\n    this.drawings = [];\n  }\n}\n\nconst DEFAULT_CANVAS_WIDTH = 3000;\nconst DEFAULT_CANVAS_HEIGHT = 2000;\n\nfunction Canvas({\n  auth,\n  setUserList,\n  selectedUser,\n  setSelectedUser,\n  currentRoomId,\n  canvasRefreshTrigger = 0,\n  currentRoomName = \"Master (not in a room)\",\n  onExitRoom = () => { },\n  onOpenSettings = null,\n  viewOnly = false,\n  isOwner = false,\n  roomType = \"public\",\n  walletConnected = false,\n  templateId = null,\n}) {\n  const canvasRef = useRef(null);\n  const snapshotRef = useRef(null);\n  const tempPathRef = useRef([]);\n  const clamp = (value, min, max) => Math.min(max, Math.max(min, value));\n\n  const currentUserRef = useRef(null);\n  if (currentUserRef.current === null) {\n    try {\n      const uname =\n        getUsername(auth) ||\n        `anon_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n      currentUserRef.current = `${uname}|${Date.now()}`;\n    } catch (e) {\n      currentUserRef.current = `anon_${Date.now()}_${Math.random()\n        .toString(36)\n        .substr(2, 5)}`;\n    }\n  }\n  const currentUser = currentUserRef.current;\n\n  const [drawing, setDrawing] = useState(false);\n  const [color, setColor] = useState(\"#000000\");\n  const [lineWidth, setLineWidth] = useState(5);\n  const [drawMode, setDrawMode] = useState(\"freehand\");\n  const [shapeType, setShapeType] = useState(\"circle\");\n  const [brushStyle] = useState(\"round\");\n  const [shapeStart, setShapeStart] = useState(null);\n\n  const brushEngine = useBrushEngine();\n  const [currentBrushType, setCurrentBrushType] = useState(\"normal\");\n  const [brushParams, setBrushParams] = useState({});\n  const [selectedStamp, setSelectedStamp] = useState(null);\n  const [stampSettings, setStampSettings] = useState({\n    size: 50,\n    rotation: 0,\n    opacity: 100,\n  });\n  const [backendStamps, setBackendStamps] = useState([]);\n  const [stampPreview, setStampPreview] = useState(null); // { x, y, stamp, settings }\n  const stampPreviewRef = useRef(null);\n  const [activeFilter, setActiveFilter] = useState(null);\n  const [filterParams, setFilterParams] = useState({});\n  const [isFilterPreview, setIsFilterPreview] = useState(false);\n  const filterCanvasRef = useRef(null);\n  const originalCanvasDataRef = useRef(null); // For preview mode undo\n  const preFilterCanvasStateRef = useRef(null);\n\n  const [showColorPicker, setShowColorPicker] = useState(false);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const [previousColor, setPreviousColor] = useState(null);\n  const [clearDialogOpen, setClearDialogOpen] = useState(false);\n  const [undoStack, setUndoStack] = useState([]);\n  const [redoStack, setRedoStack] = useState([]);\n  const [undoAvailable, setUndoAvailable] = useState(false);\n  const [redoAvailable, setRedoAvailable] = useState(false);\n  const [hasFilters, setHasFilters] = useState(false); // Track if filters exist for UI updates\n\n  const [templateObjects, setTemplateObjects] = useState([]);\n  const templateObjectsRef = useRef([]);\n\n  useEffect(() => {\n    templateObjectsRef.current = templateObjects;\n  }, [templateObjects]);\n\n  const canvasWidth = DEFAULT_CANVAS_WIDTH;\n  const canvasHeight = DEFAULT_CANVAS_HEIGHT;\n\n  const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });\n  const [isPanning, setIsPanning] = useState(false);\n  const panStartRef = useRef({ x: 0, y: 0 });\n  const panOriginRef = useRef({ x: 0, y: 0 });\n  const PAN_REFRESH_COOLDOWN_MS = 2000;\n  const panLastRefreshRef = useRef(0);\n  const panRefreshSkippedRef = useRef(false);\n  const panEndRefreshTimerRef = useRef(null);\n  const pendingPanRefreshRef = useRef(false);\n  const [pendingDrawings, setPendingDrawings] = useState([]);\n  const refreshTimerRef = useRef(null);\n  const submissionQueueRef = useRef([]);\n  const isSubmittingRef = useRef(false);\n  const confirmedStrokesRef = useRef(new Set());\n  const lastDrawnStateRef = useRef(null); // Track last drawn state to avoid redundant redraws\n  const isDrawingInProgressRef = useRef(false); // Prevent concurrent drawing operations\n  const offscreenCanvasRef = useRef(null); // Offscreen canvas for flicker free rendering\n  const cachedCanvasRef = useRef(null); // Cached canvas for incremental rendering\n  const cachedDrawingIdsRef = useRef(new Set()); // Track which drawings are in the cache\n  const forceNextRedrawRef = useRef(false); // Force next redraw even if signature matches for undo redo\n  const templateCanvasRef = useRef(null);\n  const cachedTemplateIdRef = useRef(null);\n  const [historyMode, setHistoryMode] = useState(false);\n  const [historyRange, setHistoryRange] = useState(null); // {start, end} in epoch ms\n  const [historyDialogOpen, setHistoryDialogOpen] = useState(false);\n  const [historyStartInput, setHistoryStartInput] = useState(\"\");\n  const [historyEndInput, setHistoryEndInput] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const [localSnack, setLocalSnack] = useState({\n    open: false,\n    message: \"\",\n    duration: 4000,\n  });\n  const [confirmDestructiveOpen, setConfirmDestructiveOpen] = useState(false);\n  const [destructiveConfirmText, setDestructiveConfirmText] = useState(\"\");\n  const showLocalSnack = (msg, duration = 4000) =>\n    setLocalSnack({ open: true, message: String(msg), duration });\n\n  // editingEnabled controls whether the user can perform mutating actions.\n  // When historyMode is active, a specific user is selected for replay, or\n  // when viewOnly is true (room is archived or user is a viewer), editing\n  // should be disabled.\n  // For secure rooms, wallet must be connected to allow editing.\n  const editingEnabled = !(\n    historyMode ||\n    (selectedUser && selectedUser !== \"\") ||\n    viewOnly ||\n    (roomType === \"secure\" && !walletConnected)\n  );\n  const closeLocalSnack = () =>\n    setLocalSnack({ open: false, message: \"\", duration: 4000 });\n\n  // Keyboard shortcuts state\n  const [commandPaletteOpen, setCommandPaletteOpen] = useState(false);\n  const [shortcutsHelpOpen, setShortcutsHelpOpen] = useState(false);\n  const shortcutManagerRef = useRef(null);\n\n  // ResilientDB health monitoring state\n  const [resilientDBHealthy, setResilientDBHealthy] = useState(true);\n  const [resilientDBQueueSize, setResilientDBQueueSize] = useState(0);\n\n  const roomUiRef = useRef({});\n  const previousSelectedUserRef = useRef(null); // Track previous selectedUser to detect changes\n  const isRefreshingSelectedUserRef = useRef(false); // Prevent concurrent refreshes\n  const selectedUserRefreshQueueRef = useRef(null); // Queue the next refresh target\n  const selectedUserAbortControllerRef = useRef(null); // Cancel pending operations\n  const roomStacksRef = useRef({});\n  const roomClipboardRef = useRef({});\n  const roomClearedAtRef = useRef({});\n  const drawAllDrawingsRef = useRef(null); // Store reference to drawAllDrawings function\n\n  useEffect(() => {\n    if (!currentRoomId) return;\n    const ui =\n      roomUiRef.current[currentRoomId] ||\n      JSON.parse(\n        localStorage.getItem(`rescanvas:toolbar:${currentRoomId}`) || \"null\"\n      ) ||\n      {};\n    if (ui.color) setColor(ui.color);\n    if (ui.lineWidth) setLineWidth(ui.lineWidth);\n    if (ui.drawMode) setDrawMode(ui.drawMode);\n    if (ui.shapeType) setShapeType(ui.shapeType);\n    if (ui.previousColor !== undefined) setPreviousColor(ui.previousColor);\n    if (ui.selectedStamp) setSelectedStamp(ui.selectedStamp);\n    if (ui.stampSettings) setStampSettings(ui.stampSettings);\n    if (ui.currentBrushType) {\n      setCurrentBrushType(ui.currentBrushType);\n      brushEngine.setBrushType(ui.currentBrushType);\n    }\n    if (ui.brushParams) {\n      setBrushParams(ui.brushParams);\n      brushEngine.setBrushParams(ui.brushParams);\n    }\n    roomUiRef.current[currentRoomId] = {\n      color: ui.color ?? color,\n      lineWidth: ui.lineWidth ?? lineWidth,\n      drawMode: ui.drawMode ?? drawMode,\n      shapeType: ui.shapeType ?? shapeType,\n      previousColor: ui.previousColor ?? previousColor,\n      selectedStamp: ui.selectedStamp ?? selectedStamp,\n      stampSettings: ui.stampSettings ?? stampSettings,\n      currentBrushType: ui.currentBrushType ?? currentBrushType,\n      brushParams: ui.brushParams ?? brushParams,\n    };\n    const stacks = roomStacksRef.current[currentRoomId] || {\n      undo: [],\n      redo: [],\n    };\n    setUndoStack(stacks.undo);\n    setRedoStack(stacks.redo);\n    const clip = roomClipboardRef.current[currentRoomId] || null;\n    if (setCutImageData) setCutImageData(clip);\n  }, [currentRoomId]);\n\n  // Load template objects when templateId changes\n  useEffect(() => {\n\n    if (!templateId) {\n      setTemplateObjects([]);\n      templateCanvasRef.current = null;\n      cachedTemplateIdRef.current = null;\n      return;\n    }\n\n    const template = TEMPLATE_LIBRARY.find(t => t.id === templateId);\n\n    if (template && template.canvas && template.canvas.objects) {\n      setTemplateObjects(template.canvas.objects);\n      templateCanvasRef.current = null;\n      cachedTemplateIdRef.current = null;\n    } else {\n      setTemplateObjects([]);\n      templateCanvasRef.current = null;\n      cachedTemplateIdRef.current = null;\n    }\n  }, [templateId, currentRoomId]);\n\n  // Force redraw whenever templateObjects change (ensures templates appear immediately)\n  useEffect(() => {\n    if (!templateObjects || templateObjects.length === 0) return;\n\n    const timer = setTimeout(() => {\n      if (drawAllDrawingsRef.current) {\n        lastDrawnStateRef.current = null; // Force redraw by clearing cache\n        drawAllDrawingsRef.current();\n      } else {\n        console.warn('drawAllDrawingsRef not ready yet');\n      }\n    }, 100);\n\n    return () => clearTimeout(timer);\n  }, [templateObjects]);\n\n  // ResilientDB health monitoring\n  useEffect(() => {\n    startMonitoring();\n    \n    const unsubscribe = onHealthChange(({ isHealthy, queueSize }) => {\n      setResilientDBHealthy(isHealthy);\n      setResilientDBQueueSize(queueSize || 0);\n      if (!isHealthy) {\n        console.warn(`[Canvas] ResilientDB is down - ${queueSize} strokes queued for sync`);\n      } else {\n        console.log('[Canvas] ResilientDB is healthy - blockchain persistence active');\n      }\n    });\n    \n    return () => {\n      stopMonitoring();\n      unsubscribe();\n    };\n  }, []);\n\n  useEffect(() => {\n    if (!currentRoomId) return;\n    const ui = { color, lineWidth, drawMode, shapeType, previousColor, selectedStamp, stampSettings, currentBrushType, brushParams };\n    roomUiRef.current[currentRoomId] = ui;\n    try {\n      localStorage.setItem(\n        `rescanvas:toolbar:${currentRoomId}`,\n        JSON.stringify(ui)\n      );\n    } catch { }\n  }, [currentRoomId, color, lineWidth, drawMode, shapeType, previousColor, selectedStamp, stampSettings, currentBrushType, brushParams]);\n\n  useEffect(() => {\n    if (!currentRoomId) return;\n    const cur = roomStacksRef.current[currentRoomId] || { undo: [], redo: [] };\n    cur.undo = undoStack;\n    roomStacksRef.current[currentRoomId] = cur;\n  }, [currentRoomId, undoStack]);\n  useEffect(() => {\n    if (!currentRoomId) return;\n    const cur = roomStacksRef.current[currentRoomId] || { undo: [], redo: [] };\n    cur.redo = redoStack;\n    roomStacksRef.current[currentRoomId] = cur;\n  }, [currentRoomId, redoStack]);\n\n  useEffect(() => {\n    const handleMouseUp = () => {\n      setIsPanning(false);\n      panOriginRef.current = { ...panOffset };\n      try {\n        if (panEndRefreshTimerRef.current) {\n          clearTimeout(panEndRefreshTimerRef.current);\n          panEndRefreshTimerRef.current = null;\n        }\n        if (panRefreshSkippedRef.current) {\n          panRefreshSkippedRef.current = false;\n          mergedRefreshCanvas(\"pan-mouseup-skipped\").finally(() => {\n            try {\n              setIsLoading(false);\n            } catch (e) { }\n          });\n        }\n        if (pendingPanRefreshRef.current) {\n          pendingPanRefreshRef.current = false;\n          mergedRefreshCanvas(\"pan-mouseup-pending\").finally(() => {\n            try {\n              setIsLoading(false);\n            } catch (e) { }\n          });\n        }\n      } catch (e) { }\n    };\n    document.addEventListener(\"mouseup\", handleMouseUp);\n    return () => document.removeEventListener(\"mouseup\", handleMouseUp);\n  }, [panOffset]);\n\n  // Process submission queue to ensure strokes are submitted sequentially\n  const processSubmissionQueue = async () => {\n    if (isSubmittingRef.current || submissionQueueRef.current.length === 0) {\n      return;\n    }\n\n    isSubmittingRef.current = true;\n\n    while (submissionQueueRef.current.length > 0) {\n      const submission = submissionQueueRef.current.shift();\n      try {\n        await submission();\n      } catch (error) {\n        console.error(\"Error processing queued submission:\", error);\n      }\n    }\n\n    isSubmittingRef.current = false;\n\n    // After processing all queued submissions, schedule a refresh to sync with backend\n    if (refreshTimerRef.current) clearTimeout(refreshTimerRef.current);\n    refreshTimerRef.current = setTimeout(() => {\n      mergedRefreshCanvas(\"post-queue\").catch((e) =>\n        console.error(\"Error during post-queue refresh:\", e)\n      );\n      refreshTimerRef.current = null;\n    }, 500);\n  };\n\n  useEffect(() => {\n    if (!auth?.token || !currentRoomId) return;\n    try {\n      setSocketToken(auth.token);\n    } catch (e) { }\n\n    const socket = getSocket(auth.token);\n\n    try {\n      socket.emit(\"join_room\", { roomId: currentRoomId, token: auth?.token });\n    } catch (e) {\n      socket.emit(\"join_room\", { roomId: currentRoomId });\n    }\n\n    const scheduleRefresh = (delay = 300) => {\n      try {\n        if (refreshTimerRef.current) clearTimeout(refreshTimerRef.current);\n      } catch (e) { }\n      refreshTimerRef.current = setTimeout(() => {\n        mergedRefreshCanvas().catch((e) =>\n          console.error(\"Error during scheduled refresh:\", e)\n        );\n        refreshTimerRef.current = null;\n      }, delay);\n    };\n\n    const strokeBatch = [];\n    let batchTimer = null;\n\n    const flushStrokeBatch = () => {\n      if (strokeBatch.length === 0) return;\n\n      const batch = [...strokeBatch];\n      strokeBatch.length = 0;\n\n      setPendingDrawings((prev) => [...prev, ...batch]);\n\n      requestAnimationFrame(() => {\n        drawAllDrawings();\n      });\n\n      scheduleRefresh(350);\n    };\n\n    const handleNewStroke = (data) => {\n      try {\n        const myName = getUsername(auth);\n        if (data.user === myName) {\n          // This is confirmation of our own stroke\n          const stroke = data.stroke;\n          if (stroke && stroke.drawingId) {\n            confirmedStrokesRef.current.add(stroke.drawingId);\n          }\n          return;\n        }\n      } catch (e) {\n        try {\n          const user = getAuthUser(auth) || {};\n          if (data.user === user.username) {\n            // This is confirmation of our own stroke\n            const stroke = data.stroke;\n            if (stroke && stroke.drawingId) {\n              confirmedStrokesRef.current.add(stroke.drawingId);\n            }\n            return;\n          }\n        } catch (e2) { }\n      }\n\n      const stroke = data.stroke;\n\n      // Extract metadata for advanced features (stamps, brushes, filters)\n      const metadata = {\n        brushStyle: stroke.brushStyle,\n        brushType: stroke.brushType,\n        brushParams: stroke.brushParams,\n        drawingType: stroke.drawingType,\n        stampData: stroke.stampData,\n        stampSettings: stroke.stampSettings,\n        filterType: stroke.filterType,\n        filterParams: stroke.filterParams,\n      };\n\n      const drawing = new Drawing(\n        stroke.drawingId ||\n        `remote_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,\n        stroke.color || \"#000000\",\n        stroke.lineWidth || 5,\n        stroke.pathData || [],\n        stroke.ts || stroke.timestamp || Date.now(),\n        stroke.user || \"Unknown\",\n        metadata\n      );\n\n      try {\n        const clearedAt = roomClearedAtRef.current[currentRoomId];\n        if (\n          clearedAt &&\n          (drawing.timestamp || drawing.ts || Date.now()) < clearedAt\n        ) {\n          return;\n        }\n      } catch (e) { }\n\n      strokeBatch.push(drawing);\n\n      if (drawing.drawingType === \"stamp\" && drawing.stampData && drawing.stampData.image) {\n        setBackendStamps((prevStamps) => {\n          const imageKey = drawing.stampData.image.substring(0, 100);\n          const alreadyExists = prevStamps.some(s =>\n            s.image && s.image.substring(0, 100) === imageKey\n          );\n\n          if (!alreadyExists) {\n            console.log('Adding new custom stamp from Socket.IO:', drawing.stampData.name || 'Custom Stamp');\n            return [...prevStamps, {\n              id: `stamp-${Date.now()}-${prevStamps.length}`,\n              name: drawing.stampData.name || 'Custom Stamp',\n              category: drawing.stampData.category || 'custom',\n              image: drawing.stampData.image,\n              emoji: drawing.stampData.emoji\n            }];\n          }\n          return prevStamps;\n        });\n      }\n\n      clearTimeout(batchTimer);\n      batchTimer = setTimeout(flushStrokeBatch, 50);\n    };\n\n    const handleUserJoined = (data) => {\n      try {\n        if (!data) return;\n        if (data.roomId !== currentRoomId) return;\n        console.debug(\"socket user_joined event\", data);\n        if (data.username) {\n          showLocalSnack(`${data.username} joined the canvas.`);\n        }\n      } catch (e) { }\n    };\n\n    const handleUserLeft = (data) => {\n      try {\n        if (!data) return;\n        if (data.roomId !== currentRoomId) return;\n        console.debug(\"socket user_left event\", data);\n        if (data.username) {\n          showLocalSnack(`${data.username} left the canvas.`);\n        }\n      } catch (e) { }\n    };\n\n    const handleStrokeUndone = (data) => {\n      console.log(\"Stroke undone event received:\", data);\n\n      forceNextRedrawRef.current = true;\n      lastDrawnStateRef.current = null;\n\n      // Schedule refresh instead of immediate refresh to avoid flicker\n      if (refreshTimerRef.current) clearTimeout(refreshTimerRef.current);\n      refreshTimerRef.current = setTimeout(() => {\n        mergedRefreshCanvas(\"undo-event\");\n        refreshTimerRef.current = null;\n      }, 100);\n\n      if (currentRoomId) {\n        checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      }\n    };\n\n    const handleCanvasCleared = (data) => {\n      console.log(\"Canvas cleared event received:\", data);\n      const clearedAt = data && data.clearedAt ? data.clearedAt : Date.now();\n      if (currentRoomId) roomClearedAtRef.current[currentRoomId] = clearedAt;\n\n      // Clear local authoritative drawings and pending drawings that predate the clear\n      try {\n        userData.clearDrawings();\n      } catch (e) { }\n      setPendingDrawings([]);\n      serverCountRef.current = 0;\n\n      setUndoStack([]);\n      setRedoStack([]);\n      setUndoAvailable(false);\n      setRedoAvailable(false);\n      try {\n        if (currentRoomId) {\n          roomStacksRef.current[currentRoomId] = { undo: [], redo: [] };\n          roomClipboardRef.current[currentRoomId] = null;\n        }\n      } catch (e) { }\n\n      clearCanvasForRefresh();\n      drawAllDrawings();\n\n      if (currentRoomId) {\n        checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      }\n    };\n\n    socket.on(\"new_stroke\", handleNewStroke);\n    socket.on(\"stroke_undone\", handleStrokeUndone);\n    socket.on(\"canvas_cleared\", handleCanvasCleared);\n    socket.on(\"user_joined\", handleUserJoined);\n    socket.on(\"user_left\", handleUserLeft);\n    socket.on(\"user_joined_debug\", (d) => {\n      console.debug(\"socket user_joined_debug\", d);\n    });\n\n    return () => {\n      socket.off(\"new_stroke\", handleNewStroke);\n      socket.off(\"stroke_undone\", handleStrokeUndone);\n      socket.off(\"canvas_cleared\", handleCanvasCleared);\n      socket.off(\"user_joined\", handleUserJoined);\n      socket.off(\"user_left\", handleUserLeft);\n      try {\n        socket.emit(\"leave_room\", {\n          roomId: currentRoomId,\n          token: auth?.token,\n        });\n      } catch (e) {\n        socket.emit(\"leave_room\", { roomId: currentRoomId });\n      }\n      try {\n        if (refreshTimerRef.current) clearTimeout(refreshTimerRef.current);\n      } catch (e) { }\n      try {\n        if (batchTimer) clearTimeout(batchTimer);\n      } catch (e) { }\n    };\n  }, [auth?.token, currentRoomId, auth?.user?.username]);\n\n  useEffect(() => {\n    (async () => {\n      try {\n        setUndoStack([]);\n        setRedoStack([]);\n        setUndoAvailable(false);\n        setRedoAvailable(false);\n        if (currentRoomId) {\n          roomStacksRef.current[currentRoomId] = { undo: [], redo: [] };\n        }\n\n        // Reset selectedUser tracking when room changes\n        previousSelectedUserRef.current = null;\n        isRefreshingSelectedUserRef.current = false;\n        selectedUserRefreshQueueRef.current = null;\n\n        if (auth?.token && currentRoomId) {\n          try {\n            await resetMyStacks(auth.token, currentRoomId);\n          } catch (e) { }\n          \n          // Restore undo/redo stacks from backend after page refresh\n          try {\n            const stacks = await restoreUndoRedoStacks(\n              auth,\n              currentRoomId,\n              setUndoStack,\n              setRedoStack,\n              setUndoAvailable,\n              setRedoAvailable\n            );\n            \n            // Update room stacks ref for room switching\n            if (currentRoomId && stacks) {\n              roomStacksRef.current[currentRoomId] = {\n                undo: stacks.undo || [],\n                redo: stacks.redo || []\n              };\n            }\n            \n            console.log(`Restored stacks for room ${currentRoomId}:`, {\n              undoCount: stacks.undo?.length || 0,\n              redoCount: stacks.redo?.length || 0\n            });\n          } catch (e) {\n            console.warn(\"Failed to restore undo/redo stacks:\", e);\n            // Fallback to just checking availability\n            try {\n              await checkUndoRedoAvailability(\n                auth,\n                setUndoAvailable,\n                setRedoAvailable,\n                currentRoomId\n              );\n            } catch (e2) { }\n          }\n        }\n      } catch (e) { }\n    })();\n  }, [auth?.token, currentRoomId]);\n\n  // Force full refresh when selectedUser changes (drawing history selection/deselection)\n  useEffect(() => {\n    if (!currentRoomId || !auth?.token) return;\n\n    // Serialize selectedUser for comparison (handles both string and object)\n    const serializeSelectedUser = (user) => {\n      if (!user || user === \"\") return \"\";\n      if (typeof user === \"string\") return user;\n      if (typeof user === \"object\")\n        return JSON.stringify({\n          user: user.user,\n          periodStart: user.periodStart,\n        });\n      return String(user);\n    };\n\n    const currentSerialized = serializeSelectedUser(selectedUser);\n    const previousSerialized = previousSelectedUserRef.current;\n\n    // Only refresh if selectedUser actually changed\n    if (currentSerialized === previousSerialized) {\n      return;\n    }\n\n    // If a refresh is in progress, queue this change for execution after current one completes\n    if (isRefreshingSelectedUserRef.current) {\n      console.debug(\n        \"[selectedUser] Refresh in progress, queuing new selection:\",\n        currentSerialized\n      );\n      selectedUserRefreshQueueRef.current = currentSerialized;\n      return;\n    }\n\n    const performRefresh = async (targetSerialized) => {\n      isRefreshingSelectedUserRef.current = true;\n\n      try {\n        setIsLoading(true);\n\n        // Update the ref to mark this as the last processed value\n        previousSelectedUserRef.current = targetSerialized;\n\n        // Force complete refresh from backend\n        userData.drawings = [];\n        setPendingDrawings([]);\n        serverCountRef.current = 0;\n        lastDrawnStateRef.current = null;\n\n        const isDeselect = !selectedUser || selectedUser === \"\";\n        const logLabel = isDeselect\n          ? \"selectedUser-deselect\"\n          : \"selectedUser-select\";\n        console.debug(`[selectedUser] Performing full refresh: ${logLabel}`, {\n          to: targetSerialized,\n        });\n\n        await clearCanvasForRefresh();\n        await mergedRefreshCanvas(logLabel);\n        await drawAllDrawings();\n      } catch (error) {\n        console.error(\"Error refreshing on selectedUser change:\", error);\n      } finally {\n        setIsLoading(false);\n        isRefreshingSelectedUserRef.current = false;\n\n        // Check if there's a queued refresh waiting\n        if (selectedUserRefreshQueueRef.current !== null) {\n          const queuedTarget = selectedUserRefreshQueueRef.current;\n          selectedUserRefreshQueueRef.current = null;\n\n          // Only process queued refresh if it's different from what we just processed\n          if (queuedTarget !== targetSerialized) {\n            console.debug(\n              \"[selectedUser] Processing queued selection:\",\n              queuedTarget\n            );\n            // Use setTimeout to break out of the current call stack\n            setTimeout(() => performRefresh(queuedTarget), 0);\n          }\n        }\n      }\n    };\n\n    // Start the refresh\n    performRefresh(currentSerialized);\n  }, [selectedUser, currentRoomId]);\n\n  const clearCanvasForRefresh = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return; // Guard against null ref during tests\n\n    const context = canvas.getContext(\"2d\");\n    if (!context) return; // Guard against null context during tests\n\n    context.clearRect(0, 0, canvasWidth, canvasHeight);\n    setUserData(initializeUserData());\n    setPendingDrawings([]);\n    serverCountRef.current = 0;\n\n    // Clear selection overlay artifacts\n    setSelectionRect(null);\n    setSelectionStart(null);\n\n    // Reset draw mode to freehand if in select mode\n    if (drawMode === \"select\") {\n      setDrawMode(\"freehand\");\n    }\n  };\n\n  const refreshCanvasButtonHandler = async () => {\n    if (isRefreshing) return;\n    setIsRefreshing(true);\n    setIsLoading(true);\n    try {\n      // Force full refresh from backend by clearing local state\n      userData.drawings = [];\n      setPendingDrawings([]);\n      serverCountRef.current = 0;\n      lastDrawnStateRef.current = null;\n\n      await clearCanvasForRefresh();\n      await mergedRefreshCanvas(\"refresh-button\");\n      await drawAllDrawings();\n      updateFilterState(); // Update filter state after refresh\n    } catch (error) {\n      console.error(\"Error during canvas refresh:\", error);\n      handleAuthError(error);\n    } finally {\n      setIsRefreshing(false);\n      setIsLoading(false);\n    }\n  };\n\n  const initializeUserData = () => {\n    const uniqueUserId =\n      auth?.user?.id ||\n      `user_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n    const username = auth?.user?.username || \"MainUser\";\n    return new UserData(uniqueUserId, username);\n  };\n  const [userData, setUserData] = useState(() => initializeUserData());\n  const generateId = () =>\n    `drawing_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;\n  const serverCountRef = useRef(0);\n\n  // Helper function to update filter state\n  const updateFilterState = () => {\n    // Use setUserData callback to read current state accurately\n    setUserData((currentUserData) => {\n      const filterExists = currentUserData.drawings.some((d) => d.drawingType === \"filter\");\n      const filterCount = currentUserData.drawings.filter((d) => d.drawingType === \"filter\").length;\n      console.log(`[updateFilterState] filterExists=${filterExists}, filterCount=${filterCount}`);\n      setHasFilters(filterExists);\n      return currentUserData;\n    });\n  };\n\n  // Advanced Brush/Stamp/Filter Functions\n  const handleBrushSelect = (brushType) => {\n    console.log(\"handleBrushSelect called with:\", brushType);\n    setCurrentBrushType(brushType);\n    brushEngine.setBrushType(brushType);\n    setDrawMode(\"freehand\");\n    console.log(\"Current brush type set to:\", brushType);\n  };\n\n  const handleBrushParamsChange = (params) => {\n    setBrushParams(params);\n    brushEngine.setBrushParams(params);\n  };\n\n  const placeStamp = async (x, y, stamp, settings) => {\n    const canvas = canvasRef.current;\n    if (!canvas || !stamp) return;\n\n    const context = canvas.getContext(\"2d\");\n\n    // Render stamp immediately using proper context management\n    if (stamp.emoji) {\n      context.save();\n      context.globalAlpha = settings.opacity / 100;\n      context.translate(x, y);\n      context.rotate((settings.rotation * Math.PI) / 180);\n\n      const size = settings.size;\n      context.font = `${size}px serif`;\n      context.textAlign = \"center\";\n      context.textBaseline = \"middle\";\n      context.fillText(stamp.emoji, 0, 0);\n\n      context.restore();\n    } else if (stamp.image) {\n      // For image stamps, load and render synchronously using async/await\n      try {\n        const img = await new Promise((resolve, reject) => {\n          const image = new Image();\n          image.onload = () => resolve(image);\n          image.onerror = () => reject(new Error(\"Failed to load image\"));\n          image.src = stamp.image;\n        });\n\n        context.save();\n        context.globalAlpha = settings.opacity / 100;\n        context.translate(x, y);\n        context.rotate((settings.rotation * Math.PI) / 180);\n\n        const size = settings.size;\n        context.drawImage(img, -size / 2, -size / 2, size, size);\n\n        context.restore();\n      } catch (error) {\n        console.error(\"Failed to load stamp image:\", stamp.image?.substring(0, 100), error);\n      }\n    }\n\n    // Create drawing record for stamp\n    const stampDrawing = new Drawing(\n      generateId(),\n      color,\n      lineWidth,\n      [{ x, y }],\n      Date.now(),\n      currentUser,\n      {\n        drawingType: \"stamp\",\n        stampData: stamp,\n        stampSettings: settings,\n      }\n    );\n\n    stampDrawing.roomId = currentRoomId;\n\n    userData.addDrawing(stampDrawing);\n    setPendingDrawings((prev) => [...prev, stampDrawing]);\n\n    // Add to undo stack\n    setUndoStack((prev) => [...prev, stampDrawing]);\n    setRedoStack([]);\n\n    // Use submission queue to ensure stamps are submitted in order\n    try {\n      const submitTask = async () => {\n        try {\n          console.log(\"Submitting queued stamp:\", {\n            drawingId: stampDrawing.drawingId,\n            stampData: stampDrawing.stampData,\n          });\n\n          await submitToDatabase(\n            stampDrawing,\n            auth,\n            { roomId: currentRoomId, roomType },\n            setUndoAvailable,\n            setRedoAvailable\n          );\n\n          console.log(\"Stamp submitted successfully:\", stampDrawing.drawingId);\n\n          // Mark stamp as confirmed\n          confirmedStrokesRef.current.add(stampDrawing.drawingId);\n\n          if (currentRoomId) {\n            checkUndoRedoAvailability(\n              auth,\n              setUndoAvailable,\n              setRedoAvailable,\n              currentRoomId\n            );\n          }\n        } catch (error) {\n          console.error(\"Error during queued stamp submission:\", error);\n          setPendingDrawings((prev) =>\n            prev.filter((d) => d.drawingId !== stampDrawing.drawingId)\n          );\n          handleAuthError(error);\n          showLocalSnack(\"Failed to save stamp. Please try again.\");\n        }\n      };\n\n      submissionQueueRef.current.push(submitTask);\n      processSubmissionQueue();\n    } catch (error) {\n      console.error(\"Error preparing stamp submission:\", error);\n      handleAuthError(error);\n      showLocalSnack(\"Failed to prepare stamp. Please try again.\");\n    }\n  };\n\n  const handleStampSelect = (stamp, settings) => {\n    setSelectedStamp(stamp);\n    setStampSettings(settings);\n    setDrawMode(\"stamp\");\n  };\n\n  const handleStampChange = (stamp, settings) => {\n    setSelectedStamp(stamp);\n    setStampSettings(settings);\n  };\n\n  const applyFilter = async (filterType, params) => {\n    if (!canvasRef.current) return;\n\n    // Always cancel preview mode first and clean up state\n    if (isFilterPreview) {\n      setIsFilterPreview(false);\n    }\n    preFilterCanvasStateRef.current = null;\n    originalCanvasDataRef.current = null;\n\n    // Check if we already have a filter of this type applied\n    const existingFilterIndex = userData.drawings.findIndex(\n      (d) => d.drawingType === \"filter\" && d.filterType === filterType\n    );\n    \n    let filterDrawing;\n    let isReplacement = existingFilterIndex !== -1;\n    \n    if (isReplacement) {\n      const existingFilter = userData.drawings[existingFilterIndex];\n      existingFilter.filterParams = { ...params }; // Clone params\n      existingFilter.timestamp = Date.now();\n      filterDrawing = existingFilter;\n      \n      // Update React state to reflect the filter parameter change\n      const newUserData = new UserData(userData.userId, userData.username);\n      newUserData.drawings = [...userData.drawings]; // Clone the array to trigger state update\n      setUserData(newUserData);\n      \n      // Force a complete redraw with the updated filter parameters\n      // This will redraw all strokes first, then apply the filter\n      lastDrawnStateRef.current = null;\n      forceNextRedrawRef.current = true;\n      await drawAllDrawings();\n      \n      showLocalSnack(`Updated ${filterType} filter`);\n      updateFilterState();\n      \n      // For filter updates, we need to submit the UPDATE to backend\n      // The backend should handle this as an update, not a new drawing\n      try {\n        await submitToDatabase(\n          filterDrawing,\n          auth,\n          {\n            roomId: currentRoomId,\n            roomType,\n          },\n          setUndoAvailable,\n          setRedoAvailable\n        );\n\n        if (currentRoomId) {\n          checkUndoRedoAvailability(\n            auth,\n            setUndoAvailable,\n            setRedoAvailable,\n            currentRoomId\n          );\n        }\n      } catch (error) {\n        console.error(\"Error submitting filter update:\", error);\n        handleAuthError(error);\n      }\n      \n      return; // Exit early for updates\n    }\n    \n    // Create NEW filter record for new filter type\n    filterDrawing = new Drawing(\n      generateId(),\n      \"#000000\",\n      0,\n      [],\n      Date.now(),\n      currentUser,\n      {\n        drawingType: \"filter\",\n        filterType,\n        filterParams: { ...params }, // Clone params\n      }\n    );\n\n    // Set filter properties directly on the drawing object\n    filterDrawing.drawingType = \"filter\";\n    filterDrawing.filterType = filterType;\n    filterDrawing.filterParams = { ...params };\n    filterDrawing.roomId = currentRoomId;\n\n    userData.addDrawing(filterDrawing);\n    \n    // Update React state so components know about the new filter\n    const newUserData = new UserData(userData.userId, userData.username);\n    newUserData.drawings = [...userData.drawings]; // Clone array with new filter\n    setUserData(newUserData);\n    \n    setPendingDrawings((prev) => [...prev, filterDrawing]);\n\n    setUndoStack((prev) => [...prev, filterDrawing]);\n    setRedoStack([]);\n    \n    // Force complete redraw this will render all strokes THEN apply filter\n    lastDrawnStateRef.current = null;\n    forceNextRedrawRef.current = true;\n    await drawAllDrawings();\n    \n    showLocalSnack(`Applied ${filterType} filter`);\n    updateFilterState();\n\n    try {\n      await submitToDatabase(\n        filterDrawing,\n        auth,\n        {\n          roomId: currentRoomId,\n          roomType,\n        },\n        setUndoAvailable,\n        setRedoAvailable\n      );\n\n      // Check undo/redo availability after filter submission\n      if (currentRoomId) {\n        checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      }\n    } catch (error) {\n      console.error(\"Error submitting filter:\", error);\n      // On error, remove the failed filter from pending\n      setPendingDrawings((prev) =>\n        prev.filter((d) => d.drawingId !== filterDrawing.drawingId)\n      );\n      handleAuthError(error);\n    }\n  };\n\n  const previewFilter = async (filterType, params) => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    // If already in preview mode, first restore to base state\n    if (isFilterPreview && preFilterCanvasStateRef.current) {\n      const img = new Image();\n      img.onload = async () => {\n        const context = canvas.getContext(\"2d\");\n        context.clearRect(0, 0, canvas.width, canvas.height);\n        context.drawImage(img, 0, 0);\n        \n        // Now apply the new preview\n        await applyPreviewFilter(canvas, filterType, params);\n      };\n      img.src = preFilterCanvasStateRef.current;\n      return;\n    }\n\n    // Store the current canvas state before preview (only once)\n    if (!preFilterCanvasStateRef.current) {\n      preFilterCanvasStateRef.current = canvas.toDataURL();\n    }\n\n    await applyPreviewFilter(canvas, filterType, params);\n  };\n\n  const applyPreviewFilter = async (canvas, filterType, params) => {\n    // Check if this filter type already exists in the drawings\n    const existingFilterIndex = userData.drawings.findIndex(\n      (d) => d.drawingType === \"filter\" && d.filterType === filterType\n    );\n    \n    if (existingFilterIndex !== -1) {\n      // Temporarily remove this filter, redraw, then apply preview\n      const originalDrawings = [...userData.drawings];\n      userData.drawings = userData.drawings.filter((d, i) => i !== existingFilterIndex);\n      \n      lastDrawnStateRef.current = null;\n      forceNextRedrawRef.current = true;\n      await drawAllDrawings();\n      \n      // Restore drawings array\n      userData.drawings = originalDrawings;\n    }\n    \n    // Apply the preview filter on top of current canvas\n    const context = canvas.getContext(\"2d\");\n    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);\n    const filteredImageData = applyImageFilter(imageData, filterType, params);\n    context.putImageData(filteredImageData, 0, 0);\n    \n    setIsFilterPreview(true);\n  };\n\n  const undoFilter = async () => {\n    // If in preview mode, restore from saved canvas state\n    if (isFilterPreview && preFilterCanvasStateRef.current) {\n      const canvas = canvasRef.current;\n      if (!canvas) return;\n\n      const context = canvas.getContext(\"2d\");\n      const img = new Image();\n      img.onload = async () => {\n        context.clearRect(0, 0, canvas.width, canvas.height);\n        context.drawImage(img, 0, 0);\n        setIsFilterPreview(false);\n        preFilterCanvasStateRef.current = null;\n        originalCanvasDataRef.current = null;\n      };\n      img.src = preFilterCanvasStateRef.current;\n      return;\n    }\n\n    // If not in preview mode, use regular undo (which properly syncs with backend)\n    if (!editingEnabled) {\n      showLocalSnack(\"Undo is disabled in view-only mode.\");\n      return;\n    }\n\n    if (undoStack.length === 0) {\n      showLocalSnack(\"No actions to undo.\");\n      return;\n    }\n\n    // Simply call the regular undo function, which will undo the last action\n    // This properly coordinates with the backend's undo system\n    await undo();\n  };\n\n  const clearAllFilters = async () => {\n    // Clear preview state if active\n    if (isFilterPreview) {\n      setIsFilterPreview(false);\n      preFilterCanvasStateRef.current = null;\n      originalCanvasDataRef.current = null;\n    }\n\n    if (!editingEnabled) {\n      showLocalSnack(\"Clear filters is disabled in view-only mode.\");\n      return;\n    }\n\n    // Find all filter drawings in userData (not just undo stack)\n    // Use setUserData callback to get the latest state\n    let filterDrawings = [];\n    setUserData((currentUserData) => {\n      const allDrawings = currentUserData.drawings || [];\n      filterDrawings = allDrawings.filter(\n        (drawing) => drawing.drawingType === \"filter\"\n      );\n      console.log(`[clearAllFilters] Found ${filterDrawings.length} filters to clear`, filterDrawings);\n      return currentUserData;\n    });\n\n    if (filterDrawings.length === 0) {\n      showLocalSnack(\"No filters to clear.\");\n      return;\n    }\n\n    if (isRefreshing) {\n      showLocalSnack(\"Please wait for the canvas to refresh.\");\n      return;\n    }\n\n    try {\n      showLocalSnack(`Clearing ${filterDrawings.length} filter(s)...`);\n\n      // Get filter IDs before removing from local state\n      const filterIds = filterDrawings.map(f => f.drawingId).filter(id => id);\n\n      // Remove all filter drawings from local state immediately using proper state update\n      setUserData((currentUserData) => {\n        const newUserData = new UserData(currentUserData.userId, currentUserData.username);\n        newUserData.drawings = currentUserData.drawings.filter(\n          (d) => d.drawingType !== \"filter\"\n        );\n        console.log(`[clearAllFilters] Removed ${filterDrawings.length} filters, ${newUserData.drawings.length} drawings remain`);\n        return newUserData;\n      });\n\n      // Remove from pendingDrawings\n      setPendingDrawings((prev) =>\n        prev.filter((d) => d.drawingType !== \"filter\")\n      );\n\n      // Remove from undo stack (if present)\n      setUndoStack((prev) =>\n        prev.filter((d) => d.drawingType !== \"filter\")\n      );\n\n      // Force a complete redraw immediately to show filters are gone\n      lastDrawnStateRef.current = null;\n      forceNextRedrawRef.current = true;\n      await drawAllDrawings();\n\n      showLocalSnack(`Cleared ${filterDrawings.length} filter(s).`);\n      updateFilterState(); // Update filter state for UI\n\n      // Now sync with backend - create undo markers for each filter\n      if (filterIds.length > 0) {\n        try {\n          // Import the API function\n          const { markStrokesAsUndone } = await import('../api/rooms');\n          \n          try {\n            await markStrokesAsUndone(auth.token, currentRoomId, filterIds);\n            console.log(`Marked ${filterIds.length} filters as undone in backend`);\n          } catch (apiError) {\n            // If the API doesn't exist, fall back to calling undo multiple times\n            console.warn(\"markStrokesAsUndone API not available, using fallback\");\n\n            // Fallback: call regular undo endpoint for each filter\n            const { undoRoomAction } = await import('../api/rooms');\n            for (let i = 0; i < Math.min(filterDrawings.length, 10); i++) {\n              try {\n                const result = await undoRoomAction(auth.token, currentRoomId);\n                if (result.status === \"noop\") break;\n                await new Promise(resolve => setTimeout(resolve, 50));\n              } catch (e) {\n                console.warn(\"Error calling undoRoomAction:\", e);\n                break;\n              }\n            }\n          }\n\n          await checkUndoRedoAvailability(\n            auth,\n            setUndoAvailable,\n            setRedoAvailable,\n            currentRoomId\n          );\n        } catch (e) {\n          console.error(\"Error syncing filter removal with backend:\", e);\n        }\n      }\n    } catch (error) {\n      console.error(\"Error clearing all filters:\", error);\n      showLocalSnack(\"Failed to clear all filters. Refreshing canvas...\");\n      // Refresh to restore state\n      await refreshCanvasButtonHandler();\n    }\n  };\n\n  const applyImageFilter = (imageData, filterType, params) => {\n    const data = imageData.data;\n    const filtered = new ImageData(\n      new Uint8ClampedArray(data),\n      imageData.width,\n      imageData.height\n    );\n\n    switch (filterType) {\n      case \"blur\":\n        return applyBlurFilter(filtered, params.intensity || 5);\n      case \"hueShift\":\n        return applyHueShiftFilter(\n          filtered,\n          params.hue || 0,\n          params.saturation || 0\n        );\n      case \"chalk\":\n        return applyChalkFilter(\n          filtered,\n          params.roughness || 50,\n          params.opacity || 80\n        );\n      case \"fade\":\n        return applyFadeFilter(filtered, params.amount || 30);\n      case \"vintage\":\n        return applyVintageFilter(\n          filtered,\n          params.sepia || 60,\n          params.vignette || 40\n        );\n      case \"neon\":\n        return applyNeonFilter(\n          filtered,\n          params.intensity || 15,\n          params.color || 180\n        );\n      default:\n        return filtered;\n    }\n  };\n\n  const applyBlurFilter = (imageData, intensity) => {\n    // Optimized separable box blur - O(n) instead of O(n)\n    // This is much faster and won't crash even with higher intensity values\n    const data = imageData.data;\n    const width = imageData.width;\n    const height = imageData.height;\n    \n    const radius = Math.max(1, Math.floor(intensity));\n    const temp = new Uint8ClampedArray(data);\n    const result = new Uint8ClampedArray(data);\n\n    // Horizontal pass\n    for (let y = 0; y < height; y++) {\n      let r = 0, g = 0, b = 0, a = 0;\n      let count = 0;\n      \n      // Initialize window\n      for (let x = -radius; x <= radius; x++) {\n        if (x >= 0 && x < width) {\n          const idx = (y * width + x) * 4;\n          r += data[idx];\n          g += data[idx + 1];\n          b += data[idx + 2];\n          a += data[idx + 3];\n          count++;\n        }\n      }\n      \n      // Slide window across row\n      for (let x = 0; x < width; x++) {\n        const idx = (y * width + x) * 4;\n        temp[idx] = r / count;\n        temp[idx + 1] = g / count;\n        temp[idx + 2] = b / count;\n        temp[idx + 3] = a / count;\n        \n        // Remove left pixel\n        const leftX = x - radius;\n        if (leftX >= 0) {\n          const leftIdx = (y * width + leftX) * 4;\n          r -= data[leftIdx];\n          g -= data[leftIdx + 1];\n          b -= data[leftIdx + 2];\n          a -= data[leftIdx + 3];\n          count--;\n        }\n        \n        // Add right pixel\n        const rightX = x + radius + 1;\n        if (rightX < width) {\n          const rightIdx = (y * width + rightX) * 4;\n          r += data[rightIdx];\n          g += data[rightIdx + 1];\n          b += data[rightIdx + 2];\n          a += data[rightIdx + 3];\n          count++;\n        }\n      }\n    }\n\n    // Vertical pass\n    for (let x = 0; x < width; x++) {\n      let r = 0, g = 0, b = 0, a = 0;\n      let count = 0;\n      \n      // Initialize window\n      for (let y = -radius; y <= radius; y++) {\n        if (y >= 0 && y < height) {\n          const idx = (y * width + x) * 4;\n          r += temp[idx];\n          g += temp[idx + 1];\n          b += temp[idx + 2];\n          a += temp[idx + 3];\n          count++;\n        }\n      }\n      \n      // Slide window down column\n      for (let y = 0; y < height; y++) {\n        const idx = (y * width + x) * 4;\n        result[idx] = r / count;\n        result[idx + 1] = g / count;\n        result[idx + 2] = b / count;\n        result[idx + 3] = a / count;\n        \n        // Remove top pixel\n        const topY = y - radius;\n        if (topY >= 0) {\n          const topIdx = (topY * width + x) * 4;\n          r -= temp[topIdx];\n          g -= temp[topIdx + 1];\n          b -= temp[topIdx + 2];\n          a -= temp[topIdx + 3];\n          count--;\n        }\n        \n        // Add bottom pixel\n        const bottomY = y + radius + 1;\n        if (bottomY < height) {\n          const bottomIdx = (bottomY * width + x) * 4;\n          r += temp[bottomIdx];\n          g += temp[bottomIdx + 1];\n          b += temp[bottomIdx + 2];\n          a += temp[bottomIdx + 3];\n          count++;\n        }\n      }\n    }\n\n    return new ImageData(result, width, height);\n  };\n\n  const applyHueShiftFilter = (imageData, hueShift, saturationShift) => {\n    const data = imageData.data;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const r = data[i];\n      const g = data[i + 1];\n      const b = data[i + 2];\n\n      // Convert RGB to HSL\n      const max = Math.max(r, g, b) / 255;\n      const min = Math.min(r, g, b) / 255;\n      const diff = max - min;\n      const sum = max + min;\n\n      let h = 0;\n      const l = sum / 2;\n      const s = diff === 0 ? 0 : l > 0.5 ? diff / (2 - sum) : diff / sum;\n\n      if (diff !== 0) {\n        switch (max) {\n          case r / 255:\n            h = (g - b) / 255 / diff + (g < b ? 6 : 0);\n            break;\n          case g / 255:\n            h = (b - r) / 255 / diff + 2;\n            break;\n          case b / 255:\n            h = (r - g) / 255 / diff + 4;\n            break;\n        }\n        h /= 6;\n      }\n\n      // Apply shifts\n      h = (h + hueShift / 360) % 1;\n      const newS = Math.max(0, Math.min(1, s + saturationShift / 100));\n\n      // Convert back to RGB\n      const hue2rgb = (p, q, t) => {\n        if (t < 0) t += 1;\n        if (t > 1) t -= 1;\n        if (t < 1 / 6) return p + (q - p) * 6 * t;\n        if (t < 1 / 2) return q;\n        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;\n        return p;\n      };\n\n      let newR, newG, newB;\n\n      if (newS === 0) {\n        newR = newG = newB = l;\n      } else {\n        const q = l < 0.5 ? l * (1 + newS) : l + newS - l * newS;\n        const p = 2 * l - q;\n        newR = hue2rgb(p, q, h + 1 / 3);\n        newG = hue2rgb(p, q, h);\n        newB = hue2rgb(p, q, h - 1 / 3);\n      }\n\n      data[i] = Math.round(newR * 255);\n      data[i + 1] = Math.round(newG * 255);\n      data[i + 2] = Math.round(newB * 255);\n    }\n\n    return imageData;\n  };\n\n  const applyChalkFilter = (imageData, roughness, opacity) => {\n    const data = imageData.data;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const noise = (Math.random() - 0.5) * (roughness / 100) * 255;\n      const opacityFactor = opacity / 100;\n\n      data[i] = Math.max(0, Math.min(255, data[i] + noise)) * opacityFactor;\n      data[i + 1] =\n        Math.max(0, Math.min(255, data[i + 1] + noise)) * opacityFactor;\n      data[i + 2] =\n        Math.max(0, Math.min(255, data[i + 2] + noise)) * opacityFactor;\n      data[i + 3] = data[i + 3] * opacityFactor;\n    }\n\n    return imageData;\n  };\n\n  const applyFadeFilter = (imageData, amount) => {\n    const data = imageData.data;\n    const fadeAmount = 1 - amount / 100;\n\n    for (let i = 0; i < data.length; i += 4) {\n      data[i + 3] = data[i + 3] * fadeAmount;\n    }\n\n    return imageData;\n  };\n\n  const applyVintageFilter = (imageData, sepia, vignette) => {\n    const data = imageData.data;\n    const width = imageData.width;\n    const height = imageData.height;\n    const sepiaAmount = sepia / 100;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const r = data[i];\n      const g = data[i + 1];\n      const b = data[i + 2];\n\n      // Apply sepia\n      data[i] = Math.min(\n        255,\n        (r * 0.393 + g * 0.769 + b * 0.189) * sepiaAmount +\n        r * (1 - sepiaAmount)\n      );\n      data[i + 1] = Math.min(\n        255,\n        (r * 0.349 + g * 0.686 + b * 0.168) * sepiaAmount +\n        g * (1 - sepiaAmount)\n      );\n      data[i + 2] = Math.min(\n        255,\n        (r * 0.272 + g * 0.534 + b * 0.131) * sepiaAmount +\n        b * (1 - sepiaAmount)\n      );\n\n      // Apply vignette\n      const x = (i / 4) % width;\n      const y = Math.floor(i / 4 / width);\n      const centerX = width / 2;\n      const centerY = height / 2;\n      const distance = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);\n      const maxDistance = Math.sqrt(centerX ** 2 + centerY ** 2);\n      const vignetteAmount = 1 - (distance / maxDistance) * (vignette / 100);\n\n      data[i] *= vignetteAmount;\n      data[i + 1] *= vignetteAmount;\n      data[i + 2] *= vignetteAmount;\n    }\n\n    return imageData;\n  };\n\n  const applyNeonFilter = (imageData, intensity, hue) => {\n    const data = imageData.data;\n    const width = imageData.width;\n    const height = imageData.height;\n    const glowIntensity = intensity / 25; // More aggressive scaling (max 50 -> 2.0)\n\n    // Create a copy for the glow effect\n    const result = new Uint8ClampedArray(data);\n\n    // Generate neon color based on hue using proper HSL to RGB conversion\n    const hueNormalized = hue / 360;\n    const neonR = Math.abs(Math.sin((hueNormalized) * Math.PI * 2)) * 255;\n    const neonG = Math.abs(Math.sin((hueNormalized + 0.333) * Math.PI * 2)) * 255;\n    const neonB = Math.abs(Math.sin((hueNormalized + 0.666) * Math.PI * 2)) * 255;\n\n    for (let i = 0; i < data.length; i += 4) {\n      const alpha = data[i + 3];\n      \n      // Only apply effect to visible pixels (any stroke)\n      if (alpha > 5) {\n        const r = data[i];\n        const g = data[i + 1];\n        const b = data[i + 2];\n        \n        // Calculate brightness\n        const brightness = (r + g + b) / 3;\n        \n        // Apply aggressive neon glow with color tinting\n        const alphaFactor = alpha / 255;\n        const colorFactor = glowIntensity * alphaFactor;\n        \n        // Mix original color with neon color and boost brightness\n        const boost = 1 + (glowIntensity * 0.8);\n        result[i] = Math.min(255, (r * boost) + (neonR * colorFactor * 0.7));\n        result[i + 1] = Math.min(255, (g * boost) + (neonG * colorFactor * 0.7));\n        result[i + 2] = Math.min(255, (b * boost) + (neonB * colorFactor * 0.7));\n        \n        // Ensure the effect is visible even on dark strokes\n        const minBrightness = 60 * glowIntensity;\n        const currentBrightness = (result[i] + result[i + 1] + result[i + 2]) / 3;\n        if (currentBrightness < minBrightness) {\n          const brightnessFactor = minBrightness / Math.max(currentBrightness, 1);\n          result[i] = Math.min(255, result[i] * brightnessFactor);\n          result[i + 1] = Math.min(255, result[i + 1] * brightnessFactor);\n          result[i + 2] = Math.min(255, result[i + 2] * brightnessFactor);\n        }\n      }\n    }\n\n    return new ImageData(result, width, height);\n  };\n\n  const drawAllDrawings = async () => {\n    const currentTemplateObjects = templateObjectsRef.current || [];\n\n    if (isDrawingInProgressRef.current) {\n      console.log('Drawing already in progress, skipping drawAllDrawings call');\n      return;\n    }\n\n    isDrawingInProgressRef.current = true;\n\n    // Save current brush state\n    const savedBrushType = brushEngine ? brushEngine.brushType : null;\n    const savedBrushParams = brushEngine ? brushEngine.brushParams : null;\n\n    try {\n      setIsLoading(true);\n      const canvas = canvasRef.current;\n      if (!canvas) {\n        setIsLoading(false);\n        isDrawingInProgressRef.current = false;\n        return;\n      }\n      const context = canvas.getContext(\"2d\");\n      if (!context) {\n        setIsLoading(false);\n        isDrawingInProgressRef.current = false;\n        return;\n      }\n\n      // Include any locally-pending drawings (e.g. received via socket but\n      // not yet reflected by a backend refresh) so they render immediately.\n      const userDrawingIds = new Set((userData.drawings || []).map(d => d.drawingId));\n      const uniquePendingDrawings = (pendingDrawings || []).filter(\n        pd => !userDrawingIds.has(pd.drawingId)\n      );\n\n      const combined = [\n        ...(userData.drawings || []),\n        ...uniquePendingDrawings,\n      ];\n\n      // Create a state signature to detect if we need to redraw\n      const filterSignature = combined\n        .filter(d => d.drawingType === \"filter\")\n        .map(f => `${f.drawingId}:${f.filterType}`)\n        .join(',');\n\n      const templateSignature = currentTemplateObjects?.length > 0 \n        ? currentTemplateObjects.map(t => `${t.type}:${t.x || t.x1 || t.cx}:${t.y || t.y1 || t.cy}`).join(',')\n        : '';\n\n      const stateSignature = `${combined.length}|${filterSignature}|${pendingDrawings.length}|${currentTemplateObjects?.length || 0}|${templateSignature}`;\n\n      if (lastDrawnStateRef.current === stateSignature) {\n        console.log('State unchanged, skipping redraw');\n        setIsLoading(false);\n        isDrawingInProgressRef.current = false;\n        return;\n      }\n\n      // Check if we can do incremental rendering\n      let newDrawingsOnly = [];\n      if (lastDrawnStateRef.current && \n          cachedCanvasRef.current &&\n          cachedDrawingIdsRef.current.size > 0 &&\n          combined.length > cachedDrawingIdsRef.current.size &&\n          currentTemplateObjects?.length === 0) {\n        \n        // Find drawings that aren't in the cache\n        newDrawingsOnly = combined.filter(d => !cachedDrawingIdsRef.current.has(d.drawingId));\n        \n        const hasNewFiltersOrCuts = newDrawingsOnly.some(\n          d => d.drawingType === \"filter\" || (d.pathData && d.pathData.tool === \"cut\")\n        );\n        \n        // Verify all cached drawings are still present\n        const currentIds = new Set(combined.map(d => d.drawingId));\n        const allCachedPresent = Array.from(cachedDrawingIdsRef.current).every(id => currentIds.has(id));\n        \n        if (newDrawingsOnly.length > 0 && allCachedPresent && !hasNewFiltersOrCuts && newDrawingsOnly.length <= 5) {\n          console.log(`[Optimization] Incremental rendering: adding ${newDrawingsOnly.length} new drawings`);\n          // We can use incremental rendering!\n        } else {\n          // Fall back to full redraw\n          newDrawingsOnly = [];\n          cachedCanvasRef.current = null;\n          cachedDrawingIdsRef.current.clear();\n        }\n      } else {\n        // Clear cache - we need full redraw\n        cachedCanvasRef.current = null;\n        cachedDrawingIdsRef.current.clear();\n      }\n\n      // Clear force flag after checking it\n      forceNextRedrawRef.current = false;\n      lastDrawnStateRef.current = stateSignature;\n\n      // for flicker free rendering\n      if (!offscreenCanvasRef.current ||\n        offscreenCanvasRef.current.width !== canvasWidth ||\n        offscreenCanvasRef.current.height !== canvasHeight\n      ) {\n        offscreenCanvasRef.current = document.createElement(\"canvas\");\n        offscreenCanvasRef.current.width = canvasWidth;\n        offscreenCanvasRef.current.height = canvasHeight;\n      }\n\n      const offscreenContext = offscreenCanvasRef.current.getContext(\"2d\");\n      offscreenContext.imageSmoothingEnabled = false;\n      \n      // If we can do incremental rendering, start from cached canvas\n      if (newDrawingsOnly.length > 0 && cachedCanvasRef.current) {\n        console.log(\"[drawAllDrawings] Using incremental rendering - copying from cache\");\n        offscreenContext.clearRect(0, 0, canvasWidth, canvasHeight);\n        offscreenContext.drawImage(cachedCanvasRef.current, 0, 0);\n      } else {\n        // Full redraw\n        offscreenContext.clearRect(0, 0, canvasWidth, canvasHeight);\n      }\n\n      // This avoids async rendering issues with image stamps\n      const stampsToRender = [];\n\n      // Create and render template layer with caching\n      let templateCanvas = null;\n      if (currentTemplateObjects && currentTemplateObjects.length > 0) {\n        const templateSignature = `${templateId}_${currentTemplateObjects.length}`;\n        \n        if (cachedTemplateIdRef.current === templateSignature && templateCanvasRef.current) {\n          templateCanvas = templateCanvasRef.current;\n          console.log(\"[drawAllDrawings] Using cached template layer\");\n        } else {\n          templateCanvas = document.createElement('canvas');\n          templateCanvas.width = canvasWidth;\n          templateCanvas.height = canvasHeight;\n          const templateContext = templateCanvas.getContext('2d');\n          templateContext.imageSmoothingEnabled = false;\n\n          templateContext.save();\n          templateContext.globalAlpha = 0.5;\n\n          let renderedCount = 0;\n          for (const obj of currentTemplateObjects) {\n            try {\n              if (obj.type === 'line') {\n                templateContext.beginPath();\n                templateContext.moveTo(obj.x1, obj.y1);\n                templateContext.lineTo(obj.x2, obj.y2);\n                templateContext.strokeStyle = obj.color || '#333';\n                templateContext.lineWidth = obj.lineWidth || 2;\n                templateContext.stroke();\n                renderedCount++;\n              } else if (obj.type === 'rectangle') {\n                templateContext.strokeStyle = obj.stroke || '#333';\n                templateContext.lineWidth = obj.lineWidth || 2;\n                if (obj.fill && obj.fill !== 'transparent') {\n                  templateContext.fillStyle = obj.fill;\n                  templateContext.fillRect(obj.x, obj.y, obj.width, obj.height);\n                }\n                templateContext.strokeRect(obj.x, obj.y, obj.width, obj.height);\n                renderedCount++;\n              } else if (obj.type === 'circle') {\n                templateContext.beginPath();\n                templateContext.arc(obj.cx, obj.cy, obj.radius, 0, Math.PI * 2);\n                templateContext.strokeStyle = obj.stroke || '#333';\n                templateContext.lineWidth = obj.lineWidth || 2;\n                if (obj.fill && obj.fill !== 'transparent') {\n                  templateContext.fillStyle = obj.fill;\n                  templateContext.fill();\n                }\n                templateContext.stroke();\n                renderedCount++;\n              } else if (obj.type === 'ellipse') {\n                templateContext.beginPath();\n                templateContext.ellipse(obj.cx, obj.cy, obj.rx, obj.ry, 0, 0, Math.PI * 2);\n                templateContext.strokeStyle = obj.stroke || '#333';\n                templateContext.lineWidth = obj.lineWidth || 2;\n                if (obj.fill && obj.fill !== 'transparent') {\n                  templateContext.fillStyle = obj.fill;\n                  templateContext.fill();\n                }\n                templateContext.stroke();\n                renderedCount++;\n              } else if (obj.type === 'text') {\n                templateContext.fillStyle = obj.color || '#333';\n                templateContext.font = `${obj.bold ? 'bold ' : ''}${obj.fontSize || 16}px Arial`;\n                templateContext.fillText(obj.text || '', obj.x, obj.y);\n                renderedCount++;\n              } else {\n                console.warn('Unknown template object type:', obj.type);\n              }\n            } catch (e) {\n              console.warn('Failed to render template object:', obj, e);\n            }\n          }\n          templateContext.restore();\n          \n          templateCanvasRef.current = templateCanvas;\n          cachedTemplateIdRef.current = templateSignature;\n          console.log(\"[drawAllDrawings] Cached new template layer\");\n        }\n      } else {\n        console.log('No template objects to render');\n      }\n\n      if (templateCanvas) {\n        offscreenContext.drawImage(templateCanvas, 0, 0);\n      }\n\n      const cutOriginalIds = new Set();\n      try {\n        combined.forEach((d) => {\n          if (\n            d &&\n            d.pathData &&\n            d.pathData.tool === \"cut\" &&\n            Array.isArray(d.pathData.originalStrokeIds)\n          ) {\n            d.pathData.originalStrokeIds.forEach((id) =>\n              cutOriginalIds.add(id)\n            );\n          }\n        });\n      } catch (e) { }\n\n      const sortedDrawings = combined.sort((a, b) => {\n        const orderA =\n          a.order !== undefined ? a.order : a.timestamp || a.ts || 0;\n        const orderB =\n          b.order !== undefined ? b.order : b.timestamp || b.ts || 0;\n        return orderA - orderB;\n      });\n\n      // Separate filter drawings from regular drawings\n      const regularDrawings = [];\n      const filterDrawings = [];\n      for (const drawing of sortedDrawings) {\n        if (drawing.drawingType === \"filter\") {\n          filterDrawings.push(drawing);\n        } else {\n          regularDrawings.push(drawing);\n        }\n      }\n\n      // Optimization: Pre-load all image stamps with timeout to prevent indefinite blocking\n      const imageStampCache = new Map();\n      const imageStampPromises = [];\n\n      for (const drawing of regularDrawings) {\n        if (drawing.drawingType === \"stamp\" && drawing.stampData && drawing.stampData.image && !drawing.stampData.emoji) {\n          const imageUrl = drawing.stampData.image;\n          if (!imageStampCache.has(imageUrl)) {\n            const promise = new Promise((resolve) => {\n              const img = new Image();\n              img.onload = () => {\n                imageStampCache.set(imageUrl, img);\n                resolve(img);\n              };\n              img.onerror = () => {\n                console.error(\"[drawAllDrawings] Failed to pre-load stamp image:\", imageUrl.substring(0, 100));\n                imageStampCache.set(imageUrl, null); // Mark as failed\n                resolve(null);\n              };\n              img.src = imageUrl;\n            });\n            imageStampPromises.push(promise);\n          }\n        }\n      }\n\n      // Wait for all stamp images to load before rendering, with 2-second timeout\n      if (imageStampPromises.length > 0) {\n        console.log(\"[drawAllDrawings] Pre-loading\", imageStampPromises.length, \"stamp images\");\n        await Promise.race([\n          Promise.all(imageStampPromises),\n          new Promise(resolve => setTimeout(() => {\n            console.warn(\"[drawAllDrawings] Stamp image loading timeout after 2s - proceeding anyway\");\n            resolve();\n          }, 2000))\n        ]);\n        console.log(\"[drawAllDrawings] Stamp images loaded (or timeout reached)\");\n      }\n\n      // Render drawings in chronological order. When a 'cut' record appears\n      // we immediately apply a destination-out erase so it removes prior content\n      // but does not erase strokes that are drawn after the cut.\n      const maskedOriginals = new Set();\n      let seenAnyCut = false;\n\n      // If doing incremental rendering, only draw new drawings\n      const drawingsToRender = newDrawingsOnly.length > 0 ? newDrawingsOnly : regularDrawings;\n      console.log(`[drawAllDrawings] Rendering ${drawingsToRender.length} drawings (incremental: ${newDrawingsOnly.length > 0})`);\n\n      for (const drawing of drawingsToRender) {\n        // If this is a cut record, apply the erase to the canvas now.\n        if (drawing && drawing.pathData && drawing.pathData.tool === \"cut\") {\n          seenAnyCut = true;\n          try {\n            if (Array.isArray(drawing.pathData.originalStrokeIds)) {\n              drawing.pathData.originalStrokeIds.forEach((id) =>\n                maskedOriginals.add(id)\n              );\n            }\n          } catch (e) { }\n\n          if (drawing.pathData && drawing.pathData.rect) {\n            const r = drawing.pathData.rect;\n            offscreenContext.save();\n            try {\n              offscreenContext.globalCompositeOperation = \"destination-out\";\n              offscreenContext.fillStyle = \"rgba(0,0,0,1)\";\n              // Expand rect slightly to avoid hairline due to subpixel antialiasing\n              offscreenContext.fillRect(\n                Math.floor(r.x) - 2,\n                Math.floor(r.y) - 2,\n                Math.ceil(r.width) + 4,\n                Math.ceil(r.height) + 4\n              );\n            } finally {\n              offscreenContext.restore();\n            }\n\n            // Restore template layer in the cut region so templates remain visible\n            if (templateCanvas) {\n              offscreenContext.drawImage(\n                templateCanvas,\n                Math.floor(r.x) - 2,\n                Math.floor(r.y) - 2,\n                Math.ceil(r.width) + 4,\n                Math.ceil(r.height) + 4,\n                Math.floor(r.x) - 2,\n                Math.floor(r.y) - 2,\n                Math.ceil(r.width) + 4,\n                Math.ceil(r.height) + 4\n              );\n            }\n          }\n\n          continue;\n        }\n\n        // Skip originals that have been masked by a cut\n        if (\n          drawing &&\n          drawing.drawingId &&\n          (cutOriginalIds.has(drawing.drawingId) ||\n            maskedOriginals.has(drawing.drawingId))\n        ) {\n          continue;\n        }\n\n        // Skip temporary white \"erase\" helper strokes when we've seen a cut\n        // record; destination-out masking is authoritative and drawing white\n        // strokes can produce hairlines.\n        try {\n          if (\n            seenAnyCut &&\n            drawing &&\n            drawing.color &&\n            typeof drawing.color === \"string\" &&\n            drawing.color.toLowerCase() === \"#ffffff\"\n          ) {\n            continue;\n          }\n        } catch (e) { }\n\n        // Draw the drawing normally\n        offscreenContext.globalAlpha = 1.0;\n        let viewingUser = null;\n        let viewingPeriodStart = null;\n        if (selectedUser) {\n          if (typeof selectedUser === \"string\") viewingUser = selectedUser;\n          else if (typeof selectedUser === \"object\") {\n            viewingUser = selectedUser.user;\n            viewingPeriodStart = selectedUser.periodStart;\n          }\n        }\n        if (viewingUser && drawing.user !== viewingUser) {\n          offscreenContext.globalAlpha = 0.1;\n        } else if (viewingPeriodStart !== null) {\n          const ts = drawing.timestamp || drawing.order || 0;\n          if (\n            ts < viewingPeriodStart ||\n            ts >= viewingPeriodStart + 5 * 60 * 1000\n          ) {\n            offscreenContext.globalAlpha = 0.1;\n          }\n        }\n        \n        // Apply custom opacity if specified\n        if (drawing.opacity !== undefined && drawing.opacity !== 1.0) {\n          offscreenContext.globalAlpha *= drawing.opacity;\n        }\n\n        // Stamps have pathData as array but need special rendering - render inline to preserve z-order\n        if (drawing.drawingType === \"stamp\" && drawing.stampData && drawing.stampSettings && Array.isArray(drawing.pathData) && drawing.pathData.length > 0) {\n          const stamp = drawing.stampData;\n          const settings = drawing.stampSettings;\n          const position = drawing.pathData[0];\n\n          try {\n            offscreenContext.save();\n            offscreenContext.translate(position.x, position.y);\n            offscreenContext.rotate(((settings.rotation || 0) * Math.PI) / 180);\n\n            const size = settings.size || 50;\n\n            if (stamp.emoji) {\n              // Render emoji stamp\n              offscreenContext.font = `${size}px serif`;\n              offscreenContext.textAlign = \"center\";\n              offscreenContext.textBaseline = \"middle\";\n              offscreenContext.fillText(stamp.emoji, 0, 0);\n              console.log(\"[drawAllDrawings] Rendered emoji stamp inline:\", stamp.emoji);\n            } else if (stamp.image) {\n              // Render image stamp using pre-loaded image\n              const img = imageStampCache.get(stamp.image);\n              if (img) {\n                offscreenContext.globalAlpha = (settings.opacity || 100) / 100 * offscreenContext.globalAlpha;\n                offscreenContext.drawImage(img, -size / 2, -size / 2, size, size);\n                console.log(\"[drawAllDrawings] Rendered image stamp inline\");\n              } else {\n                console.warn(\"[drawAllDrawings] Image stamp not in cache:\", stamp.image?.substring(0, 100));\n              }\n            }\n\n            offscreenContext.restore();\n          } catch (error) {\n            offscreenContext.restore();\n            console.error(\"[drawAllDrawings] Error rendering stamp:\", error);\n          }\n        } else if (drawing.drawingType === \"stamp\") {\n          console.warn(\"[drawAllDrawings] Stamp NOT rendered - missing requirements:\", {\n            drawingId: drawing.drawingId,\n            drawingType: drawing.drawingType,\n            hasStampData: !!drawing.stampData,\n            hasStampSettings: !!drawing.stampSettings,\n            pathDataIsArray: Array.isArray(drawing.pathData),\n            pathDataLength: drawing.pathData ? drawing.pathData.length : 0,\n            pathDataType: typeof drawing.pathData,\n            pathDataValue: drawing.pathData,\n            fullDrawing: drawing\n          });\n        } else if (Array.isArray(drawing.pathData)) {\n          const pts = drawing.pathData;\n          if (pts.length > 0) {\n            // Check if this is an advanced brush drawing\n            if (drawing.brushType && drawing.brushType !== \"normal\" && brushEngine) {\n              console.log(\"Rendering advanced brush in drawAllDrawings:\", {\n                id: drawing.drawingId,\n                brushType: drawing.brushType,\n                pointCount: pts.length\n              });\n\n              // Use brush engine to render advanced brush strokes\n              offscreenContext.save();\n              brushEngine.updateContext(offscreenContext);\n\n              // Start the stroke at the first point\n              offscreenContext.beginPath();\n              offscreenContext.moveTo(pts[0].x, pts[0].y);\n\n              // Render the stroke using the brush engine with explicit brush type\n              brushEngine.startStroke(pts[0].x, pts[0].y);\n              for (let i = 1; i < pts.length; i++) {\n                // Use drawWithType instead of draw to bypass state dependency\n                brushEngine.drawWithType(\n                  pts[i].x,\n                  pts[i].y,\n                  drawing.lineWidth,\n                  drawing.color,\n                  drawing.brushType  // Pass brush type directly\n                );\n              }\n              offscreenContext.restore();\n            } else {\n              if (drawing.brushType && drawing.brushType !== \"normal\") {\n                console.log(\"Advanced brush found but no brushEngine:\", {\n                  id: drawing.drawingId,\n                  brushType: drawing.brushType,\n                  hasBrushEngine: !!brushEngine\n                });\n              }\n              // Default rendering for normal brush\n              offscreenContext.beginPath();\n              offscreenContext.moveTo(pts[0].x, pts[0].y);\n              for (let i = 1; i < pts.length; i++)\n                offscreenContext.lineTo(pts[i].x, pts[i].y);\n              offscreenContext.strokeStyle = drawing.color;\n              offscreenContext.lineWidth = drawing.lineWidth;\n              offscreenContext.lineCap = drawing.brushStyle || \"round\";\n              offscreenContext.lineJoin = drawing.brushStyle || \"round\";\n              offscreenContext.stroke();\n            }\n          }\n        } else if (drawing.pathData && drawing.pathData.tool === \"shape\") {\n          if (drawing.pathData.points) {\n            const pts = drawing.pathData.points;\n            offscreenContext.save();\n            offscreenContext.beginPath();\n            offscreenContext.moveTo(pts[0].x, pts[0].y);\n            for (let i = 1; i < pts.length; i++)\n              offscreenContext.lineTo(pts[i].x, pts[i].y);\n            offscreenContext.closePath();\n            offscreenContext.fillStyle = drawing.color;\n            offscreenContext.fill();\n            offscreenContext.restore();\n          } else {\n            const {\n              type,\n              start,\n              end,\n              brushStyle: storedBrush,\n            } = drawing.pathData;\n            offscreenContext.save();\n            offscreenContext.fillStyle = drawing.color;\n            offscreenContext.lineWidth = drawing.lineWidth;\n            if (type === \"circle\") {\n              const radius = Math.sqrt(\n                (end.x - start.x) ** 2 + (end.y - start.y) ** 2\n              );\n              offscreenContext.beginPath();\n              offscreenContext.arc(start.x, start.y, radius, 0, Math.PI * 2);\n              offscreenContext.fill();\n            } else if (type === \"rectangle\") {\n              offscreenContext.fillRect(\n                start.x,\n                start.y,\n                end.x - start.x,\n                end.y - start.y\n              );\n            } else if (type === \"hexagon\") {\n              const radius = Math.sqrt(\n                (end.x - start.x) ** 2 + (end.y - start.y) ** 2\n              );\n              offscreenContext.beginPath();\n              for (let i = 0; i < 6; i++) {\n                const angle = (Math.PI / 3) * i;\n                const xPoint = start.x + radius * Math.cos(angle);\n                const yPoint = start.y + radius * Math.sin(angle);\n                if (i === 0) offscreenContext.moveTo(xPoint, yPoint);\n                else offscreenContext.lineTo(xPoint, yPoint);\n              }\n              offscreenContext.closePath();\n              offscreenContext.fill();\n            } else if (type === \"line\") {\n              offscreenContext.beginPath();\n              offscreenContext.moveTo(start.x, start.y);\n              offscreenContext.lineTo(end.x, end.y);\n              offscreenContext.strokeStyle = drawing.color;\n              offscreenContext.lineWidth = drawing.lineWidth;\n              const cap = storedBrush || drawing.brushStyle || \"round\";\n              offscreenContext.lineCap = cap;\n              offscreenContext.lineJoin = cap;\n              offscreenContext.stroke();\n            }\n            offscreenContext.restore();\n          }\n        } else if (drawing.pathData && drawing.pathData.tool === \"image\") {\n          const { image, x, y, width, height } = drawing.pathData;\n          let img = new Image();\n          img.src = image;\n          img.onload = () => {\n            offscreenContext.drawImage(img, x, y, width, height);\n          };\n        }\n      }\n      if (!selectedUser) {\n        // Group users by 5-minute intervals\n        // Use both committed drawings and pending drawings so the UI's\n        // user/time-group list reflects the strokes the user currently sees.\n        const groupMap = {};\n        const groupingSource = [\n          ...(userData.drawings || []),\n          ...(pendingDrawings || []),\n        ];\n        groupingSource.forEach((d) => {\n          try {\n            const ts = d.timestamp || d.order || 0;\n            const periodStart =\n              Math.floor(ts / (5 * 60 * 1000)) * (5 * 60 * 1000);\n            if (!groupMap[periodStart]) groupMap[periodStart] = new Set();\n            if (d.user) groupMap[periodStart].add(d.user);\n          } catch (e) { }\n        });\n        const groups = Object.keys(groupMap).map((k) => ({\n          periodStart: parseInt(k),\n          users: Array.from(groupMap[k]),\n        }));\n        groups.sort((a, b) => b.periodStart - a.periodStart);\n        if (selectedUser && selectedUser !== \"\") {\n          let stillExists = false;\n          if (typeof selectedUser === \"string\") {\n            for (const g of groups) {\n              if (g.users.includes(selectedUser)) {\n                stillExists = true;\n                break;\n              }\n            }\n          } else if (typeof selectedUser === \"object\" && selectedUser.user) {\n            for (const g of groups) {\n              if (\n                g.periodStart === selectedUser.periodStart &&\n                g.users.includes(selectedUser.user)\n              ) {\n                stillExists = true;\n                break;\n              }\n            }\n          }\n\n          if (!stillExists) {\n            try {\n              setSelectedUser(\"\");\n            } catch (e) {\n              /* swallow if setter changed */\n            }\n          }\n        }\n\n        setUserList(groups);\n      }\n\n      // Apply filters as post-processing after all regular drawings are rendered\n      if (filterDrawings.length > 0) {\n        console.log(\"[drawAllDrawings] Applying\", filterDrawings.length, \"filter(s)\");\n        for (const filterDrawing of filterDrawings) {\n          try {\n            if (filterDrawing.filterType && filterDrawing.filterParams) {\n              const imageData = offscreenContext.getImageData(0, 0, canvasWidth, canvasHeight);\n              const filteredImageData = applyImageFilter(\n                imageData,\n                filterDrawing.filterType,\n                filterDrawing.filterParams\n              );\n              offscreenContext.putImageData(filteredImageData, 0, 0);\n              console.log(\"[drawAllDrawings] Applied filter:\", filterDrawing.filterType);\n            }\n          } catch (e) {\n            console.error(\"[drawAllDrawings] Error applying filter:\", filterDrawing.filterType, e);\n          }\n        }\n      }\n\n      // Copy offscreen canvas to visible canvas atomically\n      console.log(\"[drawAllDrawings] Copying offscreen canvas to visible canvas. Total strokes rendered:\", drawingsToRender.length, \"filters:\", filterDrawings.length);\n      context.imageSmoothingEnabled = false;\n      context.clearRect(0, 0, canvasWidth, canvasHeight);\n      context.drawImage(offscreenCanvasRef.current, 0, 0);\n      \n      // Update cache after successful render (only if no filters/cuts and not in incremental mode)\n      if (filterDrawings.length === 0 && !combined.some(d => d.pathData && d.pathData.tool === \"cut\")) {\n        if (!cachedCanvasRef.current || cachedCanvasRef.current.width !== canvasWidth || cachedCanvasRef.current.height !== canvasHeight) {\n          cachedCanvasRef.current = document.createElement(\"canvas\");\n          cachedCanvasRef.current.width = canvasWidth;\n          cachedCanvasRef.current.height = canvasHeight;\n        }\n        const cacheContext = cachedCanvasRef.current.getContext(\"2d\");\n        cacheContext.clearRect(0, 0, canvasWidth, canvasHeight);\n        cacheContext.drawImage(offscreenCanvasRef.current, 0, 0);\n        \n        // Update cached drawing IDs\n        cachedDrawingIdsRef.current = new Set(combined.map(d => d.drawingId));\n        console.log(`[drawAllDrawings] Cached ${cachedDrawingIdsRef.current.size} drawings for future incremental rendering`);\n      }\n      \n      console.log(\"[drawAllDrawings] Canvas update complete\");\n    } catch (e) {\n      console.error(\"Error in drawAllDrawings:\", e);\n    } finally {\n      // Restore current brush state\n      if (brushEngine && savedBrushType) {\n        brushEngine.setBrushType(savedBrushType);\n        if (savedBrushParams) {\n          brushEngine.setBrushParams(savedBrushParams);\n        }\n      }\n      setIsLoading(false);\n      isDrawingInProgressRef.current = false;\n    }\n  };\n\n  drawAllDrawingsRef.current = drawAllDrawings;\n\n  const undo = async () => {\n    if (!editingEnabled) {\n      showLocalSnack(\"Undo is disabled in view-only mode.\");\n      return;\n    }\n    if (undoStack.length === 0) return;\n    if (isRefreshing) {\n      showLocalSnack(\n        \"Please wait for the canvas to refresh before undoing again.\"\n      );\n      return;\n    }\n    try {\n      await undoAction({\n        auth,\n        currentUser: auth?.username || \"anonymous\",\n        undoStack,\n        setUndoStack,\n        setRedoStack,\n        userData,\n        drawAllDrawings,\n        refreshCanvasButtonHandler: refreshCanvasButtonHandler,\n        roomId: currentRoomId,\n      });\n      // After undo completes, refresh undo/redo availability from server\n      try {\n        await checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      } catch (e) { }\n      updateFilterState(); // Update filter state after undo\n    } catch (error) {\n      console.error(\"Error during undo:\", error);\n    }\n  };\n\n  const redo = async () => {\n    if (!editingEnabled) {\n      showLocalSnack(\"Redo is disabled in view-only mode.\");\n      return;\n    }\n    if (redoStack.length === 0) return;\n    if (isRefreshing) {\n      showLocalSnack(\n        \"Please wait for the canvas to refresh before redoing again.\"\n      );\n      return;\n    }\n    try {\n      await redoAction({\n        auth,\n        currentUser: auth?.username || \"anonymous\",\n        redoStack,\n        setRedoStack,\n        setUndoStack,\n        userData,\n        drawAllDrawings,\n        refreshCanvasButtonHandler: refreshCanvasButtonHandler,\n        roomId: currentRoomId,\n      });\n      // After redo completes, refresh undo/redo availability from server\n      try {\n        await checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      } catch (e) { }\n      updateFilterState(); // Update filter state after redo\n    } catch (error) {\n      console.error(\"Error during redo:\", error);\n    }\n  };\n\n  // Register keyboard shortcuts and commands\n  useEffect(() => {\n    // Initialize shortcut manager\n    if (!shortcutManagerRef.current) {\n      shortcutManagerRef.current = new KeyboardShortcutManager();\n    }\n\n    const manager = shortcutManagerRef.current;\n\n    // Register all commands with the command registry\n    const commands = [\n      // Command Palette & Help\n      {\n        id: 'commands.palette',\n        label: 'Open Command Palette',\n        description: 'Quick access to all commands',\n        keywords: ['palette', 'search', 'find'],\n        category: 'Commands',\n        action: () => setCommandPaletteOpen(true),\n        shortcut: { key: 'k', modifiers: { ctrl: true } }\n      },\n      {\n        id: 'commands.shortcuts',\n        label: 'Show Keyboard Shortcuts',\n        description: 'View all available keyboard shortcuts',\n        keywords: ['help', 'shortcuts', 'keys'],\n        category: 'Commands',\n        action: () => setShortcutsHelpOpen(true),\n        shortcut: { key: '/', modifiers: { ctrl: true } }\n      },\n      {\n        id: 'commands.cancel',\n        label: 'Cancel / Escape',\n        description: 'Cancel current action or close dialogs',\n        keywords: ['cancel', 'escape', 'close'],\n        category: 'Commands',\n        action: () => {\n          if (commandPaletteOpen) setCommandPaletteOpen(false);\n          else if (shortcutsHelpOpen) setShortcutsHelpOpen(false);\n          else if (drawing) setDrawing(false);\n        },\n        shortcut: { key: 'Escape', modifiers: {} }\n      },\n\n      // Edit Operations\n      {\n        id: 'edit.undo',\n        label: 'Undo',\n        description: 'Undo the last action',\n        keywords: ['undo', 'revert'],\n        category: 'Edit',\n        action: undo,\n        shortcut: { key: 'z', modifiers: { ctrl: true } },\n        enabled: () => editingEnabled && undoStack.length > 0\n      },\n      {\n        id: 'edit.redo',\n        label: 'Redo',\n        description: 'Redo the last undone action',\n        keywords: ['redo', 'repeat'],\n        category: 'Edit',\n        action: redo,\n        shortcut: { key: 'z', modifiers: { ctrl: true, shift: true } },\n        enabled: () => editingEnabled && redoStack.length > 0\n      },\n\n      // Canvas Operations\n      {\n        id: 'canvas.clear',\n        label: 'Clear Canvas',\n        description: 'Remove all strokes from canvas',\n        keywords: ['clear', 'delete', 'reset'],\n        category: 'Canvas',\n        action: () => {\n          if (editingEnabled) {\n            setClearDialogOpen(true);\n          } else {\n            showLocalSnack('Canvas clearing is disabled in view-only mode');\n          }\n        },\n        shortcut: { key: 'k', modifiers: { ctrl: true, shift: true } },\n        enabled: () => editingEnabled\n      },\n      {\n        id: 'canvas.refresh',\n        label: 'Refresh Canvas',\n        description: 'Reload canvas from server',\n        keywords: ['refresh', 'reload'],\n        category: 'Canvas',\n        action: refreshCanvasButtonHandler,\n        shortcut: { key: 'r', modifiers: { ctrl: true } }\n      },\n      {\n        id: 'canvas.settings',\n        label: 'Canvas Settings',\n        description: 'Open canvas settings',\n        keywords: ['settings', 'preferences'],\n        category: 'Canvas',\n        action: () => {\n          if (onOpenSettings) onOpenSettings();\n        },\n        shortcut: { key: ',', modifiers: { ctrl: true } },\n        visible: () => !!onOpenSettings\n      },\n\n      // Tools\n      {\n        id: 'tool.pen',\n        label: 'Select Pen Tool',\n        description: 'Switch to freehand drawing',\n        keywords: ['pen', 'draw', 'brush'],\n        category: 'Tools',\n        action: () => {\n          if (editingEnabled) {\n            setDrawMode('freehand');\n            showLocalSnack('Pen tool selected');\n          }\n        },\n        shortcut: { key: 'p', modifiers: {} },\n        enabled: () => editingEnabled\n      },\n      {\n        id: 'tool.eraser',\n        label: 'Select Eraser',\n        description: 'Switch to eraser mode',\n        keywords: ['eraser', 'erase', 'remove'],\n        category: 'Tools',\n        action: () => {\n          if (editingEnabled) {\n            setDrawMode('eraser');\n            showLocalSnack('Eraser selected');\n          }\n        },\n        shortcut: { key: 'e', modifiers: {} },\n        enabled: () => editingEnabled\n      },\n      {\n        id: 'tool.rectangle',\n        label: 'Select Rectangle Tool',\n        description: 'Draw rectangles and squares',\n        keywords: ['rectangle', 'rect', 'square'],\n        category: 'Tools',\n        action: () => {\n          if (editingEnabled) {\n            setDrawMode('shape');\n            setShapeType('rectangle');\n            showLocalSnack('Rectangle tool selected');\n          }\n        },\n        shortcut: { key: 'r', modifiers: {} },\n        enabled: () => editingEnabled\n      },\n      {\n        id: 'tool.circle',\n        label: 'Select Circle Tool',\n        description: 'Draw circles and ellipses',\n        keywords: ['circle', 'oval', 'ellipse'],\n        category: 'Tools',\n        action: () => {\n          if (editingEnabled) {\n            setDrawMode('shape');\n            setShapeType('circle');\n            showLocalSnack('Circle tool selected');\n          }\n        },\n        shortcut: { key: 'c', modifiers: {} },\n        enabled: () => editingEnabled\n      },\n      {\n        id: 'tool.line',\n        label: 'Select Line Tool',\n        description: 'Draw straight lines',\n        keywords: ['line', 'straight'],\n        category: 'Tools',\n        action: () => {\n          if (editingEnabled) {\n            setDrawMode('shape');\n            setShapeType('line');\n            showLocalSnack('Line tool selected');\n          }\n        },\n        shortcut: { key: 'l', modifiers: {} },\n        enabled: () => editingEnabled\n      }\n    ];\n\n    // Register commands with command registry\n    // Clear first to ensure clean state\n    commandRegistry.clear();\n\n    // Register each command (allowOverwrite for React re-renders)\n    commands.forEach(cmd => {\n      commandRegistry.register(cmd, { allowOverwrite: true });\n    });\n\n    // Register keyboard shortcuts\n    manager.clear();\n    commands.forEach(cmd => {\n      if (cmd.shortcut) {\n        manager.register(\n          cmd.shortcut.key,\n          cmd.shortcut.modifiers,\n          () => {\n            // Check if command is enabled before executing\n            if (cmd.enabled && !cmd.enabled()) {\n              return;\n            }\n            cmd.action();\n          },\n          cmd.label,\n          cmd.category\n        );\n      }\n    });\n\n    // Add global keyboard event listener\n    const handleKeyDown = (event) => manager.handleKeyDown(event);\n    document.addEventListener('keydown', handleKeyDown);\n\n    // Cleanup\n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n      manager.clear();\n    };\n  }, [\n    editingEnabled,\n    undoStack,\n    redoStack,\n    undo,\n    redo,\n    refreshCanvasButtonHandler,\n    onOpenSettings,\n    commandPaletteOpen,\n    shortcutsHelpOpen,\n    drawing\n  ]);\n\n  const {\n    selectionStart,\n    setSelectionStart,\n    selectionRect,\n    setSelectionRect,\n    cutImageData,\n    setCutImageData,\n    handleCutSelection,\n  } = useCanvasSelection(\n    canvasRef,\n    currentUser,\n    userData,\n    generateId,\n    drawAllDrawings,\n    currentRoomId,\n    setUndoAvailable,\n    setRedoAvailable,\n    auth,\n    roomType,\n    showLocalSnack\n  );\n\n  // Draw a preview of a shape (for shape mode)\n  const drawShapePreview = (start, end, shape, color, lineWidth) => {\n    if (!start || !end) return;\n\n    const canvas = canvasRef.current;\n    const context = canvas.getContext(\"2d\");\n    context.save();\n    context.strokeStyle = color;\n    context.lineWidth = lineWidth;\n    context.setLineDash([5, 3]);\n\n    if (shape === \"circle\") {\n      const radius = Math.sqrt((end.x - start.x) ** 2 + (end.y - start.y) ** 2);\n      context.beginPath();\n      context.arc(start.x, start.y, radius, 0, Math.PI * 2);\n      context.stroke();\n    } else if (shape === \"rectangle\") {\n      context.strokeRect(start.x, start.y, end.x - start.x, end.y - start.y);\n    } else if (shape === \"hexagon\") {\n      const radius = Math.sqrt((end.x - start.x) ** 2 + (end.y - start.y) ** 2);\n      context.beginPath();\n\n      for (let i = 0; i < 6; i++) {\n        const angle = (Math.PI / 3) * i;\n        const xPoint = start.x + radius * Math.cos(angle);\n        const yPoint = start.y + radius * Math.sin(angle);\n\n        if (i === 0) context.moveTo(xPoint, yPoint);\n        else context.lineTo(xPoint, yPoint);\n      }\n      context.closePath();\n      context.stroke();\n    } else if (shape === \"line\") {\n      context.beginPath();\n      context.moveTo(start.x, start.y);\n      context.lineTo(end.x, end.y);\n      context.lineCap = brushStyle;\n      context.lineJoin = brushStyle;\n      context.stroke();\n    }\n\n    context.restore();\n  };\n\n  // Handle paste action for cut selection\n  const handlePaste = async (e) => {\n    if (!editingEnabled) {\n      showLocalSnack(\"Editing is disabled in view-only mode.\");\n      setDrawMode(\"freehand\");\n      return;\n    }\n    if (\n      !cutImageData ||\n      !Array.isArray(cutImageData) ||\n      cutImageData.length === 0\n    ) {\n      showLocalSnack(\"No cut selection available to paste.\");\n      setDrawMode(\"freehand\");\n      return;\n    }\n\n    const canvas = canvasRef.current;\n    const rectCanvas = canvas.getBoundingClientRect();\n    const scaleX = canvas.width / rectCanvas.width;\n    const scaleY = canvas.height / rectCanvas.height;\n    const pasteX = (e.clientX - rectCanvas.left) * scaleX;\n    const pasteY = (e.clientY - rectCanvas.top) * scaleY;\n\n    let minX = Infinity,\n      minY = Infinity;\n\n    cutImageData.forEach((drawing) => {\n      if (Array.isArray(drawing.pathData)) {\n        drawing.pathData.forEach((pt) => {\n          minX = Math.min(minX, pt.x);\n          minY = Math.min(minY, pt.y);\n        });\n      } else if (drawing.pathData && drawing.pathData.tool === \"shape\") {\n        if (drawing.pathData.points && Array.isArray(drawing.pathData.points)) {\n          drawing.pathData.points.forEach((pt) => {\n            minX = Math.min(minX, pt.x);\n            minY = Math.min(minY, pt.y);\n          });\n        } else if (drawing.pathData.type === \"line\") {\n          if (drawing.pathData.start) {\n            minX = Math.min(minX, drawing.pathData.start.x);\n            minY = Math.min(minY, drawing.pathData.start.y);\n          }\n          if (drawing.pathData.end) {\n            minX = Math.min(minX, drawing.pathData.end.x);\n            minY = Math.min(minY, drawing.pathData.end.y);\n          }\n        }\n      }\n    });\n\n    if (minX === Infinity || minY === Infinity) {\n      showLocalSnack(\"Invalid cut data.\");\n      return;\n    }\n\n    const offsetX = pasteX - minX;\n    const offsetY = pasteY - minY;\n    let pastedDrawings = [];\n\n    const newDrawings = cutImageData\n      .map((originalDrawing) => {\n        let newPathData;\n        if (Array.isArray(originalDrawing.pathData)) {\n          newPathData = originalDrawing.pathData.map((pt) => ({\n            x: pt.x + offsetX,\n            y: pt.y + offsetY,\n          }));\n        } else if (\n          originalDrawing.pathData &&\n          originalDrawing.pathData.tool === \"shape\"\n        ) {\n          if (\n            originalDrawing.pathData.points &&\n            Array.isArray(originalDrawing.pathData.points)\n          ) {\n            const newPoints = originalDrawing.pathData.points.map((pt) => ({\n              x: pt.x + offsetX,\n              y: pt.y + offsetY,\n            }));\n            newPathData = { ...originalDrawing.pathData, points: newPoints };\n          } else if (originalDrawing.pathData.type === \"line\") {\n            const newStart = {\n              x: originalDrawing.pathData.start.x + offsetX,\n              y: originalDrawing.pathData.start.y + offsetY,\n            };\n            const newEnd = {\n              x: originalDrawing.pathData.end.x + offsetX,\n              y: originalDrawing.pathData.end.y + offsetY,\n            };\n            newPathData = {\n              ...originalDrawing.pathData,\n              start: newStart,\n              end: newEnd,\n            };\n          }\n        } else {\n          return null;\n        }\n\n        // Preserve all metadata from original drawing\n        const metadata = {\n          brushStyle: originalDrawing.brushStyle,\n          brushType: originalDrawing.brushType,\n          brushParams: originalDrawing.brushParams,\n          drawingType: originalDrawing.drawingType,\n          stampData: originalDrawing.stampData,\n          stampSettings: originalDrawing.stampSettings,\n          filterType: originalDrawing.filterType,\n          filterParams: originalDrawing.filterParams,\n        };\n\n        return new Drawing(\n          generateId(),\n          originalDrawing.color,\n          originalDrawing.lineWidth,\n          newPathData,\n          Date.now(),\n          currentUser,\n          metadata\n        );\n      })\n      .filter(Boolean);\n\n    // Show all pasted items immediately (optimistic UI)\n    console.log(\"[handlePaste] Starting optimistic paste operation:\", {\n      drawingCount: newDrawings.length,\n      drawingTypes: newDrawings.map(d => d.drawingType || \"stroke\")\n    });\n\n    const pasteRecordId = generateId();\n\n    // Attach parentPasteId to each new drawing\n    for (const nd of newDrawings) {\n      nd.roomId = currentRoomId;\n      nd.parentPasteId = pasteRecordId;\n      if (!nd.pathData) nd.pathData = {};\n      nd.pathData.parentPasteId = pasteRecordId;\n      \n      // Add to local canvas immediately\n      userData.addDrawing(nd);\n    }\n    console.log(\"[handlePaste] Attached parentPasteId to all drawings:\", pasteRecordId);\n\n    // Redraw canvas immediately with all pasted items\n    drawAllDrawings();\n\n    // Now submit to backend in background (no dialog)\n    setRedoStack([]);\n\n    try {\n      // Submit all pasted drawings in batch\n      const result = await submitBatchToDatabase(\n        newDrawings,\n        auth,\n        { roomId: currentRoomId, roomType, skipUndoStack: true },\n        setUndoAvailable,\n        setRedoAvailable\n      );\n\n      console.log(\"[handlePaste] Batch submission complete:\", result);\n      \n      // Create and submit paste record\n      const pastedIds = newDrawings.map((d) => d.drawingId);\n      const pasteRecord = new Drawing(\n        pasteRecordId,\n        \"#FFFFFF\",\n        1,\n        { tool: \"paste\", cut: false, pastedDrawingIds: pastedIds },\n        Date.now(),\n        currentUser\n      );\n      \n      await submitToDatabase(\n        pasteRecord,\n        auth,\n        { roomId: currentRoomId, roomType },\n        setUndoAvailable,\n        setRedoAvailable\n      );\n      \n      console.log(\"[handlePaste] Paste record submitted successfully\");\n      \n      // Update undo stack\n      setUndoStack((prev) => [\n        ...prev,\n        { type: \"paste\", pastedDrawings: newDrawings, backendCount: 1 },\n      ]);\n\n      // Update undo/redo availability\n      if (currentRoomId) {\n        checkUndoRedoAvailability(\n          auth,\n          setUndoAvailable,\n          setRedoAvailable,\n          currentRoomId\n        );\n      }\n\n      setCutImageData([]);\n      setDrawMode(\"freehand\");\n\n    } catch (error) {\n      console.error(\"Failed to complete paste operation:\", error);\n      userData.drawings = userData.drawings.filter(\n        d => d.parentPasteId !== pasteRecordId\n      );\n      drawAllDrawings();\n      handleAuthError(error);\n    }\n\n    tempPathRef.current = [];\n  };\n\n  const mergedRefreshCanvas = async (sourceLabel = undefined) => {\n    try {\n      if (sourceLabel) {\n        console.log('mergedRefreshCanvas called from:', sourceLabel, '===');\n        console.debug('mergedRefreshCanvas called from:', sourceLabel);\n      } else {\n        console.log('mergedRefreshCanvas called (no label) ===');\n        console.debug('mergedRefreshCanvas called');\n      }\n    } catch (e) { }\n    // If currently panning, defer refresh until pan ends to avoid races and frequent backend calls.\n    try {\n      if (isPanning) {\n        console.debug(\n          \"[mergedRefreshCanvas] deferring because isPanning=true, marking pendingPanRefreshRef\"\n        );\n        pendingPanRefreshRef.current = true;\n        return;\n      }\n    } catch (e) { }\n\n    if (sourceLabel === \"undo-event\" || sourceLabel === \"redo-event\") {\n      console.log(\"[mergedRefreshCanvas] Forcing complete state reset for undo/redo\");\n      lastDrawnStateRef.current = null;\n    }\n\n    setIsLoading(true);\n    const backendCount = await backendRefreshCanvas(\n      serverCountRef.current,\n      userData,\n      drawAllDrawings,\n      historyRange ? historyRange.start : undefined,\n      historyRange ? historyRange.end : undefined,\n      {\n        roomId: currentRoomId,\n        auth,\n        clearLastDrawnState: () => {\n          console.log(\"[mergedRefreshCanvas] Clearing lastDrawnStateRef to force redraw\");\n          lastDrawnStateRef.current = null;\n        }\n      }\n    );\n\n    const pendingSnapshot = [...pendingDrawings];\n\n    // Don't clear all pending drawings, only mark confirmed ones for removal\n\n    serverCountRef.current = backendCount;\n    // Re-append any pending drawings that the backend didn't return.\n    const drawingMatches = (a, b) => {\n      if (!a || !b) return false;\n      if (a.drawingId && b.drawingId && a.drawingId === b.drawingId)\n        return true;\n\n      try {\n        const sameUser = a.user === b.user;\n        const tsA = a.timestamp || a.ts || 0;\n        const tsB = b.timestamp || b.ts || 0;\n        const tsClose = Math.abs(tsA - tsB) < 1000;\n        const lenA = Array.isArray(a.pathData)\n          ? a.pathData.length\n          : a.pathData && a.pathData.points\n            ? a.pathData.points.length\n            : 0;\n        const lenB = Array.isArray(b.pathData)\n          ? b.pathData.length\n          : b.pathData && b.pathData.points\n            ? b.pathData.points.length\n            : 0;\n        const lenClose = Math.abs(lenA - lenB) <= 1;\n        return sameUser && tsClose && lenClose;\n      } catch (e) {\n        return false;\n      }\n    };\n\n    try {\n      const cutOriginalIds = new Set();\n      (userData.drawings || []).forEach((d) => {\n        if (\n          d.pathData &&\n          d.pathData.tool === \"cut\" &&\n          Array.isArray(d.pathData.originalStrokeIds)\n        ) {\n          d.pathData.originalStrokeIds.forEach((id) => cutOriginalIds.add(id));\n        }\n      });\n\n      if (cutOriginalIds.size > 0) {\n        userData.drawings = (userData.drawings || []).filter(\n          (d) => !cutOriginalIds.has(d.drawingId)\n        );\n      }\n    } catch (e) {\n      // best-effort\n    }\n\n    // Re-append pending drawings that the backend didn't return, but\n    // skip any pending items older than the authoritative clearedAt timestamp\n    const clearedAt = currentRoomId\n      ? roomClearedAtRef.current[currentRoomId]\n      : null;\n    const stillPending = [];\n\n    pendingSnapshot.forEach((pd) => {\n      try {\n        const pdTs = pd.timestamp || pd.ts || 0;\n        if (clearedAt && pdTs < clearedAt) {\n          // This pending drawing was created before a server clear; ignore it\n          return;\n        }\n      } catch (e) { }\n\n      const exists = userData.drawings.find((d) => drawingMatches(d, pd));\n      if (!exists) {\n        // Backend doesn't have it yet, keep it pending\n        userData.drawings.push(pd);\n        stillPending.push(pd);\n      } else {\n        // If pending drawing has stampData but backend version doesn't, use pending version\n        if (pd.drawingType === \"stamp\" && pd.stampData) {\n          const backendMatch = exists;\n          if (!backendMatch.stampData || !backendMatch.stampData.image && pd.stampData.image) {\n            console.warn(\"Backend stamp missing stampData, using pending version:\", {\n              drawingId: pd.drawingId,\n              pendingHasStampData: !!pd.stampData,\n              backendHasStampData: !!backendMatch.stampData,\n              pendingImageLength: pd.stampData.image ? pd.stampData.image.length : 0,\n              backendImageLength: backendMatch.stampData && backendMatch.stampData.image ? backendMatch.stampData.image.length : 0\n            });\n\n            // Replace backend version with pending version that has complete data\n            const idx = userData.drawings.findIndex((d) => drawingMatches(d, pd));\n            if (idx !== -1) {\n              userData.drawings[idx] = pd;\n            }\n          }\n        }\n\n        // Backend has it, mark as confirmed and remove from pending\n        if (pd.drawingId) {\n          confirmedStrokesRef.current.add(pd.drawingId);\n        }\n      }\n    });\n\n    // Update pending drawings to only include those still not confirmed by backend\n    setPendingDrawings(stillPending);\n\n    // CRITICAL: Deduplicate filters - only keep the LATEST of each filter type\n    // This prevents stacking when backend returns duplicates\n    const filtersByType = new Map();\n    const nonFilterDrawings = [];\n    \n    (userData.drawings || []).forEach((drawing) => {\n      if (drawing.drawingType === \"filter\" && drawing.filterType) {\n        const existing = filtersByType.get(drawing.filterType);\n        // Keep the one with the latest timestamp\n        if (!existing || (drawing.timestamp || 0) > (existing.timestamp || 0)) {\n          filtersByType.set(drawing.filterType, drawing);\n        }\n      } else {\n        nonFilterDrawings.push(drawing);\n      }\n    });\n    \n    // Rebuild drawings array with deduplicated filters\n    const deduplicatedDrawings = [\n      ...nonFilterDrawings,\n      ...Array.from(filtersByType.values())\n    ];\n\n    console.log(`[mergedRefreshCanvas] Deduplicated filters. Filter count: ${filtersByType.size}, Total drawings: ${deduplicatedDrawings.length}`);\n\n    // CRITICAL: Update both the mutable userData object AND React state\n    // Update userData in place so the closure reference works\n    userData.drawings = deduplicatedDrawings;\n    \n    // Also update React state to trigger re-renders\n    const newUserData = new UserData(userData.userId, userData.username);\n    newUserData.drawings = deduplicatedDrawings;\n    setUserData(newUserData);\n\n    // Extract custom stamps from all drawings and update stamp panel\n    extractCustomStamps();\n\n    // Use requestAnimationFrame for smoother rendering\n    requestAnimationFrame(() => {\n      drawAllDrawings();\n      setIsLoading(false);\n      updateFilterState(); // Update filter state after loading drawings\n    });\n  };\n\n  // Extract custom stamps from backend drawings and update StampPanel\n  const extractCustomStamps = () => {\n    try {\n      const customStamps = [];\n      const seenStamps = new Map(); // Deduplicate by image content or emoji\n\n      (userData.drawings || []).forEach((drawing) => {\n        if (drawing.drawingType === \"stamp\" && drawing.stampData) {\n          const stamp = drawing.stampData;\n\n          // Skip default emoji stamps (they're already in StampPanel)\n          if (stamp.emoji && !stamp.image) {\n            return;\n          }\n\n          // For custom image stamps, create a unique key based on image content\n          if (stamp.image) {\n            const imageKey = stamp.image.substring(0, 100); // Use first 100 chars as key\n\n            if (!seenStamps.has(imageKey)) {\n              seenStamps.set(imageKey, true);\n              customStamps.push({\n                id: `stamp-${Date.now()}-${customStamps.length}`,\n                name: stamp.name || 'Custom Stamp',\n                category: stamp.category || 'custom',\n                image: stamp.image,\n                emoji: stamp.emoji\n              });\n            }\n          }\n        }\n      });\n\n      if (customStamps.length > 0) {\n        console.log('Extracted custom stamps from backend:', customStamps.length);\n        setBackendStamps(customStamps);\n      }\n    } catch (error) {\n      console.error('Error extracting custom stamps:', error);\n    }\n  };\n\n  const startDrawingHandler = (e) => {\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n\n    if (e.button === 1) {\n      // Middle mouse button: start panning\n      setIsPanning(true);\n      panStartRef.current = { x: e.clientX, y: e.clientY };\n      panOriginRef.current = { ...panOffset };\n      setIsLoading(true);\n      // Throttle pan-triggered refreshes: if we recently refreshed, defer until pan end\n      try {\n        const now = Date.now();\n        const diff = now - panLastRefreshRef.current;\n        console.debug(\n          `[pan] now=${now} lastRefresh=${panLastRefreshRef.current} diff=${diff} cooldown=${PAN_REFRESH_COOLDOWN_MS}`\n        );\n        if (diff > PAN_REFRESH_COOLDOWN_MS) {\n          panLastRefreshRef.current = now;\n          console.debug(\"[pan] triggering immediate mergedRefreshCanvas\");\n          mergedRefreshCanvas(\"pan-start\").finally(() => setIsLoading(false));\n        } else {\n          // Mark that we skipped the immediate refresh and schedule a deferred refresh on mouseup\n          panRefreshSkippedRef.current = true;\n          console.debug(\n            \"[pan] skipped immediate refresh; scheduling deferred refresh on mouseup\"\n          );\n          if (panEndRefreshTimerRef.current)\n            clearTimeout(panEndRefreshTimerRef.current);\n          panEndRefreshTimerRef.current = setTimeout(() => {\n            if (panRefreshSkippedRef.current) {\n              panRefreshSkippedRef.current = false;\n              panLastRefreshRef.current = Date.now();\n              console.debug(\"[pan] deferred timer firing mergedRefreshCanvas\");\n              mergedRefreshCanvas(\"pan-deferred\").finally(() =>\n                setIsLoading(false)\n              );\n            }\n            panEndRefreshTimerRef.current = null;\n          }, Math.max(200, PAN_REFRESH_COOLDOWN_MS - diff));\n          setIsLoading(false);\n        }\n      } catch (e) {\n        mergedRefreshCanvas().finally(() => setIsLoading(false));\n      }\n      return;\n    }\n\n    if (!editingEnabled) return;\n\n    if (drawMode === \"eraser\" || drawMode === \"freehand\") {\n      const context = canvas.getContext(\"2d\");\n      context.strokeStyle = color;\n      context.lineWidth = lineWidth;\n      context.lineCap = brushStyle;\n      context.lineJoin = brushStyle;\n\n      // Initialize brush engine for advanced brushes\n      if (brushEngine) {\n        brushEngine.updateContext(context);\n        brushEngine.startStroke(x, y);\n\n        // For normal brush, we still need the standard path setup\n        if (currentBrushType === \"normal\") {\n          context.beginPath();\n          context.moveTo(x, y);\n        }\n      } else {\n        // Fallback if no brush engine\n        context.beginPath();\n        context.moveTo(x, y);\n      }\n\n      tempPathRef.current = [{ x, y }];\n      setDrawing(true);\n    } else if (drawMode === \"shape\") {\n      setShapeStart({ x, y });\n      setDrawing(true);\n\n      const dataURL = canvas.toDataURL();\n      let snapshotImg = new Image();\n\n      snapshotImg.src = dataURL;\n      snapshotRef.current = snapshotImg;\n    } else if (drawMode === \"select\") {\n      setSelectionStart({ x, y });\n      setSelectionRect(null);\n      setDrawing(true);\n\n      const dataURL = canvas.toDataURL();\n      let snapshotImg = new Image();\n\n      snapshotImg.src = dataURL;\n      snapshotRef.current = snapshotImg;\n    } else if (drawMode === \"paste\") {\n      handlePaste(e);\n    } else if (drawMode === \"stamp\") {\n      // Start stamp preview on mousedown (will place on mouseup)\n      if (selectedStamp && stampSettings) {\n        setStampPreview({ x, y, stamp: selectedStamp, settings: stampSettings });\n        stampPreviewRef.current = { x, y, stamp: selectedStamp, settings: stampSettings };\n        setDrawing(true); // Enable dragging\n      }\n    }\n  };\n\n  const handlePan = (e) => {\n    if (!isPanning) return;\n\n    // If the middle button is no longer pressed, stop panning.\n    if (!(e.buttons & 4)) {\n      setIsPanning(false);\n      panOriginRef.current = { ...panOffset };\n      return;\n    }\n\n    const deltaX = e.clientX - panStartRef.current.x;\n    const deltaY = e.clientY - panStartRef.current.y;\n    let newX = panOriginRef.current.x + deltaX;\n    let newY = panOriginRef.current.y + deltaY;\n    const containerWidth = window.innerWidth;\n    const containerHeight = window.innerHeight;\n\n    // Calculate minimum allowed offsets so that the canvas edge is not exceeded.\n    // Our canvas is fixed at canvasWidth and canvasHeight.\n    const minX = containerWidth - canvasWidth; // This will be negative if canvasWidth > containerWidth\n    const minY = containerHeight - canvasHeight;\n\n    newX = clamp(newX, minX, 0);\n    newY = clamp(newY, minY, 0);\n\n    setPanOffset({\n      x: newX,\n      y: newY,\n    });\n  };\n\n  const drawHandler = (e) => {\n    if (isPanning) {\n      handlePan(e);\n      return;\n    }\n    if (!editingEnabled) return; // prevent drawing but allow other handlers like panning to proceed\n    if (!drawing) return;\n\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const x = e.clientX - rect.left;\n    const y = e.clientY - rect.top;\n\n    console.log(\n      \"Drawing with brush type:\",\n      currentBrushType,\n      \"drawMode:\",\n      drawMode\n    );\n\n    // Update stamp preview position during drag\n    if (drawMode === \"stamp\" && stampPreviewRef.current) {\n      setStampPreview({ ...stampPreviewRef.current, x, y });\n      stampPreviewRef.current = { ...stampPreviewRef.current, x, y };\n      return;\n    }\n\n    if (drawMode === \"eraser\" || drawMode === \"freehand\") {\n      const context = canvas.getContext(\"2d\");\n\n      // Use advanced brush engine if available\n      if (brushEngine && currentBrushType !== \"normal\") {\n        console.log(\"Drawing with advanced brush engine:\", currentBrushType);\n        // Ensure context is up to date\n        brushEngine.updateContext(context);\n\n        // Ensure brush engine has current state\n        if (brushEngine.brushType !== currentBrushType) {\n          brushEngine.setBrushType(currentBrushType);\n        }\n        if (\n          JSON.stringify(brushEngine.brushParams) !==\n          JSON.stringify(brushParams)\n        ) {\n          brushEngine.setBrushParams(brushParams);\n        }\n\n        brushEngine.draw(x, y, lineWidth, color);\n      } else {\n        console.log(\"Drawing with normal brush\");\n        // Default drawing behavior\n        context.lineTo(x, y);\n        context.stroke();\n        context.beginPath();\n        context.moveTo(x, y);\n      }\n\n      tempPathRef.current.push({ x, y });\n    } else if (drawMode === \"shape\" && drawing) {\n      // update shape preview with adjusted coordinates\n      if (snapshotRef.current && snapshotRef.current.complete) {\n        const context = canvas.getContext(\"2d\");\n        context.clearRect(0, 0, canvasWidth, canvasHeight);\n        context.drawImage(snapshotRef.current, 0, 0);\n      }\n\n      drawShapePreview(shapeStart, { x, y }, shapeType, color, lineWidth);\n    } else if (drawMode === \"select\" && drawing) {\n      setSelectionRect({ start: selectionStart, end: { x, y } });\n\n      if (snapshotRef.current && snapshotRef.current.complete) {\n        const context = canvas.getContext(\"2d\");\n        context.clearRect(0, 0, canvasWidth, canvasHeight);\n        context.drawImage(snapshotRef.current, 0, 0);\n      }\n\n      const context = canvas.getContext(\"2d\");\n      context.save();\n      context.strokeStyle = \"blue\";\n      context.lineWidth = 1;\n      context.setLineDash([6, 3]);\n\n      const s = selectionStart;\n      const selX = Math.min(s.x, x);\n      const selY = Math.min(s.y, y);\n      const selWidth = Math.abs(x - s.x);\n      const selHeight = Math.abs(y - s.y);\n\n      context.strokeRect(selX, selY, selWidth, selHeight);\n      context.restore();\n    }\n  };\n\n  const stopDrawingHandler = async (e) => {\n    if (isPanning && e.button === 1) {\n      setIsPanning(false);\n      return;\n    }\n    if (!drawing) return;\n    setDrawing(false);\n\n    if (!editingEnabled) {\n      tempPathRef.current = [];\n      return;\n    }\n\n    snapshotRef.current = null;\n    const canvas = canvasRef.current;\n    const rect = canvas.getBoundingClientRect();\n    const finalX = e.clientX - rect.left;\n    const finalY = e.clientY - rect.top;\n\n    if (drawMode === \"eraser\" || drawMode === \"freehand\") {\n      const newDrawing = new Drawing(\n        `drawing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        color,\n        lineWidth,\n        tempPathRef.current,\n        Date.now(),\n        currentUser,\n        {\n          brushStyle: brushStyle,\n          brushType: currentBrushType,\n          brushParams: brushParams,\n          drawingType: \"stroke\",\n        }\n      );\n      newDrawing.roomId = currentRoomId;\n      newDrawing.brushType = currentBrushType;\n      newDrawing.brushParams = brushParams;\n\n      setUndoStack((prev) => [...prev, newDrawing]);\n      setRedoStack([]);\n\n      try {\n        userData.addDrawing(newDrawing);\n        // Add to pending drawings for immediate display (optimistic UI)\n        setPendingDrawings((prev) => [...prev, newDrawing]);\n\n        // Use requestAnimationFrame for immediate, smooth redraw\n        requestAnimationFrame(() => {\n          drawAllDrawings();\n        });\n\n        // Queue the submission instead of submitting immediately\n        const submitTask = async () => {\n          try {\n            console.log(\"Submitting queued stroke:\", {\n              drawingId: newDrawing.drawingId,\n              pathLength: tempPathRef.current.length,\n            });\n\n            await submitToDatabase(\n              newDrawing,\n              auth,\n              {\n                roomId: currentRoomId,\n                roomType,\n              },\n              setUndoAvailable,\n              setRedoAvailable\n            );\n\n            // Mark stroke as confirmed\n            confirmedStrokesRef.current.add(newDrawing.drawingId);\n\n            if (currentRoomId) {\n              checkUndoRedoAvailability(\n                auth,\n                setUndoAvailable,\n                setRedoAvailable,\n                currentRoomId\n              );\n            }\n          } catch (error) {\n            console.error(\"Error during queued freehand submission:\", error);\n            // On error, remove the failed stroke from pending\n            setPendingDrawings((prev) =>\n              prev.filter((d) => d.drawingId !== newDrawing.drawingId)\n            );\n            handleAuthError(error);\n          }\n        };\n\n        submissionQueueRef.current.push(submitTask);\n        processSubmissionQueue();\n      } catch (error) {\n        console.error(\"Error preparing freehand stroke:\", error);\n        handleAuthError(error);\n      } finally {\n        setIsRefreshing(false);\n      }\n      tempPathRef.current = [];\n    } else if (drawMode === \"shape\") {\n      if (!shapeStart) {\n        return;\n      }\n\n      const finalEnd = { x: finalX, y: finalY };\n      const context = canvas.getContext(\"2d\");\n\n      context.save();\n      context.fillStyle = color;\n      context.lineWidth = lineWidth;\n      context.setLineDash([]);\n      if (shapeType === \"circle\") {\n        const radius = Math.sqrt(\n          (finalEnd.x - shapeStart.x) ** 2 + (finalEnd.y - shapeStart.y) ** 2\n        );\n\n        context.beginPath();\n        context.arc(shapeStart.x, shapeStart.y, radius, 0, Math.PI * 2);\n        context.fill();\n      } else if (shapeType === \"rectangle\") {\n        context.fillRect(\n          shapeStart.x,\n          shapeStart.y,\n          finalEnd.x - shapeStart.x,\n          finalEnd.y - shapeStart.y\n        );\n      } else if (shapeType === \"hexagon\") {\n        const radius = Math.sqrt(\n          (finalEnd.x - shapeStart.x) ** 2 + (finalEnd.y - shapeStart.y) ** 2\n        );\n        context.beginPath();\n        for (let i = 0; i < 6; i++) {\n          const angle = (Math.PI / 3) * i;\n          const xPoint = shapeStart.x + radius * Math.cos(angle);\n          const yPoint = shapeStart.y + radius * Math.sin(angle);\n\n          if (i === 0) context.moveTo(xPoint, yPoint);\n          else context.lineTo(xPoint, yPoint);\n        }\n\n        context.closePath();\n        context.fill();\n      } else if (shapeType === \"line\") {\n        context.beginPath();\n        context.moveTo(shapeStart.x, shapeStart.y);\n        context.lineTo(finalEnd.x, finalEnd.y);\n        context.strokeStyle = color;\n        context.lineWidth = lineWidth;\n        context.lineCap = brushStyle;\n        context.lineJoin = brushStyle;\n        context.stroke();\n      }\n      context.restore();\n\n      const shapeDrawingData = {\n        tool: \"shape\",\n        type: shapeType,\n        start: shapeStart,\n        end: finalEnd,\n        brushStyle: shapeType === \"line\" ? brushStyle : undefined,\n      };\n\n      const newDrawing = new Drawing(\n        `drawing_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        color,\n        lineWidth,\n        shapeDrawingData,\n        Date.now(),\n        currentUser,\n        {\n          brushStyle: shapeType === \"line\" ? brushStyle : \"round\",\n          brushType: currentBrushType,\n          brushParams: brushParams,\n          drawingType: \"shape\",\n        }\n      );\n      newDrawing.roomId = currentRoomId;\n\n      userData.addDrawing(newDrawing);\n      setPendingDrawings((prev) => [...prev, newDrawing]);\n\n      // Use requestAnimationFrame for smooth shape rendering\n      requestAnimationFrame(() => {\n        drawAllDrawings();\n      });\n\n      setUndoStack((prev) => [...prev, newDrawing]);\n      setRedoStack([]);\n\n      // Queue the submission\n      const submitTask = async () => {\n        try {\n          await submitToDatabase(\n            newDrawing,\n            auth,\n            {\n              roomId: currentRoomId,\n              roomType,\n            },\n            setUndoAvailable,\n            setRedoAvailable\n          );\n\n          // Mark stroke as confirmed\n          confirmedStrokesRef.current.add(newDrawing.drawingId);\n\n          // Update undo/redo availability after shape submission\n          if (currentRoomId) {\n            checkUndoRedoAvailability(\n              auth,\n              setUndoAvailable,\n              setRedoAvailable,\n              currentRoomId\n            );\n          }\n        } catch (error) {\n          console.error(\"Error during queued shape submission:\", error);\n          // On error, remove the failed stroke from pending\n          setPendingDrawings((prev) =>\n            prev.filter((d) => d.drawingId !== newDrawing.drawingId)\n          );\n          handleAuthError(error);\n        }\n      };\n\n      submissionQueueRef.current.push(submitTask);\n      processSubmissionQueue();\n\n      setShapeStart(null);\n    } else if (drawMode === \"select\") {\n      setDrawing(false);\n\n      try {\n        await mergedRefreshCanvas();\n      } catch (error) {\n        console.error(\"Error during select submission or refresh:\", error);\n      } finally {\n        setIsRefreshing(false);\n      }\n\n      mergedRefreshCanvas();\n    } else if (drawMode === \"stamp\" && stampPreviewRef.current) {\n      // Place stamp at final position on mouseup\n      const { x, y, stamp, settings } = stampPreviewRef.current;\n      await placeStamp(x, y, stamp, settings);\n\n      // Clear preview\n      setStampPreview(null);\n      stampPreviewRef.current = null;\n    }\n  };\n\n  const openHistoryDialog = () => {\n    setSelectedUser(\"\");\n    setHistoryDialogOpen(true);\n  };\n\n  const handleApplyHistory = async (startMs, endMs) => {\n    // startMs and endMs are epoch ms. If not provided, read from inputs.\n    const start =\n      startMs !== undefined\n        ? startMs\n        : historyStartInput\n          ? new Date(historyStartInput).getTime()\n          : NaN;\n    const end =\n      endMs !== undefined\n        ? endMs\n        : historyEndInput\n          ? new Date(historyEndInput).getTime()\n          : NaN;\n\n    if (isNaN(start) || isNaN(end)) {\n      showLocalSnack(\n        \"Please select both start and end date/time before applying History Recall.\"\n      );\n      return;\n    }\n    if (start > end) {\n      showLocalSnack(\"Invalid time range selected. Make sure start <= end.\");\n      return;\n    }\n\n    // Deselect any selected user when entering history recall\n    setSelectedUser(\"\");\n    setHistoryRange({ start, end });\n    setIsLoading(true);\n\n    // Try to load drawings for the requested time range\n    await clearCanvasForRefresh();\n    // set a temporary historyRange so mergedRefreshCanvas will use it\n    setHistoryRange({ start, end });\n    try {\n      const backendCount = await backendRefreshCanvas(\n        serverCountRef.current,\n        userData,\n        drawAllDrawings,\n        start,\n        end,\n        { roomId: currentRoomId, auth }\n      );\n      serverCountRef.current = backendCount;\n      // If no drawings loaded, inform user and rollback historyRange\n      if (!userData.drawings || userData.drawings.length === 0) {\n        setHistoryRange(null);\n        showLocalSnack(\n          \"No drawings were found in that date/time range. Please select another range or exit history recall mode.\"\n        );\n        return;\n      }\n      setHistoryMode(true);\n      setHistoryDialogOpen(false);\n    } catch (e) {\n      console.error(\"Error applying history range:\", e);\n      setHistoryRange(null);\n      showLocalSnack(\n        \"An error occurred while loading history. See console for details.\"\n      );\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // Auto-refresh when the active room changes\n  useEffect(() => {\n    // wipe local cache so we don't flash previous room's strokes\n    userData.drawings = [];\n    setIsRefreshing(true);\n\n    // clear what's on screen immediately\n    try {\n      if (canvasRef.current) {\n        const ctx = canvasRef.current.getContext(\"2d\");\n        if (ctx) {\n          ctx.clearRect(\n            0,\n            0,\n            canvasRef.current.width,\n            canvasRef.current.height\n          );\n        }\n        drawAllDrawings();\n      }\n    } catch { }\n\n    // reload for the new room\n    (async () => {\n      try {\n        await mergedRefreshCanvas(); // already room-aware\n      } finally {\n        setIsRefreshing(false);\n      }\n    })();\n  }, [currentRoomId, canvasRefreshTrigger]);\n\n  const exitHistoryMode = async () => {\n    // Deselect any selected user when leaving history mode\n    setSelectedUser(\"\");\n    setHistoryMode(false);\n    setHistoryRange(null);\n    setIsLoading(true);\n    try {\n      await clearCanvasForRefresh();\n      serverCountRef.current = await backendRefreshCanvas(\n        serverCountRef.current,\n        userData,\n        drawAllDrawings,\n        undefined,\n        undefined,\n        { roomId: currentRoomId, auth }\n      );\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const clearCanvas = async () => {\n    if (!editingEnabled) {\n      showLocalSnack(\"Cannot clear canvas in view-only mode.\");\n      return;\n    }\n    const canvas = canvasRef.current;\n    const context = canvas.getContext(\"2d\");\n\n    context.clearRect(0, 0, canvasWidth, canvasHeight);\n\n    setUserData(initializeUserData());\n    setUndoStack([]);\n    setRedoStack([]);\n    setPendingDrawings([]);\n    serverCountRef.current = 0;\n  };\n\n  const handleExportCanvas = async () => {\n    if (!currentRoomId) {\n      showLocalSnack(\"Cannot export: not in a room\");\n      return;\n    }\n\n    try {\n      setIsLoading(true);\n      showLocalSnack(\"Exporting canvas data...\");\n\n      const { exportRoomCanvas } = await import('../api/rooms');\n      console.log('[Export] Calling API with roomId:', currentRoomId);\n      console.log('[Export] Auth token present:', !!auth?.token);\n\n      const exportData = await exportRoomCanvas(auth?.token, currentRoomId);\n\n      console.log('[Export] Received exportData:', {\n        exists: !!exportData,\n        type: typeof exportData,\n        keys: exportData ? Object.keys(exportData) : [],\n        hasStrokes: exportData ? !!exportData.strokes : false,\n        strokeCount: exportData ? exportData.strokeCount : 'N/A'\n      });\n\n      if (!exportData) {\n        console.error('[Export] exportData is null or undefined');\n        showLocalSnack(\"Export failed: no data returned from server\");\n        return;\n      }\n\n      if (!exportData.strokes) {\n        console.error('[Export] exportData.strokes is missing:', exportData);\n        showLocalSnack(`Export failed: no strokes in response (got ${exportData.strokeCount || 0} count)`);\n        return;\n      }\n\n      // Create a downloadable JSON file\n      const dataStr = JSON.stringify(exportData, null, 2);\n      const dataBlob = new Blob([dataStr], { type: 'application/json' });\n      const url = URL.createObjectURL(dataBlob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `${exportData.roomName || 'canvas'}_export_${Date.now()}.json`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n\n      showLocalSnack(`Exported ${exportData.strokeCount} strokes successfully`);\n      console.log('[Export] Success - downloaded file');\n    } catch (error) {\n      console.error(\"[Export] Error caught:\", error);\n      console.error(\"[Export] Error stack:\", error.stack);\n      showLocalSnack(`Export failed: ${error.message || 'Unknown error'}`);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleImportCanvas = async () => {\n    if (!currentRoomId) {\n      showLocalSnack(\"Cannot import: not in a room\");\n      return;\n    }\n\n    if (!editingEnabled) {\n      showLocalSnack(\"Cannot import in view-only mode\");\n      return;\n    }\n\n    // Create a file input element\n    const input = document.createElement('input');\n    input.type = 'file';\n    input.accept = 'application/json,.json';\n\n    input.onchange = async (e) => {\n      const file = e.target.files[0];\n      if (!file) return;\n\n      try {\n        setIsLoading(true);\n        showLocalSnack(\"Reading import file...\");\n\n        const text = await file.text();\n        const importData = JSON.parse(text);\n\n        if (!importData.strokes || !Array.isArray(importData.strokes)) {\n          showLocalSnack(\"Invalid import file: missing strokes array\");\n          return;\n        }\n\n        // Ask user if they want to clear existing canvas\n        const clearExisting = window.confirm(\n          `Import ${importData.strokes.length} strokes?\\n\\n` +\n          `Click OK to replace current canvas, or Cancel to merge with existing drawings.`\n        );\n\n        showLocalSnack(`Importing ${importData.strokes.length} strokes...`);\n\n        const { importRoomCanvas } = await import('../api/rooms');\n        const result = await importRoomCanvas(auth?.token, currentRoomId, importData, clearExisting);\n\n        if (result.status === 'success') {\n          showLocalSnack(\n            `Import complete: ${result.imported} imported, ${result.failed} failed`,\n            6000\n          );\n\n          // Refresh canvas to show imported data\n          setTimeout(async () => {\n            try {\n              await clearCanvasForRefresh();\n              await mergedRefreshCanvas(\"post-import\");\n            } catch (error) {\n              console.error(\"Error refreshing after import:\", error);\n            }\n          }, 500);\n        } else {\n          showLocalSnack(`Import failed: ${result.message || 'Unknown error'}`);\n        }\n      } catch (error) {\n        console.error(\"Import error:\", error);\n        showLocalSnack(`Import failed: ${error.message || 'Invalid file format'}`);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    input.click();\n  };\n\n  const toggleColorPicker = (event) => {\n    const viewportHeight = window.innerHeight;\n    const pickerHeight = 350;\n    const rect = event.target.getBoundingClientRect();\n    const pickerElement = document.querySelector(\".Canvas-color-picker\");\n\n    setShowColorPicker(!showColorPicker);\n\n    if (rect.bottom + pickerHeight > viewportHeight && pickerElement) {\n      pickerElement.classList.add(\"Canvas-color-picker--adjust-bottom\");\n    } else if (pickerElement) {\n      pickerElement.classList.remove(\"Canvas-color-picker--adjust-bottom\");\n    }\n  };\n\n  const closeColorPicker = () => {\n    setShowColorPicker(false);\n  };\n\n  useEffect(() => {\n    setIsRefreshing(true);\n    clearCanvasForRefresh();\n\n    mergedRefreshCanvas().then(() => {\n      setTimeout(() => {\n        setIsRefreshing(false);\n      }, 500);\n    });\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedUser]);\n\n  useEffect(() => {\n    setUndoAvailable(undoStack.length > 0);\n    setRedoAvailable(redoStack.length > 0);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [undoStack, redoStack]);\n\n  const [showToolbar, setShowToolbar] = useState(true);\n  const [hoverToolbar, setHoverToolbar] = useState(false);\n\n  return (\n    <div className=\"Canvas-wrapper\" style={{ pointerEvents: \"auto\" }}>\n      {/* Top header: room name + optional history range + exit button */}\n      <Box\n        sx={{\n          position: \"absolute\",\n          top: 8,\n          left: \"50%\",\n          transform: \"translateX(-50%)\",\n          zIndex: 2100,\n          bgcolor: \"background.paper\",\n          px: 2,\n          py: 0.5,\n          borderRadius: 1.5,\n          display: \"flex\",\n          alignItems: \"center\",\n          gap: 1,\n          boxShadow: \"0 6px 14px rgba(0,0,0,0.12)\",\n          border: \"1px solid rgba(0,0,0,0.08)\",\n        }}\n      >\n        <Typography variant=\"subtitle2\" sx={{ fontWeight: \"bold\" }}>\n          {currentRoomName || \"Master (not in a room)\"}\n        </Typography>\n\n        {historyMode && historyRange && (\n          <Typography variant=\"caption\" sx={{ whiteSpace: \"nowrap\", ml: 1 }}>\n            {new Date(historyRange.start).toLocaleString()} {\" \"}\n            {new Date(historyRange.end).toLocaleString()}\n          </Typography>\n        )}\n\n        {currentRoomId && (\n          <Button\n            size=\"small\"\n            onClick={() => {\n              // Clear local history UI state for a smooth return to master\n              try {\n                setHistoryMode(false);\n                setHistoryRange(null);\n                setHistoryStartInput(\"\");\n                setHistoryEndInput(\"\");\n                setSelectedUser(\"\");\n              } catch (e) {\n                /* swallow if state setters changed */\n              }\n              onExitRoom();\n            }}\n            sx={{ ml: 1 }}\n          >\n            Return to Master\n          </Button>\n        )}\n      </Box>\n\n      {/* Archived overlay banner - visible when viewOnly (archived or explicit viewer) */}\n      {viewOnly && (\n        <Box\n          sx={{\n            position: \"absolute\",\n            top: 56,\n            left: \"50%\",\n            transform: \"translateX(-50%)\",\n            zIndex: 2200,\n            pointerEvents: \"none\",\n          }}\n        >\n          <Paper\n            elevation={6}\n            sx={{\n              px: 2,\n              py: 0.5,\n              bgcolor: \"rgba(33,33,33,0.86)\",\n              color: \"white\",\n              borderRadius: 1,\n            }}\n          >\n            <Typography\n              variant=\"caption\"\n              sx={{ fontWeight: \"bold\", letterSpacing: 0.5 }}\n            >\n              Archived  View Only\n            </Typography>\n            {/* Owner-only destructive delete button placed under the banner */}\n            {isOwner && (\n              <Box sx={{ mt: 1, display: \"flex\", justifyContent: \"center\" }}>\n                <Button\n                  size=\"small\"\n                  color=\"error\"\n                  variant=\"contained\"\n                  onClick={() => setConfirmDestructiveOpen(true)}\n                  sx={{ pointerEvents: \"all\" }}\n                >\n                  Delete permanently\n                </Button>\n              </Box>\n            )}\n          </Paper>\n        </Box>\n      )}\n\n      {/* Wallet disconnected banner - visible when secure room wallet is not connected */}\n      {roomType === \"secure\" && !walletConnected && (\n        <Box\n          sx={{\n            position: \"absolute\",\n            top: 56,\n            left: \"50%\",\n            transform: \"translateX(-50%)\",\n            zIndex: 2200,\n            pointerEvents: \"none\",\n          }}\n        >\n          <Paper\n            elevation={6}\n            sx={{\n              px: 2,\n              py: 0.5,\n              bgcolor: \"rgba(255, 152, 0, 0.9)\",\n              color: \"white\",\n              borderRadius: 1,\n            }}\n          >\n            <Typography\n              variant=\"caption\"\n              sx={{ fontWeight: \"bold\", letterSpacing: 0.5 }}\n            >\n               Wallet Not Connected  Canvas Locked\n            </Typography>\n          </Paper>\n        </Box>\n      )}\n\n      {/* ResilientDB health status banner */}\n      <Box\n        sx={{\n          position: \"fixed\",\n          top: 72,\n          left: \"50%\",\n          transform: \"translateX(-50%)\",\n          zIndex: 2150,\n          maxWidth: \"90%\",\n          width: \"600px\",\n        }}\n      >\n        <ResilientDBWarningBanner \n          isHealthy={resilientDBHealthy} \n          queueSize={resilientDBQueueSize}\n        />\n      </Box>\n\n      {/* Confirm Destructive Delete dialog (owner-only) */}\n      <Dialog\n        open={confirmDestructiveOpen}\n        onClose={() => {\n          setConfirmDestructiveOpen(false);\n          setDestructiveConfirmText(\"\");\n        }}\n      >\n        <DialogTitle>Permanently delete room</DialogTitle>\n        <DialogContent>\n          <DialogContentText color=\"error\">\n            This will permanently delete this room and all its data for every\n            user. This action is irreversible.\n          </DialogContentText>\n          <DialogContentText sx={{ mt: 1 }}>\n            To confirm, type <strong>DELETE</strong> below.\n          </DialogContentText>\n          <TextField\n            fullWidth\n            value={destructiveConfirmText}\n            onChange={(e) => setDestructiveConfirmText(e.target.value)}\n            placeholder=\"Type DELETE to confirm\"\n            sx={{ mt: 1 }}\n          />\n        </DialogContent>\n        <DialogActions>\n          <Button\n            onClick={() => {\n              setConfirmDestructiveOpen(false);\n              setDestructiveConfirmText(\"\");\n            }}\n          >\n            Cancel\n          </Button>\n          <Button\n            variant=\"contained\"\n            color=\"error\"\n            disabled={destructiveConfirmText !== \"DELETE\"}\n            onClick={async () => {\n              try {\n                const { deleteRoom } = await import(\"../api/rooms\");\n                await deleteRoom(auth.token, currentRoomId);\n                setLocalSnack({\n                  open: true,\n                  message: \"Room permanently deleted\",\n                  duration: 4000,\n                });\n                // After Delete, navigate back to dashboard\n                try {\n                  onExitRoom();\n                } catch (e) { }\n              } catch (e) {\n                console.error(\"Permanent delete failed\", e);\n                setLocalSnack({\n                  open: true,\n                  message: \"Failed to delete room: \" + (e?.message || e),\n                  duration: 4000,\n                });\n              } finally {\n                setConfirmDestructiveOpen(false);\n                setDestructiveConfirmText(\"\");\n              }\n            }}\n          >\n            Delete permanently\n          </Button>\n        </DialogActions>\n      </Dialog>\n\n      <canvas\n        ref={canvasRef}\n        width={canvasWidth}\n        height={canvasHeight}\n        className=\"Canvas-element\"\n        style={{ transform: `translate(${panOffset.x}px, ${panOffset.y}px)` }}\n        onMouseDown={startDrawingHandler}\n        onMouseMove={drawHandler}\n        onMouseUp={stopDrawingHandler}\n        onMouseLeave={stopDrawingHandler}\n      />\n\n      {/* Stamp preview overlay */}\n      {stampPreview && (\n        <Box\n          sx={{\n            position: 'absolute',\n            left: stampPreview.x + panOffset.x,\n            top: stampPreview.y + panOffset.y,\n            pointerEvents: 'none',\n            transform: `translate(-50%, -50%) rotate(${stampPreview.settings.rotation || 0}deg)`,\n            opacity: (stampPreview.settings.opacity || 100) / 100 * 0.7,\n            zIndex: 999,\n          }}\n        >\n          {stampPreview.stamp.emoji ? (\n            <Typography\n              sx={{\n                fontSize: `${stampPreview.settings.size || 50}px`,\n                lineHeight: 1,\n                userSelect: 'none',\n              }}\n            >\n              {stampPreview.stamp.emoji}\n            </Typography>\n          ) : stampPreview.stamp.image ? (\n            <img\n              src={stampPreview.stamp.image}\n              alt=\"Stamp preview\"\n              style={{\n                width: stampPreview.settings.size || 50,\n                height: stampPreview.settings.size || 50,\n                objectFit: 'contain',\n              }}\n            />\n          ) : null}\n        </Box>\n      )}\n\n      <Box\n        sx={{\n          position: \"absolute\",\n          top: \"50%\",\n          transform: \"translateY(-50%)\",\n          left: showToolbar ? 0 : -100,\n          width: 100,\n          transition: \"left 0.3s ease\",\n          pointerEvents: \"all\",\n          zIndex: 1000,\n        }}\n        onMouseEnter={() => setHoverToolbar(true)}\n        onMouseLeave={() => setHoverToolbar(false)}\n      >\n        <Box\n          onClick={() => setShowToolbar((v) => !v)}\n          sx={{\n            position: \"absolute\",\n            right: showToolbar ? 0 : -20,\n            top: \"50%\",\n            transform: \"translateY(-50%)\",\n\n            width: 20,\n            height: 60,\n            display: \"flex\",\n            alignItems: \"center\",\n            justifyContent: \"center\",\n\n            opacity: hoverToolbar ? 1 : 0,\n            transition: \"opacity 0.2s\",\n            bgcolor: \"rgba(0,0,0,0.2)\",\n            cursor: \"pointer\",\n            zIndex: 1001,\n          }}\n        >\n          <IconButton size=\"small\" sx={{ p: 0, color: \"white\" }}>\n            {showToolbar ? (\n              <ChevronLeftIcon fontSize=\"small\" />\n            ) : (\n              <ChevronRightIcon fontSize=\"small\" />\n            )}\n          </IconButton>\n        </Box>\n        <Toolbar\n          drawMode={drawMode}\n          setDrawMode={setDrawMode}\n          shapeType={shapeType}\n          setShapeType={setShapeType}\n          color={color}\n          setColor={setColor}\n          showColorPicker={showColorPicker}\n          toggleColorPicker={toggleColorPicker}\n          closeColorPicker={closeColorPicker}\n          lineWidth={lineWidth}\n          setLineWidth={setLineWidth}\n          previousColor={previousColor}\n          setPreviousColor={setPreviousColor}\n          refreshCanvasButtonHandler={refreshCanvasButtonHandler}\n          undo={undo}\n          undoAvailable={undoAvailable}\n          redo={redo}\n          redoAvailable={redoAvailable}\n          selectionRect={selectionRect}\n          handleCutSelection={async () => {\n            if (!editingEnabled) {\n              showLocalSnack(\"Cut is disabled in view-only mode.\");\n              return;\n            }\n            showLocalSnack(\"Cutting selection... This may take a moment.\");\n            try {\n              const result = await handleCutSelection();\n              if (result && result.compositeCutAction) {\n                setUndoStack((prev) => [...prev, result.compositeCutAction]);\n              }\n              setIsRefreshing(true);\n              showLocalSnack(\"Syncing cut operation...\");\n              try {\n                await mergedRefreshCanvas();\n                showLocalSnack(\"Cut completed successfully!\");\n              } catch (e) {\n                console.error(\"Error syncing cut with server:\", e);\n                showLocalSnack(\"Cut completed, but sync failed. Try refreshing.\");\n              } finally {\n                setIsRefreshing(false);\n              }\n            } catch (e) {\n              console.error(\"Error during cut:\", e);\n              showLocalSnack(\"Cut operation failed. Please try again.\");\n            }\n          }}\n          cutImageData={cutImageData}\n          setClearDialogOpen={setClearDialogOpen}\n          /* Export/Import handlers */\n          handleExportCanvas={handleExportCanvas}\n          handleImportCanvas={handleImportCanvas}\n          /* Advanced brush/stamp/filter props */\n          currentBrushType={currentBrushType}\n          onBrushSelect={handleBrushSelect}\n          onBrushParamsChange={handleBrushParamsChange}\n          selectedStamp={selectedStamp}\n          onStampSelect={handleStampSelect}\n          onStampChange={handleStampChange}\n          backendStamps={backendStamps}\n          onFilterApply={applyFilter}\n          onFilterPreview={previewFilter}\n          onFilterUndo={undoFilter}\n          onClearAllFilters={clearAllFilters}\n          canUndoFilter={\n            !!originalCanvasDataRef.current ||\n            undoStack.some((drawing) => drawing.drawingType === \"filter\")\n          }\n          canClearFilters={hasFilters}\n          appliedFilters={\n            (() => {\n              const filters = userData.drawings.filter((drawing) => drawing.drawingType === \"filter\");\n              console.log(`[Canvas render] Passing ${filters.length} applied filters to Toolbar`, filters);\n              return filters;\n            })()\n          }\n          /* History Recall props (required so the toolbar can open/change/exit history mode) */\n          openHistoryDialog={openHistoryDialog}\n          exitHistoryMode={exitHistoryMode}\n          historyMode={historyMode}\n          controlsDisabled={!editingEnabled}\n          onOpenSettings={onOpenSettings}\n        />\n      </Box>\n\n      {isRefreshing && (\n        <div className=\"Canvas-loading-overlay\">\n          <div className=\"Canvas-spinner\"></div>\n        </div>\n      )}\n\n      {/* History Recall Dialog */}\n      <Dialog\n        open={historyDialogOpen}\n        onClose={() => setHistoryDialogOpen(false)}\n        aria-labelledby=\"history-recall-dialog\"\n      >\n        <DialogTitle id=\"history-recall-dialog\">\n          History Recall - Select Date/Time Range\n        </DialogTitle>\n        <DialogContent>\n          <DialogContentText>\n            Choose a start and end date/time to recall drawings from\n            ResilientDB. Only drawings within the selected range will be loaded.\n          </DialogContentText>\n          <Box sx={{ display: \"flex\", flexDirection: \"column\", gap: 2, mt: 1 }}>\n            <TextField\n              label=\"Start\"\n              type=\"datetime-local\"\n              value={historyStartInput}\n              onChange={(e) => setHistoryStartInput(e.target.value)}\n              InputLabelProps={{ shrink: true }}\n            />\n            <TextField\n              label=\"End\"\n              type=\"datetime-local\"\n              value={historyEndInput}\n              onChange={(e) => setHistoryEndInput(e.target.value)}\n              InputLabelProps={{ shrink: true }}\n            />\n          </Box>\n        </DialogContent>\n        <DialogActions>\n          <Button\n            onClick={() => {\n              setHistoryDialogOpen(false);\n            }}\n          >\n            Cancel\n          </Button>\n          <Button\n            onClick={async () => {\n              const start = historyStartInput\n                ? new Date(historyStartInput).getTime()\n                : NaN;\n              const end = historyEndInput\n                ? new Date(historyEndInput).getTime()\n                : NaN;\n              await handleApplyHistory(start, end);\n            }}\n          >\n            Apply\n          </Button>\n        </DialogActions>\n      </Dialog>\n\n      <Fade\n        in={Boolean(historyMode || (selectedUser && selectedUser !== \"\"))}\n        timeout={300}\n      >\n        <Paper\n          elevation={6}\n          sx={{\n            position: \"fixed\",\n            bottom: 16,\n            left: \"50%\",\n            transform: \"translateX(-50%)\",\n            zIndex: 2000,\n            bgcolor: \"background.paper\",\n            px: 2,\n            py: 0.6,\n            display: \"flex\",\n            alignItems: \"center\",\n            gap: 1,\n            borderRadius: 1.5,\n          }}\n        >\n          <InfoOutlinedIcon fontSize=\"small\" />\n          <Typography variant=\"body2\" sx={{ whiteSpace: \"nowrap\" }}>\n            {historyMode\n              ? \"History Mode Enabled  Canvas Editing Disabled\"\n              : selectedUser && selectedUser !== \"\"\n                ? \"Viewing Past Drawing History of Selected User  Canvas Editing Disabled\"\n                : \"\"}\n          </Typography>\n        </Paper>\n      </Fade>\n\n      {/* Loading overlay: fades in/out while drawings load */}\n      <Fade in={Boolean(isLoading)} timeout={300}>\n        <Paper\n          elevation={6}\n          sx={{\n            position: \"absolute\",\n            left: \"50%\",\n            top: \"12%\",\n            transform: \"translateX(-50%)\",\n            padding: \"8px 12px\",\n            zIndex: 2000,\n            display: \"flex\",\n            alignItems: \"center\",\n            gap: 1,\n          }}\n        >\n          <CircularProgress size={18} />\n          <Typography variant=\"body2\">Loading Drawings...</Typography>\n        </Paper>\n      </Fade>\n\n      <Dialog open={clearDialogOpen} onClose={() => setClearDialogOpen(false)}>\n        <DialogTitle>Clear Canvas</DialogTitle>\n        <DialogContent>\n          <DialogContentText>\n            Are you sure you want to clear the canvas for everyone?\n          </DialogContentText>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={() => setClearDialogOpen(false)} color=\"primary\">\n            No\n          </Button>\n          <Button\n            onClick={async () => {\n              // Immediate local clear for responsiveness\n              await clearCanvas();\n              try {\n                const resp = await clearBackendCanvas({\n                  roomId: currentRoomId,\n                  auth,\n                });\n                // If backend returned a clearedAt timestamp, use it as authoritative\n                if (resp && resp.clearedAt && currentRoomId) {\n                  roomClearedAtRef.current[currentRoomId] = resp.clearedAt;\n                }\n              } catch (e) {\n                console.error(\"Failed to clear backend:\", e);\n              }\n              // Update undo/redo availability after clear\n              try {\n                await checkUndoRedoAvailability(\n                  auth,\n                  setUndoAvailable,\n                  setRedoAvailable,\n                  currentRoomId\n                );\n              } catch (e) { }\n              setUserList([]);\n              try {\n                setSelectedUser(\"\");\n              } catch (e) {\n                /* ignore if setter missing */\n              }\n              setClearDialogOpen(false);\n            }}\n            color=\"primary\"\n            autoFocus\n          >\n            Yes\n          </Button>\n        </DialogActions>\n      </Dialog>\n\n      {/* Command Palette - Quick command search and execution */}\n      <CommandPalette\n        open={commandPaletteOpen}\n        onClose={() => setCommandPaletteOpen(false)}\n        commands={commandRegistry.getAll()}\n        onExecute={(command) => {\n          try {\n            command.action();\n          } catch (error) {\n            console.error('[Canvas] Error executing command:', error);\n            showLocalSnack('Error executing command');\n          }\n        }}\n      />\n\n      {/* Keyboard Shortcuts Help Dialog */}\n      <KeyboardShortcutsHelp\n        open={shortcutsHelpOpen}\n        onClose={() => setShortcutsHelpOpen(false)}\n        shortcuts={shortcutManagerRef.current?.getAllShortcuts() || []}\n      />\n\n      <SafeSnackbar open={localSnack.open} message={localSnack.message} autoHideDuration={localSnack.duration} onClose={closeLocalSnack} />\n    </div>\n  );\n}\n\nexport default Canvas;\n","import { useState, useCallback, useRef } from \"react\";\n\n/**\n * Advanced brush engine with support for complex brush types\n */\nexport default function useBrushEngine(initialCtx = null) {\n  const [brushType, setBrushType] = useState(\"normal\");\n  const [brushParams, setBrushParams] = useState({});\n  const ctxRef = useRef(initialCtx); // Use ref instead of state for immediate updates\n  const particleTrailRef = useRef([]);\n  const lastPointRef = useRef(null);\n\n  // Brush configurations\n  const brushConfigs = {\n    normal: { size: 1, opacity: 1 },\n    wacky: { scatter: 5, colors: true, particles: 3 },\n    drip: { droplets: 2, gravity: 0.5, viscosity: 0.3 },\n    scatter: { spread: 20, density: 5, variation: 0.8 },\n    neon: { glow: 10, intensity: 0.9 },\n    chalk: { texture: true, opacity: 0.7, roughness: 0.5 },\n    spray: { density: 15, spread: 25, pressure: 0.6 }\n  };\n\n  const drawNormalBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    ctxRef.current.lineTo(x, y);\n    ctxRef.current.stroke();\n    ctxRef.current.beginPath();\n    ctxRef.current.moveTo(x, y);\n  }, []);\n\n  const drawWackyBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.wacky;\n\n    for (let i = 0; i < config.particles; i++) {\n      const offsetX = (Math.random() - 0.5) * config.scatter * lineWidth;\n      const offsetY = (Math.random() - 0.5) * config.scatter * lineWidth;\n      const size = Math.random() * lineWidth * 0.8 + lineWidth * 0.2;\n\n      ctxRef.current.save();\n      ctxRef.current.beginPath();\n      ctxRef.current.arc(x + offsetX, y + offsetY, size, 0, 2 * Math.PI);\n\n      if (config.colors) {\n        ctxRef.current.fillStyle = `hsl(${Math.random() * 360}, 80%, 60%)`;\n      } else {\n        ctxRef.current.fillStyle = color;\n      }\n\n      ctxRef.current.fill();\n      ctxRef.current.restore();\n    }\n  }, []);\n\n  const drawDripBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.drip;\n\n    // Main stroke with current color\n    ctxRef.current.strokeStyle = color;\n    ctxRef.current.lineWidth = lineWidth;\n    ctxRef.current.lineTo(x, y);\n    ctxRef.current.stroke();\n\n    // Add more visible droplets with higher chance\n    if (Math.random() < 0.2) {\n      for (let i = 0; i < config.droplets; i++) {\n        const dropX = x + (Math.random() - 0.5) * lineWidth * 2;\n        const dropY = y + Math.random() * lineWidth * 4;\n        const dropSize = (Math.random() * 0.4 + 0.2) * lineWidth;\n\n        ctxRef.current.save();\n        ctxRef.current.beginPath();\n        ctxRef.current.arc(dropX, dropY, dropSize, 0, 2 * Math.PI);\n        ctxRef.current.fillStyle = color;\n        ctxRef.current.globalAlpha = config.viscosity;\n        ctxRef.current.fill();\n        ctxRef.current.restore();\n      }\n    }\n  }, []);\n\n  const drawScatterBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.scatter;\n\n    for (let i = 0; i < config.density; i++) {\n      const angle = Math.random() * Math.PI * 2;\n      const distance = Math.random() * config.spread;\n      const scatterX = x + Math.cos(angle) * distance;\n      const scatterY = y + Math.sin(angle) * distance;\n      const size = Math.random() * lineWidth * config.variation + lineWidth * 0.2;\n\n      ctxRef.current.save();\n      ctxRef.current.beginPath();\n      ctxRef.current.arc(scatterX, scatterY, size, 0, 2 * Math.PI);\n      ctxRef.current.fillStyle = color;\n      ctxRef.current.globalAlpha = 0.6;\n      ctxRef.current.fill();\n      ctxRef.current.restore();\n    }\n  }, []);\n\n  const drawNeonBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.neon;\n\n    ctxRef.current.save();\n    ctxRef.current.strokeStyle = color;\n    ctxRef.current.lineWidth = lineWidth;\n    ctxRef.current.shadowColor = color;\n    ctxRef.current.shadowBlur = config.glow;\n    ctxRef.current.globalAlpha = config.intensity;\n    ctxRef.current.lineTo(x, y);\n    ctxRef.current.stroke();\n    ctxRef.current.restore();\n  }, []);\n\n  const drawChalkBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.chalk;\n\n    // Create textured effect with multiple small strokes\n    for (let i = 0; i < 3; i++) {\n      const offsetX = (Math.random() - 0.5) * lineWidth * config.roughness;\n      const offsetY = (Math.random() - 0.5) * lineWidth * config.roughness;\n\n      ctxRef.current.save();\n      ctxRef.current.globalAlpha = config.opacity * (0.3 + Math.random() * 0.7);\n      ctxRef.current.beginPath();\n      ctxRef.current.arc(x + offsetX, y + offsetY, lineWidth * 0.8, 0, 2 * Math.PI);\n      ctxRef.current.fillStyle = color;\n      ctxRef.current.fill();\n      ctxRef.current.restore();\n    }\n  }, []);\n\n  const drawSprayBrush = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) return;\n    const config = brushConfigs.spray;\n\n    // Scale spray parameters with lineWidth for proper pen size reflection\n    const sprayRadius = config.spread * (lineWidth / 5); // Scale spread with pen size\n    const particleSize = lineWidth / 5; // Scale particle size with pen size\n\n    for (let i = 0; i < config.density; i++) {\n      const angle = Math.random() * Math.PI * 2;\n      const distance = Math.random() * sprayRadius * config.pressure;\n      const sprayX = x + Math.cos(angle) * distance;\n      const sprayY = y + Math.sin(angle) * distance;\n      const size = Math.random() * particleSize + particleSize * 0.5;\n\n      ctxRef.current.save();\n      ctxRef.current.beginPath();\n      ctxRef.current.arc(sprayX, sprayY, size, 0, 2 * Math.PI);\n      ctxRef.current.fillStyle = color;\n      ctxRef.current.globalAlpha = 0.3;\n      ctxRef.current.fill();\n      ctxRef.current.restore();\n    }\n  }, []);\n  const draw = useCallback((x, y, lineWidth, color) => {\n    if (!ctxRef.current) {\n      console.log(\"BrushEngine: No context available\");\n      return;\n    }\n\n    console.log(\"BrushEngine: Drawing with brush type:\", brushType);\n\n    switch (brushType) {\n      case \"normal\":\n        drawNormalBrush(x, y, lineWidth, color);\n        break;\n      case \"wacky\":\n        drawWackyBrush(x, y, lineWidth, color);\n        break;\n      case \"drip\":\n        drawDripBrush(x, y, lineWidth, color);\n        break;\n      case \"scatter\":\n        drawScatterBrush(x, y, lineWidth, color);\n        break;\n      case \"neon\":\n        drawNeonBrush(x, y, lineWidth, color);\n        break;\n      case \"chalk\":\n        drawChalkBrush(x, y, lineWidth, color);\n        break;\n      case \"spray\":\n        drawSprayBrush(x, y, lineWidth, color);\n        break;\n      default:\n        drawNormalBrush(x, y, lineWidth, color);\n    }\n\n    lastPointRef.current = { x, y };\n  }, [brushType, drawNormalBrush, drawWackyBrush, drawDripBrush, drawScatterBrush, drawNeonBrush, drawChalkBrush, drawSprayBrush]);\n\n  // Draw with a specific brush type (doesn't rely on state)\n  const drawWithType = useCallback((x, y, lineWidth, color, specificBrushType) => {\n    if (!ctxRef.current) {\n      console.log(\"BrushEngine: No context available\");\n      return;\n    }\n\n    switch (specificBrushType) {\n      case \"normal\":\n        drawNormalBrush(x, y, lineWidth, color);\n        break;\n      case \"wacky\":\n        drawWackyBrush(x, y, lineWidth, color);\n        break;\n      case \"drip\":\n        drawDripBrush(x, y, lineWidth, color);\n        break;\n      case \"scatter\":\n        drawScatterBrush(x, y, lineWidth, color);\n        break;\n      case \"neon\":\n        drawNeonBrush(x, y, lineWidth, color);\n        break;\n      case \"chalk\":\n        drawChalkBrush(x, y, lineWidth, color);\n        break;\n      case \"spray\":\n        drawSprayBrush(x, y, lineWidth, color);\n        break;\n      default:\n        drawNormalBrush(x, y, lineWidth, color);\n    }\n\n    lastPointRef.current = { x, y };\n  }, [drawNormalBrush, drawWackyBrush, drawDripBrush, drawScatterBrush, drawNeonBrush, drawChalkBrush, drawSprayBrush]);\n\n  const startStroke = useCallback((x, y) => {\n    if (!ctxRef.current) return;\n    lastPointRef.current = { x, y };\n    particleTrailRef.current = [];\n\n    // For normal brush, ensure we start with a point\n    if (brushType === \"normal\") {\n      ctxRef.current.beginPath();\n      ctxRef.current.moveTo(x, y);\n    }\n  }, [brushType]);\n\n  const getBrushConfig = useCallback(() => {\n    return brushConfigs[brushType] || brushConfigs.normal;\n  }, [brushType, brushConfigs]);\n\n  const updateContext = useCallback((newCtx) => {\n    ctxRef.current = newCtx; // Direct assignment to ref for immediate update\n  }, []);\n\n  return {\n    brushType,\n    setBrushType,\n    brushParams,\n    setBrushParams,\n    draw,\n    drawWithType,\n    startStroke,\n    getBrushConfig,\n    updateContext,\n    availableBrushes: Object.keys(brushConfigs)\n  };\n}\n","import React, { useState, useEffect } from 'react';\nimport {\n  Box,\n  Button,\n  Paper,\n  Typography,\n  Alert,\n  CircularProgress,\n  Chip,\n  Tooltip\n} from '@mui/material';\nimport AccountBalanceWalletIcon from '@mui/icons-material/AccountBalanceWallet';\nimport CheckCircleIcon from '@mui/icons-material/CheckCircle';\nimport ErrorIcon from '@mui/icons-material/Error';\nimport {\n  connectWalletForSecureRoom,\n  disconnectWallet,\n  isWalletConnected,\n  getShortPublicKey,\n  getConnectionStatus\n} from '../wallet/resvault';\n\n/**\n * Wallet connection component for secure rooms\n * Manages ResVault wallet connection state and provides UI for users\n */\nexport default function WalletConnector({ roomType, onConnected, onDisconnected }) {\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(null);\n  const [status, setStatus] = useState(getConnectionStatus());\n\n  // Check connection status on mount\n  useEffect(() => {\n    const checkStatus = () => {\n      const currentStatus = getConnectionStatus();\n      setStatus(currentStatus);\n    };\n\n    checkStatus();\n    const interval = setInterval(checkStatus, 2000);\n\n    return () => clearInterval(interval);\n  }, []);\n\n  // Notify parent when connection changes\n  useEffect(() => {\n    if (status.connected && onConnected) {\n      onConnected(status.publicKey);\n    } else if (!status.connected && onDisconnected) {\n      onDisconnected();\n    }\n  }, [status.connected, status.publicKey, onConnected, onDisconnected]);\n\n  const handleConnect = async () => {\n    setLoading(true);\n    setError(null);\n\n    try {\n      const pubKey = await connectWalletForSecureRoom();\n      setStatus({ connected: true, publicKey: pubKey });\n    } catch (err) {\n      console.error('Wallet connection failed:', err);\n\n      // Provide helpful error message\n      let errorMsg = err.message || 'Failed to connect wallet';\n\n      if (errorMsg.includes('not connected') || errorMsg.includes('No keys found')) {\n        errorMsg = 'Please connect your wallet to this site first:\\n\\n' +\n          '1. Click the ResVault extension icon in your browser\\n' +\n          '2. Make sure you are logged in to ResVault\\n' +\n          '3. In the ResVault dashboard, select the network you want to use\\n' +\n          '4. Click the connection icon to connect to this site\\n' +\n          '5. Then try connecting again here';\n      }\n\n      setError(errorMsg);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleDisconnect = () => {\n    disconnectWallet();\n    setStatus({ connected: false, publicKey: null });\n  };\n\n  if (roomType !== 'secure') {\n    return null;\n  }\n\n  return (\n    <Paper\n      elevation={2}\n      sx={{\n        p: 2,\n        mb: 2,\n        backgroundColor: status.connected ? '#e8f5e9' : '#fff3e0',\n        border: status.connected ? '2px solid #4caf50' : '2px solid #ff9800'\n      }}\n    >\n      <Box display=\"flex\" alignItems=\"center\" justifyContent=\"space-between\">\n        <Box display=\"flex\" alignItems=\"center\" gap={2}>\n          <AccountBalanceWalletIcon\n            fontSize=\"large\"\n            color={status.connected ? 'success' : 'warning'}\n          />\n          <Box>\n            <Typography variant=\"h6\" component=\"div\">\n              Secure Room - Wallet Required\n            </Typography>\n            <Typography variant=\"body2\" color=\"text.secondary\">\n              {status.connected\n                ? `Connected: ${getShortPublicKey(status.publicKey)}`\n                : 'Connect your ResVault wallet to draw in this secure room'}\n            </Typography>\n          </Box>\n        </Box>\n\n        <Box display=\"flex\" alignItems=\"center\" gap={2}>\n          {status.connected ? (\n            <>\n              <Tooltip title={`Full public key: ${status.publicKey}`}>\n                <Chip\n                  icon={<CheckCircleIcon />}\n                  label=\"Connected\"\n                  color=\"success\"\n                  variant=\"filled\"\n                />\n              </Tooltip>\n              <Button\n                variant=\"outlined\"\n                color=\"error\"\n                onClick={handleDisconnect}\n                size=\"small\"\n              >\n                Disconnect\n              </Button>\n            </>\n          ) : (\n            <Button\n              variant=\"contained\"\n              color=\"primary\"\n              onClick={handleConnect}\n              disabled={loading}\n              startIcon={loading ? <CircularProgress size={20} /> : <AccountBalanceWalletIcon />}\n            >\n              {loading ? 'Connecting...' : 'Connect Wallet'}\n            </Button>\n          )}\n        </Box>\n      </Box>\n\n      {error && (\n        <Alert\n          severity=\"error\"\n          icon={<ErrorIcon />}\n          sx={{ mt: 2 }}\n          onClose={() => setError(null)}\n        >\n          <Typography variant=\"body2\" component=\"div\">\n            <strong>Wallet Connection Failed</strong>\n          </Typography>\n          <Typography variant=\"body2\" component=\"div\" sx={{ mt: 1, whiteSpace: 'pre-line' }}>\n            {error}\n          </Typography>\n          {error.includes('WALLET_NOT_CONNECTED') && (\n            <Box sx={{ mt: 2 }}>\n              <Typography variant=\"body2\" component=\"div\">\n                <strong>How to connect:</strong>\n              </Typography>\n              <Typography variant=\"body2\" component=\"ol\" sx={{ pl: 2, mt: 1 }}>\n                <li>Click the <strong>ResVault extension icon</strong> in your browser toolbar</li>\n                <li>Make sure you're <strong>logged in</strong> to ResVault</li>\n                <li>Select your desired <strong>network</strong> (e.g., ResilientDB Mainnet)</li>\n                <li>Click the <strong>globe/connection icon</strong> to connect to this site</li>\n                <li>Return here and click <strong>\"Connect Wallet\"</strong> again</li>\n              </Typography>\n            </Box>\n          )}\n          {error.includes('extension') && (\n            <Typography variant=\"caption\" display=\"block\" sx={{ mt: 1 }}>\n              Please install the ResVault Chrome extension from:{' '}\n              <a\n                href=\"https://github.com/apache/incubator-resilientdb-resvault\"\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                ResVault GitHub\n              </a>\n            </Typography>\n          )}\n        </Alert>\n      )}\n\n      {!status.connected && !error && (\n        <Alert severity=\"info\" sx={{ mt: 2 }}>\n          <Typography variant=\"body2\">\n            Secure rooms require all strokes to be cryptographically signed with your wallet.\n            This ensures verifiable authorship and prevents impersonation.\n          </Typography>\n        </Alert>\n      )}\n    </Paper>\n  );\n}\n","import React, { useState, useEffect, useRef, useCallback } from 'react';\nimport {\n  Box, Paper, Typography, Button, CircularProgress, IconButton,\n  List, ListItem, ListItemButton, ListItemText, Avatar, AppBar, ThemeProvider,\n  Link, Dialog, DialogTitle, DialogContent, DialogActions\n} from '@mui/material';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { getRoomDetails, getRoomStrokes } from '../api/rooms';\nimport { getUsername } from '../utils/getUsername';\nimport Canvas from '../components/Canvas';\nimport WalletConnector from '../components/WalletConnector';\nimport { handleAuthError } from '../utils/authUtils';\nimport { formatErrorMessage } from '../utils/errorHandling';\nimport { getSocket, setSocketToken } from '../services/socket';\nimport ChevronLeftIcon from '@mui/icons-material/ChevronLeft';\nimport ChevronRightIcon from '@mui/icons-material/ChevronRight';\nimport SettingsIcon from '@mui/icons-material/Settings';\nimport theme from '../config/theme';\n\nexport default function Room({ auth }) {\n  const { id } = useParams();\n  const navigate = useNavigate();\n  const [info, setInfo] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const roomId = id;\n  const socketRef = useRef(null);\n\n  const [selectedUser, setSelectedUser] = useState(\"\");\n  const [userList, setUserList] = useState([]);\n  const [expandedGroups, setExpandedGroups] = useState([]);\n  const [showUserList, setShowUserList] = useState(true);\n  const [hovering, setHovering] = useState(false);\n\n  const [helpOpen, setHelpOpen] = useState(false);\n  const [blogOpen, setBlogOpen] = useState(false);\n  const [forbiddenOpen, setForbiddenOpen] = useState(false);\n  const [forbiddenMessage, setForbiddenMessage] = useState('Access denied');\n  const [forbiddenRedirect, setForbiddenRedirect] = useState('/dashboard');\n  const [forbiddenTitle, setForbiddenTitle] = useState('Access denied');\n\n  const [walletConnected, setWalletConnected] = useState(false);\n  const [walletPublicKey, setWalletPublicKey] = useState(null);\n\n  const formatDateMs = (epochMs) => {\n    const d = new Date(epochMs);\n    return d.toLocaleDateString() + \" \" + d.toLocaleTimeString();\n  };\n\n  const toggleGroup = (periodStart) => {\n    if (expandedGroups.includes(periodStart)) {\n      setExpandedGroups(expandedGroups.filter(p => p !== periodStart));\n    } else {\n      setExpandedGroups([...expandedGroups, periodStart]);\n    }\n  };\n\n  const handleReturnToMaster = () => {\n    navigate('/dashboard');\n  };\n\n  const handleWalletConnected = (publicKey) => {\n    setWalletConnected(true);\n    setWalletPublicKey(publicKey);\n    console.log('Wallet connected:', publicKey);\n  };\n\n  const handleWalletDisconnected = () => {\n    setWalletConnected(false);\n    setWalletPublicKey(null);\n    console.log('Wallet disconnected');\n  };\n\n  const load = useCallback(async () => {\n    if (!auth?.token) {\n      console.error('No auth token available for room loading');\n      setLoading(false);\n      return;\n    }\n\n    try {\n      setLoading(true);\n      const detail = await getRoomDetails(auth.token, roomId);\n      setInfo(detail);\n      const s = await getRoomStrokes(auth.token, roomId);\n      // strokes are now handled directly by Canvas component\n      console.log('Room strokes loaded:', s.length, 'strokes');\n    } catch (error) {\n      console.error('Failed to load room details:', error);\n      if (!handleAuthError(error)) {\n        const errorMessage = formatErrorMessage(error);\n        if (error?.status === 403 || (error?.message && error.message.toLowerCase().includes('forbidden'))) {\n          setForbiddenTitle('Access Denied');\n          setForbiddenMessage(errorMessage);\n          setForbiddenRedirect('/dashboard');\n          setForbiddenOpen(true);\n        } else if (error?.status === 404) {\n          setForbiddenTitle('Room Not Found');\n          setForbiddenMessage(errorMessage);\n          setForbiddenRedirect('/dashboard');\n          setForbiddenOpen(true);\n        } else {\n          setForbiddenTitle('Error Loading Room');\n          setForbiddenMessage(errorMessage);\n          setForbiddenRedirect('/dashboard');\n          setForbiddenOpen(true);\n        }\n      }\n    } finally {\n      setLoading(false);\n    }\n  }, [auth?.token, roomId]);\n\n  useEffect(() => {\n    load();\n  }, [load]);\n\n  useEffect(() => {\n    if (!auth?.token) return;\n    setSocketToken(auth.token);\n    const sock = getSocket(auth.token);\n    socketRef.current = sock;\n    sock.emit(\"join_room\", { roomId });\n    const onStroke = (payload) => {\n      if (payload?.roomId === roomId && payload.stroke) {\n        console.log('Received real-time stroke for room:', roomId);\n      }\n    };\n    const onRoleChanged = (payload) => {\n      if (payload?.roomId === roomId) {\n        console.log('Role changed in room:', payload);\n        // Reload room details to get updated role and permissions\n        load();\n      }\n    };\n    const onUserRemoved = (payload) => {\n      if (payload?.roomId === roomId) {\n        console.log('User removed from room:', payload);\n        // Show notification and redirect to dashboard\n        try {\n          window.dispatchEvent(new CustomEvent('rescanvas:notify', {\n            detail: { message: payload.message || 'You were removed from this room', duration: 4000 }\n          }));\n        } catch (e) { }\n        setTimeout(() => {\n          navigate('/dashboard');\n        }, 1000);\n      }\n    };\n    const onRoomUpdated = (payload) => {\n      if (payload?.roomId === roomId) {\n        console.log('Room updated:', payload);\n        // Reload room details to get updated settings\n        load();\n      }\n    };\n    const onRoomDeleted = (payload) => {\n      if (payload?.roomId === roomId) {\n        console.log('Room deleted:', payload);\n        // Show notification and redirect to dashboard\n        try {\n          window.dispatchEvent(new CustomEvent('rescanvas:notify', {\n            detail: { message: 'This room was deleted by the owner', duration: 4000 }\n          }));\n        } catch (e) { }\n        setTimeout(() => {\n          navigate('/dashboard');\n        }, 1000);\n      }\n    };\n    sock.on(\"stroke\", onStroke);\n    sock.on(\"role_changed\", onRoleChanged);\n    sock.on(\"user_removed_from_room\", onUserRemoved);\n    sock.on(\"room_updated\", onRoomUpdated);\n    sock.on(\"room_deleted\", onRoomDeleted);\n    return () => {\n      try {\n        sock.off(\"stroke\", onStroke);\n        sock.off(\"role_changed\", onRoleChanged);\n        sock.off(\"user_removed_from_room\", onUserRemoved);\n        sock.off(\"room_updated\", onRoomUpdated);\n        sock.off(\"room_deleted\", onRoomDeleted);\n        sock.emit(\"leave_room\", { roomId });\n      } catch (_) { }\n    };\n  }, [roomId, auth?.token, navigate, load]);\n\n  if (loading) return <Box sx={{ p: 3 }}><CircularProgress /></Box>;\n  // If the room is archived, only the owner should be able to edit; others view-only\n  // Archived rooms are view-only for everyone. Also treat explicit 'viewer' role as view-only.\n  const viewOnly = (() => {\n    const role = info?.myRole || 'editor';\n    if (info?.archived) return true;\n    return role === 'viewer';\n  })();\n\n  const isOwner = (() => {\n    try {\n      if (!info) return false;\n      const role = info.myRole || null;\n      if (role === 'owner') return true;\n      try {\n        const uname = getUsername(auth);\n        if (uname && info.ownerName && uname === info.ownerName) return true;\n      } catch (e) { }\n      return false;\n      return false;\n    } catch (e) { return false; }\n  })();\n\n  return (\n    <ThemeProvider theme={theme}>\n      <Box className=\"App\" sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>\n        {/* Room page relies on the floating Canvas header for room title and Return to Master */}\n\n        <Box sx={{ height: 'calc(100vh - 200px)', position: 'relative', overflow: 'hidden' }}>\n          {/* Wallet Connector for Secure Rooms */}\n          {info?.type === 'secure' && (\n            <Box sx={{\n              position: 'absolute',\n              top: 80,\n              left: 20,\n              zIndex: 1200,\n            }}>\n              <WalletConnector\n                roomType={info?.type}\n                onConnected={handleWalletConnected}\n                onDisconnected={handleWalletDisconnected}\n              />\n            </Box>\n          )}\n\n          {/* Floating settings button removed - settings are available in the left toolbar */}\n          {/* Main Canvas Content Fills the Entire Area */}\n          <Box sx={{\n            width: '100%',\n            height: '100%',\n            overflow: 'hidden',\n          }}>\n            <Canvas\n              auth={auth}\n              currentRoomId={roomId}\n              currentRoomName={info?.name || `Room ${roomId}`}\n              setUserList={setUserList}\n              selectedUser={selectedUser}\n              setSelectedUser={setSelectedUser}\n              onExitRoom={handleReturnToMaster}\n              canvasRefreshTrigger={0}\n              viewOnly={viewOnly}\n              isOwner={isOwner}\n              roomType={info?.type || 'public'}\n              walletConnected={walletConnected}\n              templateId={info?.templateId}\n              onOpenSettings={((info && ((info.myRole || 'editor') !== 'viewer')) ? (() => navigate(`/rooms/${roomId}/settings`)) : null)}\n            />\n          </Box>\n\n          {/* Floating Drawing History Sidebar - Right side */}\n          <Box\n            sx={{\n              position: 'absolute',\n              top: 20,\n              right: 0,\n              bottom: 20,\n              width: showUserList ? 150 : 20,\n              transition: 'width 0.3s ease',\n              pointerEvents: 'none',\n            }}\n            onMouseEnter={() => setHovering(true)}\n            onMouseLeave={() => setHovering(false)}\n          >\n            {/* Toggle button on the left edge */}\n            <Box\n              onClick={() => setShowUserList(v => !v)}\n              sx={{\n                position: 'absolute',\n                left: 0,\n                top: '50%',\n                transform: 'translateY(-50%)',\n                width: 16,\n                height: 50,\n                display: 'flex',\n                alignItems: 'center',\n                justifyContent: 'center',\n                pointerEvents: 'all',\n                opacity: hovering ? 1 : 0,\n                transition: 'opacity 0.2s',\n                bgcolor: 'rgba(0,0,0,0.1)',\n                cursor: 'pointer',\n                zIndex: 1100,\n              }}\n            >\n              <IconButton size=\"small\" sx={{ p: 0, color: 'white' }}>\n                {showUserList\n                  ? <ChevronRightIcon fontSize=\"small\" />\n                  : <ChevronLeftIcon fontSize=\"small\" />}\n              </IconButton>\n            </Box>\n\n            {/* Drawing History Panel */}\n            {showUserList && (\n              <Paper\n                elevation={3}\n                className=\"history-panel\"\n                sx={{\n                  height: '100%',\n                  display: 'flex',\n                  flexDirection: 'column',\n                  borderRadius: '12px 0 0 12px',\n                  overflow: 'hidden',\n                  background: '#25D8C5',\n                  pointerEvents: 'all',\n                }}\n              >\n                {/* Fixed Header */}\n                <Box\n                  sx={{\n                    height: 42,\n                    backgroundImage: `\n                      linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)),\n                      url('/toolbar/toolbar-bg.jpeg')\n                    `,\n                    backgroundPosition: 'center',\n                    backgroundSize: 'cover',\n                    backgroundRepeat: 'no-repeat',\n                    display: 'flex',\n                    alignItems: 'center',\n                    justifyContent: 'center',\n                    color: 'white',\n                    fontWeight: 'bold',\n                    fontSize: '0.9rem',\n                    fontFamily: 'Comic Sans MS, cursive',\n                    flexShrink: 0,\n                  }}\n                >\n                  Drawing History\n                </Box>\n\n                {/* Scrollable User List */}\n                <Box\n                  sx={{\n                    flexGrow: 1,\n                    overflowY: 'auto',\n                    backdropFilter: 'blur(4px)',\n                    padding: 0.5,\n                  }}\n                >\n                  <List dense sx={{ py: 0 }}>\n                    {userList && userList.map((group, index) => {\n                      // group is expected to be { periodStart, users: [...] }\n                      if (group && group.periodStart !== undefined) {\n                        const label = formatDateMs(group.periodStart);\n                        const expanded = expandedGroups.includes(group.periodStart);\n                        return (\n                          <div key={group.periodStart}>\n                            <ListItem disablePadding sx={{ py: 0 }}>\n                              <ListItemButton\n                                onClick={() => toggleGroup(group.periodStart)}\n                                sx={{ py: 0.5, minHeight: 32 }}\n                              >\n                                <ListItemText\n                                  primary={label}\n                                  primaryTypographyProps={{\n                                    color: '#17635a',\n                                    fontWeight: 'bold',\n                                    fontSize: '0.8rem'\n                                  }}\n                                />\n                              </ListItemButton>\n                            </ListItem>\n                            {expanded && group.users.map((user, uidx) => {\n                              const username = user.split(\"|\")[0];\n                              const isSelected = selectedUser && (\n                                (typeof selectedUser === 'string' && selectedUser === user) ||\n                                (typeof selectedUser === 'object' && selectedUser.user === user && selectedUser.periodStart === group.periodStart)\n                              );\n                              return (\n                                <ListItem key={`${group.periodStart}-${uidx}`} disablePadding sx={{ pl: 1, py: 0 }}>\n                                  <ListItemButton\n                                    onClick={() => setSelectedUser(isSelected ? \"\" : { user: user, periodStart: group.periodStart })}\n                                    selected={Boolean(isSelected)}\n                                    sx={{\n                                      py: 0.5,\n                                      minHeight: 32,\n                                      borderRadius: 1,\n                                      '&.Mui-selected': {\n                                        backgroundColor: theme.palette.action.hover,\n                                        '&:hover': {\n                                          backgroundColor: theme.palette.action.selected\n                                        }\n                                      }\n                                    }}\n                                  >\n                                    <Avatar sx={{ bgcolor: theme.palette.primary.light, mr: 1, width: 28, height: 28, fontSize: '0.9rem' }}>\n                                      {username.charAt(0).toUpperCase()}\n                                    </Avatar>\n                                    <ListItemText\n                                      primary={username}\n                                      primaryTypographyProps={{ color: '#17635a', fontSize: '0.8rem' }}\n                                    />\n                                  </ListItemButton>\n                                </ListItem>\n                              );\n                            })}\n                          </div>\n                        );\n                      } else {\n                        const user = group;\n                        const username = (user || '').split(\"|\")[0];\n                        const isSelected = selectedUser === user;\n                        return (\n                          <ListItem key={index} disablePadding sx={{ py: 0 }}>\n                            <ListItemButton\n                              onClick={() => setSelectedUser(isSelected ? \"\" : user)}\n                              selected={Boolean(isSelected)}\n                              sx={{\n                                py: 0.5,\n                                minHeight: 32,\n                                borderRadius: 1,\n                                '&.Mui-selected': {\n                                  backgroundColor: theme.palette.action.hover,\n                                  '&:hover': {\n                                    backgroundColor: theme.palette.action.selected\n                                  }\n                                }\n                              }}\n                            >\n                              <Avatar sx={{ bgcolor: theme.palette.primary.light, mr: 1, width: 28, height: 28, fontSize: '0.9rem' }}>\n                                {username.charAt(0).toUpperCase()}\n                              </Avatar>\n                              <ListItemText\n                                primary={username}\n                                primaryTypographyProps={{ color: '#17635a', fontSize: '0.8rem' }}\n                              />\n                            </ListItemButton>\n                          </ListItem>\n                        );\n                      }\n                    })}\n                  </List>\n                </Box>\n              </Paper>\n            )}\n          </Box>\n        </Box>\n\n        {/* Legacy per-room footer removed; Layout provides the global footer now. */}\n\n        {/* Help Dialog */}\n        <Dialog open={helpOpen} onClose={() => setHelpOpen(false)} maxWidth=\"md\" fullWidth>\n          <DialogTitle sx={{ bgcolor: 'primary.main', color: 'white' }}>\n            ResCanvas Help\n          </DialogTitle>\n          <DialogContent sx={{ pt: 2 }}>\n            <Box sx={{ display: 'flex', justifyContent: 'center', mb: 3 }}>\n              <img\n                src=\"../help_screen.png\"\n                alt=\"ResCanvas Help Screen\"\n                style={{ maxWidth: '100%', height: 'auto' }}\n              />\n            </Box>\n            <Typography variant=\"h6\" gutterBottom>Welcome to ResCanvas!</Typography>\n            <Typography paragraph>\n              ResCanvas is a collaborative drawing platform that uses ResilientDB to ensure your artwork is securely stored in a decentralized manner.\n            </Typography>\n            <Typography variant=\"h6\" gutterBottom>How to Use:</Typography>\n            <Typography component=\"div\">\n              <ul>\n                <li><strong>Left Toolbar:</strong> Access drawing tools, colors, and brush sizes</li>\n                <li><strong>Drawing History:</strong> View and filter drawings by user and time period</li>\n                <li><strong>Real-time Collaboration:</strong> See other users' drawings appear instantly</li>\n                <li><strong>History Recall:</strong> Load drawings from specific time periods</li>\n                <li><strong>Undo/Redo:</strong> Use the toolbar buttons to undo or redo actions</li>\n                <li><strong>Room Management:</strong> Create and join different drawing rooms</li>\n              </ul>\n            </Typography>\n          </DialogContent>\n          <DialogActions>\n            <Button onClick={() => setHelpOpen(false)} color=\"primary\" variant=\"contained\">\n              Got it!\n            </Button>\n          </DialogActions>\n        </Dialog>\n\n        {/* Blog Dialog */}\n        <Dialog open={blogOpen} onClose={() => setBlogOpen(false)} maxWidth=\"lg\" fullWidth>\n          <DialogTitle sx={{ bgcolor: 'primary.main', color: 'white' }}>\n            ResCanvas Blog\n          </DialogTitle>\n          <DialogContent sx={{ pt: 2 }}>\n            <Typography variant=\"h4\" gutterBottom>\n              Introducing ResCanvas: Decentralized Collaborative Drawing\n            </Typography>\n            <Typography paragraph>\n              ResCanvas represents a breakthrough in web-based drawing platforms that utilizes ResilientDB to ensure that user's drawings are securely stored, allowing for multiple users to collaborate and create new works of art and express ideas freely without any limits, tracking, or censorship.\n            </Typography>\n            <Typography variant=\"h5\" gutterBottom>Key Features</Typography>\n            <Typography component=\"div\">\n              <ul>\n                <li>Real-time collaborative drawing with multiple users</li>\n                <li>Persistent, secure storage of drawing data in ResilientDB allowing for censorship free expression</li>\n                <li>Individual stroke-by-stroke caching using Redis for optimal performance</li>\n                <li>Advanced drawing tools including shapes, colors, and brush sizes</li>\n                <li>History recall functionality to view drawings from specific time periods</li>\n                <li>Room-based access control for private and secure drawing sessions</li>\n                <li>Decentralized architecture ensuring no single point of failure</li>\n              </ul>\n            </Typography>\n            <Typography variant=\"h5\" gutterBottom>Technology Stack</Typography>\n            <Typography paragraph>\n              ResCanvas combines cutting-edge blockchain technology with modern web frameworks:\n            </Typography>\n            <Typography component=\"div\">\n              <ul>\n                <li><strong>Frontend:</strong> React.js with Material-UI for responsive design</li>\n                <li><strong>Backend:</strong> Python Flask with Socket.IO for real-time communication</li>\n                <li><strong>Database:</strong> ResilientDB for decentralized, secure data storage</li>\n                <li><strong>Cache:</strong> Redis for high-performance stroke caching</li>\n                <li><strong>Authentication:</strong> JWT tokens with ResVault integration</li>\n              </ul>\n            </Typography>\n          </DialogContent>\n          <DialogActions>\n            <Button onClick={() => setBlogOpen(false)} color=\"primary\" variant=\"contained\">\n              Close\n            </Button>\n          </DialogActions>\n        </Dialog>\n      </Box>\n      <Dialog open={forbiddenOpen} onClose={() => { setForbiddenOpen(false); navigate(forbiddenRedirect); }}>\n        <DialogTitle>{forbiddenTitle}</DialogTitle>\n        <DialogContent>\n          <Typography>{forbiddenMessage}</Typography>\n        </DialogContent>\n        <DialogActions>\n          <Button onClick={() => { setForbiddenOpen(false); navigate(forbiddenRedirect); }} autoFocus>OK</Button>\n        </DialogActions>\n      </Dialog>\n    </ThemeProvider>\n  );\n}\n","// Lightweight notifier helper.\n// Dispatches a DOM CustomEvent 'rescanvas:notify' with { message, duration }.\n// The top-level Layout listens for this event and shows a themed Snackbar.\nexport default function notify(msg, duration = 4000) {\n  try {\n    const detail = { message: String(msg), duration };\n    const ev = new CustomEvent('rescanvas:notify', { detail });\n    if (window && typeof window.dispatchEvent === 'function') {\n      window.dispatchEvent(ev);\n      return;\n    }\n  } catch (e) {\n  }\n  console.warn('NOTIFY:', msg);\n}\n"],"names":["ResilientDBWarningBanner","_ref","isHealthy","queueSize","_jsx","Collapse","in","children","_jsxs","Alert","severity","icon","WarningIcon","sx","mb","borderRadius","width","AlertTitle","_Fragment","healthCheckInterval","lastCheckTime","listeners","async","checkHealth","response","fetch","API_BASE","method","headers","data","json","wasHealthy","oldQueueSize","ok","retry_queue_size","Date","now","Math","abs","console","log","forEach","cb","timestamp","error","open","onClose","commands","onExecute","search","setSearch","useState","filteredCommands","setFilteredCommands","selectedIndex","setSelectedIndex","recentCommands","setRecentCommands","listRef","useRef","inputRef","useEffect","stored","localStorage","getItem","JSON","parse","slice","length","trim","recentCommandObjs","map","id","find","cmd","filter","Boolean","otherCommands","includes","normalizedSearch","toLowerCase","searchWords","split","filtered","searchText","label","description","category","keywords","join","every","word","sort","a","b","aLabelMatch","bLabelMatch","aCategoryMatch","bCategoryMatch","localeCompare","setTimeout","current","focus","selectedElement","scrollIntoView","block","behavior","executeCommand","useCallback","command","newRecent","setItem","stringify","action","handleKeyDown","event","key","preventDefault","prev","formatShortcut","shortcut","modifiers","parts","isMac","navigator","platform","toUpperCase","indexOf","ctrl","push","shift","alt","displayKey","groupedCommands","reduce","acc","idx","prevCmd","showCategoryHeader","index","Dialog","maxWidth","fullWidth","PaperProps","className","maxHeight","TransitionProps","onEntered","Box","p","pb","TextField","autoFocus","placeholder","value","onChange","e","target","onKeyDown","variant","size","InputProps","startAdornment","InputAdornment","position","SearchIcon","color","border","borderBottom","borderColor","borderWidth","Typography","pl","List","ref","overflow","py","background","textAlign","KeyboardIcon","fontSize","_ref2","React","Divider","my","px","fontWeight","ListItem","button","selected","onClick","cursor","bgcolor","ListItemText","primary","secondary","primaryTypographyProps","secondaryTypographyProps","Chip","ml","fontFamily","height","borderTop","display","gap","shortcuts","selectedTab","setSelectedTab","searchQuery","setSearchQuery","groupedShortcuts","useMemo","_shortcut$label","_shortcut$description","_shortcut$category","categories","Object","keys","_shortcut$modifiers","_shortcut$modifiers2","_shortcut$modifiers3","_shortcut$key","DialogTitle","alignItems","pr","mr","component","IconButton","right","top","CloseIcon","DialogContent","Tabs","newValue","scrollButtons","Tab","textTransform","_groupedShortcuts$cat","role","hidden","Paper","Table","TableBody","TableRow","TableCell","align","opacity","shortcutKey","mt","gutterBottom","KeyboardShortcutManager","constructor","this","Map","enabled","activeModifiers","conflictWarnings","register","arguments","undefined","allowInInput","getShortcutKey","has","existing","get","warn","new","set","registeredAt","unregister","shortcutId","delete","ctrlKey","metaKey","shiftKey","altKey","isInputElement","stopPropagation","normalizedKey","normalizeKey","element","_element$tagName","_element$type","_element$getAttribute","_element$closest","_element$closest2","_element$closest3","tagName","type","contentEditableAttr","getAttribute","call","contentEditable","isContentEditable","closest","disable","enable","toggle","getAllShortcuts","Array","from","entries","getShortcutsByCategory","grouped","getConflicts","clear","setShortcutEnabled","CommandRegistry","_listeners","beforeExecute","afterExecute","options","Error","allowOverwrite","fullCommand","tags","visible","_hasExplicitEnabled","hasOwnProperty","notifyListeners","commandId","deleted","execute","_len","args","_key","result","getAll","values","getByCategory","getCategories","Set","add","query","normalizedQuery","words","segments","some","segment","segmentLower","startsWith","endsWith","aLabelStarts","bLabelStarts","getCommandsWithShortcuts","commandIds","on","eventName","callback","l","addListener","_len2","_key2","listener","camelEvent","getStats","all","visibleEnabled","visibleDisabled","total","byCategory","cat","withShortcuts","disabled","registerBatch","success","export","commandRegistry","DrawModeMenu","drawMode","setDrawMode","previousColor","setColor","setPreviousColor","controlsDisabled","anchorEl","setAnchorEl","modes","freehand","CreateIcon","eraser","EraserIcon","shape","ShapeIcon","select","PanToolIcon","paste","ContentPasteIcon","stamp","StarsIcon","safeDrawMode","handleClose","mode","Tooltip","title","currentTarget","padding","minWidth","Menu","anchorOrigin","vertical","horizontal","transformOrigin","MenuItem","ListItemIcon","ShapeMenu","shapeType","setShapeType","shapes","circle","CircleIcon","rectangle","SquareIcon","hexagon","HexagonIcon","line","TimelineIcon","WackyBrushPreview","brushId","params","canvasRef","canvas","ctx","getContext","clearRect","fillStyle","fillRect","intensity","variation","flow","drawNormalPreview","drawWackyPreview","drawDripPreview","drawScatterPreview","drawNeonPreview","drawChalkPreview","drawSprayPreview","strokeStyle","lineWidth","lineCap","beginPath","moveTo","quadraticCurveTo","stroke","particles","floor","i","x","y","sin","random","arc","PI","globalAlpha","fill","dripHeight","points","save","shadowColor","shadowBlur","restore","path","point","offsetX","offsetY","sprayPoints","centerX","angle","distance","cos","style","brushes","name","BrushPanel","onSelect","onParamsChange","selectedBrush","setSelected","brushParams","setBrushParams","handleParamChange","param","newParams","selectedBrushData","justifyContent","backgroundColor","brush","handleSelect","Slider","_","min","max","valueLabelDisplay","filters","default","hue","saturation","roughness","amount","gradient","sepia","vignette","MixerPanel","onApply","onPreview","onUndo","onClearAll","canUndo","canClearAll","appliedFilters","selectedFilter","setSelectedFilter","filterParams","setFilterParams","isPreviewMode","setIsPreviewMode","appliedFilterTypes","filterType","isFilterAlreadyApplied","f","existingFilter","defaultParams","config","selectedFilterData","Button","handleClearAll","handleFilterSelect","filterId","_ref3","replace","step","Stack","direction","spacing","startIcon","PreviewIcon","handlePreview","ApplyIcon","handleApply","handleUndo","UndoIcon","popularEmojis","StampEditor","onSave","stampData","setStampData","emoji","image","setMode","fileInputRef","previewImage","setPreviewImage","setError","EmojiEmotionsIcon","FormControl","InputLabel","Select","ImageIcon","overflowY","Grid","container","item","handleEmojiSelect","borderStyle","file","files","reader","FileReader","onload","readAsDataURL","accept","_fileInputRef$current","click","CloudUploadIcon","src","objectFit","DialogActions","handleSave","newStamp","defaultStamps","StampPanel","onStampChange","backendStamps","selectedStamp","externalSelectedStamp","showEditor","setShowEditor","stamps","setStamps","setSelectedStamp","stampSettings","setStampSettings","rotation","filterCategory","setFilterCategory","savedStamps","localCustomStamps","stampMap","_stamp$image","substring","_stamp$image2","mergedStamps","defaultCount","localCount","backendCount","totalUnique","saveStamps","newStamps","customStamps","s","d","handleSettingChange","setting","newSettings","filteredStamps","flexWrap","charAt","xs","Card","handleStampSelect","CardContent","stampId","updatedStamps","handleDeleteStamp","DeleteIcon","AddIcon","EditIcon","ZoomInIcon","RotateRightIcon","margin","transform","toString","actionButtonSX","showColorPicker","toggleColorPicker","closeColorPicker","setLineWidth","refreshCanvasButtonHandler","undo","undoAvailable","redo","redoAvailable","selectionRect","handleCutSelection","cutImageData","setClearDialogOpen","handleExportCanvas","handleImportCanvas","openHistoryDialog","exitHistoryMode","historyMode","onOpenSettings","currentBrushType","onBrushSelect","onBrushParamsChange","onStampSelect","onFilterApply","onFilterPreview","onFilterUndo","onClearAllFilters","canUndoFilter","canClearFilters","tool","setTool","handleOpen","selectedTool","BrushIcon","PaletteIcon","StarIcon","Popover","boxShadow","flexDirection","orientation","v","document","querySelector","SketchPicker","newColor","hex","disableAlpha","RefreshIcon","SettingsIcon","HistoryIcon","DownloadIcon","UploadIcon","ClearAllIcon","RedoIcon","ContentCutIcon","sdk","ResVaultSDK","isConnected","currentPublicKey","VERBOSE_LOG","window","location","hostname","getConnectionStatus","connected","publicKey","getWalletPublicKey","Promise","resolve","reject","handler","debug","wrapped","payload","resvault","pubKey","pubkey","removeMessageListener","clearTimeout","timeoutId","errMsg","message","addMessageListener","sendMessage","signStrokeForSecureRoom","roomId","publicKeyBase58","publicKeyBytes","bs58","decode","publicKeyHex","padStart","dataToSign","user","pathData","ts","sortKeysDeep","obj","isArray","sortedData","canonical","messageBytes","TextEncoder","encode","signature","messageUint8Array","privateKeyBytes","privateKey","keyPair","nacl","fromSeed","fromSecretKey","detached","secretKey","signatureHex","sig","signMessageHex","signerPubKey","isWalletConnected","getShortPublicKey","Drawing","drawingId","metadata","brushStyle","order","brushType","drawingType","isPending","_metadataCache","getMetadata","invalidateMetadataCache","fromBackendData","completeMetadata","brush_type","brush_params","retryWithBackoff","fn","lastError","maxRetries","baseDelay","attempt","_error$response","_error$response2","_error$response3","status","delay","pow","submitToDatabase","drawing","auth","setUndoAvailable","setRedoAvailable","token","getAuthToken","username","getUsername","strokeData","skipUndoStack","parentPasteId","roomType","notify","_signerPubKey","signedData","signError","postRoomStroke","skipUndoCheck","checkUndoRedoAvailability","refreshCanvas","currentCount","userData","drawAllDrawings","startTime","endTime","_options$auth","strokes","getRoomStrokes","start","end","count","firstStroke","lastStroke","advancedBrushStrokes","hasBrushType","hasBrush_type","hasMetadata","brushTypeValue","brush_typeValue","metadataValue","filteredDrawings","extractedMetadata","rawStroke","substr","hasStampData","hasStampSettings","pathDataIsArray","pathDataLength","oldCount","drawings","newCount","newDrawingsSample","clearLastDrawnState","firstDrawing","allDrawingIds","pastedStrokesStillPresent","undoRedoInProgress","getUndoRedoStatus","undo_available","redo_available","useCanvasSelection","currentUser","generateId","currentRoomId","showLocalSnack","selectionStart","setSelectionStart","setSelectionRect","setCutImageData","cutOriginalIds","setCutOriginalIds","cutStrokesMap","setCutStrokesMap","computeIntersections","p1","p2","rect","intersections","tLeft","yLeft","t","tRight","yRight","tTop","xTop","tBottom","xBottom","unique","inter","u","rectX","rectY","rectWidth","rectHeight","cutRect","eraseInsideSegmentsNew","newCutDrawings","updatedDrawings","affectedDrawings","newCutOriginalIds","newCutStrokesMap","totalDrawings","processedCount","pt","cutDrawing","outsideSegments","getOutsideSegments","isInside","currentSegment","inters","ip","insideSegments","getInsideSegments","replacementSegments","seg","newSeg","cutSeg","eraseSeg","shapeData","shapePoints","center","radius","sqrt","numPoints","ys","minX","maxX","minY","maxY","subj","X","Y","clipPoly","clipper1","ClipperLib","AddPath","ptSubject","ptClip","insideSolution","Execute","ctIntersection","pftNonZero","clipper2","outsideSolution","ctDifference","poly","newPoly","maxArea","bestPoly","area","Area","insidePoly","inside","outsideSegs","insideSegs","allReplacementSegments","flat","replacementSegmentIds","savedSegmentCount","cutRecord","cut","originalStrokeIds","addDrawing","compositeCutAction","eraseStrokes","UserData","userId","clearDrawings","_auth$user","_shortcutManagerRef$c","setUserList","selectedUser","setSelectedUser","canvasRefreshTrigger","currentRoomName","onExitRoom","viewOnly","isOwner","walletConnected","templateId","snapshotRef","tempPathRef","clamp","currentUserRef","uname","setDrawing","shapeStart","setShapeStart","brushEngine","initialCtx","setBrushType","ctxRef","particleTrailRef","lastPointRef","brushConfigs","normal","wacky","scatter","colors","drip","droplets","gravity","viscosity","spread","density","neon","glow","chalk","texture","spray","pressure","drawNormalBrush","lineTo","drawWackyBrush","drawDripBrush","dropX","dropY","dropSize","drawScatterBrush","scatterX","scatterY","drawNeonBrush","drawChalkBrush","drawSprayBrush","sprayRadius","particleSize","sprayX","sprayY","draw","drawWithType","specificBrushType","startStroke","getBrushConfig","updateContext","newCtx","availableBrushes","useBrushEngine","setCurrentBrushType","setBackendStamps","stampPreview","setStampPreview","stampPreviewRef","activeFilter","setActiveFilter","isFilterPreview","setIsFilterPreview","originalCanvasDataRef","preFilterCanvasStateRef","setShowColorPicker","isRefreshing","setIsRefreshing","clearDialogOpen","undoStack","setUndoStack","redoStack","setRedoStack","hasFilters","setHasFilters","templateObjects","setTemplateObjects","templateObjectsRef","canvasWidth","canvasHeight","panOffset","setPanOffset","isPanning","setIsPanning","panStartRef","panOriginRef","PAN_REFRESH_COOLDOWN_MS","panLastRefreshRef","panRefreshSkippedRef","panEndRefreshTimerRef","pendingPanRefreshRef","pendingDrawings","setPendingDrawings","refreshTimerRef","submissionQueueRef","isSubmittingRef","confirmedStrokesRef","lastDrawnStateRef","isDrawingInProgressRef","offscreenCanvasRef","cachedCanvasRef","cachedDrawingIdsRef","forceNextRedrawRef","templateCanvasRef","cachedTemplateIdRef","setHistoryMode","historyRange","setHistoryRange","historyDialogOpen","setHistoryDialogOpen","historyStartInput","setHistoryStartInput","historyEndInput","setHistoryEndInput","isLoading","setIsLoading","localSnack","setLocalSnack","duration","confirmDestructiveOpen","setConfirmDestructiveOpen","destructiveConfirmText","setDestructiveConfirmText","msg","String","editingEnabled","commandPaletteOpen","setCommandPaletteOpen","shortcutsHelpOpen","setShortcutsHelpOpen","shortcutManagerRef","resilientDBHealthy","setResilientDBHealthy","resilientDBQueueSize","setResilientDBQueueSize","roomUiRef","previousSelectedUserRef","isRefreshingSelectedUserRef","selectedUserRefreshQueueRef","roomStacksRef","roomClipboardRef","roomClearedAtRef","drawAllDrawingsRef","_ui$color","_ui$lineWidth","_ui$drawMode","_ui$shapeType","_ui$previousColor","_ui$selectedStamp","_ui$stampSettings","_ui$currentBrushType","_ui$brushParams","ui","stacks","clip","template","TEMPLATE_LIBRARY","objects","timer","setInterval","unsubscribe","clearInterval","cur","handleMouseUp","mergedRefreshCanvas","finally","addEventListener","removeEventListener","processSubmissionQueue","submission","catch","setSocketToken","socket","getSocket","emit","strokeBatch","batchTimer","flushStrokeBatch","batch","requestAnimationFrame","scheduleRefresh","handleNewStroke","myName","getAuthUser","e2","clearedAt","prevStamps","imageKey","handleUserJoined","handleUserLeft","handleStrokeUndone","handleCanvasCleared","serverCountRef","clearCanvasForRefresh","off","resetMyStacks","_stacks$undo","_stacks$redo","getUndoRedoStacks","undo_stack","redo_stack","reconstructDrawing","restoredUndoStack","restoredRedoStack","restoreUndoRedoStacks","undoCount","redoCount","currentSerialized","periodStart","performRefresh","targetSerialized","logLabel","to","queuedTarget","context","setUserData","initializeUserData","updateFilterState","handleAuthError","_auth$user2","_auth$user3","uniqueUserId","currentUserData","filterExists","filterCount","applyPreviewFilter","existingFilterIndex","findIndex","originalDrawings","imageData","getImageData","filteredImageData","applyImageFilter","putImageData","ImageData","Uint8ClampedArray","applyBlurFilter","applyHueShiftFilter","applyChalkFilter","applyFadeFilter","applyVintageFilter","applyNeonFilter","temp","r","g","leftX","leftIdx","rightX","rightIdx","topY","topIdx","bottomY","bottomIdx","hueShift","saturationShift","diff","sum","h","newS","hue2rgb","q","newR","newG","newB","round","noise","opacityFactor","fadeAmount","sepiaAmount","centerY","vignetteAmount","glowIntensity","hueNormalized","neonR","neonG","neonB","alpha","colorFactor","boost","minBrightness","currentBrightness","brightnessFactor","currentTemplateObjects","savedBrushType","savedBrushParams","userDrawingIds","uniquePendingDrawings","pd","combined","filterSignature","templateSignature","x1","cx","y1","cy","stateSignature","newDrawingsOnly","hasNewFiltersOrCuts","currentIds","allCachedPresent","createElement","offscreenContext","imageSmoothingEnabled","drawImage","templateCanvas","templateContext","renderedCount","x2","y2","strokeRect","ellipse","rx","ry","font","bold","fillText","text","sortedDrawings","regularDrawings","filterDrawings","imageStampCache","imageStampPromises","imageUrl","promise","img","Image","onerror","race","maskedOriginals","seenAnyCut","drawingsToRender","globalCompositeOperation","ceil","viewingUser","viewingPeriodStart","settings","translate","rotate","textBaseline","pathDataType","pathDataValue","fullDrawing","pts","pointCount","hasBrushEngine","lineJoin","closePath","storedBrush","xPoint","yPoint","cap","groupMap","groups","k","parseInt","users","stillExists","filterDrawing","cacheContext","lastAction","shouldRefreshFromBackend","repArr","rep","original","undoRoomAction","pastedDrawings","beforeCount","pasted","afterCount","undoAction","lastUndone","redoRoomAction","redoAction","manager","handlePaste","rectCanvas","getBoundingClientRect","scaleX","scaleY","pasteX","clientX","left","pasteY","clientY","Infinity","newDrawings","originalDrawing","newPathData","newPoints","newStart","newEnd","drawingCount","drawingTypes","pasteRecordId","nd","onProgress","processed","failed","BATCH_SIZE","totalProcessed","totalFailed","postRoomStrokesBatch","submitBatchToDatabase","pastedIds","pasteRecord","pastedDrawingIds","sourceLabel","backendRefreshCanvas","pendingSnapshot","drawingMatches","sameUser","tsA","tsB","tsClose","lenA","lenB","lenClose","stillPending","pdTs","exists","backendMatch","pendingHasStampData","backendHasStampData","pendingImageLength","backendImageLength","filtersByType","nonFilterDrawings","deduplicatedDrawings","newUserData","extractCustomStamps","seenStamps","stopDrawingHandler","finalX","finalY","newDrawing","submitTask","pathLength","finalEnd","setLineDash","shapeDrawingData","stampDrawing","placeStamp","then","showToolbar","setShowToolbar","hoverToolbar","setHoverToolbar","pointerEvents","zIndex","whiteSpace","toLocaleString","elevation","letterSpacing","DialogContentText","deleteRoom","onMouseDown","dataURL","toDataURL","snapshotImg","onMouseMove","buttons","deltaX","deltaY","newX","newY","containerWidth","innerWidth","innerHeight","handlePan","complete","drawShapePreview","selX","selY","selWidth","selHeight","onMouseUp","onMouseLeave","lineHeight","userSelect","transition","onMouseEnter","ChevronLeftIcon","ChevronRightIcon","Toolbar","viewportHeight","pickerElement","bottom","classList","remove","exportRoomCanvas","exportData","hasStrokes","strokeCount","dataStr","dataBlob","Blob","url","URL","createObjectURL","link","href","download","roomName","body","appendChild","removeChild","revokeObjectURL","stack","input","onchange","importData","clearExisting","confirm","importRoomCanvas","imported","handleStampChange","allDrawings","filterIds","markStrokesAsUndone","apiError","InputLabelProps","shrink","getTime","NaN","startMs","endMs","isNaN","handleApplyHistory","Fade","timeout","InfoOutlinedIcon","CircularProgress","clearCanvas","resp","_options$auth2","clearRoomCanvas","clearBackendCanvas","CommandPalette","KeyboardShortcutsHelp","SafeSnackbar","autoHideDuration","closeLocalSnack","WalletConnector","onConnected","onDisconnected","loading","setLoading","setStatus","checkStatus","currentStatus","interval","AccountBalanceWalletIcon","CheckCircleIcon","handleDisconnect","signerPublicKey","err","errorMsg","connectWalletForSecureRoom","ErrorIcon","rel","Room","useParams","navigate","useNavigate","info","setInfo","socketRef","userList","expandedGroups","setExpandedGroups","showUserList","setShowUserList","hovering","setHovering","helpOpen","setHelpOpen","blogOpen","setBlogOpen","forbiddenOpen","setForbiddenOpen","forbiddenMessage","setForbiddenMessage","forbiddenRedirect","setForbiddenRedirect","forbiddenTitle","setForbiddenTitle","setWalletConnected","walletPublicKey","setWalletPublicKey","load","detail","getRoomDetails","errorMessage","formatErrorMessage","sock","onStroke","onRoleChanged","onUserRemoved","dispatchEvent","CustomEvent","onRoomUpdated","onRoomDeleted","myRole","archived","ownerName","ThemeProvider","theme","handleWalletDisconnected","Canvas","handleReturnToMaster","backgroundImage","backgroundPosition","backgroundSize","backgroundRepeat","flexShrink","flexGrow","backdropFilter","dense","group","epochMs","toLocaleDateString","toLocaleTimeString","formatDateMs","expanded","disablePadding","ListItemButton","toggleGroup","minHeight","uidx","isSelected","palette","hover","Avatar","light","paragraph","ev"],"sourceRoot":""}